=== Project Directory Structure ===
Root: C:\Users\viktor.jonsson\OneDrive - CellMax Technologies AB\Documents\Repositories\svenviktorjonsson\tesseracs-chat
Relevant files and folders (excluding specified patterns):

.
├── Readme.md
├── fetch_assets.py
├── generate_secret_key.py
├── package.json
├── postcss.config.js
├── project_content.txt
├── pyproject.toml
├── tailwind.config.js
├── update_schema.py
├── write_project_content_to_file.py
├── app/
│   ├── __init__.py
│   ├── auth.py
│   ├── config.py
│   ├── database.py
│   ├── docker_utils.py
│   ├── email_utils.py
│   ├── encryption_utils.py
│   ├── llm.py
│   ├── main.py
│   ├── models.py
│   ├── state.py
│   ├── utils.py
│   ├── static/
│   │   ├── _sidebar.html
│   │   ├── chat-session.html
│   │   ├── input.css
│   │   ├── languages.json
│   │   ├── login.html
│   │   ├── script.js
│   │   ├── session-choice.html
│   │   ├── settings.html
│   │   ├── email_templates/
│   │   │   ├── password_reset_email.html
│   │   │   ├── registration_email.html
│   │   ├── js/
│   │   │   ├── app-ui.js
│   │   │   ├── d3.min.js
│   │   │   ├── mpld3.min.js
│   │   │   ├── session-manager.js
│   │   │   ├── settings.js
│   │   │   ├── sidebar-toggle.js
│   │   │   ├── temp.js
├── dockerfiles/
│   ├── python/
├── tests/
│   ├── test_coding.py


=== File Contents ===

=== Readme.md ===
Readme


=== fetch_assets.py ===
import os
import requests
import sys
import shutil
import subprocess
import tempfile
import zipfile
import glob

# --- Configuration ---
script_dir = os.path.dirname(os.path.abspath(__file__))
static_dir = os.path.join(script_dir, 'app', 'static')
assets_dir = os.path.join(static_dir, 'assets')
css_dir = os.path.join(assets_dir, 'css')
fonts_dir = os.path.join(assets_dir, 'fonts')
js_dir = os.path.join(static_dir, 'js')

# --- Base URL for KaTeX assets ---
KATEX_VERSION = "0.16.9"
KATEX_BASE_URL = f"https://cdn.jsdelivr.net/npm/katex@{KATEX_VERSION}/dist/"

# --- List of KaTeX font files to download ---
katex_fonts = [
    "KaTeX_Main-Regular.woff2", "KaTeX_Main-Italic.woff2", "KaTeX_Main-Bold.woff2",
    "KaTeX_Math-Italic.woff2", "KaTeX_Math-BoldItalic.woff2",
    "KaTeX_Size1-Regular.woff2", "KaTeX_Size2-Regular.woff2",
    "KaTeX_Size3-Regular.woff2", "KaTeX_Size4-Regular.woff2",
    "KaTeX_AMS-Regular.woff2", "KaTeX_Caligraphic-Regular.woff2", "KaTeX_Caligraphic-Bold.woff2",
    "KaTeX_Fraktur-Regular.woff2", "KaTeX_Fraktur-Bold.woff2",
    "KaTeX_SansSerif-Regular.woff2", "KaTeX_SansSerif-Bold.woff2", "KaTeX_SansSerif-Italic.woff2",
    "KaTeX_Script-Regular.woff2", "KaTeX_Typewriter-Regular.woff2",
    "KaTeX_Main-Regular.woff", "KaTeX_Math-Italic.woff", "KaTeX_Caligraphic-Regular.woff",
    "KaTeX_Main-Regular.ttf", "KaTeX_Math-Italic.ttf", "KaTeX_Caligraphic-Regular.ttf"
]

# --- Files to download directly from the web ---
files_to_download = [
    {
        'name': 'katex.min.css',
        'url': f"{KATEX_BASE_URL}katex.min.css", # CORRECTED: Use forward slashes for URL
        'dest': os.path.join(css_dir, 'katex.min.css')
    },
    {
        'name': 'prism-tomorrow.min.css',
        'url': 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css',
        'dest': os.path.join(css_dir, 'prism-tomorrow.min.css')
    },
    {
        'name': 'd3.min.js',
        'url': 'https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js',
        'dest': os.path.join(js_dir, 'd3.min.js')
    }
]

# Add all the KaTeX font files to the download list
for font_filename in katex_fonts:
    files_to_download.append({
        'name': font_filename,
        'url': f"{KATEX_BASE_URL}fonts/{font_filename}", # CORRECTED: Use forward slashes for URL
        'dest': os.path.join(fonts_dir, font_filename)
    })


# --- Files to extract from Python packages ---
files_to_extract_from_packages = [
    {
        'package_name': 'mpld3',
        'file_to_find': 'mpld3.min.js',
        'dest_path': os.path.join(js_dir, 'mpld3.min.js')
    }
]

# --- Helper Functions (No changes needed below this line) ---
def ensure_dir_exists(dir_path):
    if not os.path.exists(dir_path):
        print(f"Creating directory: {dir_path}")
        os.makedirs(dir_path, exist_ok=True)

def download_file(url, destination_path):
    print(f"Attempting to download {os.path.basename(destination_path)} from {url}...")
    try:
        response = requests.get(url, stream=True, timeout=30)
        response.raise_for_status()
        with open(destination_path, 'wb') as f:
            for chunk in response.iter_content(chunk_size=8192):
                f.write(chunk)
        print(f"Successfully downloaded: {os.path.basename(destination_path)}")
        return True
    except requests.exceptions.RequestException as e:
        print(f"Error downloading {url}: {e}", file=sys.stderr)
        return False

def extract_from_package(package_name, file_to_find, dest_path):
    print(f"Attempting to extract {os.path.basename(dest_path)} from '{package_name}' package...")
    with tempfile.TemporaryDirectory() as tmpdir:
        try:
            print(f"  - Downloading '{package_name}' package...")
            subprocess.run(
                [sys.executable, '-m', 'pip', 'download', '--no-deps', package_name, '-d', tmpdir],
                check=True, capture_output=True, text=True
            )

            wheel_files = glob.glob(os.path.join(tmpdir, '*.whl'))
            if not wheel_files:
                print(f"Error: Could not find wheel file for '{package_name}' in {tmpdir}", file=sys.stderr)
                return False
            wheel_file_path = wheel_files[0]
            print(f"  - Found package file: {os.path.basename(wheel_file_path)}")

            source_path_in_archive = None
            base_name, extension = os.path.splitext(file_to_find)
            base_name, min_ext = os.path.splitext(base_name)

            with zipfile.ZipFile(wheel_file_path, 'r') as wheel_zip:
                file_list = wheel_zip.namelist()
                for member in file_list:
                    if member.startswith(f'{package_name}/js/{base_name}.v') and member.endswith(f'{min_ext}{extension}'):
                        source_path_in_archive = member
                        break
                
                if not source_path_in_archive:
                    print(f"Error: Could not find a version of '{file_to_find}' inside the package archive.", file=sys.stderr)
                    return False
                
                print(f"  - Found asset at dynamic path: '{source_path_in_archive}'")

                with wheel_zip.open(source_path_in_archive) as source_file:
                    with open(dest_path, 'wb') as dest_file:
                        shutil.copyfileobj(source_file, dest_file)
                
                print(f"  - Successfully extracted file to {dest_path}")
            
            return True
        except subprocess.CalledProcessError as e:
            print(f"Error: Failed to download '{package_name}' with pip.", file=sys.stderr)
            print(f"PIP Stderr: {e.stderr}", file=sys.stderr)
            return False
        except Exception as e:
            print(f"An unexpected error occurred during extraction: {e}", file=sys.stderr)
            return False

def main():
    print("Starting asset fetching process...")
    total_success = 0
    total_failure = 0

    print("Ensuring necessary directories exist...")
    ensure_dir_exists(static_dir)
    ensure_dir_exists(assets_dir)
    ensure_dir_exists(css_dir)
    ensure_dir_exists(fonts_dir)
    ensure_dir_exists(js_dir)
    print("Directory check complete.")

    print("\nDownloading assets from the web...")
    for file_info in files_to_download:
        if download_file(file_info['url'], file_info['dest']):
            total_success += 1
        else:
            total_failure += 1

    print("\nExtracting assets from Python packages...")
    for file_info in files_to_extract_from_packages:
        if extract_from_package(file_info['package_name'], file_info['file_to_find'], file_info['dest_path']):
            total_success += 1
        else:
            total_failure += 1

    print(f"\nAsset fetching summary: {total_success} succeeded, {total_failure} failed.")

    if total_failure > 0:
        print("\nOne or more asset operations failed. Please check the errors above.", file=sys.stderr)
        sys.exit(1)
    else:
        print("\nAsset fetching process completed successfully.")

if __name__ == "__main__":
    main()


=== generate_secret_key.py ===
import secrets
key = secrets.token_urlsafe(32)  # Generates a 32-byte random string, URL-safe
print(key)

=== package.json ===
{
  "name": "tesseracs-chat",
  "version": "1.0.0",
  "description": "Readme",
  "main": "temp.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "build": "node build.js",
    "watch:css": "tailwindcss -i ./app/static/input.css -o ./app/static/dist/input.css --watch",
    "watch:js": "esbuild app/static/script.js --bundle --outfile=app/static/dist/script.js --watch",
    "dev": "concurrently \"npm:watch:*\""
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/svenviktorjonsson/tesseracs-chat.git"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "commonjs",
  "bugs": {
    "url": "https://github.com/svenviktorjonsson/tesseracs-chat/issues"
  },
  "homepage": "https://github.com/svenviktorjonsson/tesseracs-chat#readme",
  "devDependencies": {
    "autoprefixer": "^10.4.21",
    "concurrently": "^9.2.0",
    "esbuild": "^0.25.4",
    "esbuild-style-plugin": "^1.6.3",
    "postcss": "^8.5.3",
    "tailwindcss": "^3.4.17"
  },
  "dependencies": {
    "katex": "^0.16.22",
    "marked": "^15.0.11",
    "prismjs": "^1.29.0"
  }
}


=== postcss.config.js ===
// postcss.config.js
module.exports = {
  plugins: {
    'tailwindcss': {}, // Use 'tailwindcss' for v3
    'autoprefixer': {},
  },
}

=== project_content.txt ===
=== Project Directory Structure ===
Root: C:\Users\viktor.jonsson\OneDrive - CellMax Technologies AB\Documents\Repositories\svenviktorjonsson\tesseracs-chat
Relevant files and folders (excluding specified patterns):

.
├── Readme.md
├── fetch_assets.py
├── generate_secret_key.py
├── package.json
├── postcss.config.js
├── project_content.txt
├── pyproject.toml
├── tailwind.config.js
├── update_schema.py
├── write_project_content_to_file.py
├── app/
│   ├── __init__.py
│   ├── auth.py
│   ├── config.py
│   ├── database.py
│   ├── docker_utils.py
│   ├── email_utils.py
│   ├── encryption_utils.py
│   ├── llm.py
│   ├── main.py
│   ├── models.py
│   ├── state.py
│   ├── utils.py
│   ├── static/
│   │   ├── _sidebar.html
│   │   ├── chat-session.html
│   │   ├── input.css
│   │   ├── languages.json
│   │   ├── login.html
│   │   ├── script.js
│   │   ├── session-choice.html
│   │   ├── settings.html
│   │   ├── email_templates/
│   │   │   ├── password_reset_email.html
│   │   │   ├── registration_email.html
│   │   ├── js/
│   │   │   ├── app-ui.js
│   │   │   ├── d3.min.js
│   │   │   ├── mpld3.min.js
│   │   │   ├── session-manager.js
│   │   │   ├── settings.js
│   │   │   ├── sidebar-toggle.js
│   │   │   ├── temp.js
├── dockerfiles/
│   ├── python/
├── tests/
│   ├── test_coding.py


=== File Contents ===

=== Readme.md ===
Readme


=== fetch_assets.py ===


=== pyproject.toml ===
# pyproject.toml

# Standard project metadata (PEP 621)
[project]
name = "tesseracs-chat"
version = "1.0.1"
description = "Web chat interface for Ollama using FastAPI and LangChain"
readme = "README.md"
authors = [
    {name = "Viktor Jonsson", email = "viktor.jonsson@tesseracs.com"},
]

# Poetry-specific tool configuration
[tool.poetry]
packages = [
    { include = "app" },
]

# Project Dependencies
[tool.poetry.dependencies]
python = "^3.9"
fastapi = "^0.110.0"
uvicorn = {extras = ["standard"], version = "^0.29.0"}
langchain = "^0.2.0"
langchain-core = "^0.2.0"
langchain-community = "^0.2.0"
langchain-ollama = "^0.1.0"
langchain-openai = "^0.1.0"
langchain-anthropic = "^0.1.0"
langchain-google-genai = "^1.0.0" 
websockets = "^12.0"
python-dotenv = "^1.0.1"
aiofiles = "^23.2.1"
docker = "^7.1.0"
requests = "^2.32.3"
python-multipart = "^0.0.20"
fastapi-mail = "^1.4.2"
certifi = "^2024.7.4" # Corrected from "^2025.4.26", which is not a valid version.
pydantic = "^2.11.4"
cryptography = ">=43.0,<44.0"
passlib = {extras = ["bcrypt"], version = "^1.7.4"}
bcrypt = "==4.0.1"
fastapi-csrf-protect = "^1.0.3"

# Build System Definition

[tool.poetry.group.dev.dependencies]
pytest = "^8.4.1"
pytest-asyncio = "^1.1.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"

=== tailwind.config.js ===
/** @type {import('tailwindcss').Config} */
module.exports = {
    safelist: [
        'js-sticky',
    ],
    content: [
      "./app/static/**/*.html", // Scan HTML files in static
      "./app/static/**/*.js",   // Scan JS files in static
    ],
    theme: {
      extend: {},
    },
    plugins: [],
  }

=== update_schema.py ===
import sqlite3
from pathlib import Path
import sys
import os

# Ensure the app directory is in the Python path to import config
# This allows the script to be run from the project root
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), 'app')))

def update_database_schema():
    """
    Applies necessary schema updates to the SQLite database.
    This script is idempotent and can be run multiple times safely.
    """
    try:
        from app import config
        DATABASE_PATH = config.DATABASE_PATH
    except (ImportError, AttributeError):
        print("Could not import config. Assuming default database path.")
        PROJECT_ROOT = Path(__file__).resolve().parent
        DATABASE_PATH = PROJECT_ROOT / "tesseracs_chat.db"

    print(f"Connecting to database at: {DATABASE_PATH}")
    if not DATABASE_PATH.exists():
        print(f"Error: Database file not found at {DATABASE_PATH}. Please run the main application first to create it.")
        return

    conn = None
    try:
        conn = sqlite3.connect(DATABASE_PATH)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        print("\n--- Starting Schema Update ---")

        # Helper to check for existing columns
        def get_existing_columns(table_name):
            try:
                cursor.execute(f"PRAGMA table_info({table_name})")
                return [row['name'] for row in cursor.fetchall()]
            except sqlite3.OperationalError:
                return [] # Table might not exist yet, e.g., during creation

        # 1. Update 'users' table: Add 'is_bot' column
        print("\nChecking 'users' table...")
        user_columns = get_existing_columns('users')
        if 'is_bot' not in user_columns:
            print("-> Adding 'is_bot' column to 'users' table.")
            cursor.execute("ALTER TABLE users ADD COLUMN is_bot BOOLEAN DEFAULT FALSE NOT NULL")
            print("-> 'is_bot' column added successfully.")
        else:
            print("-> 'is_bot' column already exists. Skipping.")

        # 2. Update 'sessions' table: Replace 'is_public' with 'access_level' and add 'passcode_hash'
        print("\nChecking 'sessions' table...")
        session_columns = get_existing_columns('sessions')
        if 'access_level' not in session_columns:
            print("-> Migrating 'sessions' table to new schema (adding access_level, passcode_hash)...")
            cursor.execute("ALTER TABLE sessions RENAME TO sessions_old")
            print("   - Renamed existing table to 'sessions_old'.")

            cursor.execute("""
            CREATE TABLE sessions (
                id TEXT PRIMARY KEY,
                host_user_id INTEGER NOT NULL,
                name TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_accessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                is_active BOOLEAN DEFAULT TRUE NOT NULL,
                access_level TEXT NOT NULL DEFAULT 'private',
                passcode_hash TEXT,
                FOREIGN KEY (host_user_id) REFERENCES users (id) ON DELETE CASCADE
            );
            """)
            print("   - Created new 'sessions' table with updated schema.")

            # Check if the old table had an 'is_public' column to migrate from
            old_session_columns = get_existing_columns('sessions_old')
            if 'is_public' in old_session_columns:
                print("   - 'is_public' column found in old table. Migrating values to 'access_level'.")
                cursor.execute("""
                INSERT INTO sessions (id, host_user_id, name, created_at, last_accessed_at, is_active, access_level)
                SELECT id, host_user_id, name, created_at, last_accessed_at, is_active,
                       CASE WHEN is_public = 1 THEN 'public' ELSE 'private' END
                FROM sessions_old;
                """)
            else:
                print("   - 'is_public' column not found. Copying data and defaulting 'access_level' to 'private'.")
                cursor.execute("""
                INSERT INTO sessions (id, host_user_id, name, created_at, last_accessed_at, is_active)
                SELECT id, host_user_id, name, created_at, last_accessed_at, is_active
                FROM sessions_old;
                """)
            
            print("   - Copied data from 'sessions_old' to new 'sessions' table.")

            cursor.execute("DROP TABLE sessions_old")
            print("   - Dropped 'sessions_old' table.")
            print("-> 'sessions' table migrated successfully.")
        else:
            print("-> 'sessions' table already has the new schema. Skipping.")

        # 3. Create 'session_bots' table if it doesn't exist
        print("\nChecking 'session_bots' table...")
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS session_bots (
            session_id TEXT NOT NULL,
            bot_user_id INTEGER NOT NULL,
            added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (session_id, bot_user_id),
            FOREIGN KEY (session_id) REFERENCES sessions (id) ON DELETE CASCADE,
            FOREIGN KEY (bot_user_id) REFERENCES users (id) ON DELETE CASCADE
        );
        """)
        print("-> Ensured 'session_bots' table exists.")

        conn.commit()
        print("\n--- Schema Update Complete ---")

    except sqlite3.Error as e:
        print(f"\nAn error occurred: {e}")
        if conn:
            conn.rollback()
    finally:
        if conn:
            conn.close()
            print("Database connection closed.")

if __name__ == "__main__":
    update_database_schema()



=== write_project_content_to_file.py ===
import os
import sys

# --- Configuration ---

# Set the starting directory (e.g., "." for current directory)
root = "."


import os

# --- Configuration ---

# !!! CHANGE THIS VARIABLE TO THE DESIRED STARTING DIRECTORY !!!
# Example: root = "/path/to/your/project" or root = "src"
root = fr"./"

# Extensions to include
extensions = ('.py', '.html', '.css', '.js', '.json', '.md', '.txt', '.yaml', '.yml', '.toml')

# Directories to completely exclude (will not be walked)
exclude_dirs = (
    '.git',
    '__pycache__',
    '.pytest_cache',
    'node_modules',
    'build',
    'old2',
    'testing-bundles', # Exclude this directory name wherever it appears
    '.venv',           # Common virtual environment folder
    'venv',
    'env',
    '.env',
    'dist',
    "assets"
)

# Files to list in the tree but exclude their *content*
exclude_exact_filenames = (
    'package-lock.json',
    'yarn.lock',
    'katex.min.css',
    'katex.min.js',
    'build.js',
    # Add other large or irrelevant files by name here
)

# Files to exclude from the tree and content if their name contains any of these strings
exclude_filename_patterns = ('lock',)

# Specific files to list in the tree but exclude their *content* from the output
exclude_files = (
    'session.json',
    'cm_logo.ico',
)

# Output file name
output_filename = "project_content.txt"

# --- Script Logic ---

# Normalize the root path and make it absolute for reliable comparisons
root = os.path.abspath(root)

print(f"Starting directory: {root}")
print(f"Output file: {output_filename}")

# The instructions to be added at the end of the file
llm_instructions = """
=== LLM Instructions ===
Now please just read the project and the rules for writing code and just wait for instructions.

Here are the rules:
1. DONT write comments, placeholders or docstrings if not explicitely told.
2. Write functions with the correct initial indentation so that if the function is indented so is your code that you write.
3. DO NOT USE NON-TERMINATED SPACES. MAKE SURE TO FOLLOW THIS! ITS SUPER IMPORTANT AND YOU SEEM TO BREAK IT, PLEASE!!!
4. For changes that require multiple replacements please tell me what to replace with what instead of rewriting large portions of text. You can use vscode valid regexp for instance.
5. For small functions less than 100 lines of code please rewrite the full function. For larger functions please only write complete control statements if/while/case.
6. Never omit/change working logic if not explicitely statet that it should be removed/change
7. DONT use the CANVAS TOOL where code is written in artifacts.
8. Write only functions that are new seperately from functions that needs updates.
9. Make sure to write what has been change where to place/what to replace for each code snippet.
"""


try:
    # Using "w" mode ensures the file is overwritten if it exists
    with open(output_filename, "w", encoding="utf-8") as outfile:
        # === Add Directory Structure ===
        outfile.write("=== Project Directory Structure ===\n")
        outfile.write(f"Root: {root}\n")
        outfile.write("Relevant files and folders (excluding specified patterns):\n\n")

        start_level = root.count(os.sep)
        for current_root, dirs, files in os.walk(root, topdown=True):
            dirs[:] = [d for d in dirs if d not in exclude_dirs and not d.startswith('.')]
            rel_path_from_start = os.path.relpath(current_root, root)
            level = current_root.count(os.sep) - start_level

            if rel_path_from_start != '.':
                path_components = os.path.normpath(rel_path_from_start).split(os.sep)
                if any(comp in exclude_dirs or comp.startswith('.') for comp in path_components):
                    continue

                indent = '│   ' * (level - 1) + '├── ' if level > 0 else ''
                outfile.write(f"{indent}{os.path.basename(current_root)}/\n")
            else:
                outfile.write(".\n")

            file_indent = '│   ' * level + '├── '
            files.sort()
            for file in files:
                # Apply all file exclusion rules
                if (file.endswith(extensions) and
                    not file.startswith('.') and
                    file not in exclude_exact_filenames and
                    not any(p in file for p in exclude_filename_patterns)):
                        outfile.write(f"{file_indent}{file}\n")

        outfile.write("\n\n=== File Contents ===\n\n")

        # === Add File Contents ===
        for current_root, dirs, files in os.walk(root, topdown=True):
            dirs[:] = [d for d in dirs if d not in exclude_dirs and not d.startswith('.')]
            rel_path_from_start = os.path.relpath(current_root, root)
            if rel_path_from_start != '.':
                path_components = os.path.normpath(rel_path_from_start).split(os.sep)
                if any(comp in exclude_dirs or comp.startswith('.') for comp in path_components):
                    continue

            files.sort()
            for file in files:
                # Apply all file exclusion rules again for content processing
                if (file.endswith(extensions) and
                    not file.startswith('.') and
                    file not in exclude_exact_filenames and
                    not any(p in file for p in exclude_filename_patterns)):
                        file_path = os.path.join(current_root, file)
                        relative_path = os.path.relpath(file_path, root)
                        display_path = relative_path.replace(os.sep, '/')
                        outfile.write(f"=== {display_path} ===\n")

                        if file in exclude_files:
                            outfile.write("--- CONTENT EXCLUDED (listed in exclude_files) ---\n")
                        else:
                            try:
                                try:
                                    with open(file_path, "r", encoding="utf-8") as infile:
                                        outfile.write(infile.read())
                                except UnicodeDecodeError:
                                    try:
                                        with open(file_path, "r", encoding="latin-1") as infile:
                                            outfile.write(infile.read())
                                        outfile.write("\n--- (Warning: Read using latin-1 encoding) ---\n")
                                    except Exception as inner_e:
                                        outfile.write(f"--- Error reading file (fallback failed): {inner_e} ---\n")
                            except Exception as e:
                                outfile.write(f"--- Error reading file: {e} ---\n")
                        outfile.write("\n\n")

        # === Add LLM Instructions at the end of the file ===
        outfile.write(llm_instructions)

    print("Successfully generated project content file.")

except Exception as e:
    print(f"An error occurred: {e}")

=== app/__init__.py ===


=== app/auth.py ===
# app/auth.py
import os
import secrets
import sqlite3
import traceback # Added from earlier version
from datetime import datetime, timedelta, timezone
from typing import Optional, Dict, Any

from fastapi import Depends, HTTPException, status, Response, Request # Added Request
from fastapi.security import APIKeyCookie, OAuth2PasswordBearer # Added APIKeyCookie

from passlib.context import CryptContext

# Assuming your project structure allows these relative imports
from . import models # For type hinting if needed (e.g., User model for return types)
from . import config
# Import necessary functions from database.py
from .database import get_db_connection, generate_secure_token, hash_value as hash_session_token

# Password Hashing
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# --- Constants ---
SESSION_COOKIE_NAME = "tesseracs_session_token"
SESSION_DURATION_DAYS = 7 # From earlier version

# OAuth2 scheme for API endpoints (if you use Bearer tokens for some APIs)
# This is for FastAPI's dependency injection to get token from Authorization header
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/token") # tokenUrl points to your login endpoint

# Dependency for getting the session token from the cookie
cookie_scheme = APIKeyCookie(name=SESSION_COOKIE_NAME, auto_error=False)


# --- Password Utilities ---
def verify_password(plain_password: str, hashed_password: str) -> bool:
    """Verifies a plain password against a stored hash using passlib."""
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password: str) -> str:
    """Hashes a plain password using passlib (for user passwords)."""
    return pwd_context.hash(password)

# --- User Authentication (Database Interaction for login) ---
def authenticate_user_from_db(
    conn: sqlite3.Connection, email: str, password: str
) -> Optional[Dict[str, Any]]:
    """
    Authenticates a user by fetching from DB and verifying password.
    This is typically called by the /token login route.

    Args:
        conn: Active SQLite database connection (passed from the route).
        email: User's email.
        password: User's plain text password.

    Returns:
        A dictionary containing user details if successful, otherwise None.
    """
    if not conn:
        print("ERROR (auth.authenticate_user_from_db): Database connection is None.")
        return None
    
    try:
        cursor = conn.cursor()
        # Ensure email is normalized (e.g., lowercased) for lookup
        normalized_email = email.lower().strip()
        cursor.execute(
            "SELECT id, name, email, password_hash, is_active FROM users WHERE email = ?",
            (normalized_email,)
        )
        user_row = cursor.fetchone()

        if not user_row:
            print(f"DEBUG (auth.authenticate_user_from_db): User not found for email: {normalized_email}")
            return None 

        user_data = dict(user_row)
        stored_password_hash = user_data.get("password_hash")

        if not stored_password_hash or not verify_password(password, stored_password_hash):
            print(f"DEBUG (auth.authenticate_user_from_db): Password verification failed for email: {normalized_email}")
            return None

        # Return relevant user details, excluding the password hash
        return {
            "id": user_data["id"],
            "name": user_data["name"],
            "email": user_data["email"],
            "is_active": user_data["is_active"],
        }
    except sqlite3.Error as e:
        print(f"ERROR (auth.authenticate_user_from_db): Database error - {e}")
        traceback.print_exc()
        return None
    except Exception as e: # Catch any other unexpected errors
        print(f"ERROR (auth.authenticate_user_from_db): Unexpected error - {e}")
        traceback.print_exc()
        return None


# --- Session Token Management (Database-backed sessions) ---
async def create_user_session(response: Response, user_id: int) -> str:
    """
    Creates a new session token, stores its HASH in the database,
    and sets the RAW token as an HttpOnly cookie in the response.
    Uses `hash_session_token` (from database.py) for session tokens.
    """
    session_token_raw = generate_secure_token(32) # Generate a new raw token
    # Use the specific hash function for session tokens (e.g., SHA256 from database.py)
    session_token_hashed = hash_session_token(session_token_raw) 
    
    expires_delta = timedelta(days=SESSION_DURATION_DAYS)
    expires_at = datetime.now(timezone.utc) + expires_delta
    
    conn = None
    try:
        conn = get_db_connection() # Get a new connection
        cursor = conn.cursor()
        cursor.execute(
            """INSERT INTO auth_tokens (user_id, token_hash, token_type, created_at, expires_at)
               VALUES (?, ?, ?, datetime('now', 'utc'), ?)""",
            (user_id, session_token_hashed, 'session', expires_at.isoformat())
        )
        conn.commit()
        
        response.set_cookie(
            key=SESSION_COOKIE_NAME,
            value=session_token_raw, # Set the RAW token in the cookie
            httponly=True,
            max_age=int(expires_delta.total_seconds()),
            expires=expires_at,
            samesite="Lax",
            secure=config.BASE_URL.startswith("https://"), # Secure cookie if served over HTTPS
            path="/"
        )
        print(f"AUTH: Session cookie '{SESSION_COOKIE_NAME}' set for user_id {user_id}. Expires: {expires_at.isoformat()}")
        return session_token_raw # Return the raw token (e.g., for /token response model)
        
    except sqlite3.Error as e:
        print(f"ERROR (auth.create_user_session): Database error - {e}")
        traceback.print_exc()
        if conn: conn.rollback()
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Could not create user session due to a database issue.")
    except Exception as e:
        print(f"ERROR (auth.create_user_session): Unexpected error - {e}")
        traceback.print_exc()
        if conn: conn.rollback()
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Could not create user session due to an unexpected server error.")
    finally:
        if conn:
            conn.close()

async def get_user_by_session_token_internal(token_raw: Optional[str]) -> Optional[Dict[str, Any]]:
    """
    Internal helper: Retrieves user details based on a RAW session token.
    Hashes the raw token and verifies it against hashed tokens in the database.
    Uses `hash_session_token` (from database.py).
    """
    if not token_raw:
        return None
    
    session_token_hashed = hash_session_token(token_raw) # Hash the raw token for DB lookup
    conn = None
    try:
        conn = get_db_connection() # Get a new connection
        cursor = conn.cursor()
        now_utc_iso = datetime.now(timezone.utc).isoformat()
        
        cursor.execute(
            """SELECT u.id, u.name, u.email, u.is_active
               FROM users u JOIN auth_tokens at ON u.id = at.user_id
               WHERE at.token_hash = ? AND at.token_type = 'session' 
               AND at.expires_at > ? AND at.used_at IS NULL
            """, (session_token_hashed, now_utc_iso)
        )
        user_row = cursor.fetchone()

        if user_row:
            user_data = dict(user_row)
            return {
                "id": user_data["id"],
                "name": user_data["name"],
                "email": user_data["email"],
                "is_active": user_data["is_active"]
            }
        return None
        
    except sqlite3.Error as e:
        print(f"ERROR (auth.get_user_by_session_token_internal): Database error - {e}")
        traceback.print_exc()
        return None
    except Exception as e:
        print(f"ERROR (auth.get_user_by_session_token_internal): Unexpected error - {e}")
        traceback.print_exc()
        return None
    finally:
        if conn:
            conn.close()

# This `get_current_user` is for cookie-based authentication (Optional user)
async def get_current_user(
    session_token_raw: Optional[str] = Depends(cookie_scheme)
) -> Optional[Dict[str, Any]]:
    """
    FastAPI Dependency: Retrieves the current authenticated user based on the
    session token from the cookie. Returns user dict or None if not authenticated/active.
    Does not raise HTTPException, allowing routes to handle optional authentication.
    """
    if not session_token_raw:
        return None
    
    user = await get_user_by_session_token_internal(session_token_raw)
    if user and user.get("is_active"):
        return user
    return None


# This `get_current_active_user` is for cookie-based authentication (Required active user)
async def get_current_active_user(
    session_token_raw: Optional[str] = Depends(cookie_scheme)
) -> Dict[str, Any]:
    """
    FastAPI Dependency: Retrieves the current authenticated AND active user.
    Raises HTTPException if not authenticated or user is inactive.
    This is typically used for routes that require a logged-in, active user.
    """
    if not session_token_raw:
        # This case might be hit if cookie_scheme's auto_error=False and cookie is missing
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Not authenticated (no session cookie)",
            headers={"WWW-Authenticate": "Session"}, 
        )
    
    user = await get_user_by_session_token_internal(session_token_raw)
    
    if not user:
        # Consider how to handle invalid cookie (e.g., if main.py should clear it on redirect)
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid or expired session token",
            headers={"WWW-Authenticate": "Session"},
        )
    if not user.get("is_active"):
        raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="User account is inactive")
    
    return user


# This `get_current_user_bearer` is a placeholder for API Bearer token authentication
# It uses oauth2_scheme, which looks for "Authorization: Bearer <token>" header.
async def get_current_user_bearer(token: str = Depends(oauth2_scheme)) -> Optional[Dict[str, Any]]:
    """
    Dependency to get the current user from a Bearer token (for API calls).
    This is an example if you were using JWTs or other Bearer tokens.
    It's kept separate from cookie-based session authentication.
    """
    if not token:
        return None
    # In a real scenario, you would:
    # 1. Decode the JWT token (if it's a JWT).
    # 2. Validate its signature, issuer, audience, expiry.
    # 3. Extract user identifier (e.g., user_id or sub) from token claims.
    # 4. Fetch user from database based on that identifier.
    # For now, this is a placeholder and returns None.
    print(f"DEBUG (auth.get_current_user_bearer): Received Bearer token: {token[:15]}...")
    # Example: user_id = my_jwt_decode_function(token).get("sub")
    # user = await fetch_user_from_db_by_id(user_id)
    # return user
    return None # Replace with actual Bearer token validation and user lookup


async def logout_user(response: Response, session_token_raw: Optional[str]):
    """
    Logs out the user by invalidating their session token in the database
    (if provided) and clearing the session cookie from the browser.
    Uses `hash_session_token` for session tokens.
    """
    if session_token_raw:
        session_token_hashed = hash_session_token(session_token_raw)
        conn = None
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            now_utc_iso = datetime.now(timezone.utc).isoformat()
            # Mark the specific token as used by setting used_at and making it expire immediately
            cursor.execute(
                """UPDATE auth_tokens 
                   SET used_at = ?, expires_at = ?
                   WHERE token_hash = ? AND token_type = 'session'""",
                (now_utc_iso, now_utc_iso, session_token_hashed)
            )
            conn.commit()
            print(f"AUTH: Session token (hash starting {session_token_hashed[:10]}...) marked as used/expired in DB for logout.")
        except sqlite3.Error as e:
            print(f"ERROR (auth.logout_user): Database error invalidating token - {e}")
            traceback.print_exc()
            if conn: conn.rollback()
            # Proceed with cookie deletion even if DB update fails
        except Exception as e:
            print(f"ERROR (auth.logout_user): Unexpected error invalidating token - {e}")
            traceback.print_exc()
            if conn: conn.rollback()
        finally:
            if conn:
                conn.close()

    # Always attempt to delete the cookie from the browser
    response.delete_cookie(
        SESSION_COOKIE_NAME,
        httponly=True,
        secure=config.BASE_URL.startswith("https://"), # Match secure attribute used when setting
        samesite="Lax", # Match samesite attribute
        path="/"
    )
    print(f"AUTH: Session cookie '{SESSION_COOKIE_NAME}' cleared from browser response.")


=== app/config.py ===
import os
import sys
from pathlib import Path
from dotenv import load_dotenv
from typing import Optional, List, Dict, Any
import json

# Load environment variables from a .env file if it exists
load_dotenv()

# --- Application Base URL ---
BASE_URL = os.getenv("BASE_URL", "http://localhost:8001")

CSRF_PROTECT_SECRET_KEY = os.getenv("CSRF_PROTECT_SECRET_KEY")

DEBUG_MODE = os.getenv("DEBUG_MODE", "False").lower() in ('true', '1', 't', 'yes')
DATABASE_PATH = Path(os.getenv("DATABASE_PATH","./tesseracs_chat.db"))

# --- Secret Key for Encryption ---
APP_SECRET_KEY = os.getenv("APP_SECRET_KEY")
if not APP_SECRET_KEY:
    print("CRITICAL WARNING: APP_SECRET_KEY is not set in the environment. "
          "User-specific API keys will not be securely stored. This is a major security risk. "
          "Please set this environment variable to a strong, random string. "
          "For development, the application will proceed, but encryption will be disabled if this key is missing.")
elif len(APP_SECRET_KEY) < 32:
    print(f"WARNING: APP_SECRET_KEY is set but may not be strong enough (length: {len(APP_SECRET_KEY)}). "
          "Ensure it's a Fernet-compatible key (32 url-safe base64-encoded bytes).")


# --- LLM Configuration ---
LLM_PROVIDERS: Dict[str, Dict[str, Any]] = {
    "google_gemini": {
        "display_name": "Google Gemini",
        "type": "google_genai",
        "base_url_env_var": None, # Google SDK handles the endpoint
        "api_key_env_var": "GOOGLE_API_KEY",
        "available_models": [
            {
                "model_id": "gemini-2.5-pro",
                "display_name": "Gemini 2.5 Pro", 
                "context_window": 1048576 
            },
            {
                "model_id": "gemini-2.5-flash",
                "display_name": "Gemini 2.5 Flash", 
                "context_window": 1048576 
            }
        ],
    },
    "anthropic_claude": {
        "display_name": "Anthropic Claude",
        "type": "anthropic",
        "base_url_env_var": None, # Anthropic SDK handles the endpoint
        "api_key_env_var": "ANTHROPIC_API_KEY",
        "available_models": [
            {
                "model_id": "claude-sonnet-4-20250514",
                "display_name": "Claude 4.0 Sonnet", 
                "context_window": 200000 
            }
        ],
    },
    "openai_compatible_server": {
        "display_name": "OpenAI-Compatible API",
        "type": "openai_compatible",
        "base_url_env_var": "OPENAI_COMPATIBLE_BASE_URL",
        "api_key_env_var": "OPENAI_COMPATIBLE_API_KEY",
        "available_models": [
            {
                "model_id": "gpt-4o-2024-08-06", 
                "display_name": "GPT 4o",
                "context_window": 128000
            }
        ],
    },
}

# --- Provider Characteristics ---
PROVIDERS_TYPICALLY_USING_API_KEYS = {
    "google_gemini",
    "anthropic_claude",
    "openai_compatible_server"
}

PROVIDERS_ALLOWING_USER_KEYS_EVEN_IF_SYSTEM_CONFIGURED = {
    "google_gemini",
    "anthropic_claude",
    "openai_compatible_server"
}


# --- Helper function to get a provider's configuration ---
def get_provider_config(provider_id: str) -> Optional[Dict[str, Any]]:
    provider_info_template = LLM_PROVIDERS.get(provider_id)
    if not provider_info_template:
        return None

    runtime_config = provider_info_template.copy()

    base_url_env_name = provider_info_template.get("base_url_env_var")
    resolved_base_url = None
    if base_url_env_name:
        resolved_base_url = os.getenv(base_url_env_name)
    
    runtime_config["base_url"] = resolved_base_url if resolved_base_url else provider_info_template.get("base_url")

    runtime_config["api_key_env_var_name"] = provider_info_template.get("api_key_env_var")

    if "available_models" not in runtime_config or not isinstance(runtime_config["available_models"], list):
        runtime_config["available_models"] = []
    return runtime_config


# --- Static Files Configuration ---
APP_DIR = Path(__file__).resolve().parent 
PROJECT_ROOT = APP_DIR.parent
STATIC_DIR_IN_APP = APP_DIR / "static"
STATIC_DIR_AT_ROOT_LEVEL = PROJECT_ROOT / "static"
STATIC_DIR: Optional[Path] = None 

if STATIC_DIR_IN_APP.is_dir():
    STATIC_DIR = STATIC_DIR_IN_APP
elif STATIC_DIR_AT_ROOT_LEVEL.is_dir() and (PROJECT_ROOT / "pyproject.toml").exists(): 
    STATIC_DIR = STATIC_DIR_AT_ROOT_LEVEL
else:
    current_working_dir = Path.cwd()
    if (current_working_dir / "app" / "static").is_dir(): 
        STATIC_DIR = current_working_dir / "app" / "static"
    elif (current_working_dir / "static").is_dir(): 
        STATIC_DIR = current_working_dir / "static"
    
    if not STATIC_DIR or not STATIC_DIR.is_dir(): 
        print(f"CRITICAL ERROR: Static directory not found. Checked standard locations relative to {APP_DIR}, {PROJECT_ROOT}, and {current_working_dir}. Application may not serve frontend assets.")

# --- Docker Configuration ---
LANGUAGES_CONFIG_PATH = APP_DIR / "static" / "languages.json"
try:
    with open(LANGUAGES_CONFIG_PATH, "r", encoding="utf-8") as f:
        SUPPORTED_LANGUAGES = json.load(f)
    print(f"DEBUG config: Successfully loaded {len(SUPPORTED_LANGUAGES)} languages from {LANGUAGES_CONFIG_PATH}")
except Exception as e:
    print(f"CRITICAL ERROR: Could not load or parse languages.json: {e}")
    SUPPORTED_LANGUAGES = {}

DOCKER_TIMEOUT_SECONDS = int(os.getenv("DOCKER_TIMEOUT_SECONDS", 30))
DOCKER_MEM_LIMIT = os.getenv("DOCKER_MEM_LIMIT", "128m")


# --- Email Configuration ---
MAIL_CONFIG = {
    "MAIL_USERNAME": os.getenv("MAIL_USERNAME"),
    "MAIL_PASSWORD": os.getenv("MAIL_PASSWORD"),
    "MAIL_FROM": os.getenv("MAIL_FROM"),
    "MAIL_PORT": int(os.getenv("MAIL_PORT", 465)),
    "MAIL_SERVER": os.getenv("MAIL_SERVER"),
    "MAIL_FROM_NAME": os.getenv("MAIL_FROM_NAME", "Tesseracs Chat"),
    "MAIL_STARTTLS": os.getenv("MAIL_STARTTLS", 'False').lower() in ('true', '1', 't', 'yes'),
    "MAIL_SSL_TLS": os.getenv("MAIL_SSL_TLS", 'True').lower() in ('true', '1', 't', 'yes'),
    "USE_CREDENTIALS": True,
    "VALIDATE_CERTS": os.getenv("MAIL_VALIDATE_CERTS", 'True').lower() in ('true', '1', 't', 'yes')
}

if not all([MAIL_CONFIG["MAIL_USERNAME"], MAIL_CONFIG["MAIL_PASSWORD"], MAIL_CONFIG["MAIL_SERVER"], MAIL_CONFIG["MAIL_FROM"]]):
    print("WARNING: Essential email configuration (USERNAME, PASSWORD, SERVER, FROM) missing in .env file. Email functionalities will likely fail.")

# --- Rate Limiting Configuration ---
FORGOT_PASSWORD_ATTEMPT_LIMIT = int(os.getenv("FORGOT_PASSWORD_ATTEMPT_LIMIT", 3))
FORGOT_PASSWORD_ATTEMPT_WINDOW_HOURS = int(os.getenv("FORGOT_PASSWORD_ATTEMPT_WINDOW_HOURS", 24))

# --- Debug Logging for Configuration ---
print(f"DEBUG config: Application DEBUG_MODE: {DEBUG_MODE}")
print(f"DEBUG config: Application BASE_URL is set to: {BASE_URL}")
if STATIC_DIR:
    print(f"DEBUG config: Static files directory resolved to: {STATIC_DIR.resolve()}")
else:
     print("DEBUG config: Static files directory NOT RESOLVED.")
print(f"DEBUG config: Email VALIDATE_CERTS: {MAIL_CONFIG['VALIDATE_CERTS']}, SSL_TLS: {MAIL_CONFIG['MAIL_SSL_TLS']}, STARTTLS: {MAIL_CONFIG['MAIL_STARTTLS']}")

if not CSRF_PROTECT_SECRET_KEY:
     print("WARNING config: CSRF_PROTECT_SECRET_KEY is not set in environment. main.py will use a fallback (insecure for production).")
 
print("-" * 50)
print(f"DEBUG: APP_SECRET_KEY loaded in config.py: {APP_SECRET_KEY}")
print("-" * 50)


=== app/database.py ===
import sqlite3
import os
from pathlib import Path
import hashlib
import secrets
import datetime

APP_DIR = Path(__file__).parent
PROJECT_ROOT = APP_DIR.parent
DATABASE_NAME = "tesseracs_chat.db"
DATABASE_PATH = PROJECT_ROOT / DATABASE_NAME

def get_code_execution_results(session_id):
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute("""
            SELECT code_block_id, language, code_content, output_content, 
                   html_content, exit_code, error_message, execution_status, 
                   executed_at, turn_id
            FROM code_execution_results 
            WHERE session_id = ? 
            ORDER BY executed_at ASC
        """, (session_id,))
        results = []
        for row in cursor.fetchall():
            results.append({
                'code_block_id': row['code_block_id'],
                'language': row['language'],
                'code_content': row['code_content'],
                'output_content': row['output_content'],
                'html_content': row['html_content'],
                'exit_code': row['exit_code'],
                'error_message': row['error_message'],
                'execution_status': row['execution_status'],
                'executed_at': row['executed_at'],
                'turn_id': row['turn_id']
            })
        return results
    except Exception as e:
        print(f"Error retrieving code execution results for session {session_id}: {e}")
        return []
    finally:
        conn.close()

def get_edited_code_blocks(session_id: str) -> dict:
    conn = get_db_connection()
    cursor = conn.cursor()
    edited_blocks = {}
    try:
        cursor.execute(
            "SELECT code_block_id, edited_content FROM edited_code_blocks WHERE session_id = ?",
            (session_id,)
        )
        rows = cursor.fetchall()
        for row in rows:
            edited_blocks[row['code_block_id']] = row['edited_content']
        return edited_blocks
    except Exception as e:
        print(f"Error retrieving edited code blocks for session {session_id}: {e}")
        return {}
    finally:
        conn.close()

def delete_edited_code_block(session_id, code_block_id):
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute(
            "DELETE FROM edited_code_blocks WHERE session_id = ? AND code_block_id = ?",
            (session_id, code_block_id)
        )
        conn.commit()
        print(f"Successfully deleted edited content for {code_block_id} in session {session_id}")
        return True
    except Exception as e:
        conn.rollback()
        print(f"Error deleting edited code block for {code_block_id}: {e}")
        return False
    finally:
        conn.close()

def save_code_execution_result(session_id, code_block_id, language, code_content, 
                               output_content=None, html_content=None, exit_code=None, 
                               error_message=None, execution_status='completed', turn_id=None):
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute("DELETE FROM code_execution_results WHERE code_block_id = ?", (code_block_id,))
        cursor.execute("""
            INSERT INTO code_execution_results 
            (session_id, code_block_id, language, code_content, output_content, 
             html_content, exit_code, error_message, execution_status, turn_id, executed_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now', 'utc'))
        """, (session_id, code_block_id, language, code_content, output_content, 
              html_content, exit_code, error_message, execution_status, turn_id))
        conn.commit()
        return True
    except Exception as e:
        conn.rollback()
        print(f"Error saving code execution result for {code_block_id}: {e}")
        return False
    finally:
        conn.close()

def get_db_connection():
    conn = sqlite3.connect(DATABASE_PATH)
    conn.row_factory = sqlite3.Row
    conn.execute("PRAGMA foreign_keys = ON;")
    return conn

def init_db():
    print(f"Initializing database schema at {DATABASE_PATH}...")
    conn = get_db_connection()
    cursor = conn.cursor()

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        email TEXT UNIQUE NOT NULL,
        password_hash TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        is_active BOOLEAN DEFAULT TRUE NOT NULL,
        is_bot BOOLEAN DEFAULT FALSE NOT NULL,
        selected_llm_provider_id TEXT,
        selected_llm_model_id TEXT,
        user_llm_api_key_encrypted TEXT,
        selected_llm_base_url TEXT
    );
    """)
    print("Ensured 'users' table exists.")

    user_table_columns_to_add = {
        "is_bot": "BOOLEAN DEFAULT FALSE NOT NULL"
    }
    cursor.execute("PRAGMA table_info(users)")
    existing_user_columns = [col[1] for col in cursor.fetchall()]
    for col_name, col_definition in user_table_columns_to_add.items():
        if col_name not in existing_user_columns:
            try:
                cursor.execute(f"ALTER TABLE users ADD COLUMN {col_name} {col_definition}")
                print(f"Added '{col_name}' column to 'users' table.")
            except sqlite3.OperationalError as e:
                print(f"Could not add column '{col_name}' to 'users' table: {e}.")

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS sessions (
        id TEXT PRIMARY KEY,
        host_user_id INTEGER NOT NULL,
        name TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        last_accessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        is_active BOOLEAN DEFAULT TRUE NOT NULL,
        access_level TEXT NOT NULL DEFAULT 'private',
        passcode_hash TEXT,
        FOREIGN KEY (host_user_id) REFERENCES users (id) ON DELETE CASCADE
    );
    """)
    print("Ensured 'sessions' table exists.")

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS session_participants (
        session_id TEXT NOT NULL,
        user_id INTEGER NOT NULL,
        joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        is_hidden BOOLEAN DEFAULT FALSE NOT NULL,
        PRIMARY KEY (session_id, user_id),
        FOREIGN KEY (session_id) REFERENCES sessions (id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
    );
    """)
    print("Ensured 'session_participants' table exists.")

    cursor.execute("PRAGMA table_info(session_participants)")
    existing_participant_columns = [col[1] for col in cursor.fetchall()]
    if "is_hidden" not in existing_participant_columns:
        try:
            cursor.execute("ALTER TABLE session_participants ADD COLUMN is_hidden BOOLEAN DEFAULT FALSE NOT NULL")
            print("Added 'is_hidden' column to 'session_participants' table.")
        except sqlite3.OperationalError as e:
            print(f"Could not add 'is_hidden' column to 'session_participants': {e}.")

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS auth_tokens (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        token_hash TEXT UNIQUE NOT NULL,
        token_type TEXT NOT NULL CHECK(token_type IN ('magic_login', 'session', 'password_reset')),
        expires_at TIMESTAMP NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        used_at TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
    );
    """)
    print("Ensured 'auth_tokens' table exists.")

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS chat_messages (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        session_id TEXT NOT NULL,
        user_id INTEGER,
        sender_name TEXT,
        sender_type TEXT NOT NULL CHECK(sender_type IN ('user', 'ai', 'system', 'anon_user')),
        content TEXT NOT NULL,
        client_id_temp TEXT,
        turn_id INTEGER,
        thinking_content TEXT,
        timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        model_provider_id TEXT,
        model_id TEXT,
        reply_to_message_id INTEGER,
        FOREIGN KEY (session_id) REFERENCES sessions (id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE SET NULL,
        FOREIGN KEY (reply_to_message_id) REFERENCES chat_messages (id) ON DELETE SET NULL
    );
    """)
    print("Ensured 'chat_messages' table exists.")

    chat_messages_columns_to_add = {
        "reply_to_message_id": "INTEGER"
    }
    cursor.execute("PRAGMA table_info(chat_messages)")
    existing_chat_columns = [col[1] for col in cursor.fetchall()]
    for col_name, col_type in chat_messages_columns_to_add.items():
        if col_name not in existing_chat_columns:
            try:
                cursor.execute(f"ALTER TABLE chat_messages ADD COLUMN {col_name} {col_type}")
                print(f"Added '{col_name}' column to 'chat_messages' table.")
            except sqlite3.OperationalError as e:
                print(f"Could not add column '{col_name}' to 'chat_messages' table: {e}.")

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS session_bots (
        session_id TEXT NOT NULL,
        bot_user_id INTEGER NOT NULL,
        added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (session_id, bot_user_id),
        FOREIGN KEY (session_id) REFERENCES sessions (id) ON DELETE CASCADE,
        FOREIGN KEY (bot_user_id) REFERENCES users (id) ON DELETE CASCADE
    );
    """)
    print("Ensured 'session_bots' table exists.")

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS edited_code_blocks (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        session_id TEXT NOT NULL,
        code_block_id TEXT NOT NULL,
        language TEXT NOT NULL,
        edited_content TEXT NOT NULL,
        edited_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(session_id, code_block_id),
        FOREIGN KEY (session_id) REFERENCES sessions (id) ON DELETE CASCADE
    );
    """)
    print("Ensured 'edited_code_blocks' table exists.")

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS session_memory_state (
        session_id TEXT PRIMARY KEY,
        memory_state_json TEXT NOT NULL,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (session_id) REFERENCES sessions (id) ON DELETE CASCADE
    );
    """)
    print("Ensured 'session_memory_state' table exists.")

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS password_reset_attempts (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        email TEXT NOT NULL,
        ip_address TEXT,
        attempted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    """)
    print("Ensured 'password_reset_attempts' table exists.")

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS code_execution_results (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        session_id TEXT NOT NULL,
        code_block_id TEXT NOT NULL,
        language TEXT NOT NULL,
        code_content TEXT NOT NULL,
        output_content TEXT,
        html_content TEXT,
        exit_code INTEGER,
        error_message TEXT,
        execution_status TEXT NOT NULL DEFAULT 'completed' CHECK(execution_status IN ('completed', 'error', 'timeout')),
        executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        turn_id INTEGER,
        FOREIGN KEY (session_id) REFERENCES sessions (id) ON DELETE CASCADE
    );
    """)
    print("Ensured 'code_execution_results' table exists.")

    print("Ensuring database indexes exist...")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_users_email ON users (email);")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_auth_tokens_token_hash ON auth_tokens (token_hash);")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_auth_tokens_user_id ON auth_tokens (user_id);")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_sessions_host_user_id ON sessions (host_user_id);")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_session_participants_session_id ON session_participants (session_id);")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_session_participants_user_id ON session_participants (user_id);")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_chat_messages_session_id ON chat_messages (session_id);")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_chat_messages_timestamp ON chat_messages (timestamp);")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_session_memory_state_session_id ON session_memory_state (session_id);")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_password_reset_attempts_email_time ON password_reset_attempts (email, attempted_at);")
    print("Ensured all indexes exist.")

    conn.commit()
    conn.close()
    print("Database initialization process complete.")

def hash_value(value: str) -> str:
    return hashlib.sha256(value.encode('utf-8')).hexdigest()

def generate_secure_token(length: int = 32) -> str:
    return secrets.token_urlsafe(length)

def save_edited_code_content(session_id, code_block_id, language, code_content):
    conn = get_db_connection()
    cursor = conn.cursor()
    
    try:
        cursor.execute("""
            INSERT OR REPLACE INTO edited_code_blocks 
            (session_id, code_block_id, language, edited_content, edited_at)
            VALUES (?, ?, ?, ?, datetime('now', 'utc'))
        """, (session_id, code_block_id, language, code_content))
        
        conn.commit()
        return True
    except Exception as e:
        conn.rollback()
        print(f"Error saving edited code content for {code_block_id}: {e}")
        return False
    finally:
        conn.close()

if __name__ == "__main__":
    print(f"Running database script directly. Current Working Directory: {Path.cwd()}")
    print(f"Project Root (expected): {PROJECT_ROOT}")
    print(f"Database will be created/checked at: {DATABASE_PATH}")
    
    DATABASE_PATH.parent.mkdir(parents=True, exist_ok=True)
    
    init_db()



=== app/docker_utils.py ===
import asyncio
import tempfile
import traceback
from pathlib import Path
import docker
from docker.errors import DockerException, ImageNotFound, APIError, NotFound
from docker.models.containers import Container
from fastapi import WebSocket
import time
import socket
import json # Ensure json is imported
import re   # --- NEW: Import re module ---
import ast
import os
from typing import List

STD_LIB_MODULES = {
    'abc', 'aifc', 'argparse', 'array', 'ast', 'asynchat', 'asyncio', 'asyncore', 'atexit',
    'audioop', 'base64', 'bdb', 'binascii', 'binhex', 'bisect', 'builtins', 'bz2',
    'calendar', 'cgi', 'cgitb', 'chunk', 'cmath', 'cmd', 'code', 'codecs', 'codeop',
    'collections', 'colorsys', 'compileall', 'concurrent', 'configparser', 'contextlib',
    'contextvars', 'copy', 'copyreg', 'crypt', 'csv', 'ctypes', 'curses', 'dataclasses',
    'datetime', 'dbm', 'decimal', 'difflib', 'dis', 'distutils', 'doctest', 'dummy_threading',
    'email', 'encodings', 'ensurepip', 'enum', 'errno', 'faulthandler', 'fcntl', 'filecmp',
    'fileinput', 'fnmatch', 'fractions', 'ftplib', 'functools', 'gc', 'getopt', 'getpass',
    'gettext', 'glob', 'grp', 'gzip', 'hashlib', 'heapq', 'hmac', 'html', 'http', 'imaplib',
    'imghdr', 'imp', 'importlib', 'inspect', 'io', 'ipaddress', 'itertools', 'json',
    'keyword', 'lib2to3', 'linecache', 'locale', 'logging', 'lzma', 'mailbox', 'mailcap',
    'marshal', 'math', 'mimetypes', 'mmap', 'modulefinder', 'multiprocessing', 'netrc',
    'nis', 'nntplib', 'numbers', 'operator', 'optparse', 'os', 'ossaudiodev', 'parser',
    'pathlib', 'pdb', 'pickle', 'pickletools', 'pipes', 'pkgutil', 'platform', 'plistlib',
    'poplib', 'posix', 'pprint', 'profile', 'pstats', 'pty', 'pwd', 'py_compile', 'pyclbr',
    'pydoc', 'queue', 'quopri', 'random', 're', 'readline', 'reprlib', 'resource', 'rlcompleter',
    'runpy', 'sched', 'secrets', 'select', 'selectors', 'shelve', 'shlex', 'shutil',
    'signal', 'site', 'smtpd', 'smtplib', 'sndhdr', 'socket', 'socketserver', 'spwd',
    'sqlite3', 'ssl', 'stat', 'statistics', 'string', 'stringprep', 'struct', 'subprocess',
    'sunau', 'symbol', 'symtable', 'sys', 'sysconfig', 'syslog', 'tabnanny', 'tarfile',
    'telnetlib', 'tempfile', 'termios', 'textwrap', 'threading', 'time', 'timeit', 'tkinter',
    'token', 'tokenize', 'trace', 'traceback', 'tracemalloc', 'tty', 'turtle', 'turtledemo',
    'types', 'typing', 'unicodedata', 'unittest', 'urllib', 'uu', 'uuid', 'venv', 'warnings',
    'wave', 'weakref', 'webbrowser', 'wsgiref', 'xdrlib', 'xml', 'xmlrpc', 'zipapp',
    'zipfile', 'zipimport', 'zlib'
}

# Import pywintypes if on Windows, otherwise ignore
try:
    import pywintypes
    PIPE_ENDED_ERROR = pywintypes.error
except ImportError:
    class DummyPipeEndedError(Exception):
        pass
    PIPE_ENDED_ERROR = DummyPipeEndedError

from . import config
from . import state
from .utils import send_ws_message

docker_client = None
try:
    docker_client = docker.from_env()
    docker_client.ping()
    print("Successfully connected to Docker daemon.")
except DockerException as e:
    print(f"CRITICAL WARNING: Could not connect to Docker daemon: {e}")
    print("Code execution via Docker will be unavailable.")
    docker_client = None

def get_docker_client():
    return docker_client

def find_python_imports(code: str) -> List[str]:
    """
    Analyzes Python code using AST to find top-level modules that need to be installed.
    """
    try:
        tree = ast.parse(code)
        imports = set()
        for node in ast.walk(tree):
            if isinstance(node, ast.Import):
                for alias in node.names:
                    imports.add(alias.name.split('.')[0])
            elif isinstance(node, ast.ImportFrom):
                if node.module:
                    imports.add(node.module.split('.')[0])
        
        # Filter out standard library modules from the found imports
        non_std_lib_imports = {imp for imp in imports if imp not in STD_LIB_MODULES}
        
        print(f"[find_python_imports] Found potential packages to install: {non_std_lib_imports}")
        return sorted(list(non_std_lib_imports))
    except SyntaxError as e:
        print(f"[find_python_imports] Syntax error analyzing code: {e}")
        return []
    except Exception as e:
        print(f"[find_python_imports] Error analyzing code with AST: {e}")
        return []

async def read_from_socket_and_stream(
    loop: asyncio.AbstractEventLoop,
    websocket: WebSocket,
    code_block_id: str,
    container: Container,
    socket: socket.socket,
    timeout_seconds: int  # <-- MODIFICATION: Added timeout parameter
):
    import struct
    buffer = b''
    try:
        while True:
            try:
                # --- MODIFICATION START: Wrap the blocking call in a timeout ---
                raw_data = await asyncio.wait_for(
                    asyncio.to_thread(socket.recv, 8192),
                    timeout=timeout_seconds
                )
                # --- MODIFICATION END ---
            except asyncio.TimeoutError:
                # Re-raise the timeout to be caught by the calling function
                print(f"[SocketStreamer-{code_block_id}] Inactivity timeout after {timeout_seconds}s.")
                raise
            except PIPE_ENDED_ERROR:
                print(f"[SocketStreamer-{code_block_id}] Container finished normally (pipe ended)")
                break
            except (ConnectionResetError, BrokenPipeError, OSError) as e:
                print(f"[SocketStreamer-{code_block_id}] Connection closed: {e}")
                break

            if not raw_data:
                print(f"[SocketStreamer-{code_block_id}] No more data, container finished")
                break

            buffer += raw_data
            while len(buffer) >= 8:
                header_bytes = buffer[:8]
                stream_type, size = struct.unpack('>BxxxL', header_bytes)

                if len(buffer) < 8 + size:
                    break 

                payload_bytes = buffer[8 : 8 + size]
                buffer = buffer[8 + size:]

                stream_name = 'stdout' if stream_type == 1 else 'stderr'
                chunk_str = payload_bytes.decode('utf-8', 'replace')

                await send_ws_message(websocket, "code_output", {
                    "code_block_id": code_block_id, "stream": stream_name, "data": chunk_str
                })

                if stream_name == 'stdout':
                    stripped_chunk = chunk_str.rstrip()
                    if stripped_chunk and stripped_chunk.endswith((':', '?', '>')):
                        print(f"[SocketStreamer-{code_block_id}] Detected input prompt: '{chunk_str}'")
                        await send_ws_message(websocket, "code_waiting_input", {"code_block_id": code_block_id, "prompt": chunk_str})

    except Exception as e:
        # Re-raising asyncio.TimeoutError will be caught here, but we pass it up
        if isinstance(e, asyncio.TimeoutError):
            raise
        print(f"[SocketStreamer-{code_block_id}] Unexpected error in stream: {e}")
        traceback.print_exc()
    finally:
        print(f"[SocketStreamer-{code_block_id}] Stream finished - entering finally block")
        try:
            print(f"[SocketStreamer-{code_block_id}] Reloading container to check status...")
            await asyncio.to_thread(container.reload)
            container_status = container.status
            print(f"[SocketStreamer-{code_block_id}] Container status: {container_status}")

            if container_status == 'running':
                print(f"[SocketStreamer-{code_block_id}] Container still running, getting state without waiting...")
                result = {"StatusCode": 0, "Error": None}
            else:
                print(f"[SocketStreamer-{code_block_id}] Container already finished, getting exit code...")
                container_state = container.attrs.get('State', {})
                exit_code = container_state.get('ExitCode', 0)
                error_detail = container_state.get('Error')
                result = {"StatusCode": exit_code, "Error": error_detail}
                print(f"[SocketStreamer-{code_block_id}] Exit code: {exit_code}, Error: {error_detail}")

            exit_code = result.get("StatusCode", 0)
            error_msg = result.get("Error")

            print(f"[SocketStreamer-{code_block_id}] About to send code_finished with exit_code: {exit_code}")

            if websocket.client_state.name != 'CONNECTED':
                print(f"[SocketStreamer-{code_block_id}] WARNING: WebSocket not connected (state: {websocket.client_state.name})")

            await send_ws_message(websocket, "code_finished", {
                "code_block_id": code_block_id, 
                "exit_code": exit_code, 
                "error": error_msg
            })
            print(f"[SocketStreamer-{code_block_id}] ✓ code_finished message sent successfully")

        except Exception as e:
            print(f"[SocketStreamer-{code_block_id}] ERROR in finally block: {e}")
            traceback.print_exc()
            try:
                await send_ws_message(websocket, "code_finished", {
                    "code_block_id": code_block_id, 
                    "exit_code": 0, 
                    "error": None
                })
                print(f"[SocketStreamer-{code_block_id}] ✓ Fallback code_finished message sent")
            except Exception as fallback_error:
                print(f"[SocketStreamer-{code_block_id}] ✗ Even fallback message failed: {fallback_error}")

        try:
            socket.close()
            print(f"[SocketStreamer-{code_block_id}] Socket closed")
        except Exception as socket_error:
            print(f"[SocketStreamer-{code_block_id}] Error closing socket: {socket_error}")



async def run_code_in_docker_stream(websocket: WebSocket, client_id: str, code_block_id: str, language: str, code: str):
    print(f"[DockerRun-{code_block_id}] === STARTING DOCKER CODE EXECUTION ===")
    
    local_docker_client = get_docker_client()
    if not local_docker_client:
        await send_ws_message(websocket, "code_finished", {"code_block_id": code_block_id, "exit_code": -1, "error": "Docker service is unavailable."})
        return

    lang_config = config.SUPPORTED_LANGUAGES.get(language.lower())
    if not lang_config:
        await send_ws_message(websocket, "code_finished", {"code_block_id": code_block_id, "exit_code": -1, "error": f"Language '{language}' not supported."})
        return

    tmpdir_obj = tempfile.TemporaryDirectory()
    tmp_path = Path(tmpdir_obj.name)
    container = None
    
    final_command = lang_config["command"]
    volumes_to_mount = {str(tmp_path): {'bind': '/app', 'mode': 'rw'}}
    code_to_run = code

    if language.lower() == 'python':
        code = re.sub(r'^\s*plt\.show\(\s*\)\s*$', '', code, flags=re.MULTILINE)
        
        packages_to_install = find_python_imports(code)
        required_plot_packages = {'matplotlib', 'mpld3'}
        for pkg in required_plot_packages:
            if pkg not in packages_to_install:
                packages_to_install.append(pkg)

        volumes_to_mount['tesseracs-uv-cache'] = {'bind': '/root/.cache/uv', 'mode': 'rw'}
        
        python_harness_script = f"""
import sys
import json
import traceback
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import mpld3

user_code = '''
{code}
'''

try:
    exec(user_code, globals())

finally:
    fignums = plt.get_fignums()
    if fignums:
        print(f"[Harness] {{len(fignums)}} Matplotlib plots detected. Capturing all.", file=sys.stderr)
        all_plots_data = []
        for i in fignums:
            fig = plt.figure(i)
            try:
                plot_dict = mpld3.fig_to_dict(fig)
                all_plots_data.append(plot_dict)
            except Exception as e:
                print(f"[Harness] Error capturing plot figure {{i}}: {{e}}", file=sys.stderr)
            finally:
                plt.close(fig)
        
        if all_plots_data:
            with open('/app/plot_output.json', 'w') as f:
                json.dump(all_plots_data, f)
"""
        code_to_run = python_harness_script
        install_command_parts = []
        if packages_to_install:
            install_command_parts.append(f"uv pip install --system --no-cache-dir {' '.join(packages_to_install)}")
        
        run_command = "stdbuf -o0 python -u /app/script.py"
        install_command_parts.append(run_command)
        
        final_command = ["sh", "-c", " && ".join(install_command_parts)]
        print(f"[DockerRun-{code_block_id}] Modified command for Python: {final_command}")

    try:
        (tmp_path / lang_config["filename"]).write_text(code_to_run, encoding="utf-8")
        
        is_interactive = lang_config.get("interactive", True)
        
        container = local_docker_client.containers.run(
            image=lang_config["image"],
            command=final_command,
            volumes=volumes_to_mount,
            working_dir='/app',
            mem_limit=config.DOCKER_MEM_LIMIT,
            stdin_open=True,
            tty=False,
            detach=True,
            remove=False
        )

        if is_interactive:
            params = {'stdin': 1, 'stdout': 1, 'stderr': 1, 'stream': 1}
            interactive_socket = container.attach_socket(params=params)

            async with state.running_containers_lock:
                state.running_containers[code_block_id] = {
                    "container": container, "client_id": client_id, "socket": interactive_socket
                }

            loop = asyncio.get_running_loop()
            # --- MODIFICATION: Pass timeout and remove wait_for wrapper ---
            reader_task = loop.create_task(
                read_from_socket_and_stream(loop, websocket, code_block_id, container, interactive_socket, timeout_seconds=config.DOCKER_TIMEOUT_SECONDS)
            )
            await reader_task
        else: # Batch mode for non-interactive
            container.wait(timeout=config.DOCKER_TIMEOUT_SECONDS)

    except asyncio.TimeoutError:
        # This block now catches the inactivity timeout from the reader task
        print(f"[DockerRun-{code_block_id}] Session timed out after {config.DOCKER_TIMEOUT_SECONDS}s of inactivity.")
        await send_ws_message(websocket, "code_finished", {"code_block_id": code_block_id, "exit_code": 137, "error": "Execution timed out due to inactivity."})
    except Exception as e:
        error_payload = f"Server Execution Error: {e}"
        print(f"[DockerRun-{code_block_id}] CRITICAL ERROR: {error_payload}")
        traceback.print_exc()
        await send_ws_message(websocket, "code_finished", {"code_block_id": code_block_id, "exit_code": -1, "error": error_payload})
    finally:
        plot_output_path = tmp_path / "plot_output.json"
        if plot_output_path.exists():
            print(f"[DockerRun-{code_block_id}] Found plot_output.json. Sending to client.")
            try:
                with open(plot_output_path, 'r') as f:
                    plot_data = json.load(f) # This will now be a list
                await send_ws_message(websocket, "plot_output", {
                    "code_block_id": code_block_id,
                    "plot_data": plot_data
                })
            except Exception as e:
                print(f"[DockerRun-{code_block_id}] Error reading or sending plot data: {e}")
        
        print(f"[DockerRun-{code_block_id}] === CLEANUP PHASE ===")
        await stop_docker_container(code_block_id)
        if tmpdir_obj:
            try:
                tmpdir_obj.cleanup()
            except Exception as e:
                print(f"[DockerRun-{code_block_id}] Error cleaning temp directory: {e}")
        
        print(f"[DockerRun-{code_block_id}] === DOCKER EXECUTION COMPLETE ===")

async def send_input_to_container(code_block_id: str, user_input: str):
    # This function remains unchanged...
    async with state.running_containers_lock:
        container_info = state.running_containers.get(code_block_id)
        if container_info and (socket := container_info.get("socket")):
            try:
                await asyncio.to_thread(socket.sendall, user_input.encode('utf-8'))
                print(f"Sent input to {code_block_id}: {user_input.strip()}")
            except Exception as e:
                print(f"Error sending input via socket: {e}")
        else:
            print(f"Send input failed: No active container or socket for {code_block_id}")

async def stop_docker_container(code_block_id: str):
    # This function remains unchanged...
    container_info = None
    async with state.running_containers_lock:
        container_info = state.running_containers.pop(code_block_id, None)
    
    if not container_info:
        return

    if socket := container_info.get("socket"):
        try:
            socket.close()
            print(f"Socket for {code_block_id} closed.")
        except Exception as e_sock:
            print(f"Error closing socket for {code_block_id}: {e_sock}")

    if container := container_info.get("container"):
        try:
            await asyncio.to_thread(container.reload)
            if container.status == 'running':
                await asyncio.to_thread(container.kill)
                print(f"Container for {code_block_id} killed.")
            else:
                print(f"Container for {code_block_id} already stopped (status: {container.status}).")
            
            await asyncio.to_thread(container.remove, force=True)
            print(f"Container for {code_block_id} removed.")
        except Exception as e:
            print(f"Error stopping/removing container for {code_block_id}: {e}")

async def cleanup_client_containers(client_id: str):
    # This function remains unchanged...
    async with state.running_containers_lock:
        ids_for_client = [cb_id for cb_id, info in state.running_containers.items() if info.get("client_id") == client_id]
    
    if ids_for_client:
        await asyncio.gather(*[stop_docker_container(cb_id) for cb_id in ids_for_client], return_exceptions=True)

=== app/email_utils.py ===
# app/email_utils.py
from fastapi_mail import FastMail, MessageSchema, ConnectionConfig
from pathlib import Path
import traceback
from . import config # Import your config module

# --- Email Configuration ---
# Create the ConnectionConfig using settings from config.py
# This configuration is used to connect to the email server.
conf = ConnectionConfig(
    MAIL_USERNAME=config.MAIL_CONFIG.get("MAIL_USERNAME"),
    MAIL_PASSWORD=config.MAIL_CONFIG.get("MAIL_PASSWORD"),
    MAIL_FROM=config.MAIL_CONFIG.get("MAIL_FROM"),
    MAIL_PORT=config.MAIL_CONFIG.get("MAIL_PORT", 587), # Default to 587 if not in config
    MAIL_SERVER=config.MAIL_CONFIG.get("MAIL_SERVER"),
    MAIL_FROM_NAME=config.MAIL_CONFIG.get("MAIL_FROM_NAME"),
    MAIL_STARTTLS=config.MAIL_CONFIG.get("MAIL_STARTTLS", True), # Default to True
    MAIL_SSL_TLS=config.MAIL_CONFIG.get("MAIL_SSL_TLS", False),   # Default to False
    USE_CREDENTIALS=config.MAIL_CONFIG.get("USE_CREDENTIALS", True),
    VALIDATE_CERTS=config.MAIL_CONFIG.get("VALIDATE_CERTS", True) # Default to True
)

# Initialize FastMail instance with the configuration
fm = FastMail(conf)

# Define the base path for email templates
# config.APP_DIR should point to the 'app' directory.
EMAIL_TEMPLATES_DIR = config.APP_DIR / "static" / "email_templates"

async def send_registration_password_email(
    recipient_email: str,
    recipient_name: str,
    generated_password: str,
    login_url: str
) -> bool:
    """
    Sends the generated password to a new user using an HTML template.
    The password sent is the user's actual password.
    """
    # Basic check for essential mail server configuration
    if not conf.MAIL_FROM or not conf.MAIL_SERVER:
        print("EMAIL ERROR: Mail configuration (MAIL_FROM, MAIL_SERVER) is incomplete. Cannot send registration password email.")
        return False

    template_path = EMAIL_TEMPLATES_DIR / "registration_email.html"
    subject = "Welcome to Tesseracs Chat - Your Account Details"

    try:
        # Read the HTML template from file
        with open(template_path, "r", encoding="utf-8") as f:
            html_template = f.read()

        # Replace placeholders in the template
        # Ensure all placeholders match those in the HTML template
        html_body = html_template.replace("{{ recipient_name }}", recipient_name)
        html_body = html_body.replace("{{ email }}", recipient_email) # Changed from {{ recipient_email }} for consistency
        html_body = html_body.replace("{{ password }}", generated_password)
        html_body = html_body.replace("{{ login_url }}", login_url)

    except FileNotFoundError:
        print(f"EMAIL ERROR: Registration email template not found at {template_path}")
        return False
    except Exception as e:
        print(f"EMAIL ERROR: Failed to read or process registration email template: {e}")
        traceback.print_exc()
        return False

    # Create the email message schema
    message = MessageSchema(
        subject=subject,
        recipients=[recipient_email],
        body=html_body,
        subtype="html"
    )

    try:
        # Attempt to send the email
        print(f"EMAIL: Attempting to send registration password to {recipient_email} via {conf.MAIL_SERVER}:{conf.MAIL_PORT}")
        await fm.send_message(message)
        print(f"EMAIL: Registration password email successfully sent to {recipient_email}.")
        return True  # Indicate success
    except Exception as e:
        # Log any errors during email sending
        print(f"EMAIL ERROR: Failed to send registration password email to {recipient_email}")
        print(f"EMAIL ERROR DETAILS: {type(e).__name__} - {e}")
        traceback.print_exc()
        return False # Indicate failure

async def send_password_reset_email(
    recipient_email: str,
    recipient_name: str,
    new_password: str,
    login_url: str
) -> bool:
    """
    Sends an email containing a newly generated password after a reset request,
    using an HTML template.
    """
    # Basic check for essential mail server configuration
    if not conf.MAIL_FROM or not conf.MAIL_SERVER:
        print("EMAIL ERROR: Mail configuration (MAIL_FROM, MAIL_SERVER) is incomplete. Cannot send password reset email.")
        return False

    template_path = EMAIL_TEMPLATES_DIR / "password_reset_email.html"
    subject = "Your Tesseracs Chat Password Has Been Reset"

    try:
        # Read the HTML template from file
        with open(template_path, "r", encoding="utf-8") as f:
            html_template = f.read()

        # Replace placeholders in the template
        # Ensure all placeholders match those in the HTML template
        html_body = html_template.replace("{{ recipient_name }}", recipient_name)
        html_body = html_body.replace("{{ email }}", recipient_email) # Changed from {{ recipient_email }} for consistency
        html_body = html_body.replace("{{ password }}", new_password)
        html_body = html_body.replace("{{ login_url }}", login_url)

    except FileNotFoundError:
        print(f"EMAIL ERROR: Password reset email template not found at {template_path}")
        return False
    except Exception as e:
        print(f"EMAIL ERROR: Failed to read or process password reset email template: {e}")
        traceback.print_exc()
        return False

    # Create the email message schema
    message = MessageSchema(
        subject=subject,
        recipients=[recipient_email],
        body=html_body,
        subtype="html"
    )

    try:
        # Attempt to send the email
        print(f"EMAIL: Attempting to send password reset to {recipient_email} via {conf.MAIL_SERVER}:{conf.MAIL_PORT}")
        await fm.send_message(message)
        print(f"EMAIL: Password reset email successfully sent to {recipient_email}.")
        return True # Indicate success
    except Exception as e:
        # Log any errors during email sending
        print(f"EMAIL ERROR: Failed to send password reset email to {recipient_email}")
        print(f"EMAIL ERROR DETAILS: {type(e).__name__} - {e}")
        traceback.print_exc()
        return False # Indicate failure


=== app/encryption_utils.py ===
# app/encryption_utils.py
import os
from cryptography.fernet import Fernet, InvalidToken
# Import config from the current package
from . import config 
from typing import Optional

# Global variable to hold the Fernet instance, initialized once
_fernet_instance: Optional[Fernet] = None

def _get_fernet() -> Fernet:
    """
    Initializes and returns the Fernet instance for encryption/decryption.
    Raises ValueError if APP_SECRET_KEY is not configured or invalid.
    """
    global _fernet_instance
    if _fernet_instance is None:
        if not config.APP_SECRET_KEY:
            print("CRITICAL ERROR: APP_SECRET_KEY is not configured in the environment. "
                  "Cannot perform encryption/decryption of sensitive data.")
            raise ValueError("APP_SECRET_KEY is not configured. Encryption services are unavailable.")
        
        try:
            # APP_SECRET_KEY must be a URL-safe base64-encoded 32-byte key.
            key_bytes = config.APP_SECRET_KEY.encode('utf-8')
            _fernet_instance = Fernet(key_bytes)
            print("Fernet encryption service initialized successfully.")
        except Exception as e:
            # This can happen if the key is not correctly formatted (e.g., wrong length, not base64)
            print(f"CRITICAL ERROR: Failed to initialize Fernet with APP_SECRET_KEY: {e}. "
                  "Ensure APP_SECRET_KEY is a valid Fernet key (URL-safe base64 encoded 32-byte key). "
                  "You can generate one using: python -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\"")
            raise ValueError(f"Invalid APP_SECRET_KEY format for Fernet encryption: {e}") from e
            
    return _fernet_instance

def encrypt_data(data: str) -> Optional[str]:
    """
    Encrypts a string using the configured Fernet instance.

    Args:
        data: The string data to encrypt.

    Returns:
        The encrypted string, or None if encryption fails or data is empty.
    """
    if not data:
        return None # Do not encrypt empty strings, return None or empty as per policy
    
    try:
        fernet_cipher = _get_fernet()
        encrypted_bytes = fernet_cipher.encrypt(data.encode('utf-8'))
        return encrypted_bytes.decode('utf-8') # Store the encrypted data as a string
    except ValueError as ve: # Raised by _get_fernet if APP_SECRET_KEY is not set/invalid
        print(f"Encryption failed due to configuration issue: {ve}")
        # Depending on policy, you might re-raise or return a specific error indicator.
        # For now, returning None as the operation could not be completed.
        return None
    except Exception as e:
        print(f"Error during data encryption: {e}")
        # import traceback
        # traceback.print_exc() # Uncomment for detailed stack trace during development
        return None

def decrypt_data(encrypted_data: str) -> Optional[str]:
    """
    Decrypts a string using the configured Fernet instance.

    Args:
        encrypted_data: The encrypted string data.

    Returns:
        The decrypted string, or None if decryption fails (e.g., invalid token, key mismatch, or data corruption)
        or if the input is empty.
    """
    if not encrypted_data:
        return None
    
    try:
        fernet_cipher = _get_fernet()
        decrypted_bytes = fernet_cipher.decrypt(encrypted_data.encode('utf-8'))
        return decrypted_bytes.decode('utf-8')
    except InvalidToken:
        # This is a common error if the token is tampered with, the key is wrong,
        # or the data is not valid Fernet-encrypted data.
        print("Error during data decryption: Invalid token. Data might be corrupted or key mismatch.")
        return None
    except ValueError as ve: # Raised by _get_fernet if APP_SECRET_KEY is not set/invalid
        print(f"Decryption failed due to configuration issue: {ve}")
        return None
    except Exception as e:
        print(f"An unexpected error occurred during data decryption: {e}")
        # import traceback
        # traceback.print_exc() # Uncomment for detailed stack trace during development
        return None

# Example usage (for testing purposes, typically not run directly like this in production)
if __name__ == '__main__':
    # This block will only run if the script is executed directly.
    # It requires APP_SECRET_KEY to be set in the environment or .env file.
    print("Running encryption_utils.py for testing...")
    if not config.APP_SECRET_KEY:
        print("Skipping tests: APP_SECRET_KEY is not set in environment.")
    else:
        try:
            # Ensure Fernet can be initialized
            _get_fernet() 
            print("Fernet instance obtained successfully for testing.")

            original_text = "This is a super secret API key!"
            print(f"Original text: '{original_text}'")

            encrypted = encrypt_data(original_text)
            if encrypted:
                print(f"Encrypted text: '{encrypted}'")
                
                decrypted = decrypt_data(encrypted)
                if decrypted:
                    print(f"Decrypted text: '{decrypted}'")
                    assert original_text == decrypted, "Decryption did not match original!"
                    print("Encryption and decryption test successful!")
                else:
                    print("Decryption FAILED.")
            else:
                print("Encryption FAILED.")
            
            print("\nTesting with empty string:")
            encrypted_empty = encrypt_data("")
            print(f"Encrypting empty string: {encrypted_empty}")
            decrypted_empty_from_none = decrypt_data(None) # type: ignore
            print(f"Decrypting None: {decrypted_empty_from_none}")

            print("\nTesting decryption of invalid token:")
            invalid_decryption = decrypt_data("this_is_not_a_valid_fernet_token")
            print(f"Decrypting invalid token: {invalid_decryption}")

        except ValueError as e:
            print(f"Test failed due to ValueError (likely APP_SECRET_KEY issue): {e}")
        except Exception as e:
            print(f"An unexpected error occurred during testing: {e}")



=== app/llm.py ===
import sys
import os
import traceback
from typing import List, Callable, Optional, Any
import asyncio
import sqlite3

from fastapi import WebSocket

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import RunnablePassthrough, Runnable, RunnableLambda
from langchain_core.messages import BaseMessage
from langchain_ollama.llms import OllamaLLM
from langchain_openai import ChatOpenAI
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_anthropic import ChatAnthropic

from . import config
from . import state
from . import database
from . import utils
from . import encryption_utils

# --- System Prompt Definition ---
SYSTEM_PROMPT = (
    "You are a versatile and helpful AI assistant with expertise in programming and data visualization.\n\n"
    "## Your Core Directives:\n"
    "1.  **Interpret the User's Goal:** First, determine if the user is asking for information, a plot, or code in a specific language.\n"
    "2.  **Provide Direct Answers:** For general questions, facts, explanations, or summaries, provide the answer directly using clear text and Markdown formatting (like tables and lists).\n"
    "3.  **Generate Code in the Requested Language:** If the user asks for a script, a webpage, or mentions a language (e.g., 'Python', 'HTML', 'JavaScript'), you MUST generate code in that specific language. Use the correct language identifier in the fenced code block (e.g., ```python, ```html).\n"
    "4.  **Code-Only Responses:** When the user's request is primarily for a code snippet, your response must contain ONLY the Markdown-fenced code block. Do not include any extra explanatory text or conversational phrases before or after the code block.\n"
    "5.  **Never Wrap Code in Python:** Your environment can render `html` code blocks directly. Therefore, NEVER write Python code to print or display another language's code (e.g., do not use `IPython.display` or `print(html_code)`). If the final desired output is HTML, write it in an `html` code block.\n"
    "6.  **Use `matplotlib` for Plots:** All plotting must be done using the `matplotlib.pyplot` library in a Python code block. The system will render the plots automatically.\n"
    "7.  **Use LaTeX for Mathematics:** When writing mathematical equations or formulas, you MUST enclose them in LaTeX notation. Use `$$...$$` for block equations and `$...$` for inline equations.\n"
    "8.  **Use the Thinking Process:** For complex requests, explain your reasoning using the `\\think` command at the start of your response."
)

def get_model(
    provider_id: str,
    model_id: str,
    api_key: Optional[str] = None,
    base_url_override: Optional[str] = None
) -> Optional[Any]:
    print(f"LLM: Attempting to get model for provider='{provider_id}', model='{model_id}', base_url_override='{base_url_override}'")
    provider_config = config.get_provider_config(provider_id)

    if not provider_config:
        print(f"LLM_ERROR: Provider ID '{provider_id}' not found in LLM_PROVIDERS configuration.")
        return None

    provider_type = provider_config.get("type")
    
    final_base_url: Optional[str] = None
    if base_url_override and base_url_override.strip():
        final_base_url = base_url_override.strip()
    else:
        final_base_url = provider_config.get("base_url")

    if provider_type in ["openai_compatible"] and not final_base_url:
        print(f"LLM_ERROR: Final base URL for provider '{provider_id}' (type: {provider_type}) is missing.")
        return None

    resolved_api_key = api_key
    api_key_env_name = provider_config.get("api_key_env_var_name")

    if not resolved_api_key and api_key_env_name:
        resolved_api_key = os.getenv(api_key_env_name)
    
    try:
        if provider_type == "openai_compatible":
            if api_key_env_name and not resolved_api_key:
                print(f"LLM_WARNING: API key for openai_compatible provider '{provider_id}' not found. Proceeding without if possible.")
            return ChatOpenAI(
                model_name=model_id,
                openai_api_base=final_base_url,
                openai_api_key=resolved_api_key,
            )
        
        elif provider_type == "google_genai":
            if not resolved_api_key:
                print(f"LLM_ERROR: Google API Key is required for provider '{provider_id}' but was not provided.")
                return None
            return ChatGoogleGenerativeAI(
                model=model_id,
                google_api_key=resolved_api_key
            )

        elif provider_type == "anthropic":
            if not resolved_api_key:
                print(f"LLM_ERROR: Anthropic API Key is required for provider '{provider_id}' but was not provided.")
                return None
            return ChatAnthropic(
                    model=model_id,
                    anthropic_api_key=resolved_api_key,
                    max_tokens=8192,
                )
            
        else:
            print(f"LLM_ERROR: Unknown provider type '{provider_type}' for provider ID '{provider_id}'.")
            return None

    except Exception as e:
        print(f"LLM_CRITICAL_ERROR: Failed to initialize model for provider '{provider_id}', model '{model_id}': {e}")
        traceback.print_exc()
        return None

prompt = ChatPromptTemplate.from_messages([
    ("system", SYSTEM_PROMPT),
    MessagesPlaceholder(variable_name="history"),
    ("human", "{input}")
])

output_parser = StrOutputParser()

def create_chain(
    provider_id: str,
    model_id: str,
    memory_loader_func: Callable[[dict], List[BaseMessage]],
    api_key: Optional[str] = None,
    base_url_override: Optional[str] = None
) -> Optional[Runnable]:
    try:
        current_model_instance = get_model(
            provider_id=provider_id,
            model_id=model_id,
            api_key=api_key,
            base_url_override=base_url_override
        )
        if not current_model_instance:
            print(f"LLM Chain ERROR: Failed to get model instance for provider '{provider_id}', model '{model_id}'. Cannot create chain.")
            return None

        chain = (
            RunnablePassthrough.assign(history=RunnableLambda(memory_loader_func))
            | prompt
            | current_model_instance
            | output_parser
        )
        print(f"LLM Chain: Successfully created chain for '{model_id}' from '{provider_id}'.")
        return chain
    except Exception as e:
        print(f"LLM Chain CRITICAL_ERROR: Failed to create LangChain chain: {e}")
        traceback.print_exc()
        return None

async def invoke_llm_for_session(
    session_id: str,
    websocket: WebSocket,
    user_id: int,
    user_input_raw: str,
    turn_id: int,
    stream_id: str,
    reply_to_message_id: Optional[int]
):
    stop_event = await state.register_ai_stream(stream_id)
    full_response_content = ""
    db_conn = None
    ai_message_id = None
    
    try:
        db_conn_for_settings = database.get_db_connection()
        cursor = db_conn_for_settings.cursor()
        cursor.execute(
            "SELECT selected_llm_provider_id, selected_llm_model_id, user_llm_api_key_encrypted, selected_llm_base_url FROM users WHERE id = ?",
            (user_id,)
        )
        user_settings = cursor.fetchone()
        db_conn_for_settings.close()

        provider_id = user_settings["selected_llm_provider_id"] if user_settings else None
        model_id = user_settings["selected_llm_model_id"] if user_settings else None

        if not provider_id or not model_id:
            await websocket.send_text("<ERROR> AI provider not configured. Please select a provider and model in your User Settings.")
            return 

        api_key = None
        base_url = None
        if user_settings:
            if user_settings["user_llm_api_key_encrypted"]:
                api_key = encryption_utils.decrypt_data(user_settings["user_llm_api_key_encrypted"])
            base_url = user_settings["selected_llm_base_url"]
        
        def get_history(input_dict: dict) -> List[BaseMessage]:
            memory = state.get_memory_for_client(session_id)
            return memory.chat_memory.messages

        chain = create_chain(
            provider_id=provider_id,
            model_id=model_id,
            memory_loader_func=get_history,
            api_key=api_key,
            base_url_override=base_url
        )

        if not chain:
            raise ValueError(f"Failed to create chain for provider {provider_id}")

        stream = chain.astream({"input": user_input_raw})

        async for chunk in stream:
            if stop_event.is_set():
                break
            
            full_response_content += chunk
            await utils.send_ws_message(websocket, "ai_chunk", chunk)
            await asyncio.sleep(0.01)

    except Exception as e:
        print(f"--- LLM ERROR for stream '{stream_id}' ---")
        traceback.print_exc()
        error_message = f"<ERROR> AI Error: {str(e)}"
        await websocket.send_text(error_message)
    finally:
        print(f"--- LLM STREAM: Finalizing stream '{stream_id}' ---")
        if full_response_content:
            try:
                db_conn = database.get_db_connection()
                cursor = db_conn.cursor()
                cursor.execute(
                    """INSERT INTO chat_messages (session_id, user_id, sender_name, sender_type, content, turn_id, reply_to_message_id, timestamp)
                       VALUES (?, ?, ?, ?, ?, ?, ?, ?, datetime('now', 'utc'))""",
                    (session_id, user_id, 'AI', 'ai', full_response_content, turn_id, reply_to_message_id)
                )
                ai_message_id = cursor.lastrowid
                db_conn.commit()
                state.remove_memory_for_client(session_id)
            except sqlite3.Error as db_err:
                print(f"--- DB ERROR: Failed to save AI response for stream '{stream_id}': {db_err} ---")
                traceback.print_exc()
            finally:
                if db_conn:
                    db_conn.close()

        await utils.send_ws_message(websocket, "ai_stream_end", {"message_id": ai_message_id})
        await state.unregister_ai_stream(stream_id)


=== app/main.py ===
import os
import sys
import traceback
from pathlib import Path
import asyncio
import json
import sqlite3
import uuid
from urllib.parse import urlparse
import datetime
from typing import Optional, Dict, Any, List

from fastapi import (
    FastAPI,
    Request,
    HTTPException,
    WebSocket,
    WebSocketDisconnect,
    Form,
    Depends,
    Response as FastAPIResponse,
    Path as FastApiPath,
    Body,
    status
)
from fastapi.responses import (
    HTMLResponse,
    RedirectResponse,
    JSONResponse,
    FileResponse,
    Response
)
from fastapi.security import OAuth2PasswordRequestForm
from fastapi.staticfiles import StaticFiles
from fastapi.websockets import WebSocketState

from pydantic import HttpUrl

from fastapi_csrf_protect import CsrfProtect
from fastapi_csrf_protect.exceptions import CsrfProtectError

from . import config
from . import state
from . import llm
from . import docker_utils
from . import utils
from . import database
from . import auth
from . import email_utils
from . import models
from . import encryption_utils

app = FastAPI(title="Tesseracs Chat CSRF Example")

@CsrfProtect.load_config
def get_csrf_config():
    loaded_secret_from_config = getattr(config, 'CSRF_PROTECT_SECRET_KEY', None)
    final_csrf_secret = None
    default_fallback_secret = "a_very_secure_fallback_secret_key_must_be_at_least_32_bytes_long_0123456789"

    if isinstance(loaded_secret_from_config, str) and len(loaded_secret_from_config) >= 32:
        final_csrf_secret = loaded_secret_from_config
    else:
        final_csrf_secret = default_fallback_secret
    
    return [
        ("secret_key", final_csrf_secret),
        ("cookie_key", "fastapi-csrf-token"),
        ("header_name", "X-CSRF-Token"),
        ("httponly", True),
    ]

@app.exception_handler(CsrfProtectError)
async def csrf_protect_exception_handler(request: Request, exc: CsrfProtectError):
    return JSONResponse(
        status_code=exc.status_code, 
        content={"detail": exc.message if exc.message else "CSRF Validation Failed"}
    )

async def serve_html_with_csrf(
    file_path: Path,
    request: Request,
    csrf_protect: CsrfProtect,
    replacements: Optional[Dict[str, str]] = None
) -> HTMLResponse:
    if not file_path.is_file():
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=f"Resource {file_path.name} not found.")

    html_content_original = ""
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            html_content_original = f.read()
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail=f"Error loading content for {file_path.name}.")

    _raw_token_csrf, signed_token_for_cookie = csrf_protect.generate_csrf_tokens()
    if not _raw_token_csrf or not signed_token_for_cookie:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="CSRF token generation failed on server.")

    html_content_processed = html_content_original
    
    csrf_placeholder = "%%CSRF_TOKEN_RAW%%"
    if csrf_placeholder in html_content_processed:
        html_content_processed = html_content_processed.replace(csrf_placeholder, _raw_token_csrf)
    
    if replacements:
        for key, value in replacements.items():
            if key in html_content_processed:
                html_content_processed = html_content_processed.replace(key, str(value))

    response = HTMLResponse(content=html_content_processed)
    try:
        csrf_protect.set_csrf_cookie(response=response, csrf_signed_token=signed_token_for_cookie)
    except Exception as e:
        traceback.print_exc()

    return response

@app.patch("/api/sessions/{session_id}", response_model=models.SessionResponseModel, tags=["Sessions"])
async def update_session_name(
    request: Request,
    session_id: str = FastApiPath(..., description="The ID of the session to update."),
    update_data: models.SessionUpdateRequest = Body(...),
    user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    user_id = user['id']
    new_name = update_data.name

    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()

        cursor.execute("SELECT 1 FROM session_participants WHERE session_id = ? AND user_id = ?", (session_id, user_id))
        if not cursor.fetchone():
            raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="You do not have permission to modify this session.")

        cursor.execute(
            "UPDATE sessions SET name = ?, last_accessed_at = datetime('now', 'utc') WHERE id = ?",
            (new_name, session_id)
        )
        if cursor.rowcount == 0:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Session not found.")
        
        cursor.execute("SELECT * FROM sessions WHERE id = ?", (session_id,))
        updated_session_row = cursor.fetchone()
        conn.commit()

        if not updated_session_row:
             raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Session not found after update.")

        state.remove_memory_for_client(session_id)

        session_data = dict(updated_session_row)
        return models.SessionResponseModel(**session_data)

    except HTTPException as http_exc:
        if conn: conn.rollback()
        raise http_exc
    except sqlite3.Error as db_err:
        if conn: conn.rollback()
        traceback.print_exc()
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Database error while updating session.")
    except Exception as e:
        if conn: conn.rollback()
        traceback.print_exc()
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="An unexpected error occurred.")
    finally:
        if conn: conn.close()

@app.get("/login", response_class=HTMLResponse, name="get_login_page_route", tags=["Pages"])
async def get_login_page_route(
    request: Request,
    user: Optional[Dict[str, Any]] = Depends(auth.get_current_user), 
    csrf_protect: CsrfProtect = Depends()
) -> Response:
    if user:
        session_choice_url = request.url_for("get_session_choice_page")
        return RedirectResponse(url=str(session_choice_url), status_code=status.HTTP_302_FOUND)

    login_html_path = config.STATIC_DIR / "login.html"
    return await serve_html_with_csrf(login_html_path, request, csrf_protect)

@app.get("/", response_class=HTMLResponse, name="get_session_choice_page", tags=["Pages"])
async def get_session_choice_page_route(
    request: Request,
    user: Optional[Dict[str, Any]] = Depends(auth.get_current_user),
    csrf_protect: CsrfProtect = Depends()
) -> Response:
    if user is None:
        login_url = request.url_for("get_login_page_route")
        return RedirectResponse(url=str(login_url), status_code=status.HTTP_302_FOUND)

    session_choice_html_path = config.STATIC_DIR / "session-choice.html"
    replacements = {"[User Name]": user.get("name", "User")}
    return await serve_html_with_csrf(session_choice_html_path, request, csrf_protect, replacements=replacements)

@app.get("/chat/{session_id}", response_class=HTMLResponse, name="get_chat_page_for_session", tags=["Pages"])
async def get_chat_page_for_session(
    request: Request,
    session_id: str = FastApiPath(..., description="The ID of the chat session to load."),
    user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    user_id = user['id']
    session_name_for_html = "Chat Session"
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        
        cursor.execute("SELECT id, name FROM sessions WHERE id = ? AND is_active = 1", (session_id,))
        session_row = cursor.fetchone()
        
        if not session_row:
            raise HTTPException(status_code=404, detail="Chat session not found or is inactive.")
        
        session_name_for_html = session_row["name"]

        cursor.execute("SELECT 1 FROM session_participants WHERE session_id = ? AND user_id = ?", (session_id, user_id))
        if not cursor.fetchone():
            raise HTTPException(status_code=403, detail="You do not have access to this chat session.")

        current_time_utc_iso = datetime.datetime.now(datetime.timezone.utc).isoformat()
        cursor.execute("UPDATE sessions SET last_accessed_at = ? WHERE id = ?", (current_time_utc_iso, session_id))
        conn.commit()

    except HTTPException as http_exc:
        if conn: conn.rollback()
        raise http_exc
    except Exception as e:
        if conn: conn.rollback()
        traceback.print_exc()
        raise HTTPException(status_code=500, detail="Error verifying session access for chat page.")
    finally:
        if conn: conn.close()

    chat_html_path = config.STATIC_DIR / "chat-session.html"
    replacements = {"%%SESSION_NAME_PLACEHOLDER%%": utils.escape_html(session_name_for_html)}
    return await serve_html_with_csrf(chat_html_path, request, csrf_protect, replacements=replacements)

@app.get("/settings", response_class=HTMLResponse, name="get_settings_page", tags=["Pages"])
async def get_settings_page(
    request: Request,
    user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    settings_html_path = config.STATIC_DIR / "settings.html"
    return await serve_html_with_csrf(settings_html_path, request, csrf_protect)

@app.post("/check_email", response_model=models.EmailCheckResponse, tags=["Authentication"])
async def check_email_exists_route(
    request: Request,
    request_data: models.EmailCheckRequest,
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    email_to_check = request_data.email.lower().strip()
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT name FROM users WHERE email = ? AND is_active = 1", (email_to_check,))
        user_row = cursor.fetchone()
        if user_row:
            return models.EmailCheckResponse(exists=True, user_name=user_row["name"])
        else:
            return models.EmailCheckResponse(exists=False, user_name=None)
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Error checking email.")
    finally:
        if conn: conn.close()

@app.post("/token", response_model=models.Token, tags=["Authentication"])
async def login_for_access_token(
    request: Request,
    response: FastAPIResponse,
    form_data: OAuth2PasswordRequestForm = Depends(),
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    email = form_data.username.lower().strip()
    password = form_data.password
    conn = None
    try:
        conn = database.get_db_connection()
        user_dict = auth.authenticate_user_from_db(conn, email, password)
        if not user_dict:
            raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Incorrect email or password.")
        
        if not user_dict["is_active"]:
            raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="Account is inactive.")
        
        session_token_raw = await auth.create_user_session(response=response, user_id=user_dict["id"])
        
        _raw_token_new, signed_token_for_cookie_new = csrf_protect.generate_csrf_tokens()
        csrf_protect.set_csrf_cookie(response=response, csrf_signed_token=signed_token_for_cookie_new)
        
        return models.Token(
            access_token=session_token_raw, 
            token_type="bearer",
            user_id=user_dict["id"], 
            user_name=user_dict["name"], 
            user_email=user_dict["email"]
        )
    except HTTPException as http_exc:
        raise http_exc
    finally:
        if conn: conn.close()

@app.post("/sessions/create", response_model=models.SessionResponseModel, tags=["Sessions"])
async def create_new_session_route(
    request: Request,
    session_data: models.HostSessionRequest,
    user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    print("\n--- LOG: 1. `create_new_session_route` endpoint initiated. ---")
    await csrf_protect.validate_csrf(request)
    host_user_id = user["id"]
    new_session_id = str(uuid.uuid4())
    passcode_hash = None

    if session_data.access_level in ['protected', 'unlisted'] and not session_data.passcode:
        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="A passcode is required for protected or unlisted sessions.")
    
    if session_data.passcode:
        passcode_hash = auth.get_password_hash(session_data.passcode)

    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()

        if session_data.access_level in ['public', 'protected']:
            cursor.execute(
                "SELECT id FROM sessions WHERE name = ? AND access_level IN ('public', 'protected') AND is_active = 1",
                (session_data.name,)
            )
            if cursor.fetchone():
                raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="A public or protected session with this name already exists.")

        cursor.execute(
            """INSERT INTO sessions (id, host_user_id, name, access_level, passcode_hash, created_at, last_accessed_at) 
               VALUES (?, ?, ?, ?, ?, datetime('now', 'utc'), datetime('now', 'utc'))""",
            (new_session_id, host_user_id, session_data.name, session_data.access_level, passcode_hash)
        )

        cursor.execute(
            "INSERT INTO session_participants (session_id, user_id) VALUES (?, ?)",
            (new_session_id, host_user_id)
        )
        
        conn.commit()
        print(f"--- LOG: 2. Session '{new_session_id}' created and saved to database. ---")

        cursor.execute("SELECT * FROM sessions WHERE id = ?", (new_session_id,))
        new_session_row = cursor.fetchone()
        
        session_dict = dict(new_session_row)

        if session_dict['access_level'] in ['public', 'protected']:
            print(f"--- LOG: 3. Session is public/protected. Preparing to broadcast to lobby. ---")
            broadcast_payload = models.SessionResponseModel(
                id=session_dict['id'],
                name=session_dict['name'],
                created_at=session_dict['created_at'],
                last_active=session_dict['last_accessed_at'],
                host_user_id=session_dict['host_user_id'],
                is_member=False,
                access_level=session_dict['access_level']
            )
            await state.broadcast_to_lobby({
                "type": "new_public_session",
                "payload": broadcast_payload.model_dump()
            })
        
        session_dict['is_member'] = True
        print(f"--- LOG: 5. Returning successful response to host client. ---")
        return models.SessionResponseModel(**session_dict)

    except HTTPException as http_exc:
        if conn: conn.rollback()
        raise http_exc
    except sqlite3.Error as db_err:
        if conn: conn.rollback()
        traceback.print_exc()
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Database error creating session.")
    finally:
        if conn: conn.close()

@app.post("/register", response_model=models.RegistrationResponse, tags=["Authentication"])
async def register_new_user(
    request_data: models.RegistrationRequest,
    request: Request,
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    email = request_data.email.lower().strip()
    name = request_data.name.strip()

    if not name or not utils.is_valid_email(email):
        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Invalid name or email format.")

    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT id FROM users WHERE email = ?", (email,))
        if cursor.fetchone():
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="This email address is already registered.")
        
        plain_password = database.generate_secure_token(12)
        hashed_password = auth.get_password_hash(plain_password)
        
        cursor.execute(
            "INSERT INTO users (name, email, password_hash, is_active, created_at, updated_at) VALUES (?, ?, ?, ?, datetime('now'), datetime('now'))",
            (name, email, hashed_password, True)
        )
        user_id = cursor.lastrowid
        if not user_id:
            conn.rollback()
            raise sqlite3.Error("User insertion failed to return an ID.")

        login_url_from_fastapi = str(request.url_for('get_login_page_route'))
        parsed_base_url = urlparse(config.BASE_URL)
        parsed_login_route_url = urlparse(login_url_from_fastapi)
        login_page_url = parsed_base_url._replace(path=parsed_login_route_url.path).geturl()
        
        email_sent = await email_utils.send_registration_password_email(
            recipient_email=email, recipient_name=name, generated_password=plain_password, login_url=login_page_url
        )
        
        if not email_sent:
            conn.commit()
            raise HTTPException(status_code=status.HTTP_502_BAD_GATEWAY, detail="Account created, but there was an issue sending your password email.")
        
        conn.commit()
        return models.RegistrationResponse(message="Account created successfully! Your password has been sent to your email address.")

    except HTTPException as http_exc:
        if conn: conn.rollback()
        raise http_exc
    finally:
        if conn: conn.close()

@app.post("/forgot_password", response_model=models.ForgotPasswordResponse, tags=["Authentication"])
async def handle_forgot_password(
    request_data: models.ForgotPasswordRequest,
    request: Request,
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    email = request_data.email.lower().strip()
    generic_response = models.ForgotPasswordResponse(message="If an account with this email exists and is active, a password reset email has been sent.")

    if not utils.is_valid_email(email):
        return generic_response

    client_ip = request.client.host if request.client else "unknown_ip"
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()

        cursor.execute(
            "INSERT INTO password_reset_attempts (email, ip_address, attempted_at) VALUES (?, ?, datetime('now'))",
            (email, client_ip)
        )
        
        time_window_start = datetime.datetime.now(datetime.timezone.utc) - datetime.timedelta(hours=config.FORGOT_PASSWORD_ATTEMPT_WINDOW_HOURS)
        cursor.execute(
            "SELECT COUNT(*) FROM password_reset_attempts WHERE email = ? AND attempted_at >= ?",
            (email, time_window_start.isoformat())
        )
        attempt_count_row = cursor.fetchone()
        recent_attempts = attempt_count_row[0] if attempt_count_row else 0

        if recent_attempts > config.FORGOT_PASSWORD_ATTEMPT_LIMIT:
            conn.commit()
            return generic_response

        cursor.execute("SELECT id, name FROM users WHERE email = ? AND is_active = 1", (email,))
        user_row = cursor.fetchone()

        if not user_row:
            conn.commit()
            return generic_response

        user_id = user_row["id"]
        user_name = user_row["name"]

        new_plain_password = database.generate_secure_token(12)
        new_hashed_password = auth.get_password_hash(new_plain_password)

        cursor.execute("UPDATE users SET password_hash = ?, updated_at = datetime('now') WHERE id = ?", (new_hashed_password, user_id))
        
        login_url_from_fastapi = str(request.url_for('get_login_page_route'))
        parsed_base_url = urlparse(config.BASE_URL)
        parsed_login_route_url = urlparse(login_url_from_fastapi)
        login_page_url = parsed_base_url._replace(path=parsed_login_route_url.path).geturl()
        
        email_sent = await email_utils.send_password_reset_email(
            recipient_email=email, recipient_name=user_name, new_password=new_plain_password, login_url=login_page_url
        )

        if not email_sent:
            conn.rollback()
            return generic_response
        
        conn.commit()
        return generic_response
    except Exception as e:
        if conn: conn.rollback()
        return generic_response
    finally:
        if conn: conn.close()

async def _ensure_csrf_for_cookie_auth(request: Request, csrf_protect: CsrfProtect):
    auth_header = request.headers.get("authorization")
    is_bearer_auth = auth_header and auth_header.lower().startswith("bearer ")
    if not is_bearer_auth:
        await csrf_protect.validate_csrf(request)

@app.put("/api/me/llm-settings", response_model=models.UserLLMSettingsResponse, tags=["User Account Management", "LLM Configuration"])
async def update_user_llm_settings(
    request: Request,
    settings_update: models.UserLLMSettingsUpdateRequest,
    current_user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    await _ensure_csrf_for_cookie_auth(request, csrf_protect)
    user_id = current_user["id"]
    conn = None

    if settings_update.selected_llm_provider_id:
        provider_config_info = config.LLM_PROVIDERS.get(settings_update.selected_llm_provider_id)
        if not provider_config_info:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=f"Invalid provider ID: {settings_update.selected_llm_provider_id}")
        
        available_models_for_provider = provider_config_info.get("available_models", [])
        if settings_update.selected_llm_model_id:
            model_found = any(model.get("model_id") == settings_update.selected_llm_model_id for model in available_models_for_provider)
            if not model_found:
                raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=f"Model ID not valid for provider.")
        elif available_models_for_provider:
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=f"A model ID must be selected for this provider.")

    encrypted_api_key_to_store: Optional[str] = None
    if settings_update.user_llm_api_key is not None:
        if settings_update.user_llm_api_key == "":
            encrypted_api_key_to_store = None
        else:
            if not config.APP_SECRET_KEY:
                raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="API key encryption service is unavailable.")
            encrypted_api_key_to_store = encryption_utils.encrypt_data(settings_update.user_llm_api_key)
            if not encrypted_api_key_to_store:
                raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Failed to secure API key.")
    
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT selected_llm_provider_id, selected_llm_model_id, user_llm_api_key_encrypted, selected_llm_base_url FROM users WHERE id = ?", (user_id,))
        current_db_settings = cursor.fetchone()
        if not current_db_settings:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="User settings record not found.")

        final_provider_id = settings_update.selected_llm_provider_id if settings_update.selected_llm_provider_id is not None else current_db_settings["selected_llm_provider_id"]
        final_model_id = settings_update.selected_llm_model_id if settings_update.selected_llm_model_id is not None else current_db_settings["selected_llm_model_id"]
        final_api_key_encrypted = encrypted_api_key_to_store if settings_update.user_llm_api_key is not None else current_db_settings["user_llm_api_key_encrypted"]
        final_base_url_str = str(settings_update.selected_llm_base_url) if settings_update.selected_llm_base_url else None
        
        cursor.execute(
            """UPDATE users SET
               selected_llm_provider_id = ?, selected_llm_model_id = ?, user_llm_api_key_encrypted = ?,
               selected_llm_base_url = ?, updated_at = datetime('now')
               WHERE id = ?""",
            (final_provider_id, final_model_id, final_api_key_encrypted, final_base_url_str, user_id)
        )
        conn.commit()

        has_user_api_key = bool(final_api_key_encrypted)
        updated_base_url_obj = HttpUrl(final_base_url_str) if final_base_url_str else None
        
        return models.UserLLMSettingsResponse(
            selected_llm_provider_id=final_provider_id,
            selected_llm_model_id=final_model_id,
            has_user_api_key=has_user_api_key,
            selected_llm_base_url=updated_base_url_obj
        )
    except Exception as e:
        if conn: conn.rollback()
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="An error occurred while updating settings.")
    finally:
        if conn: conn.close()

@app.post("/api/me/regenerate-password", response_model=models.RegeneratePasswordResponse, tags=["User Account Management"])
async def regenerate_user_password(
    request: Request,
    payload: models.RegeneratePasswordRequest = Body(...),
    current_user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    await _ensure_csrf_for_cookie_auth(request, csrf_protect)
    user_id = current_user.get("id")
    user_email = current_user.get("email")
    user_name = current_user.get("name", "User")
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT password_hash FROM users WHERE id = ?", (user_id,))
        user_record = cursor.fetchone()
        if not user_record or not auth.verify_password(payload.current_password, user_record["password_hash"]):
            raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Incorrect current password.")

        new_plain_password = database.generate_secure_token(12)
        new_hashed_password = auth.get_password_hash(new_plain_password)
        
        cursor.execute("UPDATE users SET password_hash = ?, updated_at = datetime('now') WHERE id = ?", (new_hashed_password, user_id))
        
        login_url = request.url_for('get_login_page_route')
        email_sent = await email_utils.send_password_reset_email(
            recipient_email=user_email, recipient_name=user_name, new_password=new_plain_password, login_url=str(login_url)
        )
        if not email_sent:
            conn.rollback()
            raise HTTPException(status_code=status.HTTP_502_BAD_GATEWAY, detail="Password change rolled back due to email failure.")

        now_utc_iso = datetime.datetime.now(datetime.timezone.utc).isoformat()
        cursor.execute(
            "UPDATE auth_tokens SET used_at = ?, expires_at = ? WHERE user_id = ? AND token_type = 'session' AND used_at IS NULL",
            (now_utc_iso, now_utc_iso, user_id)
        )
        conn.commit()
        return models.RegeneratePasswordResponse(message="Password regenerated successfully. Please check your email.")
    except HTTPException as http_exc:
        if conn: conn.rollback()
        raise http_exc
    finally:
        if conn: conn.close()

@app.patch("/api/me/update-email", response_model=models.UpdateEmailResponse, tags=["User Account Management"])
async def update_user_email(
    request: Request,
    payload: models.UpdateEmailRequest = Body(...),
    current_user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    await _ensure_csrf_for_cookie_auth(request, csrf_protect)
    user_id = current_user.get("id")
    new_email_normalized = payload.new_email.lower().strip()

    if not utils.is_valid_email(new_email_normalized):
        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="Invalid new email address format.")
    
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT password_hash FROM users WHERE id = ?", (user_id,))
        user_record = cursor.fetchone()
        if not user_record or not auth.verify_password(payload.current_password, user_record["password_hash"]):
            raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Incorrect current password.")

        cursor.execute("SELECT id FROM users WHERE email = ? AND id != ?", (new_email_normalized, user_id))
        if cursor.fetchone():
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="This email address is already in use.")

        cursor.execute("UPDATE users SET email = ?, updated_at = datetime('now') WHERE id = ?", (new_email_normalized, user_id))
        
        now_utc_iso = datetime.datetime.now(datetime.timezone.utc).isoformat()
        cursor.execute(
            "UPDATE auth_tokens SET used_at = ?, expires_at = ? WHERE user_id = ? AND token_type = 'session' AND used_at IS NULL",
            (now_utc_iso, now_utc_iso, user_id)
        )
        conn.commit()
        return models.UpdateEmailResponse(message="Email updated. You will be logged out.", new_email=new_email_normalized)
    except HTTPException as http_exc:
        if conn: conn.rollback()
        raise http_exc
    finally:
        if conn: conn.close()

@app.patch("/api/me/update-name", response_model=models.UpdateNameResponse, tags=["User Account Management"])
async def update_user_name(
    request: Request,
    update_data: models.UpdateNameRequest = Body(...),
    current_user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    await _ensure_csrf_for_cookie_auth(request, csrf_protect)
    user_id = current_user.get("id")
    new_name_stripped = update_data.new_name.strip()

    if not new_name_stripped:
        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail="New name cannot be empty.")
    
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT password_hash FROM users WHERE id = ?", (user_id,))
        user_record = cursor.fetchone()
        if not user_record or not auth.verify_password(update_data.current_password, user_record["password_hash"]):
            raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Incorrect current password.")

        cursor.execute("UPDATE users SET name = ?, updated_at = datetime('now') WHERE id = ?", (new_name_stripped, user_id))
        conn.commit()
        return models.UpdateNameResponse(message="Name updated successfully.", new_name=new_name_stripped)
    except HTTPException as http_exc:
        if conn: conn.rollback()
        raise http_exc
    finally:
        if conn: conn.close()

@app.get("/api/llm/providers", response_model=List[models.LLMProviderDetail], tags=["LLM Configuration"])
async def list_llm_providers(
    current_user: Optional[Dict[str, Any]] = Depends(auth.get_current_user)
):
    response_providers = []
    for provider_id, provider_data in config.LLM_PROVIDERS.items():
        provider_runtime_config = config.get_provider_config(provider_id)
        if not provider_runtime_config:
            continue

        api_key_env_var_name = provider_runtime_config.get("api_key_env_var_name")
        is_system_key_configured = bool(api_key_env_var_name and os.getenv(api_key_env_var_name))
        
        provider_type_can_use_key = provider_id in config.PROVIDERS_TYPICALLY_USING_API_KEYS or bool(api_key_env_var_name)
        needs_api_key_from_user = provider_type_can_use_key and not is_system_key_configured
        can_accept_user_api_key = provider_id in config.PROVIDERS_ALLOWING_USER_KEYS_EVEN_IF_SYSTEM_CONFIGURED or needs_api_key_from_user
        
        response_providers.append(
            models.LLMProviderDetail(
                id=provider_id,
                display_name=provider_data.get("display_name", provider_id),
                type=provider_runtime_config.get("type", "unknown"),
                is_system_configured=is_system_key_configured or not provider_type_can_use_key,
                can_accept_user_api_key=can_accept_user_api_key,
                needs_api_key_from_user=needs_api_key_from_user,
                available_models=[models.LLMAvailableModel(**m) for m in provider_data.get("available_models", [])],
                can_accept_user_base_url=provider_runtime_config.get("type") == "openai_compatible_server"
            )
        )
    return response_providers

# In app/main.py

@app.get("/api/me/llm-settings", response_model=models.UserLLMSettingsResponse, tags=["User Account Management", "LLM Configuration"])
async def get_user_llm_settings(
    current_user: Dict[str, Any] = Depends(auth.get_current_active_user)
):
    user_id = current_user["id"]
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT selected_llm_provider_id, selected_llm_model_id, user_llm_api_key_encrypted, selected_llm_base_url FROM users WHERE id = ?", (user_id,))
        settings = cursor.fetchone()
        if not settings:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="User LLM settings not found.")
        
        has_key = bool(settings["user_llm_api_key_encrypted"])
        base_url = HttpUrl(settings["selected_llm_base_url"]) if settings["selected_llm_base_url"] else None
        
        provider_id = settings["selected_llm_provider_id"]
        is_ready = False
        if provider_id and settings["selected_llm_model_id"]:
            provider_config_details = config.get_provider_config(provider_id)
            if provider_config_details:
                provider_type_needs_key = provider_id in config.PROVIDERS_TYPICALLY_USING_API_KEYS
                if not provider_type_needs_key:
                    is_ready = True
                else:
                    api_key_env_var = provider_config_details.get("api_key_env_var_name")
                    is_system_key_set = bool(api_key_env_var and os.getenv(api_key_env_var))
                    if has_key or is_system_key_set:
                        is_ready = True

        return models.UserLLMSettingsResponse(
            selected_llm_provider_id=settings["selected_llm_provider_id"],
            selected_llm_model_id=settings["selected_llm_model_id"],
            has_user_api_key=has_key,
            selected_llm_base_url=base_url,
            is_llm_ready=is_ready
        )
    finally:
        if conn: conn.close()

@app.get("/logout", tags=["Authentication"])
async def logout_route(
    request: Request,
    response: FastAPIResponse,
    session_token_value: Optional[str] = Depends(auth.cookie_scheme)
):
    await auth.logout_user(response, session_token_value)
    redirect_url = request.url_for('get_login_page_route')
    return RedirectResponse(url=str(redirect_url), status_code=status.HTTP_302_FOUND)

@app.get("/api/me", response_model=models.UserResponseModel, tags=["Users"])
async def get_current_user_details(
    user: Dict[str, Any] = Depends(auth.get_current_active_user)
):
    return models.UserResponseModel(id=user["id"], name=user["name"], email=user["email"])

@app.get("/api/sessions/{session_id}/code-results", response_model=List[Dict[str, Any]], tags=["Code Execution"])
async def get_session_code_execution_results(
    session_id: str = FastApiPath(..., description="The ID of the session to fetch code results for."),
    user: Dict[str, Any] = Depends(auth.get_current_active_user)
) -> List[Dict[str, Any]]:
    user_id = user.get('id')
    conn = database.get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT 1 FROM session_participants WHERE session_id = ? AND user_id = ?", (session_id, user_id))
    if not cursor.fetchone():
        conn.close()
        raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="Access denied.")
    conn.close()
    return database.get_code_execution_results(session_id)


@app.get("/api/sessions/{session_id}/edited-blocks", response_model=Dict[str, str], tags=["Sessions"])
async def get_session_edited_blocks(
    session_id: str = FastApiPath(..., description="The ID of the session to fetch edited code blocks for."),
    user: Dict[str, Any] = Depends(auth.get_current_active_user)
):
    conn = database.get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT 1 FROM session_participants WHERE session_id = ? AND user_id = ?", (session_id, user['id']))
    if not cursor.fetchone():
        conn.close()
        raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="Access denied.")
    conn.close()
    return database.get_edited_code_blocks(session_id)

@app.get("/api/sessions/{session_id}/messages", response_model=List[models.MessageItem], tags=["Messages"])
async def get_chat_messages_for_session(
    session_id: str = FastApiPath(..., description="The ID of the session to fetch messages for."),
    user: Dict[str, Any] = Depends(auth.get_current_active_user)
) -> List[models.MessageItem]:
    user_id = user.get('id')
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT 1 FROM session_participants WHERE session_id = ? AND user_id = ?", (session_id, user_id))
        if not cursor.fetchone():
            raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="Access denied.")
        
        cursor.execute("SELECT * FROM chat_messages WHERE session_id = ? ORDER BY timestamp ASC", (session_id,))
        return [models.MessageItem(**dict(row)) for row in cursor.fetchall()]
    finally:
        if conn: conn.close()

@app.post("/api/sessions/{session_id}/join", status_code=status.HTTP_200_OK, tags=["Sessions"])
async def join_session(
    request: Request,
    session_id: str = FastApiPath(..., description="The ID of the session to join."),
    payload: models.JoinSessionRequest = Body(None), # Can be empty or contain passcode
    user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    user_id = user['id']
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT access_level, passcode_hash FROM sessions WHERE id = ? AND is_active = 1", (session_id,))
        session = cursor.fetchone()

        if not session:
            raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Session not found or is not active.")

        if session["access_level"] == 'protected':
            if not payload or not payload.passcode:
                raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="A passcode is required to join this protected session.")
            if not auth.verify_password(payload.passcode, session["passcode_hash"]):
                raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="Incorrect passcode.")
        elif session["access_level"] != 'public':
             raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="This session is private and cannot be joined.")

        cursor.execute(
            "INSERT OR IGNORE INTO session_participants (session_id, user_id) VALUES (?, ?)",
            (session_id, user_id)
        )
        conn.commit()
        chat_url = request.url_for("get_chat_page_for_session", session_id=session_id)
        return {"redirect_url": str(chat_url)}
    except sqlite3.Error as e:
        if conn: conn.rollback()
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Database error while trying to join session.")
    finally:
        if conn: conn.close()

def _get_session_participants_logic(session_id: str, user_id: int) -> Optional[List[models.UserResponseModel]]:
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT 1 FROM session_participants WHERE session_id = ? AND user_id = ?", (session_id, user_id))
        if not cursor.fetchone():
            return None
        
        cursor.execute(
            """SELECT u.id, u.name, u.email FROM users u JOIN session_participants sp ON u.id = sp.user_id WHERE sp.session_id = ?""",
            (session_id,)
        )
        return [models.UserResponseModel(**dict(row)) for row in cursor.fetchall()]
    except sqlite3.Error:
        return None
    finally:
        if conn: conn.close()

@app.get("/api/sessions/{session_id}/participants", response_model=List[models.UserResponseModel], tags=["Sessions"])
async def get_session_participants(
    session_id: str = FastApiPath(..., description="The session ID."),
    user: Dict[str, Any] = Depends(auth.get_current_active_user)
):
    user_id = user['id']
    participants = _get_session_participants_logic(session_id, user_id)
    if participants is None:
        raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="You are not a participant of this session.")
    return participants

# In app/main.py

PARTICIPANT_COLORS = [
    "#E0F2FE",  # sky-100
    "#D1FAE5",  # emerald-100
    "#FEF3C7",  # amber-100
    "#FFE4E6",  # rose-100
    "#F3E8FF",  # purple-100
    "#E0E7FF",  # indigo-100
    "#DBEAFE",  # blue-100
    "#CFFAFE",  # cyan-100
    "#D1F2EB",  # teal-100
    "#FCE7F3",  # pink-100
]

def _generate_unique_initials(participants: List[Dict]) -> List[Dict]:
    """Generates unique initials for a list of participants."""
    # This is a simplified version; a more robust one would handle collisions more gracefully
    for p in participants:
        names = p['name'].split()
        if len(names) > 1:
            p['initials'] = (names[0][0] + names[-1][0]).upper()
        else:
            p['initials'] = names[0][:2].upper()
    # In a real app, you'd add logic here to check for duplicate initials and extend them (e.g., VJ -> VJO)
    return participants

def _get_session_participants_logic(session_id: str, user_id: int) -> Optional[List[models.UserResponseModel]]:
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT 1 FROM session_participants WHERE session_id = ? AND user_id = ?", (session_id, user_id))
        if not cursor.fetchone():
            return None
        
        cursor.execute(
            """SELECT u.id, u.name, u.email FROM users u JOIN session_participants sp ON u.id = sp.user_id WHERE sp.session_id = ? ORDER BY u.name""",
            (session_id,)
        )
        participants = [dict(row) for row in cursor.fetchall()]
        
        # Generate initials and assign colors
        participants = _generate_unique_initials(participants)
        for i, p in enumerate(participants):
            p['color'] = PARTICIPANT_COLORS[p['id'] % len(PARTICIPANT_COLORS)]

        return [models.UserResponseModel(**p) for p in participants]
    except sqlite3.Error:
        return None
    finally:
        if conn: conn.close()

@app.websocket("/ws/{session_id_ws}/{client_js_id}")
async def websocket_endpoint(
    websocket: WebSocket,
    session_id_ws: str = FastApiPath(..., title="Session ID"),
    client_js_id: str = FastApiPath(..., title="Client JS ID")
):
    session_token_from_cookie = websocket.cookies.get(auth.SESSION_COOKIE_NAME)
    if not session_token_from_cookie:
        await websocket.close(code=status.WS_1008_POLICY_VIOLATION)
        return
    
    current_ws_user = await auth.get_user_by_session_token_internal(session_token_from_cookie)
    if not current_ws_user:
        await websocket.close(code=status.WS_1008_POLICY_VIOLATION)
        return
    
    user_id = current_ws_user.get('id')
    user_name = current_ws_user.get('name')
    if not user_id:
        await websocket.close(code=status.WS_1011_INTERNAL_ERROR)
        return

    participants = _get_session_participants_logic(session_id_ws, user_id)
    if participants is None:
        await websocket.close(code=status.WS_1008_POLICY_VIOLATION)
        return
    
    await websocket.accept()
    await state.connect(session_id_ws, websocket)

    async def broadcast_participants():
        live_participants = _get_session_participants_logic(session_id_ws, user_id)
        if live_participants is not None:
            await state.broadcast(session_id_ws, {
                "type": "participants_update",
                "payload": [p.model_dump() for p in live_participants]
            })

    await broadcast_participants()
    
    try:
        while True:
            received_data = await websocket.receive_text()
            message_data = json.loads(received_data)
            message_type = message_data.get("type")
            payload = message_data.get("payload")

            if message_type == "chat_message" and payload:
                user_input_raw = payload.get("user_input")
                turn_id = payload.get("turn_id")
                recipient_ids = payload.get("recipient_ids", [])
                reply_to_id = payload.get("reply_to_id")
                
                user_input_cleaned = user_input_raw
                if user_input_raw.startswith(config.NO_THINK_PREFIX):
                    user_input_cleaned = user_input_raw[len(config.NO_THINK_PREFIX):].lstrip()
                
                db_conn = database.get_db_connection()
                cursor = db_conn.cursor()
                cursor.execute(
                    """INSERT INTO chat_messages (session_id, user_id, sender_name, sender_type, content, client_id_temp, turn_id, reply_to_message_id, timestamp) 
                       VALUES (?, ?, ?, ?, ?, ?, ?, ?, datetime('now', 'utc'))""",
                    (session_id_ws, user_id, user_name, 'user', user_input_cleaned, client_js_id, turn_id, reply_to_id)
                )
                message_id = cursor.lastrowid
                db_conn.commit()
                cursor.execute("SELECT * FROM chat_messages WHERE id = ?", (message_id,))
                new_msg_row = cursor.fetchone()
                db_conn.close()

                current_participants = _get_session_participants_logic(session_id_ws, user_id)
                sender_info = next((p for p in current_participants if p.id == user_id), None)

                message_model = models.MessageItem(**dict(new_msg_row))
                if sender_info:
                    message_model.sender_color = sender_info.color

                await state.broadcast(
                    session_id_ws,
                    {"type": "new_message", "payload": message_model.model_dump()}
                )

                if any(recipient.upper() == 'AI' for recipient in recipient_ids):
                    stream_id = f"{session_id_ws}-{client_js_id}-{turn_id}"
                    asyncio.create_task(
                        llm.invoke_llm_for_session(
                            session_id=session_id_ws,
                            websocket=websocket,
                            user_id=user_id,
                            user_input_raw=user_input_raw,
                            turn_id=turn_id,
                            stream_id=stream_id,
                            reply_to_message_id=reply_to_id
                        )
                    )
            
            elif message_type == "stop_ai_stream" and payload:
                turn_id = payload.get("turn_id")
                stream_id_to_stop = f"{session_id_ws}-{client_js_id}-{turn_id}"
                await state.signal_stop_ai_stream(stream_id_to_stop)

            elif message_type == "run_code" and payload:
                asyncio.create_task(docker_utils.run_code_in_docker_stream(
                    websocket, client_js_id, payload['code_block_id'], payload['language'], payload['code']
                ))

            elif message_type == "stop_code" and payload:
                await docker_utils.stop_docker_container(payload['code_block_id'])

            elif message_type == "code_input" and payload:
                await docker_utils.send_input_to_container(payload['code_block_id'], payload['input'])
            
            elif message_type == "save_code_content" and payload:
                database.save_edited_code_content(
                    payload['session_id'], payload['code_block_id'], payload['language'], payload['code_content']
                )
                state.remove_memory_for_client(payload['session_id'])
            
            elif message_type == "save_code_result" and payload:
                payload['session_id'] = session_id_ws
                database.save_code_execution_result(**payload)
                state.remove_memory_for_client(session_id_ws)

    except WebSocketDisconnect:
        print(f"Client {client_js_id} (User {user_id}) disconnected.")
    finally:
        await state.disconnect(session_id_ws, websocket)
        await broadcast_participants()
        await docker_utils.cleanup_client_containers(client_js_id)

@app.get("/api/sessions", response_model=List[models.SessionResponseModel], tags=["Sessions"])
async def get_user_sessions(
    request: Request,
    response: FastAPIResponse,
    scope: str = "personal",
    user: Dict[str, Any] = Depends(auth.get_current_active_user)
) -> List[models.SessionResponseModel]:
    response.headers["Cache-Control"] = "no-store"
    user_id = user.get('id')
    
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        
        user_session_ids = {row['session_id'] for row in cursor.execute("SELECT session_id FROM session_participants WHERE user_id = ? AND is_hidden = 0", (user_id,))}

        if scope == "joinable":
            cursor.execute(
                """SELECT s.id, s.name, s.created_at, s.last_accessed_at AS last_active, s.host_user_id, s.access_level, s.is_active
                   FROM sessions s
                   WHERE s.is_active = 1 AND s.access_level IN ('public', 'protected')
                   ORDER BY s.created_at DESC"""
            )
        else: # "personal" scope
            cursor.execute(
                """SELECT s.id, s.name, s.created_at, s.last_accessed_at AS last_active, s.host_user_id, s.access_level, s.is_active
                   FROM sessions s
                   JOIN session_participants sp ON s.id = sp.session_id
                   WHERE sp.user_id = ? AND sp.is_hidden = 0
                   ORDER BY s.is_active DESC, s.last_accessed_at DESC""",
                (user_id,)
            )
        
        rows = cursor.fetchall()
        sessions_list = []
        for row in rows:
            session_dict = dict(row)
            session_dict['is_member'] = session_dict['id'] in user_session_ids
            sessions_list.append(models.SessionResponseModel(**session_dict))
            
        return sessions_list
    finally:
        if conn: conn.close()

@app.delete("/api/sessions/{session_id}", status_code=status.HTTP_204_NO_CONTENT, tags=["Sessions"])
async def delete_session_route(
    request: Request,
    session_id: str = FastApiPath(..., description="The ID of the session to leave or delete."),
    user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    user_id = user.get('id')
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()

        cursor.execute("SELECT host_user_id, access_level, is_active FROM sessions WHERE id = ?", (session_id,))
        session = cursor.fetchone()

        if not session:
            return Response(status_code=status.HTTP_204_NO_CONTENT)

        is_host = (session["host_user_id"] == user_id)

        if not session["is_active"]:
            # If the session is already inactive, the action is always to hide it from history.
            cursor.execute(
                "UPDATE session_participants SET is_hidden = 1 WHERE session_id = ? AND user_id = ?",
                (session_id, user_id)
            )
        elif is_host and session["access_level"] == 'private':
            cursor.execute("UPDATE sessions SET is_active = 0 WHERE id = ?", (session_id,))
        elif not is_host:
            cursor.execute(
                "DELETE FROM session_participants WHERE session_id = ? AND user_id = ?",
                (session_id, user_id)
            )
        
        conn.commit()
        return Response(status_code=status.HTTP_204_NO_CONTENT)
    finally:
        if conn: conn.close()

@app.delete("/api/sessions/{session_id}/edited-blocks/{code_block_id}", status_code=status.HTTP_204_NO_CONTENT, tags=["Code Execution"])
async def delete_edited_code_block_route(
    request: Request,
    session_id: str = FastApiPath(..., description="The session ID."),
    code_block_id: str = FastApiPath(..., description="The code block ID to restore."),
    user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    conn = database.get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT 1 FROM session_participants WHERE session_id = ? AND user_id = ?", (session_id, user['id']))
    if not cursor.fetchone():
        conn.close()
        raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="Access denied.")
    conn.close()
    if not database.delete_edited_code_block(session_id, code_block_id):
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Failed to restore code block.")
    state.remove_memory_for_client(session_id)
    return

@app.websocket("/ws/lobby")
async def websocket_lobby_endpoint(websocket: WebSocket):
    session_token = websocket.cookies.get(auth.SESSION_COOKIE_NAME)
    if not session_token or not await auth.get_user_by_session_token_internal(session_token):
        await websocket.close(code=status.WS_1008_POLICY_VIOLATION)
        return

    await state.connect_to_lobby(websocket)
    try:
        while True:
            # Keep the connection alive
            await websocket.receive_text()
    except WebSocketDisconnect:
        await state.disconnect_from_lobby(websocket)

@app.delete("/api/sessions/{session_id}/delete-by-host", status_code=status.HTTP_204_NO_CONTENT, tags=["Sessions"])
async def delete_session_by_host(
    request: Request,
    session_id: str = FastApiPath(..., description="The ID of the session to delete."),
    user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    user_id = user.get('id')
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT host_user_id FROM sessions WHERE id = ?", (session_id,))
        session = cursor.fetchone()
        if not session or session['host_user_id'] != user_id:
            raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="You are not the host of this session and cannot delete it.")
        
        # Mark the session as inactive instead of a hard delete
        cursor.execute("UPDATE sessions SET is_active = 0 WHERE id = ?", (session_id,))
        conn.commit()

        # Notify clients in the lobby and the session itself
        delete_payload = {"type": "session_deleted", "payload": {"session_id": session_id}}
        await state.broadcast_to_lobby(delete_payload)
        await state.broadcast(session_id, delete_payload)

        return Response(status_code=status.HTTP_204_NO_CONTENT)
    except sqlite3.Error:
        if conn: conn.rollback()
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Database error during session deletion.")
    finally:
        if conn: conn.close()

@app.delete("/api/sessions/{session_id}", status_code=status.HTTP_204_NO_CONTENT, tags=["Sessions"])
async def delete_session_route(
    request: Request,
    session_id: str = FastApiPath(..., description="The ID of the session to leave or delete."),
    user: Dict[str, Any] = Depends(auth.get_current_active_user),
    csrf_protect: CsrfProtect = Depends()
):
    await csrf_protect.validate_csrf(request)
    user_id = user.get('id')
    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()

        cursor.execute("SELECT host_user_id, access_level FROM sessions WHERE id = ? AND is_active = 1", (session_id,))
        session = cursor.fetchone()

        if not session:
            return Response(status_code=status.HTTP_204_NO_CONTENT)

        is_host = (session["host_user_id"] == user_id)

        if is_host:
            # A host cannot leave their own session via this method. 
            # This endpoint is now only for "leaving" as a participant or deleting a private session.
            # Deleting public/protected sessions will be a separate action.
            if session["access_level"] == 'private':
                cursor.execute("UPDATE sessions SET is_active = 0 WHERE id = ?", (session_id,))
                print(f"---- SERVER LOG: Private session '{session_id}' deleted by host '{user_id}'.")
            else:
                # A host trying to "leave" a public session does nothing here.
                # This action will be handled on the client-side as "hide".
                print(f"---- SERVER LOG: Host '{user_id}' attempted to leave public/protected session '{session_id}'. Action ignored on backend.")
                pass
        else:
            # If the user is not the host, they are "leaving" the session.
            cursor.execute(
                "DELETE FROM session_participants WHERE session_id = ? AND user_id = ?",
                (session_id, user_id)
            )
            print(f"---- SERVER LOG: User '{user_id}' left session '{session_id}'.")

        conn.commit()
        return Response(status_code=status.HTTP_204_NO_CONTENT)

    except sqlite3.Error as e:
        if conn: conn.rollback()
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Database error while processing your request.")
    finally:
        if conn: conn.close()

@app.on_event("startup")
async def startup_event():
    print("Application startup: Initializing database...")
    db_parent_dir = config.DATABASE_PATH.parent
    if not db_parent_dir.exists():
        db_parent_dir.mkdir(parents=True, exist_ok=True)
    database.init_db()
    print("Database initialization check complete.")

if config.STATIC_DIR and config.STATIC_DIR.is_dir():
    dist_dir = config.STATIC_DIR / "dist"
    if dist_dir.is_dir():
        app.mount("/dist", StaticFiles(directory=dist_dir), name="dist_assets")
    app.mount("/static", StaticFiles(directory=config.STATIC_DIR), name="static_general")



=== app/models.py ===
from pydantic import BaseModel, Field, EmailStr, StringConstraints, HttpUrl
from pydantic_settings import BaseSettings
from typing import Optional, List, Dict, Any, Annotated

class LLMAvailableModel(BaseModel):
    model_id: str
    display_name: str
    context_window: Optional[int] = None

class LLMProviderDetail(BaseModel):
    id: str
    display_name: str
    type: str
    is_system_configured: bool
    needs_api_key_from_user: bool
    can_accept_user_api_key: bool
    can_accept_user_base_url: bool
    available_models: List[LLMAvailableModel]

class UserLLMSettingsResponse(BaseModel):
    selected_llm_provider_id: Optional[str] = None
    selected_llm_model_id: Optional[str] = None
    has_user_api_key: bool = False
    selected_llm_base_url: Optional[HttpUrl] = None
    is_llm_ready: bool = False

class UserLLMSettingsUpdateRequest(BaseModel):
    selected_llm_provider_id: Optional[str] = Field(None, description="ID of the selected LLM provider (e.g., 'ollama_local'). Use null to clear.")
    selected_llm_model_id: Optional[str] = Field(None, description="ID of the selected model (e.g., 'qwen2:7b-instruct-q4_K_M'). Use null to clear if provider allows.")
    user_llm_api_key: Optional[str] = Field(None, description="User-provided API key. Will be encrypted. Send empty string or null to clear.")
    selected_llm_base_url: Optional[HttpUrl] = Field(None, description="User-defined base URL. Send empty string or null to clear.")

class Token(BaseModel):
    access_token: str
    token_type: str
    user_id: Optional[int] = None
    user_name: Optional[str] = None
    user_email: Optional[EmailStr] = None



class EmailCheckRequest(BaseModel):
    email: EmailStr

class EmailCheckResponse(BaseModel):
    exists: bool
    user_name: Optional[str] = None

class RegistrationRequest(BaseModel):
    email: EmailStr
    name: Annotated[str, StringConstraints(strip_whitespace=True, min_length=1, max_length=100)]

class RegistrationResponse(BaseModel):
    message: str

class ForgotPasswordRequest(BaseModel):
    email: EmailStr

class ForgotPasswordResponse(BaseModel):
    message: str

class UpdateNameRequest(BaseModel):
    new_name: Annotated[str, StringConstraints(strip_whitespace=True, min_length=1, max_length=100)]
    current_password: str = Field(..., min_length=1)

class UpdateNameResponse(BaseModel):
    message: str
    new_name: str

class RegeneratePasswordRequest(BaseModel):
    current_password: str = Field(..., min_length=1, description="The user's current password for verification.")

class RegeneratePasswordResponse(BaseModel):
    message: str

class UpdateEmailRequest(BaseModel):
    new_email: EmailStr
    current_password: str = Field(..., min_length=1, description="The user's current password for verification.")

class UpdateEmailResponse(BaseModel):
    message: str
    new_email: EmailStr

class SessionUpdateRequest(BaseModel):
    name: Annotated[str, StringConstraints(strip_whitespace=True, min_length=1, max_length=100)]

class SessionResponseModel(BaseModel):
    id: str
    name: Optional[str] = None
    created_at: Optional[str] = None
    last_active: Optional[str] = None
    host_user_id: Optional[int] = None
    is_member: bool = False
    access_level: Optional[str] = None
    is_active: bool = True

class SessionListContainerResponse(BaseModel):
    sessions: List[SessionResponseModel]

class UserResponseModel(BaseModel):
    id: int
    name: str
    email: EmailStr
    initials: str = ""
    color: str = "#E5E7EB"

class MessageItem(BaseModel):
    id: int
    session_id: str
    user_id: Optional[int] = None
    sender_name: Optional[str] = None
    sender_type: str
    content: str
    client_id_temp: Optional[str] = None
    thinking_content: Optional[str] = None
    timestamp: str
    turn_id: Optional[int] = None
    model_provider_id: Optional[str] = None
    model_id: Optional[str] = None
    reply_to_message_id: Optional[int] = None
    sender_initials: Optional[str] = None
    sender_color: Optional[str] = None

class MessageListContainerResponse(BaseModel):
    messages: List[MessageItem]

class HostSessionRequest(BaseModel):
    name: Annotated[str, StringConstraints(strip_whitespace=True, min_length=1, max_length=100)]
    access_level: str = 'private' # 'private', 'public', 'protected', 'unlisted'
    passcode: Optional[str] = None

class JoinSessionRequest(BaseModel):
    passcode: Optional[str] = None


=== app/state.py ===
import asyncio
import json
import sqlite3
import datetime
from langchain.memory import ConversationBufferMemory
from langchain_core.messages import messages_from_dict, messages_to_dict
from typing import Dict, Any, Optional, List
from fastapi import WebSocket
from . import database
import traceback

client_memory: Dict[str, ConversationBufferMemory] = {}
running_containers: Dict[str, Dict[str, Any]] = {}
running_containers_lock = asyncio.Lock()
active_ai_streams: Dict[str, asyncio.Event] = {}
active_ai_streams_lock = asyncio.Lock()

import re

def get_memory_for_client(session_id: str) -> ConversationBufferMemory:
    global client_memory
    if session_id in client_memory:
        return client_memory[session_id]

    conn = None
    try:
        conn = database.get_db_connection()
        cursor = conn.cursor()

        cursor.execute(
            "SELECT * FROM chat_messages WHERE session_id = ? ORDER BY timestamp ASC",
            (session_id,)
        )
        messages_rows = cursor.fetchall()

        edited_blocks = database.get_edited_code_blocks(session_id)

        reconstructed_messages = []
        for row in messages_rows:
            msg = dict(row)
            if msg['sender_type'] == 'ai' and msg['content'] and edited_blocks:
                code_block_counter = 0

                def process_code_block_for_context(match):
                    nonlocal code_block_counter
                    code_block_counter += 1

                    turn_id = msg.get('turn_id')
                    if turn_id is None:
                        return match.group(0)

                    block_id = f"code-block-turn{turn_id}-{code_block_counter}"
                    original_block_text = match.group(0)
                    edited_code = edited_blocks.get(block_id)

                    if edited_code is not None:
                        language = match.group(1)
                        edited_block_text = f"```{language}\n{edited_code}\n```"
                        return f"{original_block_text}\n\n(after edit by user:...)\n\n{edited_block_text}"
                    else:
                        return original_block_text

                code_block_regex = r"```(\w*)\n([\s\S]*?)\n```"
                msg['content'] = re.sub(code_block_regex, process_code_block_for_context, msg['content'])

            reconstructed_messages.append(msg)

        if reconstructed_messages:
            memory_instance = ConversationBufferMemory(return_messages=True, memory_key="history")

            langchain_messages = []
            for msg in reconstructed_messages:
                if msg['sender_type'] == 'user':
                    langchain_messages.append({"type": "human", "data": {"content": msg['content']}})
                elif msg['sender_type'] == 'ai':
                    langchain_messages.append({"type": "ai", "data": {"content": msg['content']}})

            memory_instance.chat_memory.messages = messages_from_dict(langchain_messages)
            client_memory[session_id] = memory_instance
            print(f"STATE: Memory loaded from DB and reconstructed for session {session_id}")
            return memory_instance

    except Exception as e:
        print(f"STATE ERROR: Failed to load/reconstruct memory for session {session_id}: {e}")
        traceback.print_exc()
    finally:
        if conn:
            conn.close()

    print(f"STATE: Creating new memory for session {session_id}")
    new_memory = ConversationBufferMemory(return_messages=True, memory_key="history")
    client_memory[session_id] = new_memory
    return new_memory

def save_memory_state_to_db(session_id: str, memory: Optional[ConversationBufferMemory]):
    if not memory:
        print(f"STATE WARNING (save_memory): Attempted to save null memory for session {session_id}. Skipping.")
        return

    conn = None
    print(f"STATE ATTEMPT (save_memory): Saving memory state to DB for session {session_id}.")
    try:
        messages = memory.chat_memory.messages
        memory_state_list = messages_to_dict(messages)
        memory_state_json = json.dumps(memory_state_list)
        
        current_time_utc = datetime.datetime.now(datetime.timezone.utc).isoformat()

        conn = database.get_db_connection()
        cursor = conn.cursor()
        print(f"STATE PRE-EXECUTE (save_memory): About to execute INSERT OR REPLACE for session {session_id}.")
        cursor.execute(
            """
            INSERT OR REPLACE INTO session_memory_state 
            (session_id, memory_state_json, updated_at) 
            VALUES (?, ?, ?)
            """,
            (session_id, memory_state_json, current_time_utc)
        )
        print(f"STATE POST-EXECUTE (save_memory): SQL executed for session {session_id}.")
        conn.commit()
        print(f"STATE SUCCESS (save_memory): Memory saved and committed to DB for session {session_id}.")
    except json.JSONDecodeError as json_err:
        print(f"STATE JSON ERROR (save_memory): Failed to serialize memory for session {session_id}: {json_err}")
        traceback.print_exc()
        if conn:
            conn.rollback()
    except sqlite3.Error as db_err:
        print(f"STATE DB ERROR (save_memory): Failed to save memory state to DB for session {session_id}: {db_err}")
        traceback.print_exc()
        if conn:
            conn.rollback()
    except Exception as e:
        print(f"STATE UNEXPECTED ERROR (save_memory): Failed to save memory state for session {session_id}: {e}")
        traceback.print_exc()
        if conn:
            conn.rollback()
    finally:
        if conn:
            conn.close()
            print(f"STATE FINALLY (save_memory): DB connection closed for session {session_id}.")

def remove_memory_for_client(session_id: str):
    global client_memory
    if session_id in client_memory:
        del client_memory[session_id]
        print(f"STATE: Memory cache cleared for session {session_id} due to data change.")

async def register_ai_stream(stream_id: str) -> asyncio.Event:
    async with active_ai_streams_lock:
        if stream_id in active_ai_streams:
            print(f"STATE WARNING: Stream ID {stream_id} already registered. Overwriting stop event.")
        stop_event = asyncio.Event()
        active_ai_streams[stream_id] = stop_event
        print(f"STATE: AI stream {stream_id} registered for stopping.")
        return stop_event

async def unregister_ai_stream(stream_id: str):
    async with active_ai_streams_lock:
        if stream_id in active_ai_streams:
            del active_ai_streams[stream_id]
            print(f"STATE: AI stream {stream_id} unregistered.")
        else:
            print(f"STATE WARNING: Attempted to unregister non-existent AI stream {stream_id}.")

async def signal_stop_ai_stream(stream_id: str) -> bool:
    async with active_ai_streams_lock:
        stop_event = active_ai_streams.get(stream_id)
        if stop_event:
            stop_event.set()
            print(f"STATE: Stop signal sent to AI stream {stream_id}.")
            return True
        else:
            print(f"STATE WARNING: Attempted to signal stop for non-existent AI stream {stream_id}.")
            return False

# --- WebSocket Connection Manager ---
active_connections: Dict[str, List[WebSocket]] = {}
active_connections_lock = asyncio.Lock()

async def connect(session_id: str, websocket: WebSocket):
    async with active_connections_lock:
        if session_id not in active_connections:
            active_connections[session_id] = []
        active_connections[session_id].append(websocket)
        print(f"STATE: WebSocket connected to session {session_id}. Total connections: {len(active_connections[session_id])}")

async def disconnect(session_id: str, websocket: WebSocket):
    async with active_connections_lock:
        if session_id in active_connections:
            try:
                active_connections[session_id].remove(websocket)
                if not active_connections[session_id]:
                    del active_connections[session_id]
                print(f"STATE: WebSocket disconnected from session {session_id}.")
            except ValueError:
                print(f"STATE WARNING: WebSocket to disconnect not found in session {session_id}.")

async def broadcast(session_id: str, message: dict, exclude_websocket: Optional[WebSocket] = None):
    websockets_to_send = []
    async with active_connections_lock:
        if session_id in active_connections:
            for ws in active_connections[session_id]:
                if ws != exclude_websocket:
                    websockets_to_send.append(ws)
    
    if websockets_to_send:
        await asyncio.gather(
            *[ws.send_json(message) for ws in websockets_to_send],
            return_exceptions=True
        )


# In app/state.py, at the end of the file

# --- WebSocket Lobby Connection Manager ---
lobby_connections: List[WebSocket] = []
lobby_connections_lock = asyncio.Lock()

async def connect_to_lobby(websocket: WebSocket):
    await websocket.accept()
    async with lobby_connections_lock:
        lobby_connections.append(websocket)
        print(f"STATE: WebSocket connected to lobby. Total connections: {len(lobby_connections)}")

async def disconnect_from_lobby(websocket: WebSocket):
    async with lobby_connections_lock:
        try:
            lobby_connections.remove(websocket)
            print(f"STATE: WebSocket disconnected from lobby.")
        except ValueError:
            pass # Socket already removed

async def broadcast_to_lobby(message: dict):
    websockets_to_send = []
    async with lobby_connections_lock:
        websockets_to_send = [ws for ws in lobby_connections]
    
    print(f"--- LOG: 4. `broadcast_to_lobby` called. Broadcasting to {len(websockets_to_send)} clients. ---")
    print(f"--- LOG:    Message payload: {message}")

    if websockets_to_send:
        results = await asyncio.gather(
            *[ws.send_json(message) for ws in websockets_to_send],
            return_exceptions=True
        )
        for i, result in enumerate(results):
            if isinstance(result, Exception):
                print(f"--- LOG ERROR: Failed to send broadcast to client {i}: {result}")
    else:
        print("--- LOG: No clients in lobby to broadcast to.")

=== app/utils.py ===
# app/utils.py

from fastapi import WebSocket, WebSocketDisconnect
from fastapi.websockets import WebSocketState
import re
import html
import traceback
from typing import Any

def escape_html(s: str) -> str:
    """
    Escapes a string for safe inclusion in HTML, preventing XSS.
    """
    if not isinstance(s, str):
        s = str(s) # Ensure it's a string
    return html.escape(s)

def is_valid_email(email: str) -> bool:
    """
    Validates an email address.
    (This is a basic example, consider a more robust library for production)
    """
    if not email:
        return False
    # Basic regex for email validation
    pattern = r"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
    if re.match(pattern, email):
        return True
    return False

async def send_ws_message(websocket: WebSocket, message_type: str, payload: Any):
    """Safely sends a JSON message over the WebSocket."""
    code_block_id = payload.get('code_block_id', 'N/A') if isinstance(payload, dict) else 'N/A'
    
    print(f"[utils] Attempting to send {message_type} for {code_block_id}")
    
    if websocket.client_state != WebSocketState.CONNECTED:
        print(f"[utils] ✗ WebSocket not connected (state: {websocket.client_state.name}), cannot send {message_type} for {code_block_id}")
        return False
        
    try:
        message = {"type": message_type, "payload": payload}
        await websocket.send_json(message)
        print(f"[utils] ✓ Successfully sent {message_type} for {code_block_id}")
        return True
    except WebSocketDisconnect:
        print(f"[utils] ✗ WebSocket disconnected while trying to send {message_type} for {code_block_id}")
        return False
    except Exception as e:
        print(f"[utils] ✗ Error sending WebSocket message ({message_type}) for {code_block_id}: {e}")
        traceback.print_exc()
        return False

=== app/static/_sidebar.html ===
<div class="p-4 border-b border-gray-700 flex items-center justify-between">
    <h2 class="text-xl font-semibold text-white">Tesseracs</h2>
    <a href="/" title="Home" aria-label="Home" class="text-gray-400 hover:text-white">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
    </a>
</div>

<nav class="flex-1 p-4 space-y-2 sidebar-scrollable flex flex-col" aria-label="Main navigation">
    <div class="mb-4">
        <input type="text" id="session-filter-input" placeholder="Filter my sessions..." class="w-full bg-gray-700 text-white rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <div class="text-sm text-gray-400 uppercase tracking-wider mb-2" id="sessions-heading">My Sessions</div>
    <ul id="session-list" class="space-y-1 flex-grow">
        <li class="px-3 py-1 text-gray-400 italic text-sm">Loading sessions...</li>
    </ul>

    <div class="mt-auto pt-4 border-t border-gray-700">
        <a href="/settings" id="user-settings-link-sidebar" class="flex items-center px-3 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md text-sm">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            User Settings
        </a>
    </div>
</nav>

<div class="p-4 border-t border-gray-700">
    <a href="/logout" id="logout-link-sidebar" class="flex items-center justify-center w-full px-4 py-2 border border-gray-600 hover:bg-gray-700 rounded-md text-sm font-medium text-gray-300 hover:text-white transition duration-150 ease-in-out">
        Logout
    </a>
</div>

=== app/static/chat-session.html ===
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>%%SESSION_NAME_PLACEHOLDER%% - Tesseracs Chat</title>
    <link rel="stylesheet" href="/dist/input.css">
    <link rel="stylesheet" href="/static/assets/css/katex.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script id="csrf-token-script-page-chat">
        window.csrfTokenRaw = "%%CSRF_TOKEN_RAW%%";
    </script>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen overflow-hidden bg-gray-100">
        <!-- Sidebar -->
        <aside id="sidebar-loader-target" class="w-64 bg-gray-800 text-gray-200 flex flex-col shrink-0 transition-all duration-300 ease-in-out">
            <!-- Sidebar content is loaded dynamically -->
        </aside>

        <!-- Sidebar Toggle Button -->
        <div class="relative z-10 flex items-center justify-center">
            <button id="sidebar-toggle" class="absolute top-1/2 -translate-y-1/2 -ml-4 bg-gray-700 hover:bg-gray-600 text-white p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 ease-in-out">
                <svg id="sidebar-toggle-icon" class="w-5 h-5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
        </div>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white border-b border-gray-200 p-4 shadow-sm flex items-center justify-between">
                <h1 id="chat-session-title" class="text-lg font-semibold text-gray-800 truncate">%%SESSION_NAME_PLACEHOLDER%%</h1>
                <button id="session-settings-button" class="ml-4 p-2 rounded-full hover:bg-gray-200 text-gray-500 hover:text-gray-700 hidden" title="Session Settings">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </header>

            <div id="chat-view" class="flex-1 flex flex-col overflow-hidden">
                <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-white shadow-inner m-2 md:m-4 rounded-lg"></div>
                <footer class="p-4 bg-gray-200 border-t border-gray-300">
                    <form id="chat-form" class="flex items-center space-x-2">
                        <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" required class="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Send</button>
                        <button type="button" id="stop-ai-button" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Stop</button>
                    </form>
                </footer>
            </div>

            <div id="session-settings-view" class="hidden flex-1 overflow-y-auto p-6">
                <div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Session Settings</h2>
                    <div class="border-t border-gray-200 pt-6 mt-6">
                        <h3 class="text-lg font-medium text-red-600">Delete Session</h3>
                        <p class="text-sm text-gray-500 mt-1">This action cannot be undone. It will permanently delete the session for all participants.</p>
                        <div class="mt-4">
                            <label for="delete-confirmation" class="block text-sm font-medium text-gray-700">To confirm, type the session name: <strong id="session-name-for-delete"></strong></label>
                            <input type="text" id="delete-confirmation" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                        </div>
                        <button id="delete-session-button" class="mt-4 w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">Delete this Session</button>
                    </div>
                     <button id="back-to-chat-button" class="mt-6 w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">Back to Chat</button>
                </div>
            </div>
        </main>
        
        <!-- Right Participants Panel -->
        <aside class="w-48 bg-gray-50 border-l border-gray-200 p-4 flex flex-col shrink-0">
            <h3 class="text-md font-semibold text-gray-700 mb-4 border-b pb-2">Participants</h3>
            <ul id="participant-list" class="space-y-2 overflow-y-auto">
                <li class="text-gray-500 italic text-sm">Loading...</li>
            </ul>
        </aside>
    </div>

    <script type="module">
        import { loadSidebarHTML, populateSessionList } from '/static/js/app-ui.js';
        import { updateAndDisplayParticipants, handleSessionSettings } from '/static/js/session-manager.js';
        import { initializeSidebarToggle } from '/static/js/sidebar-toggle.js';

        async function initializeChatPage() {
            initializeSidebarToggle();

            const userResponse = await fetch('/api/me');
            if (userResponse.ok) {
                window.currentUserInfo = await userResponse.json();
            } else {
                console.error("Failed to fetch current user data for chat page.");
                return;
            }
            
            const sidebarContainer = document.getElementById('sidebar-loader-target');
            if (!sidebarContainer) return;

            const sidebarLoaded = await loadSidebarHTML('/static/_sidebar.html', 'sidebar-loader-target');
            
            if (sidebarLoaded) {
                const sessionsResponse = await fetch('/api/sessions');
                if(sessionsResponse.ok) {
                    const sessions = await sessionsResponse.json();
                    const currentSessionId = window.location.pathname.split('/')[2];
                    window.currentSessionData = sessions.find(s => s.id === currentSessionId);
                }
                await populateSessionList('/api/sessions', 'session-list', '/chat/');
            }
            
            await updateAndDisplayParticipants();
            handleSessionSettings();
        }

        document.addEventListener('DOMContentLoaded', initializeChatPage);
    </script>
    <script src="/static/js/d3.min.js" defer></script>
    <script src="/static/js/mpld3.min.js" defer></script>
    <script src="/dist/script.js" defer></script>
</body>
</html>


=== app/static/input.css ===
/* app/static/input.css */

/* --- Imports for Prism and KaTeX --- */
@import 'prismjs/themes/prism-tomorrow.css';
@import 'katex/dist/katex.min.css';
/* ----------------------------------- */

/* --- Tailwind CSS Directives --- */
@tailwind base;
@tailwind components;
@tailwind utilities;
/* ----------------------------------- */

/* --- General Styles & Custom Scrollbars --- */
html, body {
    height: 100%;
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6; /* Light gray background for the whole page */
}

#chat-history {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    background-color: #ffffff;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    margin: 1rem;
    border-radius: 0.5rem;
}

.sidebar-scrollable {
    overflow-y: auto;
    scrollbar-width: thin; /* For Firefox */
    scrollbar-color: theme('colors.gray.400') theme('colors.gray.200'); /* For Firefox */
}
.sidebar-scrollable::-webkit-scrollbar {
    width: 6px;
}
.sidebar-scrollable::-webkit-scrollbar-track {
    background: theme('colors.gray.200');
    border-radius: 3px;
}
.sidebar-scrollable::-webkit-scrollbar-thumb {
    background-color: theme('colors.gray.400');
    border-radius: 3px;
    border: 1px solid theme('colors.gray.200');
}
/* ----------------------------------- */

/* Style for the AI Stop Generation button */
#stop-ai-button {
    background-color: #ef4444; /* red-500 */
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: bold;
    transition: background-color 0.15s ease-in-out;
    margin-left: 0.5rem;
}
#stop-ai-button:hover {
    background-color: #dc2626; /* red-600 */
}
#stop-ai-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Utility class (already present in Tailwind but good to have explicit) */
.hidden {
    display: none !important;
}
/* ----------------------------------- */

/* --- Message Styling --- */
.message {
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 0.5rem;
    max-width: 90%;
    word-wrap: break-word;
    line-height: 1.5;
}

.user-message {
    background-color: #dbeafe; /* Tailwind blue-100 */
    align-self: flex-end;
    margin-left: auto;
    white-space: pre-wrap;
}

.ai-turn-container {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
    margin-bottom: 0.5rem;
}

.ai-message {
    background-color: #e5e7eb; /* Tailwind gray-200 */
    align-self: flex-start;
    margin-right: auto;
    max-width: 90%;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
}

.ai-message p { margin-bottom: 0.5em; }
.ai-message p:last-child { margin-bottom: 0; }
.ai-message ul, .ai-message ol { margin-left: 1.5em; margin-top: 0.5em; margin-bottom: 0.5em; }
.ai-message li { margin-bottom: 0.25em; }
.ai-message blockquote { border-left: 3px solid #ccc; padding-left: 0.8em; margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; color: #555; }
.ai-message code {
    background-color: rgba(0, 0, 0, 0.06);
    padding: 0.1em 0.3em;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.9em;
}
.ai-message pre[class*="language-"] code {
    background-color: transparent;
    padding: 0;
    border-radius: 0;
    font-size: inherit;
}
.ai-message a { color: #007bff; text-decoration: underline; }
.ai-message a:hover { color: #0056b3; }
.ai-message hr { border: none; border-top: 1px solid #ccc; margin: 1em 0; }
.ai-message table { border-collapse: collapse; margin: 1em 0; width: auto; }
.ai-message th, .ai-message td { border: 1px solid #ccc; padding: 0.3em 0.6em; text-align: left; }
.ai-message th { background-color: #f2f2f2; font-weight: bold; }

.code-reference {
    font-family: monospace;
    background-color: rgba(0, 0, 0, 0.08);
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 0.85em;
    white-space: nowrap;
    margin: 0 2px;
}

.loading-dots { display: inline-block; }
.loading-dots::after {
    display: inline-block; position: relative; left: 1px;
    animation: ellipsis 1.5s infinite; content: ".";
    width: 1.5em; text-align: left; vertical-align: bottom;
}
@keyframes ellipsis {
    0% { content: "."; } 33% { content: ".."; } 66% { content: "..."; }
}

.thinking-area {
    width: 100%; max-width: 90%; margin-bottom: 4px;
    align-self: flex-start; font-size: 0.9em;
}
.thinking-area details {
    width: 100%; border: 1px dashed #aaa; border-radius: 6px;
    background-color: #f0f0f0; overflow: hidden;
}
.thinking-summary {
    padding: 3px 8px; cursor: pointer; font-weight: normal; color: #444;
    background-color: #e0e0e0; border-bottom: 1px dashed #aaa;
    outline: none; user-select: none; list-style: none; display: block;
    transition: background-color 0.15s ease;
}
.thinking-summary:hover { background-color: #d0d0d0; }
.thinking-summary::-webkit-details-marker { display: none; }
.thinking-summary .dots { display: inline-block; margin-left: 4px; }
.thinking-summary .dots::after {
    display: inline-block; position: relative; left: 1px;
    animation: ellipsis 1.5s infinite; content: ".";
    width: 1.5em; text-align: left; vertical-align: bottom;
}
.thinking-area details[open] > .thinking-summary .dots { display: none; }
.thinking-area details pre {
    margin: 0; padding: 8px; background-color: #f8f8f8;
    white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;
    max-height: 200px; overflow-y: auto;
}

.code-blocks-area {
    width: 100%;
    max-width: 90%;
    align-self: flex-start;
    margin-top: 0.5rem;
}

.block-container {
    margin-bottom: 0.75rem;
    border-radius: 0.375rem;
    overflow: hidden;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}


.block-header {
    display: flex;
    align-items: center;
    background-color: #e5e7eb;
    padding: 0.25rem 0.5rem;
    font-size: 0.8em;
    color: #4b5563;
    gap: 0.625rem;
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
}

.block-buttons {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    flex-shrink: 0;
}

.block-title {
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-shrink: 1;
    flex-grow: 1;
    text-align: left;
}

.block-status {
    margin-left: auto;
    text-align: right;
    font-style: italic;
    font-size: 0.9em;
    padding: 0 0.3125rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #6b7280;
    flex-shrink: 0;
}

.block-status.running, .block-status.stopping { color: #ca8a04; font-weight: 500; }
.block-status.success { color: #16a34a; font-weight: 500; }
.block-status.error, .block-status.stopped { color: #dc2626; font-weight: 500; }

.block-action-btn {
    background-color: #d1d5db;
    color: #4b5563;
    border: none;
    padding: 0.1875rem 0.4375rem;
    border-radius: 0.25rem;
    cursor: pointer;
    font-size: 0.9em;
    line-height: 1.2;
    transition: background-color 0.2s ease, color 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
}
.block-action-btn:hover { background-color: #9ca3af; color: #1f2937; }
.block-action-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.block-action-btn.copied { background-color: #16a34a; color: white; }

.run-code-btn {
    padding: 4px; width: 24px; height: 24px; font-size: 1em;
    background-color: transparent !important; border: none !important;
    color: #9ca3af; transition: color 0.2s ease;
}
.run-code-btn:hover { color: #4b5563; background-color: transparent !important; }
.run-code-btn[data-status="idle"] { color: #16a34a; }
.run-code-btn[data-status="idle"]:hover { color: #15803d; }
.run-code-btn[data-status="running"] { color: #dc2626; }
.run-code-btn[data-status="running"]:hover { color: #b91c1c; }
.run-code-btn[data-status="stopping"] { color: #f59e0b; cursor: wait; animation: spin 1s linear infinite; }
.run-code-btn[data-status="stopping"]:hover { color: #d97706; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

.block-container > pre[class*="language-"] {
    margin: 0;
    border: 1px solid #d1d5db;
    border-top: none;
    border-bottom: none !important;
    overflow: hidden;
}
.block-container > pre[class*="language-"] > code[class*="language-"] {
    outline: none;
    white-space: pre-wrap !important;
    word-wrap: break-word !important;
    display: block;
    min-height: 1.5em;
    padding: 0.5em;
}
.block-container > pre[class*="language-"] > code[class*="language-"]:focus {
    background-color: rgba(0, 0, 0, 0.03);
}

.block-output-console {
    background-color: #1f2937;
    color: #f3f4f6;
    padding: 0;
    border: 1px solid #4b5563;
    border-top: none !important;
    border-bottom-left-radius: 0.375rem;  /* Add this */
    border-bottom-right-radius: 0.375rem; /* Add this */
    max-height: 250px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.85em;
    line-height: 1.4;
}

.block-output-console pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: inherit;
    border: none !important;
    padding: 0.5rem;
    background-color: transparent;
    outline: none !important;
}
.block-output-console span { display: inline; white-space: pre-wrap; }
.block-output-console span.stdout-output { color: #ffffff; }
.block-output-console span.stderr-output { color: #f87171; }
.block-container > pre.hidden,
.block-output-console.hidden,
.block-header.hidden { display: none !important; }

/* Sticky header fixes */
.block-header.header-is-sticky-js {
    box-shadow: none !important;
    margin-top: 0 !important;
}



.mpld3-plot-container {
    background-color: white !important;
    border: 1px solid #d1d5db;
    border-top: none !important;
    border-bottom-left-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
    padding: 0 !important;
    margin: 0;
    overflow: visible !important; /* Key change: ensure toolbar isn't clipped */
    min-height: 500px;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    box-sizing: border-box;
}

.mpld3-plot-container svg {
    background-color: white !important;
    border: none !important;
    border-radius: 0;
    box-shadow: none !important;
    width: 100% !important;
    height: auto !important;
    min-height: 450px;
    max-width: 100% !important;
    display: block;
    margin: 0 !important;
    padding: 0 !important;
    overflow: visible !important; /* Ensure SVG content isn't clipped */
}

.mpld3-plot-container.hidden {
    display: none !important;
}

/* Toolbar styling - ensure it's always visible */
.mpld3-plot-container .mpld3-toolbar {
    background-color: rgba(255, 255, 255, 0.95) !important;
    border: 1px solid #d1d5db !important;
    border-radius: 0.375rem !important;
    padding: 0.375rem !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
    pointer-events: auto !important;
    z-index: 1000 !important;
    position: relative !important; /* Ensure it's not clipped */
}

.mpld3-plot-container .mpld3-toolbar button {
    background-color: white !important;
    border: 1px solid #d1d5db !important;
    color: #374151 !important;
    padding: 0.25rem 0.5rem !important;
    margin: 0.125rem !important;
    border-radius: 0.25rem !important;
    cursor: pointer !important;
    pointer-events: auto !important;
    min-width: 24px !important;
    min-height: 24px !important;
}

.mpld3-plot-container .mpld3-toolbar button:hover {
    background-color: #f9fafb !important;
    border-color: #9ca3af !important;
}

/* Ensure toolbar images/icons are visible */
.mpld3-plot-container .mpld3-toolbar image {
    pointer-events: auto !important;
    opacity: 1 !important;
}

.mpld3-plot-container .mpld3-toolbar rect {
    pointer-events: auto !important;
}

/* Ensure axes and plot elements are properly contained */
.mpld3-plot-container .mpld3-axes {
    pointer-events: auto !important;
}

/* Fix any text elements that might be clipped */
.mpld3-plot-container text {
    pointer-events: none !important;
    fill: #333333 !important;
}

/* Animation notice styling */
.animation-notice {
    background-color: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.animation-notice-content {
    font-size: 0.875rem;
}

.animation-notice-content strong {
    color: #92400e;
    display: block;
    margin-bottom: 0.5rem;
}

.animation-notice-content p {
    margin: 0.5rem 0;
    color: #78350f;
}

.animation-notice-content details {
    margin-top: 0.75rem;
}

.animation-notice-content summary {
    cursor: pointer;
    font-weight: 600;
    color: #92400e;
    margin-bottom: 0.5rem;
}

.animation-notice-content ul {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
    color: #78350f;
}

.animation-notice-content li {
    margin: 0.25rem 0;
}

.animation-notice-content code {
    background-color: #fbbf24;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
}

.animation-notice.hidden {
    display: none;
}

/* Warning status styling */
.block-status.warning {
    background-color: #fbbf24;
    color: #78350f;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
}

footer { padding: 1rem; background-color: #e5e7eb; border-top: 1px solid #d1d5db; }
#chat-form { display: flex; align-items: center; gap: 0.5rem; }
.think-checkbox-container { display: flex; align-items: center; font-size: 0.9em; color: #4b5563; }
.think-checkbox-container input { margin-right: 4px; cursor: pointer; }
.think-checkbox-container label { cursor: pointer; user-select: none;}
#message-input {
    flex-grow: 1; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db;
    border-radius: 0.5rem; outline: none;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
#message-input:focus { border-color: #2563eb; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
#send-button {
    background-color: #2563eb; color: white; font-weight: 500; padding: 0.5rem 1rem;
    border-radius: 0.5rem; border: none; cursor: pointer; transition: background-color 0.2s ease;
}
#send-button:hover { background-color: #1d4ed8; }
#send-button:disabled { opacity: 0.6; cursor: not-allowed; }
.error-message {
    background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca;
    align-self: flex-start; margin-right: auto; padding: 0.5rem 0.75rem;
    border-radius: 0.5rem; max-width: 90%; word-wrap: break-word;
    margin-bottom: 0.5rem; white-space: pre-wrap;
}
.system-message {
    width: 100%; text-align: center; font-size: 0.875rem; color: #6b7280;
    font-style: italic; margin: 0.25rem 0;
}
span[data-katex-rendered="true"] .katex-display { margin: 0.5em 0; overflow-x: auto; overflow-y: hidden; padding: 0.2em 0; }
span[data-katex-rendered="true"] .katex { line-height: normal; vertical-align: baseline; font-size: 1em; }
.katex-error { color: #cc0000; background-color: #fdd; border: 1px solid #cc0000; padding: 2px 4px; border-radius: 3px; }


.sidebar-collapsed {
    width: 0 !important;
    padding: 0 !important;
    overflow: hidden;
}

#sidebar-toggle.collapsed {
    transform: translateX(1.5rem); /* Move button slightly out from the edge */
}

#sidebar-toggle-icon.collapsed {
    transform: rotate(180deg);
}


=== app/static/languages.json ===
{
  "html": {
    "image": "alpine:latest",
    "filename": "script.html",
    "command": ["cat", "/app/script.html"],
    "executable": true,
    "interactive": false
  },
  "python": {
    "image": "python-runner-with-uv",
    "filename": "script.py",
    "command": ["stdbuf", "-o0", "python", "-u", "/app/script.py"],
    "executable": true,
    "interactive": true
  },
  "javascript": {
    "image": "node:18-alpine",
    "filename": "script.js",
    "command": ["stdbuf", "-o0", "node", "/app/script.js"],
    "executable": true,
    "interactive": true
  },
  "c": {
    "image": "gcc:latest",
    "filename": "script.c",
    "command": ["sh", "-c", "gcc /app/script.c -o /app/output_executable && exec stdbuf -o0 /app/output_executable"],
    "executable": true,
    "interactive": true
  },
  "cpp": {
    "image": "gcc:latest",
    "filename": "script.cpp",
    "command": ["sh", "-c", "g++ /app/script.cpp -o /app/output_executable && exec stdbuf -o0 /app/output_executable"],
    "executable": true,
    "interactive": true
  },
  "csharp": {
    "image": "mcr.microsoft.com/dotnet/sdk:latest",
    "filename": "Script.cs",
    "command": ["sh", "-c", "cd /app && dotnet new console --force -o . > /dev/null && cp Script.cs Program.cs && rm Script.cs && exec dotnet run"],
    "executable": true,
    "interactive": true
  },
  "typescript": {
    "image": "node:18-alpine",
    "filename": "script.ts",
    "command": ["sh", "-c", "npm install -g typescript > /dev/null 2>&1 && tsc --module commonjs /app/script.ts && exec stdbuf -o0 node /app/script.js"],
    "executable": true,
    "interactive": true
  },
  "java": {
    "image": "openjdk:17-jdk-slim",
    "filename": "Main.java",
    "command": ["sh", "-c", "javac /app/Main.java && exec stdbuf -o0 java -cp /app Main"],
    "executable": true,
    "interactive": true
  },
  "go": {
    "image": "golang:1.21-alpine",
    "filename": "script.go",
    "command": ["stdbuf", "-o0", "go", "run", "/app/script.go"],
    "executable": true,
    "interactive": true
  },
  "rust": {
    "image": "rust:1-slim",
    "filename": "main.rs",
    "command": ["sh", "-c", "cd /app && rustc main.rs -o main_executable && exec stdbuf -o0 ./main_executable"],
    "executable": true,
    "interactive": true
  }
}

=== app/static/login.html ===
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Tesseracs Chat</title>
    <link rel="stylesheet" href="/dist/input.css">
    <script id="csrf-token-script">
      // This placeholder is replaced by the server with the actual raw CSRF token.
      window.csrfTokenRaw = "%%CSRF_TOKEN_RAW%%"; 
    </script>
    <script>
      // Early diagnostic log to check if the CSRF token is injected correctly by the server.
      console.log('JS EARLY DIAGNOSTIC (immediately after csrf-token-script): window.csrfTokenRaw =', "'" + window.csrfTokenRaw + "'", "(Type:", typeof window.csrfTokenRaw + ")");
    </script>
</head>
<body class="flex flex-col justify-center items-center min-h-screen bg-gray-100 font-sans p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h1 class="text-center mb-6 text-2xl font-semibold text-gray-900">Tesseracs Chat</h1>
        <div id="message-area" class="p-3 rounded-md text-sm text-center mb-4" style="display: none;"></div>
        
        <form id="auth-form" class="mt-4">
            <input type="hidden" name="csrf_token" id="csrf_token_form_field">
            
            <div class="mb-5">
                <label for="email" class="block mb-2 text-sm font-medium text-gray-700">Email:</label>
                <input type="email" id="email" name="username" required autocomplete="username" class="block w-full py-2.5 px-3 border border-gray-300 rounded-md text-sm transition-colors duration-200 ease-in-out focus:border-blue-600 focus:ring-2 focus:ring-blue-300 focus:outline-none">
            </div>
            
            <div id="password-field-container" class="mb-5 hidden">
                <label for="password" class="block mb-2 text-sm font-medium text-gray-700">Password:</label>
                <input type="password" id="password" name="password" autocomplete="current-password" class="block w-full py-2.5 px-3 border border-gray-300 rounded-md text-sm transition-colors duration-200 ease-in-out focus:border-blue-600 focus:ring-2 focus:ring-blue-300 focus:outline-none">
                <a href="#" id="forgot-password-link" class="block text-right text-sm text-gray-600 no-underline mt-2 mb-5 hover:text-blue-700 hover:underline hidden">Forgot Password?</a>
            </div>
            
            <div id="name-field-container" class="mb-5 hidden">
                <label for="name" class="block mb-2 text-sm font-medium text-gray-700">Full Name:</label>
                <input type="text" id="name" name="name" autocomplete="name" class="block w-full py-2.5 px-3 border border-gray-300 rounded-md text-sm transition-colors duration-200 ease-in-out focus:border-blue-600 focus:ring-2 focus:ring-blue-300 focus:outline-none">
            </div>
            
            <button type="submit" id="submit-button" class="w-full py-3 bg-blue-600 text-white rounded-md text-sm font-medium cursor-pointer transition-colors duration-200 ease-in-out hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Continue</button>
            <button type="button" id="change-email-button" class="block w-auto mt-3 mx-auto py-2 px-4 text-sm text-gray-600 bg-gray-100 border border-gray-300 rounded-md cursor-pointer text-center hover:bg-gray-200 hidden">Change Email / Start Over</button>
        </form>
        
        <p id="form-instructions" class="text-xs text-center mt-6 text-gray-500">
            Enter your email to log in or create an account.
        </p>
    </div>

    <script>
        // Utility function to get a cookie by name. Used for diagnostics or specific needs,
        // but CSRF token for AJAX is primarily handled via window.csrfTokenRaw.
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // DOM element references
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email'); 
        const nameInput = document.getElementById('name');
        const passwordInput = document.getElementById('password');
        const nameFieldContainer = document.getElementById('name-field-container');
        const passwordFieldContainer = document.getElementById('password-field-container');
        const submitButton = document.getElementById('submit-button');
        const messageArea = document.getElementById('message-area');
        const formInstructions = document.getElementById('form-instructions');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const changeEmailButton = document.getElementById('change-email-button');
        const csrfTokenFormField = document.getElementById('csrf_token_form_field'); // Hidden input for CSRF token in form
        
        // Placeholder string that the server is supposed to replace with the actual CSRF token.
        const CSRF_ORIGINAL_PLACEHOLDER = ['%', '%CSRF_TOKEN_RAW%', '%'].join('');

        let formState = 'initial_email'; // Manages the current state of the login/registration form
        let cachedEmail = ''; // Stores the email after it's been checked

        // Log the initial CSRF token value when the main script runs.
        console.log('JS MAIN SCRIPT: window.csrfTokenRaw at script start =', "'" + window.csrfTokenRaw + "'", "(Type:", typeof window.csrfTokenRaw + ")");
        console.log('JS MAIN SCRIPT: CSRF_ORIGINAL_PLACEHOLDER =', "'" + CSRF_ORIGINAL_PLACEHOLDER + "'");

        /**
         * Updates the UI elements (input fields, buttons, instructions) based on the current formState.
         */
        function updateUIForState() {
            // Hide all optional sections by default; specific states will unhide them.
            passwordFieldContainer.classList.add('hidden');
            nameFieldContainer.classList.add('hidden');
            forgotPasswordLink.classList.add('hidden');
            changeEmailButton.classList.add('hidden');

            // Reset 'required' attributes; states will set them if needed.
            passwordInput.required = false;
            nameInput.required = false;
            emailInput.readOnly = false; // Email input is generally editable unless a state locks it.
            submitButton.disabled = false; // Submit button is enabled by default.

            // **MODIFICATION**: messageArea is NOT hidden here by default.
            // It will be hidden explicitly by states that require a clean slate (e.g., 'initial_email').
            // Otherwise, messages shown by showMessage() will persist into the new state.

            // Populate the hidden CSRF token field if window.csrfTokenRaw is valid.
            const tokenValue = window.csrfTokenRaw;
            const isTokenValid = tokenValue && typeof tokenValue === 'string' && tokenValue !== CSRF_ORIGINAL_PLACEHOLDER && tokenValue.trim() !== "";

            if (isTokenValid) {
                csrfTokenFormField.value = tokenValue;
            } else {
                csrfTokenFormField.value = ""; // Ensure field is empty if token is invalid.
                console.warn("JS WARN (updateUIForState): window.csrfTokenRaw ('" + tokenValue + "') is not a valid token for form field. Hidden CSRF field set to empty. Is it the original placeholder?", tokenValue === CSRF_ORIGINAL_PLACEHOLDER);
            }

            // Configure UI based on the current state
            switch (formState) {
                case 'initial_email':
                    emailInput.value = ''; 
                    passwordInput.value = '';
                    nameInput.value = '';
                    cachedEmail = '';
                    submitButton.textContent = 'Continue';
                    formInstructions.textContent = 'Enter your email to log in or create an account.';
                    submitButton.disabled = emailInput.value.trim() === ''; // Disable if email is empty
                    emailInput.focus();
                    messageArea.style.display = 'none'; // Explicitly hide message area for this clean state
                    break;
                case 'login_password':
                    passwordFieldContainer.classList.remove('hidden');
                    forgotPasswordLink.classList.remove('hidden');
                    changeEmailButton.classList.remove('hidden');
                    passwordInput.required = true;
                    emailInput.readOnly = true; 
                    emailInput.value = cachedEmail; 
                    submitButton.textContent = 'Login';
                    formInstructions.textContent = 'Enter your password to log in.';
                    passwordInput.value = ''; 
                    submitButton.disabled = true; // Disable until password input
                    passwordInput.focus();
                    // messageArea might still be visible from a previous action if not explicitly hidden
                    break;
                case 'register_name':
                    nameFieldContainer.classList.remove('hidden');
                    changeEmailButton.classList.remove('hidden');
                    nameInput.required = true;
                    emailInput.readOnly = true; 
                    emailInput.value = cachedEmail; 
                    submitButton.textContent = 'Create Account & Send Password';
                    formInstructions.textContent = 'This email is not registered. Enter your name to create an account. A password will be emailed to you.';
                    nameInput.value = '';
                    submitButton.disabled = nameInput.value.trim() === ''; // Disable if name is empty
                    nameInput.focus();
                    // messageArea might still be visible (e.g. if an error occurred before reaching this state)
                    break;
                case 'forgot_password_prompt':
                    emailInput.readOnly = false; 
                    emailInput.value = cachedEmail || ''; 
                    passwordInput.value = '';
                    nameInput.value = '';
                    submitButton.textContent = 'Send Reset Email';
                    formInstructions.textContent = 'Enter your email address to receive a password reset email.';
                    changeEmailButton.classList.remove('hidden'); 
                    submitButton.disabled = emailInput.value.trim() === '';
                    emailInput.focus();
                    // messageArea might be visible from a previous action
                    break;
                case 'login_after_registration':
                case 'login_after_password_reset':
                    emailInput.value = cachedEmail; 
                    emailInput.readOnly = true;
                    passwordFieldContainer.classList.remove('hidden');
                    changeEmailButton.classList.remove('hidden');
                    passwordInput.required = true;
                    submitButton.textContent = 'Login';
                    if (formState === 'login_after_registration') {
                        // The success message from registration (via showMessage) should still be visible here.
                        formInstructions.textContent = 'Account created! Please check your email for the password and enter it below.';
                    } else { 
                        // The success message from password reset (via showMessage) should still be visible.
                        formInstructions.textContent = 'Please check your email for the new password and enter it below.';
                    }
                    passwordInput.value = '';
                    submitButton.disabled = true; // Disable until password input
                    passwordInput.focus();
                    break;
            }
        }

        // Event listeners to enable/disable submit button based on input
        emailInput.addEventListener('input', function() {
            if (formState === 'initial_email' || formState === 'forgot_password_prompt') {
                submitButton.disabled = emailInput.value.trim() === '';
            }
        });
        nameInput.addEventListener('input', function() {
            if (formState === 'register_name') {
                submitButton.disabled = nameInput.value.trim() === '';
            }
        });
        passwordInput.addEventListener('input', function() {
            if (formState === 'login_password' || formState === 'login_after_registration' || formState === 'login_after_password_reset') {
                submitButton.disabled = passwordInput.value.trim() === '';
            }
        });

        // Event listener for "Forgot Password?" link
        forgotPasswordLink.addEventListener('click', (event) => {
            event.preventDefault();
            formState = 'forgot_password_prompt';
            updateUIForState();
            messageArea.style.display = 'none'; // Clear previous messages when switching to forgot password
        });

        // Event listener for "Change Email / Start Over" button
        changeEmailButton.addEventListener('click', (event) => {
            event.preventDefault();
            formState = 'initial_email';
            updateUIForState(); // This will hide messageArea as per 'initial_email' state
        });

        /**
         * Handles form submission for all states (email check, login, registration, forgot password).
         */
        authForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission
            messageArea.className = 'p-3 rounded-md text-sm text-center mb-4 border'; // Reset message area classes
            submitButton.disabled = true; // Disable submit button during processing

            const emailForLogic = emailInput.value.trim().toLowerCase();
            const currentRawCsrfToken = window.csrfTokenRaw; 
            
            console.log('JS LOG (Submit Start): currentRawCsrfToken value is:', "'" + currentRawCsrfToken + "'", "(Type:", typeof currentRawCsrfToken + ")");
            const isTokenTheOriginalPlaceholder = currentRawCsrfToken === CSRF_ORIGINAL_PLACEHOLDER;
            console.log('JS LOG (Submit Start): Is currentRawCsrfToken the original placeholder?', isTokenTheOriginalPlaceholder);
            
            const headers = { 
                // Content-Type is set per request type below (JSON or FormData)
            };

            // Set X-CSRF-Token header if the token is valid and not the placeholder.
            if (typeof currentRawCsrfToken === 'string' && !isTokenTheOriginalPlaceholder && currentRawCsrfToken.trim() !== "") {
                headers['X-CSRF-Token'] = currentRawCsrfToken;
            } else {
                console.warn('JS WARN (Submit): X-CSRF-Token header will NOT be set or will be problematic. currentRawCsrfToken:', "'" + currentRawCsrfToken + "'. Is it original placeholder?", isTokenTheOriginalPlaceholder);
                // If CSRF token is missing/invalid, for critical operations, we might stop here.
                // For now, proceeding and letting server handle it, but this is a potential failure point.
            }

            // --- State: Initial Email Check ---
            if (formState === 'initial_email') {
                submitButton.textContent = 'Checking Email...';
                headers['Content-Type'] = 'application/json';
                try {
                    const response = await fetch('/check_email', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ email: emailForLogic })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        cachedEmail = emailForLogic; 
                        formState = result.exists ? 'login_password' : 'register_name';
                        updateUIForState(); 
                        // No explicit message shown here by showMessage, state instructions will guide.
                    } else {
                        showMessage(result, 'error'); 
                        submitButton.textContent = 'Continue'; 
                        submitButton.disabled = emailInput.value.trim() === ''; 
                    }
                } catch (error) {
                    console.error('Email check error:', error);
                    showMessage('Network error or server issue checking email. Please try again.', 'error');
                    submitButton.textContent = 'Continue';
                    submitButton.disabled = emailInput.value.trim() === '';
                }
            } 
            // --- State: Login (Password Submission) ---
            else if (formState === 'login_password' || formState === 'login_after_registration' || formState === 'login_after_password_reset') {
                submitButton.textContent = 'Logging In...';
                const formData = new FormData(authForm); 
                // formData will include email (name="username"), password, and csrf_token (from hidden input)
                // csrfTokenFormField.value is set by updateUIForState()
                console.log('JS LOG (Submit /token): FormData csrf_token field value being sent:', "'" + csrfTokenFormField.value + "'");
                
                // The `headers` object already contains X-CSRF-Token if currentRawCsrfToken was valid.
                // For FormData, fetch sets Content-Type automatically.
                try {
                    const response = await fetch('/token', { 
                        method: 'POST', 
                        headers: headers, // Send X-CSRF-Token header
                        body: formData    // Body is FormData
                    });
                    const result = await response.json(); 
                    if (response.ok) {
                        showMessage('Login successful! Redirecting...', 'success');
                        setTimeout(() => { window.location.href = '/'; }, 1500); // Redirect to dashboard/main page
                    } else {
                        showMessage(result, 'error'); 
                        submitButton.textContent = 'Login';
                        submitButton.disabled = passwordInput.value.trim() === '';
                    }
                } catch (error) { 
                    console.error('Login error:', error);
                    showMessage('Network error or server issue during login. Please try again.', 'error');
                    submitButton.textContent = 'Login';
                    submitButton.disabled = passwordInput.value.trim() === '';
                }
            }
            // --- State: Registration (Name Submission) ---
            else if (formState === 'register_name') {
                submitButton.textContent = 'Creating Account...';
                headers['Content-Type'] = 'application/json';
                const name = nameInput.value.trim();
                try {
                    const response = await fetch('/register', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ email: emailForLogic, name: name }) 
                    });
                    const result = await response.json(); // Expects models.RegistrationResponse
                    if (response.ok) {
                        // `result.message` contains the success string from the server
                        showMessage(result.message, 'success'); // This will show the green banner
                        formState = 'login_after_registration';
                        updateUIForState(); // This will set up the form for password entry
                                            // The success message from showMessage() should remain visible.
                    } else {
                        showMessage(result, 'error'); // `result` would be like {"detail": "error message"}
                        submitButton.textContent = 'Create Account & Send Password';
                        submitButton.disabled = nameInput.value.trim() === '';
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    showMessage('Network error or server issue during registration. Please try again.', 'error');
                    submitButton.textContent = 'Create Account & Send Password';
                    submitButton.disabled = nameInput.value.trim() === '';
                }
            }
            // --- State: Forgot Password ---
            else if (formState === 'forgot_password_prompt') {
                submitButton.textContent = 'Sending Reset Email...';
                headers['Content-Type'] = 'application/json';
                try {
                    const response = await fetch('/forgot_password', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ email: emailForLogic })
                    });
                    const result = await response.json(); // Expects models.ForgotPasswordResponse
                    showMessage(result.message, response.ok ? 'success' : 'error'); 
                    if (response.ok) {
                        cachedEmail = emailForLogic; 
                        formState = 'login_after_password_reset';
                        updateUIForState(); // Sets up form for new password entry
                                            // The success message from showMessage() should remain.
                    } else {
                        submitButton.textContent = 'Send Reset Email';
                        submitButton.disabled = emailInput.value.trim() === '';
                    }
                } catch (error) {
                    console.error('Forgot password error:', error);
                    // Provide a generic message for security (don't confirm/deny email existence based on network error)
                    showMessage('A network error occurred. If an account with this email exists, a password reset email may have been sent.', 'error');
                    submitButton.textContent = 'Send Reset Email';
                    submitButton.disabled = emailInput.value.trim() === '';
                }
            }
        });

        /**
         * Displays a message (error, success, info) in the messageArea.
         * @param {string|object} messageData - The message string or an error object from the server.
         * @param {string} type - 'info', 'success', or 'error'.
         */
        function showMessage(messageData, type = 'info') { 
            let displayMessage = "An unexpected error occurred.";
            if (typeof messageData === 'string') {
                displayMessage = messageData;
            } else if (typeof messageData === 'object' && messageData !== null) {
                // Handle FastAPI HTTPException detail structure
                if (messageData.detail) {
                    if (typeof messageData.detail === 'string') {
                        displayMessage = messageData.detail;
                    } else if (Array.isArray(messageData.detail) && messageData.detail.length > 0) {
                        // Handle Pydantic validation error arrays
                        displayMessage = messageData.detail.map(err => {
                            let loc = err.loc ? err.loc.join('.') : 'field';
                            return `${loc}: ${err.msg}`;
                        }).join('; ');
                    } else {
                        displayMessage = JSON.stringify(messageData.detail); // Fallback for other detail structures
                    }
                } else if (messageData.message) { // Handle custom success messages like {"message": "..."}
                     displayMessage = messageData.message;
                } else {
                    displayMessage = JSON.stringify(messageData); // Fallback for other object structures
                }
            }
            
            messageArea.textContent = displayMessage;
            messageArea.className = 'p-3 rounded-md text-sm text-center mb-4 border'; // Reset base classes
            if (type === 'error') {
                messageArea.classList.add('text-red-700', 'bg-red-100', 'border-red-300');
            } else if (type === 'success') {
                messageArea.classList.add('text-green-700', 'bg-green-100', 'border-green-300');
            } else { // 'info' or default
                messageArea.classList.add('text-blue-700', 'bg-blue-100', 'border-blue-300');
            }
            messageArea.style.display = 'block'; // Make the message area visible
        }

        // Initialize the UI to the default state when the page loads.
        updateUIForState();
    </script>
</body>
</html>

=== app/static/script.js ===
// --- JS Imports ---
import { marked } from 'marked';
import katex from 'katex';
import Prism from 'prismjs';
import { updateAndDisplayParticipants } from './js/session-manager.js';

// --- Prism Components ---
import 'prismjs/components/prism-clike';
import 'prismjs/components/prism-python';
import 'prismjs/components/prism-javascript';
import 'prismjs/components/prism-css';
import 'prismjs/components/prism-bash';
import 'prismjs/components/prism-json';
import 'prismjs/components/prism-yaml';
import 'prismjs/components/prism-sql';
import 'prismjs/components/prism-java';
import 'prismjs/components/prism-csharp';
import 'prismjs/components/prism-go';
import 'prismjs/components/prism-rust';
import 'prismjs/components/prism-docker';
import 'prismjs/components/prism-typescript';
import 'prismjs/components/prism-c';
import 'prismjs/components/prism-cpp';

// --- DOM Elements ---
const chatHistory = document.getElementById('chat-history');
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const thinkCheckbox = document.getElementById('think-checkbox');
const stopAiButton = document.getElementById('stop-ai-button');

// --- Core Variables ---
let websocket;
const clientId = `web-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`;
let currentTurnId = 0;

// --- Constants ---
const NO_THINK_PREFIX = "\\no_think";
const THINK_PREFIX = "\\think";

const LANGUAGE_ALIASES = {
    'python': 'python', 'py': 'python',
    'javascript': 'javascript', 'js': 'javascript',
    'html': 'html',
    'css': 'css',
    'bash': 'bash', 'sh': 'bash', 'shell': 'bash',
    'json': 'json',
    'c': 'c',
    'cpp': 'cpp', 'c++': 'cpp',
    'csharp': 'csharp', 'cs': 'csharp',
    'go': 'go',
    'rust': 'rust',
    'typescript': 'typescript', 'ts': 'typescript',
    'java': 'java',
    'plaintext': 'plaintext', 'text': 'plaintext',
};

const PRISM_LANGUAGE_MAP = {
    'html': 'markup', // Prism's class for HTML is 'markup'
    'xml': 'markup',
    'svg': 'markup',
    'c++': 'cpp',
    'cs': 'csharp',
    'js': 'javascript',
    'py': 'python',
    'ts': 'typescript',
    'sh': 'bash',
    'shell': 'bash'
};

// --- State Variables ---
let supportedLanguagesConfig = {};
let currentAiTurnContainer = null;
let currentAnswerElement = null;
let currentThinkingArea = null;
let currentThinkingPreElement = null;
let currentCodeBlocksArea = null;
let codeBlockCounterThisTurn = 0;
let thinkingRequestedForCurrentTurn = false;
let accumulatedAnswerText = '';
let hasThinkingContentArrivedThisTurn = false;
let firstAnswerTokenReceived = false;
let activeStreamingCodeBlocks = new Map(); // blockId -> { element, language, content }
let streamingCodeBlockCounter = 0;




function addTerminalPrompt(outputPreElement, promptText) {
    if (!outputPreElement) return;
    
    const outputContainer = outputPreElement.closest('.block-container');
    if (!outputContainer) return;
    
    const inputField = document.createElement('input');
    inputField.type = 'text';
    inputField.style.border = 'none';
    inputField.style.outline = 'none';
    inputField.style.background = 'transparent';
    inputField.style.color = 'inherit';
    inputField.style.font = 'inherit';
    inputField.style.padding = '0';
    inputField.style.margin = '0';
    inputField.style.display = 'inline';
    inputField.style.width = 'auto';
    inputField.style.minWidth = '200px';
    
    outputPreElement.appendChild(inputField);
    inputField.focus();
    
    inputField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const userInput = inputField.value;
            
            const textNode = document.createTextNode(userInput + '\n');
            outputPreElement.replaceChild(textNode, inputField);
            
            // FIX: Get the output block's ID and strip the prefix to find the original code block ID.
            const outputBlockId = outputContainer.id; // e.g., "output-for-code-block-turn1-1"
            const originalCodeBlockId = outputBlockId.replace('output-for-', ''); // results in "code-block-turn1-1"

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'code_input',
                    payload: { 
                        code_block_id: originalCodeBlockId, // Send the CORRECT ID
                        input: userInput + '\n' 
                    }
                }));
            }
        }
    });
}

function escapeHTML(str) {
    if (str === null || str === undefined) return '';
    return str.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function getCursorPosition(parentElement) {
    const selection = window.getSelection();
    if (selection.rangeCount === 0) return -1;

    const range = selection.getRangeAt(0);
    if (!parentElement.contains(range.startContainer)) {
        return -1;
    }

    const preSelectionRange = range.cloneRange();
    preSelectionRange.selectNodeContents(parentElement);
    try {
        preSelectionRange.setEnd(range.startContainer, range.startOffset);
        return preSelectionRange.toString().length;
    } catch (e) {
        console.error("Error getting cursor position:", e);
        return -1;
    }
}

function setCursorPosition(parentElement, offset) {
    const selection = window.getSelection();
    if (!selection) return;

    const range = document.createRange();
    let charCount = 0;
    let foundStart = false;

    function findNodeAndOffset(node) {
        if (foundStart) return;

        if (node.nodeType === Node.TEXT_NODE) {
            const nextCharCount = charCount + node.length;
            if (!foundStart && offset >= charCount && offset <= nextCharCount) {
                try {
                    const offsetInNode = Math.min(offset - charCount, node.length);
                    range.setStart(node, offsetInNode);
                    foundStart = true;
                } catch (e) {
                    console.error("Error setting range start:", e);
                }
            }
            charCount = nextCharCount;
        } else {
            for (let i = 0; i < node.childNodes.length; i++) {
                findNodeAndOffset(node.childNodes[i]);
                if (foundStart) break;
            }
        }
    }

    findNodeAndOffset(parentElement);

    if (foundStart) {
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
    } else {
        range.selectNodeContents(parentElement);
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);
    }
}

function initializeCodeBlockHistory(blockId, initialContent) {
    if (!window.codeBlockHistories) {
        window.codeBlockHistories = new Map();
    }
    
    if (!window.codeBlockHistories.has(blockId)) {
        window.codeBlockHistories.set(blockId, {
            history: [initialContent],
            currentIndex: 0,
            saveTimeout: null
        });
    }
}

// --- Configuration Loading ---
async function loadLanguagesConfig() {
    try {
        const response = await fetch('/static/languages.json');
        if (!response.ok) {
            console.error('Failed to fetch languages.json');
            return;
        }
        supportedLanguagesConfig = await response.json();
    } catch (error) {
        console.error('Error loading languages.json:', error);
    }
}

async function initializeCurrentUser() {
    try {
        const response = await fetch('/api/me');
        if (response.ok) {
            const userData = await response.json();
            if (userData && userData.name) {
                window.currentUserInfo = {
                    name: userData.name,
                    email: userData.email,
                    id: userData.id
                };
            } else {
                window.currentUserInfo = null;
            }
        } else {
            window.currentUserInfo = null;
        }
    } catch (error) {
        window.currentUserInfo = null;
    }
}

// --- Session Management ---
function getSessionIdFromPath() {
    const pathName = window.location.pathname;
    const pathParts = pathName.split('/');

    if (pathParts.length >= 3 && pathParts[1] === 'chat') {
        const sessionId = pathParts[2];
        if (sessionId && sessionId.trim() !== "") {
            return sessionId;
        } else {
            console.error("Session ID extracted from path is empty or invalid.");
            return null;
        }
    }

    return null;
}

// --- UI Helper Functions ---
function scrollToBottom(behavior = 'auto') {
    const isNearBottom = chatHistory.scrollHeight - chatHistory.scrollTop - chatHistory.clientHeight < 100;
    if (isNearBottom) {
        requestAnimationFrame(() => {
            chatHistory.scrollTo({ top: chatHistory.scrollHeight, behavior: behavior });
        });
    }
}

function setInputDisabledState(inputsDisabled, aiResponding) {
    if (messageInput) messageInput.disabled = inputsDisabled;
    if (sendButton) sendButton.disabled = inputsDisabled;
    if (thinkCheckbox) thinkCheckbox.disabled = inputsDisabled;

    if (stopAiButton) {
        if (aiResponding) {
            stopAiButton.classList.remove('hidden');
            stopAiButton.disabled = false;
            stopAiButton.innerHTML = `
                <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                Stop`;
            if (sendButton) sendButton.classList.add('hidden');
        } else {
            stopAiButton.classList.add('hidden');
            stopAiButton.disabled = true;
            stopAiButton.innerHTML = `
                <svg class="w-5 h-5 inline-block mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                Stop`;
            if (sendButton) sendButton.classList.remove('hidden');
        }
    }
}


function addUserMessage(text) {
    if (!chatHistory) return;

    const messageElement = document.createElement('div');
    messageElement.classList.add('message', 'user-message', 'p-3', 'rounded-lg', 'max-w-xl', 'mb-2', 'break-words', 'flex', 'flex-col', 'self-end', 'ml-auto');
    
    const currentUser = window.currentUserInfo;
    const participantData = currentUser && window.participantInfo ? window.participantInfo[currentUser.id] : null;

    if (participantData && participantData.color) {
        messageElement.style.backgroundColor = participantData.color;
    } else {
        messageElement.classList.add('bg-gray-200'); // Fallback color
    }

    const senderElem = document.createElement('p');
    senderElem.classList.add('font-semibold', 'text-sm', 'mb-1', 'text-gray-800');
    senderElem.textContent = escapeHTML(currentUser ? currentUser.name : 'User');
    messageElement.appendChild(senderElem);

    const contentElem = document.createElement('div');
    contentElem.classList.add('text-gray-800', 'text-sm', 'message-content');
    
    let displayedText = text;
    // Always strip the prefix for display, regardless of who the message is for.
    if (text.startsWith(NO_THINK_PREFIX)) {
        displayedText = text.substring(NO_THINK_PREFIX.length).trim();
    }
    contentElem.textContent = displayedText.replace(/@\w+/g, '').trim(); 
    messageElement.appendChild(contentElem);

    chatHistory.appendChild(messageElement);
    setTimeout(() => scrollToBottom('smooth'), 50);
}

function renderSingleMessage(msg, parentElement, isHistory = false, editedCodeBlocks = {}) {
    if (!parentElement || !msg) return;

    const senderType = msg.sender_type;
    const senderName = msg.sender_name || (senderType === 'ai' ? 'AI' : 'User');
    const timestamp = msg.timestamp;
    const currentUserId = window.currentUserInfo ? window.currentUserInfo.id : null;
    const isCurrentUser = msg.user_id === currentUserId;

    if (senderType === 'user' || senderType === 'system' || senderType === 'ai') {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message-item', 'p-3', 'rounded-lg', 'max-w-xl', 'mb-2', 'break-words', 'flex', 'flex-col');
        messageDiv.setAttribute('data-sender', senderType);
        if (msg.id) messageDiv.setAttribute('data-message-id', String(msg.id));

        if (senderType === 'user') {
            if (isCurrentUser) {
                messageDiv.classList.add('self-end', 'ml-auto');
            } else {
                messageDiv.classList.add('self-start', 'mr-auto');
            }

            // --- THIS IS THE FIX ---
            // 1. Check for color on the message object itself (for live messages).
            // 2. If not found, look up the color from the globally stored participant info.
            let bubbleColor = msg.sender_color;
            if (!bubbleColor && window.participantInfo && msg.user_id) {
                const participant = window.participantInfo[msg.user_id];
                if (participant) {
                    bubbleColor = participant.color;
                }
            }
            
            if (bubbleColor) {
                messageDiv.style.backgroundColor = bubbleColor;
            } else {
                messageDiv.classList.add('bg-gray-200'); // Final fallback for unknown/past users
            }
            // --- END OF FIX ---

        } else if (senderType === 'ai') {
            messageDiv.classList.add('bg-sky-100', 'self-start', 'mr-auto');
        } else {
             messageDiv.classList.add('bg-slate-200', 'self-center', 'mx-auto', 'text-xs', 'italic');
        }

        const senderElem = document.createElement('p');
        senderElem.classList.add('font-semibold', 'text-sm', 'mb-1', 'text-gray-800');
        senderElem.textContent = escapeHTML(senderName);
        messageDiv.appendChild(senderElem);

        const contentElem = document.createElement('div');
        contentElem.classList.add('text-gray-800', 'text-sm', 'message-content');
        
        if (senderType === 'ai') {
            const codeBlocksArea = document.createElement('div');
            codeBlocksArea.classList.add('code-blocks-area');
            parseAndRenderAiContent(msg.content, contentElem, codeBlocksArea, msg.turn_id, editedCodeBlocks);
            messageDiv.appendChild(contentElem);
            messageDiv.appendChild(codeBlocksArea);
        } else {
            let displayedText = msg.content || '';
            if (displayedText.startsWith(NO_THINK_PREFIX)) {
                displayedText = displayedText.substring(NO_THINK_PREFIX.length).trim();
            }
            contentElem.innerHTML = marked.parse(displayedText);
            messageDiv.appendChild(contentElem);
        }

        parentElement.appendChild(messageDiv);
    }
}

function addSystemMessage(text) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('system-message');
    messageElement.textContent = text;
    chatHistory.appendChild(messageElement);
    setTimeout(() => scrollToBottom('smooth'), 50);
}

function addErrorMessage(text) {
    console.error("[UI ERROR] ", text);
    const messageElement = document.createElement('div');
    messageElement.classList.add('error-message');
    messageElement.textContent = `Error: ${text}`;
    if (currentAiTurnContainer) {
        const target = currentAnswerElement || currentCodeBlocksArea || currentAiTurnContainer;
        target.appendChild(messageElement);
    } else {
        chatHistory.appendChild(messageElement);
    }
    setTimeout(() => scrollToBottom('smooth'), 50);
}

function setupNewAiTurn() {
    currentTurnId++;
    codeBlockCounterThisTurn = 0;
    accumulatedAnswerText = '';
    hasThinkingContentArrivedThisTurn = false;
    firstAnswerTokenReceived = false;

    // This map is for tracking blocks within a single turn and MUST be cleared.
    activeStreamingCodeBlocks.clear();
    // streamingCodeBlockCounter is now session-wide and is NOT reset here.

    currentAiTurnContainer = null;
    currentThinkingArea = null;
    currentThinkingPreElement = null;
    currentAnswerElement = null;
    currentCodeBlocksArea = null;

    currentAiTurnContainer = document.createElement('div');
    currentAiTurnContainer.classList.add('ai-turn-container');
    currentAiTurnContainer.dataset.turnId = currentTurnId;

    // Thinking Area Setup
    currentThinkingArea = document.createElement('div');
    currentThinkingArea.classList.add('thinking-area');
    currentThinkingArea.dataset.turnId = currentTurnId;
    if (!thinkingRequestedForCurrentTurn) {
        currentThinkingArea.style.display = 'none';
    }
    
    const details = document.createElement('details');
    details.id = `thinking-details-${currentTurnId}`;
    const summary = document.createElement('summary');
    summary.classList.add('thinking-summary');
    const summaryTextSpan = document.createElement('span');
    summaryTextSpan.classList.add('text');
    summaryTextSpan.textContent = 'Show Thinking';
    const summaryDotsSpan = document.createElement('span');
    summaryDotsSpan.classList.add('dots');
    summary.appendChild(summaryTextSpan);
    summary.appendChild(summaryDotsSpan);
    currentThinkingPreElement = document.createElement('pre');
    details.appendChild(summary);
    details.appendChild(currentThinkingPreElement);
    currentThinkingArea.appendChild(details);
    currentAiTurnContainer.appendChild(currentThinkingArea);
    
    details.addEventListener('toggle', (event) => {
        const textSpan = event.target.querySelector('.thinking-summary .text');
        if (!textSpan) return;
        textSpan.textContent = event.target.open ? 'Hide Thinking' : 'Show Thinking';
    });

    // Answer Element (AI Message Bubble) Setup
    currentAnswerElement = document.createElement('div');
    currentAnswerElement.classList.add('message', 'ai-message', 'p-3', 'rounded-lg', 'max-w-xl', 'mb-2', 'break-words', 'flex', 'flex-col', 'bg-sky-100', 'self-start', 'mr-auto');

    const senderElem = document.createElement('p');
    senderElem.classList.add('font-semibold', 'text-sm', 'mb-1', 'text-sky-700');
    senderElem.textContent = 'AI';
    currentAnswerElement.appendChild(senderElem);

    const liveContentDiv = document.createElement('div');
    liveContentDiv.classList.add('text-gray-800', 'text-sm', 'message-content', 'live-ai-content-area');
    currentAnswerElement.appendChild(liveContentDiv);

    if (thinkingRequestedForCurrentTurn) {
        currentAnswerElement.style.display = 'none';
    } else {
        const loadingSpan = document.createElement('span');
        loadingSpan.classList.add('loading-dots');
        liveContentDiv.appendChild(loadingSpan);
    }
    currentAiTurnContainer.appendChild(currentAnswerElement);

    // Code Blocks Area Setup
    currentCodeBlocksArea = document.createElement('div');
    currentCodeBlocksArea.classList.add('code-blocks-area');
    currentAiTurnContainer.appendChild(currentCodeBlocksArea);

    chatHistory.appendChild(currentAiTurnContainer);
}

// --- Live Rendering ---
function renderLiveMessage(fullContent) {
    if (!currentAiTurnContainer) return;

    if (!firstAnswerTokenReceived && fullContent.trim().length > 0) {
        if (currentAnswerElement && currentAnswerElement.style.display === 'none') {
            currentAnswerElement.style.display = '';
        }
        const loadingDots = currentAnswerElement ? currentAnswerElement.querySelector('.loading-dots') : null;
        if (loadingDots) loadingDots.remove();
        firstAnswerTokenReceived = true;
    }

    const contentArea = currentAnswerElement.querySelector('.live-ai-content-area');
    const codeArea = currentCodeBlocksArea;

    if (!contentArea || !codeArea) return;
    
    parseAndRenderStreamingContent(fullContent, contentArea, codeArea, currentTurnId);
    scrollToBottom('auto');
}

function parseAndRenderAiContent(contentString, answerBubbleContentElement, codeBlocksDivElement, turnIdSuffix, editedCodeBlocks = {}) {
    if (!contentString || !answerBubbleContentElement || !codeBlocksDivElement) return;

    const KATEX_PLACEHOLDER_PREFIX_HISTORICAL = `%%HISTORICAL_KATEX_PLACEHOLDER_${turnIdSuffix}_`;
    const codeBlockRegex = /```(\w*)\n([\s\S]*?)\n```/g;

    let contentForProcessing = contentString;
    let historicalCodeBlockCounter = 0;
    const extractedCodeBlocks = [];
    let tempContentForCodeExtraction = contentForProcessing;
    let contentAfterCodeExtraction = "";
    let lastCodeMatchEndIndex = 0;
    let matchCode;

    codeBlocksDivElement.innerHTML = '';

    while ((matchCode = codeBlockRegex.exec(tempContentForCodeExtraction)) !== null) {
        const language = (matchCode[1] || 'plaintext').toLowerCase();
        const originalCode = matchCode[2];
        const placeholder = `%%HISTORICAL_CODE_BLOCK_${historicalCodeBlockCounter}%%`;

        contentAfterCodeExtraction += tempContentForCodeExtraction.substring(lastCodeMatchEndIndex, matchCode.index);

        if (language === 'markdown' || language === 'md') {
            contentAfterCodeExtraction += originalCode;
        } else {
            historicalCodeBlockCounter++;
            const blockId = `code-block-turn${turnIdSuffix}-${historicalCodeBlockCounter}`;

            extractedCodeBlocks.push({ 
                language, 
                originalCode, 
                placeholder, 
                index: historicalCodeBlockCounter,
                id: blockId 
            });
            contentAfterCodeExtraction += placeholder;
        }
        lastCodeMatchEndIndex = codeBlockRegex.lastIndex;
    }
    contentAfterCodeExtraction += tempContentForCodeExtraction.substring(lastCodeMatchEndIndex);
    contentForProcessing = contentAfterCodeExtraction;

    extractedCodeBlocks.forEach(block => {
        const finalCodeContent = editedCodeBlocks[block.id] || block.originalCode;
        createCodeBlock(block.language, finalCodeContent, block.originalCode, turnIdSuffix, block.index, codeBlocksDivElement, false);
        initializeCodeBlockHistory(block.id, finalCodeContent);
        const replacementHTML = `<a href="#${block.id}" class="code-block-link text-blue-600 hover:underline">[Code Block ${block.index}]</a>`;
        contentForProcessing = contentForProcessing.replace(block.placeholder, replacementHTML);
    });

    const storedKatex = {};
    let katexPlaceholderIndex = 0;
    const katexRegexGlobal = /(?<!\\)\$\$([\s\S]+?)(?<!\\)\$\$|(?<!\\)\$((?:\\\$|[^$])+?)(?<!\\)\$/g;
    let textForMarkdownParsing = contentForProcessing.replace(katexRegexGlobal, (match, displayContent, inlineContent) => {
        const isDisplayMode = !!displayContent;
        const katexString = displayContent || inlineContent;
        const cleanedKatexString = katexString.replace(/\\([$])/g, '$1');
        let katexHtml = '';
        try {
            katexHtml = katex.renderToString(cleanedKatexString, {
                displayMode: isDisplayMode, throwOnError: false, output: "html", strict: false
            });
        } catch (e) {
            katexHtml = `<span class="katex-error" title="${escapeHTML(e.toString())}">${escapeHTML(match)}</span>`;
        }
        const placeholderId = `${KATEX_PLACEHOLDER_PREFIX_HISTORICAL}${katexPlaceholderIndex++}`;
        storedKatex[placeholderId] = katexHtml;
        return placeholderId;
    });

    answerBubbleContentElement.innerHTML = marked.parse(textForMarkdownParsing);

    if (Object.keys(storedKatex).length > 0) {
        const walker = document.createTreeWalker(answerBubbleContentElement, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const textNodesToModify = [];
        while (node = walker.nextNode()) {
            if (node.nodeValue && node.nodeValue.includes(KATEX_PLACEHOLDER_PREFIX_HISTORICAL)) {
                textNodesToModify.push(node);
            }
        }
        textNodesToModify.forEach(textNode => {
            let currentTextValue = textNode.nodeValue;
            const parent = textNode.parentNode;
            if (!parent) return;
            const fragment = document.createDocumentFragment();
            let lastSplitEnd = 0;
            const placeholderScanRegex = new RegExp(`(${KATEX_PLACEHOLDER_PREFIX_HISTORICAL}\\d+)`, 'g');
            let placeholderMatch;
            while((placeholderMatch = placeholderScanRegex.exec(currentTextValue)) !== null) {
                const placeholderId = placeholderMatch[1];
                const matchStartIndex = placeholderMatch.index;
                if (matchStartIndex > lastSplitEnd) {
                    fragment.appendChild(document.createTextNode(currentTextValue.substring(lastSplitEnd, matchStartIndex)));
                }
                if (storedKatex[placeholderId]) {
                    const katexWrapperSpan = document.createElement('span');
                    katexWrapperSpan.innerHTML = storedKatex[placeholderId];
                    fragment.appendChild(katexWrapperSpan.firstChild || katexWrapperSpan);
                } else {
                    fragment.appendChild(document.createTextNode(placeholderId));
                }
                lastSplitEnd = placeholderScanRegex.lastIndex;
            }
            if (lastSplitEnd < currentTextValue.length) {
                fragment.appendChild(document.createTextNode(currentTextValue.substring(lastSplitEnd)));
            }
            parent.replaceChild(fragment, textNode);
        });
    }
}

function parseAndRenderStreamingContent(contentString, answerBubbleContentElement, codeBlocksDivElement, turnIdSuffix) {
    if (!contentString || !answerBubbleContentElement || !codeBlocksDivElement) return;

    const codeBlockRegex = /```(\w*)\n?([\s\S]*?)(?:\n```|$)/g;

    let match;
    let lastIndex = 0;
    let contentWithPlaceholders = '';

    while ((match = codeBlockRegex.exec(contentString)) !== null) {
        const [fullMatch, language, code] = match;
        const isComplete = fullMatch.endsWith('\n```') || fullMatch.endsWith('```');
        const startIndex = match.index;

        contentWithPlaceholders += contentString.substring(lastIndex, startIndex);

        const safeLanguage = (language || 'plaintext').trim().toLowerCase();

        if (safeLanguage === 'markdown' || safeLanguage === 'md') {
            contentWithPlaceholders += code;
            if (isComplete) {
                contentWithPlaceholders += '\n';
            }
        } else {
            if (!activeStreamingCodeBlocks.has(startIndex)) {
                streamingCodeBlockCounter++;
                const newBlockElement = createCodeBlock(
                    language || 'plaintext', 
                    code, 
                    code,
                    turnIdSuffix, 
                    streamingCodeBlockCounter, 
                    codeBlocksDivElement, 
                    true
                );
                activeStreamingCodeBlocks.set(startIndex, {
                    blockId: newBlockElement.id,
                    language: language || 'plaintext',
                    content: code,
                    isComplete: isComplete
                });
            } else {
                const blockData = activeStreamingCodeBlocks.get(startIndex);
                const newLanguage = language || 'plaintext';
                blockData.language = newLanguage;
                blockData.content = code;
                blockData.isComplete = isComplete;
                updateStreamingCodeBlockContent(blockData.blockId, newLanguage, code, isComplete);
            }

            const blockData = activeStreamingCodeBlocks.get(startIndex);
            const blockNumber = blockData.blockId.split('-').pop();
            const blockId = `code-block-turn${turnIdSuffix}-${blockNumber}`;
            const linkHTML = `<a href="#${blockId}" class="code-block-link text-blue-600 hover:underline">[Code Block ${blockNumber}]</a>`;
            contentWithPlaceholders += linkHTML;
        }
        lastIndex = codeBlockRegex.lastIndex;
    }

    contentWithPlaceholders += contentString.substring(lastIndex);

    const KATEX_PLACEHOLDER_PREFIX_STREAMING = `%%STREAMING_KATEX_PLACEHOLDER_${turnIdSuffix}_`;
    const storedKatex = {};
    let katexPlaceholderIndex = 0;

    const katexRegexGlobal = /(?<!\\)\$\$([\s\S]+?)(?<!\\)\$\$|(?<!\\)\$((?:\\\$|[^$])+?)(?<!\\)\$/g;
    let textForMarkdownParsing = contentWithPlaceholders.replace(katexRegexGlobal, (match, displayContent, inlineContent) => {
        const isDisplayMode = !!displayContent;
        const katexString = displayContent || inlineContent;
        const cleanedKatexString = katexString.replace(/\\([$])/g, '$1');
        let katexHtml = '';
        try {
            katexHtml = katex.renderToString(cleanedKatexString, {
                displayMode: isDisplayMode, throwOnError: false, output: "html", strict: false
            });
        } catch (e) {
            katexHtml = `<span class="katex-error" title="${escapeHTML(e.toString())}">${escapeHTML(match)}</span>`;
        }
        const placeholderId = `${KATEX_PLACEHOLDER_PREFIX_STREAMING}${katexPlaceholderIndex++}`;
        storedKatex[placeholderId] = katexHtml;
        return placeholderId;
    });

    answerBubbleContentElement.innerHTML = marked.parse(textForMarkdownParsing);

    if (Object.keys(storedKatex).length > 0) {
        const walker = document.createTreeWalker(answerBubbleContentElement, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const textNodesToModify = [];
        while (node = walker.nextNode()) {
            if (node.nodeValue && node.nodeValue.includes(KATEX_PLACEHOLDER_PREFIX_STREAMING)) {
                textNodesToModify.push(node);
            }
        }
        textNodesToModify.forEach(textNode => {
            let currentTextValue = textNode.nodeValue;
            const parent = textNode.parentNode;
            if (!parent) return;
            const fragment = document.createDocumentFragment();
            let lastSplitEnd = 0;
            const placeholderScanRegex = new RegExp(`(${KATEX_PLACEHOLDER_PREFIX_STREAMING}\\d+)`, 'g');
            let placeholderMatch;
            while((placeholderMatch = placeholderScanRegex.exec(currentTextValue)) !== null) {
                const placeholderId = placeholderMatch[1];
                const matchStartIndex = placeholderMatch.index;
                if (matchStartIndex > lastSplitEnd) {
                    fragment.appendChild(document.createTextNode(currentTextValue.substring(lastSplitEnd, matchStartIndex)));
                }
                if (storedKatex[placeholderId]) {
                    const katexWrapperSpan = document.createElement('span');
                    katexWrapperSpan.innerHTML = storedKatex[placeholderId];
                    fragment.appendChild(katexWrapperSpan.firstChild || katexWrapperSpan);
                } else {
                    fragment.appendChild(document.createTextNode(placeholderId));
                }
                lastSplitEnd = placeholderScanRegex.lastIndex;
            }
            if (lastSplitEnd < currentTextValue.length) {
                fragment.appendChild(document.createTextNode(currentTextValue.substring(lastSplitEnd)));
            }
            parent.replaceChild(fragment, textNode);
        });
    }
}

function updateStreamingCodeBlockContent(blockId, language, content, isComplete) {
    const container = document.getElementById(blockId);
    if (!container) return;

    const codeElement = container.querySelector('code');
    const dotsSpan = container.querySelector('.streaming-dots');
    const titleTextSpan = container.querySelector('.block-title .title-text');
    const currentLanguage = container.dataset.language;

    const rawLang = (language || 'plaintext').trim().toLowerCase();
    const canonicalLang = LANGUAGE_ALIASES[rawLang] || 'plaintext';

    if (canonicalLang && canonicalLang !== currentLanguage) {
        container.dataset.language = canonicalLang;
        if (titleTextSpan) {
            const blockNumber = blockId.split('-').pop();
            titleTextSpan.textContent = `Code Block ${blockNumber} (${canonicalLang})`;
        }
        
        const prismLang = PRISM_LANGUAGE_MAP[canonicalLang] || canonicalLang;
        if (codeElement) {
            codeElement.className = `language-${prismLang}`;
        }

        const runStopBtn = container.querySelector('.run-code-btn');
        if (runStopBtn) {
            const isLanguageSupported = supportedLanguagesConfig[canonicalLang]?.executable;
            if (isLanguageSupported) {
                runStopBtn.style.display = '';
                runStopBtn.title = 'Run Code';
            } else {
                runStopBtn.style.display = 'none';
                runStopBtn.title = `Run Code (language '${canonicalLang}' not supported for execution)`;
            }
        }
        
        initializeCodeBlockHistory(blockId, content);
    }
    
    if (codeElement) {
        const cursorPos = getCursorPosition(codeElement);
        const wasEditing = document.activeElement === codeElement;
        
        codeElement.textContent = content;
        
        if (typeof Prism !== 'undefined' && typeof Prism.highlightElement === 'function') {
            try {
                Prism.highlightElement(codeElement);
                if (wasEditing) {
                    setCursorPosition(codeElement, cursorPos);
                    codeElement.focus();
                }
            } catch (e) {
                console.error(`Prism highlight error:`, e);
            }
        }
        
        if (window.codeBlockHistories && window.codeBlockHistories.has(blockId)) {
            const historyData = window.codeBlockHistories.get(blockId);
            if (historyData.history.length === 1) {
                historyData.history[0] = content;
            }
        }
    }
    
    if (isComplete && dotsSpan) {
        dotsSpan.remove();
    }
}

function updateAllRunButtonStates() {
    document.querySelectorAll('.run-code-btn').forEach(btn => {
        const container = btn.closest('.block-container');
        const lang = container ? container.dataset.language : null;
        const isExecutable = lang ? supportedLanguagesConfig[lang]?.executable : false;

        if (isExecutable && !btn.disabled) {
            btn.disabled = false;
            btn.title = 'Run Code';
        }
    });
}

function createCodeBlock(language, codeContent, originalCodeForDataset, turnIdSuffix, codeBlockIndex, codeBlocksAreaElement, isStreaming = false) {
   if (!codeBlocksAreaElement) {
       console.error("createCodeBlock: Code blocks area element is null!");
       return;
   }

   const rawLang = (language || 'plaintext').trim().toLowerCase();
   const canonicalLang = LANGUAGE_ALIASES[rawLang] || 'plaintext';
   const isLanguageSupported = supportedLanguagesConfig[canonicalLang]?.executable;
   const prismLang = PRISM_LANGUAGE_MAP[canonicalLang] || canonicalLang;

   const blockId = `code-block-turn${turnIdSuffix}-${codeBlockIndex}`;

   const container = document.createElement('div');
   container.classList.add('block-container');
   container.id = blockId;
   container.dataset.language = canonicalLang;
   // Set the dataset to the TRUE original content, not the potentially edited content
   container.dataset.originalContent = originalCodeForDataset;

   const codeHeader = document.createElement('div');
   codeHeader.classList.add('block-header');

   const codeButtonsDiv = document.createElement('div');
   codeButtonsDiv.classList.add('block-buttons');

   const runStopBtn = document.createElement('button');
   runStopBtn.classList.add('run-code-btn', 'block-action-btn');
   runStopBtn.dataset.status = 'idle';
   runStopBtn.innerHTML = `<svg viewBox="0 0 100 100" fill="currentColor" width="1em" height="1em" style="display: block;"><polygon points="0,0 100,50 0,100"/></svg>`;
   runStopBtn.addEventListener('click', handleRunStopCodeClick);
   runStopBtn.disabled = false;
   runStopBtn.title = 'Run Code';

   if (!isLanguageSupported) {
       runStopBtn.style.display = 'none';
   }

   const restoreBtn = document.createElement('button');
   restoreBtn.classList.add('restore-code-btn', 'block-action-btn');
   restoreBtn.textContent = 'Restore';
   restoreBtn.title = 'Restore Original Code';

   const toggleCodeBtn = document.createElement('button');
   toggleCodeBtn.classList.add('toggle-code-btn', 'block-action-btn');
   toggleCodeBtn.textContent = 'Hide';
   toggleCodeBtn.title = 'Show/Hide Code';

   const copyCodeBtn = document.createElement('button');
   copyCodeBtn.classList.add('copy-code-btn', 'block-action-btn');
   copyCodeBtn.textContent = 'Copy';
   copyCodeBtn.title = 'Copy Code';

   codeButtonsDiv.appendChild(runStopBtn);
   codeButtonsDiv.appendChild(restoreBtn);
   codeButtonsDiv.appendChild(toggleCodeBtn);
   codeButtonsDiv.appendChild(copyCodeBtn);

   const codeTitle = document.createElement('span');
   codeTitle.classList.add('block-title');
   const titleTextSpan = document.createElement('span');
   titleTextSpan.classList.add('title-text');
   titleTextSpan.textContent = `Code Block ${codeBlockIndex} (${canonicalLang})`;
   codeTitle.appendChild(titleTextSpan);

   if (isStreaming) {
       const dotsSpan = document.createElement('span');
       dotsSpan.classList.add('streaming-dots');
       dotsSpan.textContent = '...';
       codeTitle.appendChild(dotsSpan);
   }

   codeHeader.appendChild(codeButtonsDiv);
   codeHeader.appendChild(codeTitle);

   const preElement = document.createElement('pre');
   preElement.classList.add('manual');
   const codeElement = document.createElement('code');
   codeElement.className = `language-${prismLang}`;
   codeElement.setAttribute('contenteditable', 'true');
   codeElement.setAttribute('spellcheck', 'false');
   // Display the final content (which could be an edit)
   codeElement.textContent = codeContent;

   initializeCodeBlockHistory(blockId, codeContent);

   preElement.appendChild(codeElement);
   container.appendChild(codeHeader);
   container.appendChild(preElement);
   codeBlocksAreaElement.appendChild(container);

   toggleCodeBtn.addEventListener('click', () => {
       const isHidden = preElement.classList.toggle('hidden');
       toggleCodeBtn.textContent = isHidden ? 'Show' : 'Hide';
   });

   copyCodeBtn.addEventListener('click', async () => {
       try {
           await navigator.clipboard.writeText(codeElement.textContent || '');
           copyCodeBtn.textContent = 'Copied!';
           setTimeout(() => { copyCodeBtn.textContent = 'Copy'; }, 1500);
       } catch (err) {
           console.error('Failed to copy code: ', err);
       }
   });

   restoreBtn.addEventListener('click', async () => {
        const originalContent = container.dataset.originalContent;
        const sessionId = getSessionIdFromPath();
        if (!sessionId || !window.csrfTokenRaw) return;

        try {
            const response = await fetch(`/api/sessions/${sessionId}/edited-blocks/${blockId}`, {
                method: 'DELETE',
                headers: { 'X-CSRF-Token': window.csrfTokenRaw }
            });

            if (response.ok) {
                const cursorPos = getCursorPosition(codeElement);
                codeElement.textContent = originalContent;

                if (typeof Prism !== 'undefined' && typeof Prism.highlightElement === 'function') {
                    try {
                        Prism.highlightElement(codeElement);
                        setCursorPosition(codeElement, Math.min(cursorPos, originalContent.length));
                    } catch (e) { console.error(`Prism highlight error:`, e); }
                }
                // Add the restored state to the undo history instead of wiping it
                saveCodeBlockState(blockId, originalContent);
            } else {
                const error = await response.json();
                alert(`Failed to restore code block: ${error.detail || 'Server error'}`);
            }
        } catch (error) {
            console.error("Error restoring code block:", error);
            alert("An error occurred while restoring the code block.");
        }
   });

   codeElement.addEventListener('keydown', (event) => {
       handleCodeBlockKeydown(event, blockId);
   });

   codeElement.addEventListener('blur', () => {
       const content = codeElement.textContent || '';
       saveCodeBlockContent(blockId, content);
   });

   codeElement.addEventListener('input', () => {
       const cursorPos = getCursorPosition(codeElement);
       const content = codeElement.textContent || '';

       setTimeout(() => {
           if (typeof Prism !== 'undefined' && typeof Prism.highlightElement === 'function') {
               try {
                   Prism.highlightElement(codeElement);
                   setCursorPosition(codeElement, cursorPos);
               } catch (e) {
                   console.error(`Prism highlight error:`, e);
               }
           }
       }, 10);

       saveCodeBlockState(blockId, content);
   });

   return container;
}

function createPlotBlock(codeBlockId, plotData, uniquePlotBlockId, plotIndex) {
    const codeContainer = document.getElementById(codeBlockId);
    if (!codeContainer) return;

    // Remove existing plot
    const existingPlot = document.getElementById(uniquePlotBlockId);
    if (existingPlot) {
        existingPlot.remove();
    }

    // Find where to insert - after output block if it exists, otherwise after code block
    const outputBlock = document.getElementById(`output-for-${codeBlockId}`);
    const insertAfter = outputBlock || codeContainer;

    const plotContainer = document.createElement('div');
    plotContainer.id = uniquePlotBlockId;
    plotContainer.className = 'block-container';

    const blockNumber = codeBlockId.split('-').pop();

    const plotHeader = document.createElement('div');
    plotHeader.className = 'block-header';
    plotHeader.innerHTML = `
        <div class="block-buttons">
            <button class="toggle-output-btn block-action-btn">Hide</button>
            <button class="copy-plot-btn block-action-btn">Copy SVG</button>
        </div>
        <span class="block-title">Plot Output ${plotIndex}</span>
        <span class="block-status success">Rendered</span>
    `;

    const plotDivId = `plot-div-${uniquePlotBlockId}`;
    const plotDiv = document.createElement('div');
    plotDiv.id = plotDivId;
    plotDiv.className = 'mpld3-plot-container';

    plotContainer.appendChild(plotHeader);
    plotContainer.appendChild(plotDiv);

    // Insert after the right element (output block or code block)
    insertAfter.insertAdjacentElement('afterend', plotContainer);

    // Add event listeners
    plotHeader.querySelector('.toggle-output-btn').addEventListener('click', (e) => {
        const isHidden = plotDiv.classList.toggle('hidden');
        e.target.textContent = isHidden ? 'Show' : 'Hide';
    });

    plotHeader.querySelector('.copy-plot-btn').addEventListener('click', async (e) => {
        try {
            const svgElement = plotDiv.querySelector('svg');
            if (svgElement) {
                const svgString = new XMLSerializer().serializeToString(svgElement);
                await navigator.clipboard.writeText(svgString);
                e.target.textContent = 'Copied!';
                setTimeout(() => { e.target.textContent = 'Copy SVG'; }, 1500);
            }
        } catch (err) {
            console.error('Failed to copy SVG:', err);
        }
    });

    renderPlotWhenReady(plotDivId, plotData);
}

// In app/static/script.js
// Replace the existing renderPlotWhenReady function with this one.

function renderPlotWhenReady(plotDivId, plotData, timeout = 3000) {
    const startTime = Date.now();
    const interval = setInterval(() => {
        if (typeof mpld3 !== 'undefined' && typeof mpld3.draw_figure === 'function') {
            clearInterval(interval);
            
            try {
                // Let mpld3 handle the initial drawing.
                mpld3.draw_figure(plotDivId, plotData);

                // --- NEW LOGIC START: Make the generated SVG responsive ---
                const plotDiv = document.getElementById(plotDivId);
                if (plotDiv) {
                    const svg = plotDiv.querySelector('svg');
                    if (svg) {
                        const originalWidth = svg.getAttribute('width');
                        const originalHeight = svg.getAttribute('height');

                        if (originalWidth && originalHeight) {
                            // Set the viewBox to the original dimensions
                            svg.setAttribute('viewBox', `0 0 ${originalWidth} ${originalHeight}`);
                            // Ensure aspect ratio is maintained
                            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                            
                            // Remove fixed dimensions and use CSS for responsive scaling
                            svg.removeAttribute('width');
                            svg.removeAttribute('height');
                            svg.style.width = '100%';
                            svg.style.height = 'auto';
                        }
                    }
                }
                // --- NEW LOGIC END ---

            } catch (error) {
                console.error('Error during mpld3.draw_figure:', error);
                const plotDiv = document.getElementById(plotDivId);
                if (plotDiv) {
                    plotDiv.textContent = "Error rendering plot. See browser console for details.";
                }
            }

        } else if (Date.now() - startTime > timeout) {
            clearInterval(interval);
            const plotDiv = document.getElementById(plotDivId);
            if (plotDiv) {
                plotDiv.textContent = "Error: Timed out waiting for mpld3.js library to load.";
            }
            console.error("Timed out waiting for mpld3 to become available.");
        }
    }, 50);
}

function handleStructuredMessage(messageData) {
    const { type, payload } = messageData;
    console.log(`[handleStructuredMessage] Processing ${type} for ${payload?.code_block_id || 'unknown'}`);
    
    if (!payload || !payload.code_block_id) return;
    
    const codeBlockId = payload.code_block_id;
    const codeContainer = document.getElementById(codeBlockId);
    const outputBlockId = `output-for-${codeBlockId}`;
    let outputContainer = document.getElementById(outputBlockId);

    if (!outputContainer && (type === 'code_output' || type === 'code_waiting_input')) {
        outputContainer = document.createElement('div');
        outputContainer.id = outputBlockId;
        outputContainer.className = 'block-container';
        outputContainer.style.display = 'none'; // Start hidden
        
        const blockNumber = codeBlockId.split('-').pop();
        const outputHeader = document.createElement('div');
        outputHeader.className = 'block-header';
        outputHeader.innerHTML = createOutputHeaderHTML(blockNumber);
        const outputConsoleDiv = document.createElement('div');
        outputConsoleDiv.className = 'block-output-console';
        const outputPre = document.createElement('pre');
        outputConsoleDiv.appendChild(outputPre);
        outputContainer.appendChild(outputHeader);
        outputContainer.appendChild(outputConsoleDiv);
        codeContainer.insertAdjacentElement('afterend', outputContainer);

        outputContainer.querySelector('.toggle-output-btn').addEventListener('click', (e) => {
            const isHidden = outputConsoleDiv.classList.toggle('hidden');
            e.target.textContent = isHidden ? 'Show' : 'Hide';
        });
        outputContainer.querySelector('.copy-output-btn').addEventListener('click', async (e) => {
            try {
                await navigator.clipboard.writeText(outputPre.textContent || '');
                e.target.textContent = 'Copied!';
                setTimeout(() => { e.target.textContent = 'Copy'; }, 1500);
            } catch (err) { console.error('Failed to copy output:', err); }
        });
    }

    if (!codeContainer) return;
    
    switch (type) {
        case 'plot_output': {
            if (payload.plot_data) {
                // Check if the data is an array (for multiple plots) or a single object
                const plots = Array.isArray(payload.plot_data) ? payload.plot_data : [payload.plot_data];
                plots.forEach((plotData, index) => {
                    // Create a unique ID for each plot block to avoid conflicts
                    const uniquePlotBlockId = `${codeBlockId}-plot-${index}`;
                    createPlotBlock(codeBlockId, plotData, uniquePlotBlockId, index + 1);
                });
            }
            break;
        }

        case 'code_output': {
            if (!outputContainer) return;
            const outputPre = outputContainer.querySelector('.block-output-console pre');
            const language = codeContainer.dataset.language;
            const outputText = payload.data;
            
            // Filter out harness messages AND library warnings
            const isHarnessOutput = /Using Python|Audited|packages in|Matplotlib plots detected|Capturing all|\[Harness\]|UserWarning.*Blended transforms not yet supported|warnings\.warn|mplexporter\/exporter\.py/i.test(outputText);
            
            if (isHarnessOutput) {
                // Skip harness output and library warnings completely
                return;
            }
            
            const isInstallerOutput = /Resolving|Downloading|Installing|Installed|uv pip install/.test(outputText);

            if (isInstallerOutput) {
                let statusMessage = outputText.trim();
                if (statusMessage.startsWith('uv pip install')) { statusMessage = 'Preparing to install packages...'; }
                updateHeaderStatus(outputContainer, statusMessage, 'running');
            } else {
                if (outputPre) { 
                    addCodeOutput(outputPre, payload.stream, outputText, language); 
                    // Make sure the output block is visible since we have real content
                    outputContainer.style.display = '';
                }
            }
            break;
        }

        case 'code_waiting_input': {
            if (!outputContainer) return;
            updateHeaderStatus(outputContainer, 'Waiting for input...', 'waiting-input');
            const outputPre = outputContainer.querySelector('.block-output-console pre');
            if (outputPre) { 
                addTerminalPrompt(outputPre, payload.prompt || '');
                // Show output block when waiting for input
                outputContainer.style.display = '';
            }
            break;
        }

        case 'code_finished': {
            if (!outputContainer) return;
            const runStopBtn = codeContainer.querySelector('.run-code-btn');
            const outputConsoleDiv = outputContainer.querySelector('.block-output-console');
            const outputPre = outputConsoleDiv ? outputConsoleDiv.querySelector('pre') : null;

            if (!runStopBtn || !outputConsoleDiv || !outputPre) { return; }

            const { exit_code, error } = payload;
            let finishMessage = '';
            let statusClass = '';
            const language = codeContainer.dataset.language;
            const codeElement = codeContainer.querySelector('code');
            const codeContent = codeElement ? codeElement.textContent || '' : '';
            let outputContent = null;
            let htmlContent = null;
            
            // Check if we actually have any real output (not just whitespace)
            const hasRealOutput = outputPre.textContent && outputPre.textContent.trim().length > 0;
            
            if (error) {
                finishMessage = 'Failed';
                statusClass = 'error';
                const helpfulHint = error.includes("Docker service is unavailable") ? "\n\nHint: Is Docker Desktop running?" : "";
                addCodeOutput(outputPre, 'stderr', `Error: ${error}${helpfulHint}`, language);
                outputContent = outputPre.textContent;
                outputContainer.style.display = ''; // Show on error
            } else if (language === 'html') {
                const iframe = document.createElement('iframe');
                iframe.className = 'html-render-iframe';
                htmlContent = outputPre.htmlBuffer || '';
                const style = `<style>body { margin: 0; background-color: white; color: black; font-family: sans-serif; padding: 1rem; }</style>`;
                iframe.srcdoc = style + htmlContent;
                iframe.onload = () => { try { /* iframe resize logic */ } catch (e) { iframe.style.height = '400px'; } };
                outputPre.replaceWith(iframe);
                outputConsoleDiv.style.maxHeight = 'none';
                finishMessage = `Finished (Rendered HTML)`;
                statusClass = 'success';
                outputContainer.style.display = ''; // Show for HTML
            } else {
                finishMessage = `Finished (Exit: ${exit_code})`;
                statusClass = (exit_code === 0) ? 'success' : 'error';
                outputContent = outputPre.textContent;
                
                // Hide output block if no real output and no error
                if (!hasRealOutput && exit_code === 0) {
                    outputContainer.style.display = 'none';
                } else {
                    outputContainer.style.display = '';
                }
            }
            
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const codeBlockParts = codeBlockId.split('-');
                const extractedTurnId = codeBlockParts[2].replace('turn', '');
                websocket.send(JSON.stringify({
                    type: 'save_code_result',
                    payload: {
                        code_block_id: codeBlockId,
                        language: language,
                        code_content: codeContent,
                        output_content: outputContent,
                        html_content: htmlContent,
                        exit_code: exit_code,
                        error_message: error,
                        execution_status: error ? 'error' : 'completed',
                        turn_id: parseInt(extractedTurnId)
                    }
                }));
            }
            
            updateHeaderStatus(outputContainer, finishMessage, statusClass);
            runStopBtn.dataset.status = 'idle';
            runStopBtn.innerHTML = `<svg viewBox="0 0 100 100" fill="currentColor" width="1em" height="1em" style="display: block;"><polygon points="0,0 100,50 0,100"/></svg>`;
            runStopBtn.title = 'Run Code';
            break;
        }
    }
}

function saveCodeBlockContent(blockId, content) {
    const container = document.getElementById(blockId);
    if (!container) return;
    
    const language = container.dataset.language;
    const sessionId = getSessionIdFromPath();
    
    if (!sessionId || !websocket || websocket.readyState !== WebSocket.OPEN) {
        return;
    }
    
    websocket.send(JSON.stringify({
        type: 'save_code_content',
        payload: {
            session_id: sessionId,
            code_block_id: blockId,
            language: language,
            code_content: content
        }
    }));
}

function createOutputHeaderHTML(blockNumber, statusText = 'Running...', statusClass = 'running') {
    return `
        <div class="block-buttons">
            <button class="run-code-btn block-action-btn" style="display: none;">Run</button>
            <button class="toggle-output-btn block-action-btn">Hide</button>
            <button class="copy-output-btn block-action-btn">Copy</button>
        </div>
        <span class="block-title">Output Block ${blockNumber}</span>
        <span class="block-status ${statusClass}">${statusText}</span>
    `;
}


function setupIframeResizing(iframe) {
    iframe.setAttribute('scrolling', 'no');
    iframe.style.overflow = 'hidden';

    iframe.onload = () => {
        try {
            const iWin = iframe.contentWindow;
            const iDoc = iWin.document;

            const updateHeight = () => {
                if (!iDoc || !iDoc.body) return;
                // The +2 is a small buffer to prevent scrollbars from appearing in some edge cases
                const newHeight = Math.max(
                    iDoc.body.scrollHeight, iDoc.documentElement.scrollHeight,
                    iDoc.body.offsetHeight, iDoc.documentElement.offsetHeight
                ) + 2;
                iframe.style.height = `${newHeight}px`;
            };

            updateHeight(); // Initial resize

            // Use ResizeObserver to automatically adjust height if iframe content changes
            const observer = new ResizeObserver(updateHeight);
            if (iDoc.body) observer.observe(iDoc.body);

            // Fallback resizes for dynamic content that might not trigger observer
            setTimeout(updateHeight, 150);
            setTimeout(updateHeight, 500);

        } catch (e) {
            console.error("Error resizing iframe:", e);
            // Fallback to a reasonable default height on error
            iframe.style.height = '400px'; 
        }
    };
}

async function handleRunStopCodeClick(event) {
    const button = event.currentTarget;
    const container = button.closest('.block-container');
    if (!container) return;

    const codeBlockId = container.id;
    const language = container.dataset.language;
    const codeElement = container.querySelector('code');
    const code = codeElement ? codeElement.textContent || '' : '';

    // --- FIX: Handle STOP action ---
    if (button.dataset.status === 'running') {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            console.log(`Sending stop_code for ${codeBlockId}`);
            websocket.send(JSON.stringify({
                type: 'stop_code',
                payload: { code_block_id: codeBlockId }
            }));
            // The `code_finished` message from the server will reset the button state.
            // Visually update the output header to show it's stopping.
            const outputContainer = document.getElementById(`output-for-${codeBlockId}`);
            if (outputContainer) {
                updateHeaderStatus(outputContainer, 'Stopping...', 'running');
            }
        }
        return; // Exit after sending the stop command.
    }

    // --- FIX: Handle RUN action ---
    saveCodeBlockContent(codeBlockId, code);

    // Always create a fresh output container, removing any old one.
    let outputContainer = document.getElementById(`output-for-${codeBlockId}`);
    if (outputContainer) {
        outputContainer.remove();
    }
    
    outputContainer = document.createElement('div');
    outputContainer.id = `output-for-${codeBlockId}`;
    outputContainer.className = 'block-container';
    const blockNumber = codeBlockId.split('-').pop();
    const outputHeader = document.createElement('div');
    outputHeader.className = 'block-header';
    const outputConsoleDiv = document.createElement('div');
    outputConsoleDiv.className = 'block-output-console';
    outputContainer.appendChild(outputHeader);
    outputContainer.appendChild(outputConsoleDiv);
    container.insertAdjacentElement('afterend', outputContainer);

    if (language === 'html') {
        outputHeader.innerHTML = createOutputHeaderHTML(blockNumber, 'Rendered HTML', 'success');
        const iframe = document.createElement('iframe');
        iframe.className = 'html-render-iframe';
        const style = `<style>body { margin: 0; background-color: white; color: black; font-family: sans-serif; padding: 1rem; }</style>`;
        iframe.srcdoc = style + code;

        // --- MODIFICATION START ---
        setupIframeResizing(iframe); // Call the new helper function
        // --- MODIFICATION END ---

        outputConsoleDiv.appendChild(iframe);

        // Save the rendered HTML to the database for chat history.
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            const codeBlockParts = codeBlockId.split('-');
            const extractedTurnId = codeBlockParts[2].replace('turn', '');
            websocket.send(JSON.stringify({
                type: 'save_code_result',
                payload: {
                    code_block_id: codeBlockId, language: language, code_content: code,
                    html_content: code, execution_status: 'completed', turn_id: parseInt(extractedTurnId)
                }
            }));
        }
        return; // Exit here, no need to change button state as it's instant.
    }
    
    // --- Existing logic for other languages ---
    outputHeader.innerHTML = createOutputHeaderHTML(blockNumber);
    const outputPre = document.createElement('pre');
    outputConsoleDiv.appendChild(outputPre);
    
    // Add event listeners for the new output block's buttons
    outputHeader.querySelector('.toggle-output-btn').addEventListener('click', (e) => {
        const isHidden = outputConsoleDiv.classList.toggle('hidden');
        e.target.textContent = isHidden ? 'Show' : 'Hide';
    });
    outputHeader.querySelector('.copy-output-btn').addEventListener('click', async (e) => {
        try {
            await navigator.clipboard.writeText(outputPre.textContent || '');
            e.target.textContent = 'Copied!';
            setTimeout(() => { e.target.textContent = 'Copy'; }, 1500);
        } catch (err) { console.error('Failed to copy output:', err); }
    });
    
    // Set button to "running" state
    button.dataset.status = 'running';
    button.innerHTML = `<svg viewBox="0 0 100 100" fill="currentColor" width="1em" height="1em" style="display: block;"><rect width="100" height="100" rx="15"/></svg>`;
    button.title = 'Stop Execution';
    
    if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
            type: 'run_code',
            payload: { code_block_id: codeBlockId, language: language, code: code }
        }));
        
        // Scroll to the new output block
        setTimeout(() => {
            if (outputContainer) {
                outputContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 100);
    } else {
        addErrorMessage("Cannot run code: Not connected to server.");
        button.dataset.status = 'idle';
        button.innerHTML = `<svg viewBox="0 0 100 100" fill="currentColor" width="1em" height="1em" style="display: block;"><polygon points="0,0 100,50 0,100"/></svg>`;
        button.title = 'Run Code';
    }
}

function updateHeaderStatus(outputContainer, statusText, statusClass) {
    const statusSpan = outputContainer.querySelector('.block-status');
    if (statusSpan) {
        statusSpan.textContent = statusText;
        statusSpan.className = `block-status ${statusClass}`;
    }
    
    const outputHeader = outputContainer.querySelector('.block-header');
    if (outputHeader && outputHeader.classList.contains('header-is-sticky-js')) {
        const stickyId = outputHeader.dataset.stickyId;
        if (stickyId) {
            const stickyClone = document.getElementById(stickyId);
            if (stickyClone) {
                const stickyStatusSpan = stickyClone.querySelector('.block-status');
                if (stickyStatusSpan) {
                    stickyStatusSpan.textContent = statusText;
                    stickyStatusSpan.className = `block-status ${statusClass}`;
                }
            }
        }
    }
}


function addCodeOutput(outputPreElement, streamType, text, language) {
    if (!outputPreElement || !text) return;

    // The language is now passed in directly, so we don't need to guess it from the DOM.
    if (language === 'html' && streamType !== 'stderr') {
        if (!outputPreElement.htmlBuffer) {
            outputPreElement.htmlBuffer = '';
        }
        outputPreElement.htmlBuffer += text;
        return;
    }

    // For all other languages, append the output as text.
    const span = document.createElement('span');
    span.classList.add(streamType === 'stderr' ? 'stderr-output' : 'stdout-output');
    span.textContent = text;
    outputPreElement.appendChild(span);
    outputPreElement.scrollTop = outputPreElement.scrollHeight;
}

function performUndo(blockId) {
    if (!window.codeBlockHistories) return false;
    
    const historyData = window.codeBlockHistories.get(blockId);
    if (!historyData || historyData.currentIndex <= 0) return false;
    
    historyData.currentIndex--;
    const content = historyData.history[historyData.currentIndex];
    
    const container = document.getElementById(blockId);
    if (!container) return false;
    
    const codeElement = container.querySelector('code');
    if (!codeElement) return false;
    
    const cursorPos = getCursorPosition(codeElement);
    codeElement.textContent = content;
    
    if (typeof Prism !== 'undefined' && typeof Prism.highlightElement === 'function') {
        try {
            Prism.highlightElement(codeElement);
            setCursorPosition(codeElement, Math.min(cursorPos, content.length));
        } catch (e) {
            console.error(`Prism highlight error:`, e);
        }
    }
    
    return true;
}

function performRedo(blockId) {
    if (!window.codeBlockHistories) return false;
    
    const historyData = window.codeBlockHistories.get(blockId);
    if (!historyData || historyData.currentIndex >= historyData.history.length - 1) return false;
    
    historyData.currentIndex++;
    const content = historyData.history[historyData.currentIndex];
    
    const container = document.getElementById(blockId);
    if (!container) return false;
    
    const codeElement = container.querySelector('code');
    if (!codeElement) return false;
    
    const cursorPos = getCursorPosition(codeElement);
    codeElement.textContent = content;
    
    if (typeof Prism !== 'undefined' && typeof Prism.highlightElement === 'function') {
        try {
            Prism.highlightElement(codeElement);
            setCursorPosition(codeElement, Math.min(cursorPos, content.length));
        } catch (e) {
            console.error(`Prism highlight error:`, e);
        }
    }
    
    return true;
}

function handleCodeBlockKeydown(event, blockId) {
    const isCtrlZ = event.ctrlKey && event.key === 'z' && !event.shiftKey;
    const isCtrlY = event.ctrlKey && (event.key === 'y' || (event.key === 'z' && event.shiftKey));
    
    if (isCtrlZ) {
        event.preventDefault();
        performUndo(blockId);
        return;
    }
    
    if (isCtrlY) {
        event.preventDefault();
        performRedo(blockId);
        return;
    }
    
    const codeElement = event.target;
    const content = codeElement.textContent || '';
    saveCodeBlockState(blockId, content);
}

function saveCodeBlockState(blockId, content) {
    if (!window.codeBlockHistories) return;
    
    const historyData = window.codeBlockHistories.get(blockId);
    if (!historyData) return;

    clearTimeout(historyData.saveTimeout);
    historyData.saveTimeout = setTimeout(() => {
        const lastContent = historyData.history[historyData.currentIndex];
        if (lastContent !== content) {
            historyData.history = historyData.history.slice(0, historyData.currentIndex + 1);
            historyData.history.push(content);
            
            if (historyData.history.length > 50) {
                historyData.history.shift();
            } else {
                historyData.currentIndex++;
            }
        }
    }, 2000);
}




function restoreCodeExecutionResult(result) {
    const codeContainer = document.getElementById(result.code_block_id);
    if (!codeContainer) {
        return;
    }

    const outputBlockId = `output-for-${result.code_block_id}`;
    let outputContainer = document.getElementById(outputBlockId);
    
    if (outputContainer) {
        outputContainer.remove();
    }

    outputContainer = document.createElement('div');
    outputContainer.id = outputBlockId;
    outputContainer.className = 'block-container';

    const blockNumber = result.code_block_id.split('-').pop();

    const outputHeader = document.createElement('div');
    outputHeader.className = 'block-header';
    
    let statusText = '';
    let statusClass = '';
    if (result.error_message) {
        statusText = 'Failed';
        statusClass = 'error';
    } else if (result.language === 'html') {
        statusText = 'Finished (Rendered HTML)';
        statusClass = 'success';
    } else {
        statusText = `Finished (Exit: ${result.exit_code})`;
        statusClass = (result.exit_code === 0) ? 'success' : 'error';
    }
    
    outputHeader.innerHTML = `
        <div class="block-buttons">
            <button class="toggle-output-btn block-action-btn">Hide</button>
            <button class="copy-output-btn block-action-btn">Copy</button>
        </div>
        <span class="block-title">Output Block ${blockNumber}</span>
        <span class="block-status ${statusClass}">${statusText}</span>
    `;
    
    const outputConsoleDiv = document.createElement('div');
    outputConsoleDiv.className = 'block-output-console';
    
    if (result.language === 'html' && result.html_content) {
        const iframe = document.createElement('iframe');
        iframe.className = 'html-render-iframe';
        iframe.style.width = '100%';
        iframe.style.border = '1px solid #e2e8f0';
        iframe.setAttribute('scrolling', 'no');
        iframe.style.overflow = 'hidden';
        iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
        
        const style = `<style>body { margin: 0; background-color: white; color: black; font-family: sans-serif; padding: 1rem; }</style>`;
        iframe.srcdoc = style + result.html_content;
        
        iframe.onload = () => {
            try {
                const iWin = iframe.contentWindow;
                const iDoc = iWin.document;
                const updateHeight = () => {
                    if (!iDoc || !iDoc.body) return;
                    const newHeight = Math.max(
                        iDoc.body.scrollHeight, iDoc.documentElement.scrollHeight,
                        iDoc.body.offsetHeight, iDoc.documentElement.offsetHeight
                    );
                    iframe.style.height = `${newHeight}px`;
                };
                updateHeight();
                const observer = new ResizeObserver(updateHeight);
                if (iDoc.body) observer.observe(iDoc.body);
                setTimeout(updateHeight, 150);
                setTimeout(updateHeight, 500);
            } catch (e) {
                iframe.style.height = '400px';
            }
        };
        
        outputConsoleDiv.appendChild(iframe);
        outputConsoleDiv.style.maxHeight = 'none';
    } else {
        const outputPre = document.createElement('pre');
        if (result.output_content) {
            outputPre.textContent = result.output_content;
        }
        outputConsoleDiv.appendChild(outputPre);
    }

    outputContainer.appendChild(outputHeader);
    outputContainer.appendChild(outputConsoleDiv);

    codeContainer.insertAdjacentElement('afterend', outputContainer);

    outputContainer.querySelector('.toggle-output-btn').addEventListener('click', (e) => {
        const isHidden = outputConsoleDiv.classList.toggle('hidden');
        e.target.textContent = isHidden ? 'Show' : 'Hide';
    });
    
    const copyBtn = outputContainer.querySelector('.copy-output-btn');
    copyBtn.addEventListener('click', async (e) => {
        try {
            const textToCopy = result.language === 'html' && result.html_content ? 
                result.html_content : (result.output_content || '');
            await navigator.clipboard.writeText(textToCopy);
            e.target.textContent = 'Copied!';
            setTimeout(() => { e.target.textContent = 'Copy'; }, 1500);
        } catch (err) { 
            console.error('Failed to copy output:', err); 
        }
    });
}

async function loadAndDisplayChatHistory(sessionId) {
    await updateAndDisplayParticipants();

    const chatHistoryDiv = document.getElementById('chat-history');
    if (!chatHistoryDiv) {
        console.error("Chat history container 'chat-history' not found.");
        return;
    }

    chatHistoryDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Loading history...</p>';

    try {
        const [messagesResponse, codeResultsResponse, editedBlocksResponse] = await Promise.all([
            fetch(`/api/sessions/${sessionId}/messages`),
            fetch(`/api/sessions/${sessionId}/code-results`),
            fetch(`/api/sessions/${sessionId}/edited-blocks`)
        ]);

        if (!messagesResponse.ok) {
            const errorData = await messagesResponse.json().catch(() => ({ detail: "Failed to load chat history." }));
            throw new Error(errorData.detail || messagesResponse.statusText);
        }

        const messages = await messagesResponse.json();
        const codeResults = codeResultsResponse.ok ? await codeResultsResponse.json() : [];
        const editedCodeBlocks = editedBlocksResponse.ok ? await editedBlocksResponse.json() : {};

        chatHistoryDiv.innerHTML = '';

        if (messages.length === 0) {
            chatHistoryDiv.innerHTML = '<p class="text-center text-gray-500 p-4">No messages in this session yet. Start chatting!</p>';
        } else {
            messages.forEach(msg => {
                renderSingleMessage(msg, chatHistoryDiv, true, editedCodeBlocks);
            });

            codeResults.forEach(result => {
                restoreCodeExecutionResult(result);
            });

            if (typeof Prism !== 'undefined' && typeof Prism.highlightAll === 'function') {
                Prism.highlightAll();
            }

            const allCodeBlocks = chatHistoryDiv.querySelectorAll('.block-container[id^="code-block-turn"]');
            let maxBlockIndex = 0;
            allCodeBlocks.forEach(block => {
                const parts = block.id.split('-');
                const blockIndex = parseInt(parts[parts.length - 1], 10);
                if (!isNaN(blockIndex) && blockIndex > maxBlockIndex) {
                    maxBlockIndex = blockIndex;
                }
            });
            streamingCodeBlockCounter = maxBlockIndex;

            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

    } catch (error){
        console.error(`Failed to fetch or display chat history for session ${sessionId}:`, error);
        chatHistoryDiv.innerHTML = `<p class="text-center text-red-500 p-4">An unexpected error occurred while loading history: ${escapeHTML(error.message)}</p>`;
    }
}
// --- WebSocket Connection ---
function resetAllCodeButtonsOnErrorOrClose() {
    const playIconSvg = `<svg viewBox="0 0 100 100" fill="currentColor" width="1em" height="1em" style="display: block;"><polygon points="0,0 100,50 0,100"/></svg>`;

    document.querySelectorAll('.block-container').forEach(container => {
        const button = container.querySelector('.run-code-btn');
        const outputHeader = container.querySelector('.block-header');
        const statusSpan = outputHeader ? outputHeader.querySelector('.block-status') : null;

        if (button && button.dataset.status !== 'idle') {
            button.dataset.status = 'idle';
            button.innerHTML = playIconSvg;
            button.title = 'Run Code';
            button.disabled = false;
        }
        if (statusSpan) {
            if (!statusSpan.classList.contains('idle') && !statusSpan.classList.contains('success')) {
                if (outputHeader) outputHeader.style.display = 'flex';
                statusSpan.textContent = 'Error: Disconnected';
                statusSpan.className = 'code-status-span error';
            }
        }
    });
}

// ADD THIS ENTIRE BLOCK OF HELPER FUNCTIONS

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function stickHeader(header, scrollerRect) {
    if (!header || header.classList.contains('header-is-sticky-js')) return;
    
    const container = header.parentElement;
    const containerRect = container.getBoundingClientRect();
    const stickyId = `sticky-${header.classList[0]}-${Date.now()}`;
    
    if (document.getElementById(stickyId)) return;
    
    const stickyClone = header.cloneNode(true);
    stickyClone.id = stickyId;
    stickyClone.style.position = 'fixed';
    stickyClone.style.top = `${scrollerRect.top}px`;
    stickyClone.style.left = `${containerRect.left}px`;
    stickyClone.style.width = `${containerRect.width}px`;
    stickyClone.style.zIndex = '1000';
    stickyClone.style.backgroundColor = '#e5e7eb';
    stickyClone.style.borderRadius = '0';
    stickyClone.style.boxShadow = 'none';
    stickyClone.style.overflow = 'hidden';
    
    const originalButtons = header.querySelectorAll('button');
    const cloneButtons = stickyClone.querySelectorAll('button');
    
    cloneButtons.forEach((cloneBtn, index) => {
        const originalBtn = originalButtons[index];
        if (originalBtn) {
            cloneBtn.disabled = originalBtn.disabled;
            cloneBtn.className = originalBtn.className;
            cloneBtn.innerHTML = originalBtn.innerHTML;
            cloneBtn.dataset.status = originalBtn.dataset.status;
            
            cloneBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                originalBtn.click();
            };
            
            const syncButton = () => {
                cloneBtn.disabled = originalBtn.disabled;
                cloneBtn.className = originalBtn.className;
                cloneBtn.innerHTML = originalBtn.innerHTML;
                cloneBtn.dataset.status = originalBtn.dataset.status;
            };
            
            const observer = new MutationObserver(syncButton);
            observer.observe(originalBtn, { 
                attributes: true, 
                attributeFilter: ['class', 'disabled', 'data-status'],
                childList: true,
                subtree: true
            });
            
            cloneBtn._syncObserver = observer;
        }
    });
    
    document.body.appendChild(stickyClone);
    header.classList.add('header-is-sticky-js');
    header.dataset.stickyId = stickyId;
}

function unstickHeader(header) {
    if (!header || !header.classList.contains('header-is-sticky-js')) return;

    const stickyId = header.dataset.stickyId;
    if (stickyId) {
        const stickyClone = document.getElementById(stickyId);
        if (stickyClone) {
            // Clean up button observers
            const cloneButtons = stickyClone.querySelectorAll('button');
            cloneButtons.forEach(btn => {
                if (btn._syncObserver) {
                    btn._syncObserver.disconnect();
                    delete btn._syncObserver;
                }
            });
            
            // NEW: Clean up status observer
            const cloneStatusSpan = stickyClone.querySelector('.block-status');
            if (cloneStatusSpan && cloneStatusSpan._syncObserver) {
                cloneStatusSpan._syncObserver.disconnect();
                delete cloneStatusSpan._syncObserver;
            }
            
            stickyClone.remove();
        }
    }

    header.classList.remove('header-is-sticky-js');
    delete header.dataset.stickyId;
}

function finalizeTurnOnErrorOrClose() {
    if (currentAnswerElement && !currentAnswerElement.querySelector('.timestamp-p')) {
        const timestampElem = document.createElement('p');
        timestampElem.classList.add('text-xs', 'text-slate-500', 'mt-1', 'text-left', 'timestamp-p');
        timestampElem.textContent = new Date().toLocaleString();
        currentAnswerElement.appendChild(timestampElem);
    }
    
    // Clean up streaming dots from any active code blocks
    activeStreamingCodeBlocks.forEach((blockData) => {
        const container = document.getElementById(blockData.blockId);
        if (container) {
            const dotsSpan = container.querySelector('.streaming-dots');
            if (dotsSpan) dotsSpan.remove();
        }
    });
    
    // Reset state
    codeBlockCounterThisTurn = 0;
    accumulatedAnswerText = '';
    hasThinkingContentArrivedThisTurn = false;
    firstAnswerTokenReceived = false;
    thinkingRequestedForCurrentTurn = false;
    activeStreamingCodeBlocks.clear();
    streamingCodeBlockCounter = 0;
    
    setInputDisabledState(false, false);
    if (messageInput && messageInput.offsetParent !== null) {
        messageInput.focus();
    }
}

function connectWebSocket() {
    let sessionId = getSessionIdFromPath();
    if (!sessionId) {
        addErrorMessage("Cannot connect to chat: Invalid session ID in URL.");
        setInputDisabledState(true);
        return;
    }
    
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/${sessionId}/${clientId}`;

    try {
        const ws = new WebSocket(wsUrl);
        websocket = ws;

        ws.onopen = () => {
            setInputDisabledState(false, false);
            addSystemMessage("Connected to the chat server.");
            updateAllRunButtonStates();
            if (messageInput) messageInput.focus();
        };

        ws.onclose = (event) => {
            if (window.isNavigatingAway) return;
            addSystemMessage(`Connection closed: ${event.reason || 'Normal closure'} (Code: ${event.code})`);
            finalizeTurnOnErrorOrClose();
            resetAllCodeButtonsOnErrorOrClose();
            updateAllRunButtonStates();
            const noReconnectCodes = [1000, 1005, 1008, 1011];
            if (!noReconnectCodes.includes(event.code)) {
                addSystemMessage("Attempting to reconnect...");
                setInputDisabledState(true, false);
                setTimeout(connectWebSocket, 3000);
            } else {
                setInputDisabledState(true, false);
            }
        };

        ws.onerror = (event) => {
            console.error("WebSocket error:", event);
            addErrorMessage("WebSocket connection error. Please try refreshing.");
            finalizeTurnOnErrorOrClose();
            resetAllCodeButtonsOnErrorOrClose();
            updateAllRunButtonStates();
            setInputDisabledState(true, false);
        };

        ws.onmessage = (event) => {
            let messageData;
            try {
                messageData = JSON.parse(event.data);
            } catch (e) {
                messageData = null;
            }

            if (messageData && messageData.type) {
                switch (messageData.type) {
                    case 'participants_update':
                        if (window.updateAndDisplayParticipants) {
                            window.updateAndDisplayParticipants(messageData.payload);
                        }
                        break;
                    case 'new_message':
                        if (messageData.payload && messageData.payload.client_id_temp !== clientId) {
                            renderSingleMessage(messageData.payload, chatHistory, true, {});
                            scrollToBottom('smooth');
                        }
                        break;
                    case 'ai_chunk':
                        if (!currentAiTurnContainer) {
                            setupNewAiTurn();
                        }
                        accumulatedAnswerText += messageData.payload;
                        renderLiveMessage(accumulatedAnswerText);
                        break;
                    case 'ai_stream_end':
                        renderLiveMessage(accumulatedAnswerText);
                        finalizeTurnOnErrorOrClose();
                        setInputDisabledState(false, false);
                        break;
                    case 'session_deleted':
                        const chatTitle = document.getElementById('chat-session-title');
                        if (chatTitle) {
                            chatTitle.textContent = `[Deleted] ${chatTitle.textContent}`;
                        }
                        const banner = document.createElement('div');
                        banner.className = 'text-center text-sm text-red-700 bg-red-100 p-2 rounded-md font-semibold';
                        banner.textContent = 'The host has deleted this session. The chat is now read-only.';
                        chatHistory.prepend(banner);
                        setInputDisabledState(true, false);
                        break;
                    default:
                        handleStructuredMessage(messageData);
                        break;
                }
            } else if (typeof event.data === 'string' && event.data.startsWith("<ERROR>")) {
                addErrorMessage(event.data.substring(7));
                finalizeTurnOnErrorOrClose();
                setInputDisabledState(false, false);
            }
        };
    } catch (error) {
        console.error("WebSocket creation error:", error);
        addErrorMessage(`WebSocket Creation Error: ${error.message}.`);
        setInputDisabledState(true, false);
        updateAllRunButtonStates();
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    await loadLanguagesConfig();
    await initializeCurrentUser();

    setInputDisabledState(true, false);

    if (typeof marked !== 'undefined' && typeof marked.setOptions === 'function') {
        marked.setOptions({
            gfm: true, breaks: true, sanitize: false, smartLists: true, smartypants: false,
        });
    }

    if (chatForm && messageInput && sendButton && stopAiButton) {
        chatForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;
            if (!websocket || websocket.readyState !== WebSocket.OPEN) return;
            
            try {
                const mentionRegex = /@(\w+)/gi;
                const recipients = (userMessage.match(mentionRegex) || []).map(m => m.substring(1).toUpperCase());
                
                if (recipients.includes("AI")) {
                    if (!window.isAiConfigured) {
                        alert("AI provider has not been configured. Please go to User Settings to select a provider and add your API key.");
                        return;
                    }
                    setupNewAiTurn();
                    setInputDisabledState(true, true);
                }
                
                addUserMessage(userMessage);
                
                const messagePayload = {
                    type: "chat_message",
                    payload: {
                        user_input: userMessage,
                        turn_id: ++currentTurnId,
                        recipient_ids: recipients,
                        reply_to_id: null
                    }
                };
                websocket.send(JSON.stringify(messagePayload));
                messageInput.value = '';
            } catch (sendError) {
                addErrorMessage(`Failed to send message: ${sendError.message}`);
            }
        });

        stopAiButton.addEventListener('click', () => {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) return;
            websocket.send(JSON.stringify({
                type: "stop_ai_stream",
                payload: { client_id: clientId, session_id: getSessionIdFromPath(), turn_id: currentTurnId }
            }));
        });
    }

    const currentSessionId = getSessionIdFromPath();
    if (currentSessionId) {
        await loadAndDisplayChatHistory(currentSessionId);
        connectWebSocket();
    } else {
        if (messageInput) {
            setInputDisabledState(true, false);
        }
    }

    const chatHistoryScroller = document.getElementById('chat-history');
    if (chatHistoryScroller) {
        let rafId = null;
        const handleScroll = function() {
            if (rafId) cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(function() {
                const scrollerRect = chatHistoryScroller.getBoundingClientRect();
                const containers = chatHistoryScroller.querySelectorAll('.block-container');

                const measurements = [];
                containers.forEach(function(container) {
                    const header = container.querySelector('.block-header, .block-header');
                    const content = container.querySelector('pre, .block-output-console');
                    
                    if (header && content) {
                        measurements.push({
                            header: header,
                            headerRect: header.getBoundingClientRect(),
                            contentRect: content.getBoundingClientRect(),
                            container: container
                        });
                    }
                });

                measurements.forEach(function(m) {
                    const shouldStick = m.headerRect.top < scrollerRect.top && m.contentRect.bottom > scrollerRect.top;
                    
                    if (shouldStick) {
                        stickHeader(m.header, scrollerRect);
                        
                        // Handle clipping when approaching the bottom of content
                        const stickyId = m.header.dataset.stickyId;
                        if (stickyId) {
                            const stickyClone = document.getElementById(stickyId);
                            if (stickyClone) {
                                const headerHeight = stickyClone.offsetHeight;
                                const contentBottom = m.contentRect.bottom;
                                const viewportTop = scrollerRect.top + 1; // Add 1px offset
                                
                                // Calculate how much space is available for the header (add 2px buffer)
                                const availableSpace = contentBottom - viewportTop + 3;
                                
                                if (availableSpace < headerHeight && availableSpace > 0) {
                                    // Clip the header from the top by moving it up and adjusting height
                                    const clipAmount = headerHeight - availableSpace - 1;
                                    stickyClone.style.top = `${viewportTop - clipAmount - 1}px`; // Move up by clip amount
                                    stickyClone.style.clipPath = `inset(${clipAmount}px 0 0 0)`; // Clip from top
                                    stickyClone.style.height = `${headerHeight}px`; // Keep original height for proper clipping
                                    stickyClone.style.borderBottomLeftRadius = '0.375rem';
                                    stickyClone.style.borderBottomRightRadius = '0.375rem';
                                } else if (availableSpace <= 2) {
                                    // Content has scrolled completely past, hide the sticky header
                                    stickyClone.style.display = 'none';
                                } else {
                                    // Normal case: full header visible
                                    stickyClone.style.height = 'auto';
                                    stickyClone.style.top = `${scrollerRect.top}px`; // Use original viewport top without offset
                                    stickyClone.style.display = 'flex';
                                    stickyClone.style.clipPath = 'none'; // Reset clipping
                                    stickyClone.style.borderBottomLeftRadius = '0';
                                    stickyClone.style.borderBottomRightRadius = '0';
                                }
                            }
                        }
                    } else {
                        unstickHeader(m.header);
                    }
                });
            });
        };

        chatHistoryScroller.addEventListener('scroll', function(e) {
            // Only handle scroll if it's specifically from the chat history scroller
            if (e.target === chatHistoryScroller) {
                handleScroll();
            }
        }, { passive: true });
            }
});

=== app/static/session-choice.html ===
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Tesseracs Chat</title>
    <link rel="stylesheet" href="/dist/input.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script id="csrf-token-script-page-session-choice">
        window.csrfTokenRaw = "%%CSRF_TOKEN_RAW%%";
    </script>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen overflow-hidden bg-gray-100">
        <!-- Sidebar -->
        <aside id="sidebar-loader-target" class="w-64 bg-gray-800 text-gray-200 flex flex-col shrink-0 transition-all duration-300 ease-in-out">
            <!-- Sidebar content is loaded dynamically -->
        </aside>

        <!-- Sidebar Toggle Button -->
        <div class="relative z-10 flex items-center justify-center">
            <button id="sidebar-toggle" class="absolute top-1/2 -translate-y-1/2 -ml-4 bg-gray-700 hover:bg-gray-600 text-white p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 ease-in-out">
                <svg id="sidebar-toggle-icon" class="w-5 h-5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
        </div>

        <!-- Main Content -->
        <main id="session-choice-content" class="flex-1 flex flex-col p-6 overflow-y-auto">
            <div class="max-w-4xl w-full mx-auto">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Welcome, [User Name]!</h1>
                
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="host-tab-button" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-500" aria-current="page">
                            Host a Session
                        </button>
                        <button id="join-tab-button" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            Join a Session
                        </button>
                    </nav>
                </div>

                <div id="host-session-view">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Host a New Session</h2>
                        <p class="text-gray-600 mb-6">Create a new session. You can make it public for others to join or keep it private.</p>
                        <form id="host-session-form">
                            <div class="mb-4">
                                <label for="session-name" class="block text-sm font-medium text-gray-700 mb-1">Session Name</label>
                                <input type="text" id="session-name" name="name" required class="w-full py-2 px-3 border border-gray-300 rounded-md text-sm" placeholder="e.g., Project Brainstorm">
                            </div>
                            <div class="mb-4">
                                <label for="session-access" class="block text-sm font-medium text-gray-700 mb-1">Access Level</label>
                                <select id="session-access" name="access_level" class="w-full py-2 px-3 border border-gray-300 rounded-md text-sm bg-white">
                                    <option value="private" selected>Private (Only you can see and use)</option>
                                    <option value="public">Public (Visible to all, no passcode)</option>
                                    <option value="protected">Protected (Visible to all, passcode required)</option>
                                </select>
                            </div>
                            <div id="passcode-group" class="mb-4 hidden">
                                <label for="session-passcode" class="block text-sm font-medium text-gray-700 mb-1">Passcode</label>
                                <input type="password" id="session-passcode" name="passcode" class="w-full py-2 px-3 border border-gray-300 rounded-md text-sm" placeholder="Enter a passcode">
                            </div>
                            <button type="button" id="host-session-button" class="w-full flex items-center justify-center px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-medium transition duration-150">
                                Host New Session
                            </button>
                        </form>
                    </div>
                </div>

                <div id="join-session-view" class="hidden">
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Join an Existing Session</h2>
                         <p class="text-gray-600 mb-4">Here are the public and protected sessions currently active that you haven't joined yet.</p>
                        <div class="border-t border-gray-200 pt-4">
                            <ul id="joinable-session-list" class="space-y-2 max-h-80 overflow-y-auto">
                                <li class="px-3 py-1 text-gray-500 italic text-sm">Loading available sessions...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { loadSidebarHTML, populateSessionList } from '/static/js/app-ui.js';
        import { initializeDashboard, populateJoinableSessionList, connectToLobbySocket } from '/static/js/session-manager.js';
        import { initializeSidebarToggle } from '/static/js/sidebar-toggle.js';

        async function initializeDashboardPage() {
            initializeSidebarToggle();
            const userResponse = await fetch('/api/me');
            if (userResponse.ok) {
                window.currentUserInfo = await userResponse.json();
            } else {
                console.error("Failed to fetch current user data.");
                return;
            }
            initializeDashboard();
            populateJoinableSessionList();
            connectToLobbySocket();
            const sidebarLoaded = await loadSidebarHTML('/static/_sidebar.html', 'sidebar-loader-target');
            if (sidebarLoaded) {
                await populateSessionList('/api/sessions?scope=personal', 'session-list', '/chat/');
            } else {
                console.error("Session Choice Page: Sidebar loading failed.");
            }
        }
        document.addEventListener('DOMContentLoaded', initializeDashboardPage);
    </script>
    </body>
</html>


=== app/static/settings.html ===
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Settings - Tesseracs Chat</title>
    <link rel="stylesheet" href="/dist/input.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script id="csrf-token-script-page-settings">
      // This placeholder will be replaced by the server with the actual raw CSRF token.
      window.csrfTokenRaw = "%%CSRF_TOKEN_RAW%%";
    </script>
    <script>
      // Optional immediate diagnostic client-side to verify token injection
      if (typeof window.csrfTokenRaw !== 'undefined' && window.csrfTokenRaw !== "%%CSRF_TOKEN_RAW%%") {
        console.log('SETTINGS PAGE JS (after csrf-token-script): window.csrfTokenRaw is available.');
      } else {
        console.warn('SETTINGS PAGE JS (after csrf-token-script): window.csrfTokenRaw IS STILL THE PLACEHOLDER "%%CSRF_TOKEN_RAW%%" OR UNDEFINED. Value:', window.csrfTokenRaw);
      }
    </script>    
    <style>
        .sidebar-scrollable { overflow-y: auto; scrollbar-width: thin; scrollbar-color: #a0aec0 #edf2f7; }
        .sidebar-scrollable::-webkit-scrollbar { width: 6px; }
        .sidebar-scrollable::-webkit-scrollbar-track { background: #edf2f7; border-radius: 3px; }
        .sidebar-scrollable::-webkit-scrollbar-thumb { background-color: #a0aec0; border-radius: 3px; border: 1px solid #edf2f7; }
        /* Additional styles for focused state or loading states if needed */
        input:read-only, select:disabled {
            background-color: #f3f4f6; /* Tailwind gray-100 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        label {
            user-select: none;
        }
    </style>
</head>
<body class="font-inter bg-gray-100 text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <aside id="sidebar-loader-target" class="w-64 bg-gray-800 text-gray-200 flex flex-col overflow-hidden">
            </aside>

        <main class="flex-1 flex flex-col overflow-y-auto p-6 items-center">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-2xl lg:max-w-3xl"> <h1 class="text-2xl lg:text-3xl font-semibold text-gray-900 mb-6 border-b border-gray-200 pb-4">User Settings</h1>

                <div id="settings-message-area" class="p-3 rounded-md text-sm text-center mb-4" style="display: none;" role="alert" aria-live="polite"></div>

                <section id="account-settings" aria-labelledby="account-settings-heading" class="mb-8">
                    <h2 id="account-settings-heading" class="text-xl font-semibold text-gray-700 mb-5">Account Information</h2>
                    
                    <form id="update-name-form" class="space-y-4 mb-6">
                        <div class="mb-4">
                            <label for="current-name" class="block text-sm font-medium text-gray-700 mb-1">Current Name</label>
                            <input type="text" id="current-name" name="current-name" readonly
                                   class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm"
                                   placeholder="Loading...">
                        </div>
                        <div class="mb-4">
                            <label for="new-name" class="block text-sm font-medium text-gray-700 mb-1">New Name</label>
                            <input type="text" id="new-name" name="new_name" required autocomplete="name"
                                   class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150"
                                   minlength="1" maxlength="100">
                        </div>
                        <div class="mb-4">
                            <label for="current-password-for-name" class="block text-sm font-medium text-gray-700 mb-1">Current Password <span class="text-gray-500">(to confirm name change)</span></label>
                            <input type="password" id="current-password-for-name" name="current_password" required autocomplete="current-password"
                                   class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150">
                        </div>
                        <div>
                            <button type="submit" id="update-name-button"
                                    class="py-2.5 px-5 bg-blue-600 text-white rounded-md font-medium text-sm transition-colors duration-150 hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                Update Name
                            </button>
                        </div>
                    </form>

                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">Change Email</h3>
                        <p class="text-sm text-gray-500 mb-3" id="change-email-description">You will be logged out after successfully changing your email address.</p>
                        <form id="update-email-form" class="space-y-4 mb-6" aria-describedby="change-email-description">
                            <div class="mb-4">
                                <label for="current-email" class="block text-sm font-medium text-gray-700 mb-1">Current Email</label>
                                <input type="email" id="current-email" name="current-email" readonly
                                       class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm"
                                       placeholder="Loading...">
                            </div>
                            <div class="mb-4">
                                <label for="new-email" class="block text-sm font-medium text-gray-700 mb-1">New Email Address</label>
                                <input type="email" id="new-email" name="new_email" required autocomplete="email"
                                       class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150">
                            </div>
                            <div class="mb-4">
                                <label for="current-password-for-email" class="block text-sm font-medium text-gray-700 mb-1">Current Password <span class="text-gray-500">(to confirm email change)</span></label>
                                <input type="password" id="current-password-for-email" name="current_password" required autocomplete="current-password"
                                       class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150">
                            </div>
                            <div>
                                <button type="submit" id="update-email-button"
                                        class="py-2.5 px-5 bg-blue-600 text-white rounded-md font-medium text-sm transition-colors duration-150 hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Update Email Address
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">Regenerate Password</h3>
                        <p class="text-sm text-gray-500 mb-3" id="regenerate-password-description">A new password will be generated and emailed to your current email address. You will be logged out after this action.</p>
                        <form id="regenerate-password-form" class="space-y-4" aria-describedby="regenerate-password-description">
                            <div class="mb-4">
                                <label for="current-password-for-regen" class="block text-sm font-medium text-gray-700 mb-1">Current Password <span class="text-gray-500">(to confirm password regeneration)</span></label>
                                <input type="password" id="current-password-for-regen" name="current_password" required autocomplete="current-password"
                                       class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150">
                            </div>
                            <div>
                                <button type="submit" id="regenerate-password-button"
                                        class="py-2.5 px-5 bg-orange-600 text-white rounded-md font-medium text-sm transition-colors duration-150 hover:bg-orange-700 focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Regenerate Password & Send Email
                                </button>
                            </div>
                        </form>
                    </div>
                </section>

                <section id="llm-settings" class="mt-8 pt-6 border-t border-gray-200" aria-labelledby="llm-settings-heading">
                    <h2 id="llm-settings-heading" class="text-xl font-semibold text-gray-700 mb-5">LLM Configuration</h2>
                    <form id="llm-settings-form" class="space-y-4">
                        <div class="mb-4">
                            <label for="llm-provider" class="block text-sm font-medium text-gray-700 mb-1">Chat Provider</label>
                            <select id="llm-provider" name="selected_llm_provider_id"
                                    class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150"
                                    aria-describedby="llm-provider-status">
                                <option value="">Loading providers...</option>
                            </select>
                            <p id="llm-provider-status" class="text-xs text-gray-500 mt-1"></p>
                        </div>

                        <div class="mb-4">
                            <label for="llm-model" class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                            <select id="llm-model" name="selected_llm_model_id"
                                    class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150"
                                    disabled> <option value="">Select a provider first</option>
                            </select>
                        </div>

                        <div id="llm-api-key-group" class="mb-4" style="display: none;" aria-hidden="true">
                            <label for="llm-api-key" class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                            <input type="password" id="llm-api-key" name="user_llm_api_key" autocomplete="off"
                                   class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150"
                                   placeholder="Leave blank to use system key or if not required"
                                   aria-describedby="llm-api-key-status">
                            <p id="llm-api-key-status" class="text-xs text-gray-500 mt-1"></p>
                        </div>

                        <div id="llm-base-url-group" class="mb-4" style="display: none;" aria-hidden="true">
                            <label for="llm-base-url" class="block text-sm font-medium text-gray-700 mb-1">Custom Base URL <span class="text-gray-500">(Optional)</span></label>
                            <input type="url" id="llm-base-url" name="selected_llm_base_url" autocomplete="off"
                                   class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150"
                                   placeholder="e.g., http://localhost:11434/v1"
                                   aria-describedby="llm-base-url-description">
                               <p id="llm-base-url-description" class="text-xs text-gray-500 mt-1">Typically for OpenAI-compatible servers or custom Ollama instances.</p>
                        </div>
                        <div>
                            <button type="submit" id="save-llm-settings-button"
                                    class="py-2.5 px-5 bg-blue-600 text-white rounded-md font-medium text-sm transition-colors duration-150 hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                Save LLM Settings
                            </button>
                        </div>
                    </form>
                </section>
            </div>
        </main>
    </div>

    <script type="module" src="/static/js/settings.js"></script>
    </body>
</html>

=== app/static/email_templates/password_reset_email.html ===
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset - Tesseracs Chat</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            line-height: 1.6;
            color: #333333;
            margin: 0;
            padding: 0;
            background-color: #f7fafc;
        }
        .email-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 25px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #edf2f7;
        }
        .header h2 {
            color: #2c5282;
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        .content {
            padding-top: 10px;
        }
        .content p {
            margin: 18px 0;
            font-size: 16px;
            color: #4a5568;
        }
        .content strong {
            color: #2b6cb0;
            font-weight: 500;
        }
        .password-display-container {
            margin: 25px 0;
            text-align: center;
        }
        .password-label {
            font-size: 16px;
            color: #4a5568;
            margin-bottom: 8px;
            display: block;
        }
        .password-value {
            background-color: #edf2f7;
            padding: 15px 20px;
            border-radius: 6px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2em;
            text-align: center;
            color: #1a202c;
            border: 1px solid #cbd5e0;
            display: inline-block;
            letter-spacing: 1px;
            word-break: break-all;
        }
        .login-button-container {
            text-align: center;
            margin: 30px 0;
        }
        .login-button {
            display: inline-block;
            background-color: #3182ce;
            color: #ffffff !important;
            padding: 14px 28px;
            text-decoration: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .login-button:hover {
            background-color: #2b6cb0;
        }
        .footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #edf2f7;
            font-size: 0.875em;
            color: #718096;
        }
        .link {
            color: #3182ce;
            text-decoration: none;
        }
        .link:hover {
            text-decoration: underline;
        }
        .url-display { /* Style for displaying the URL as text */
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #718096; /* Tailwind gray-600 */
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="header">
            <h2>Password Reset for Tesseracs Chat</h2>
        </div>
        <div class="content">
            <p>Hello {{ recipient_name }},</p>
            <p>As requested, your password for Tesseracs Chat has been reset.</p>
            <p>Your email: <strong>{{ email }}</strong></p>
            <div class="password-display-container">
                <span class="password-label">Your new password is:</span>
                <div class="password-value">{{ password }}</div>
            </div>
            <p>Please use this new password to log in. You can log in here:</p>
            <div class="login-button-container">
                <a href="{{ login_url }}" class="login-button">Log In to Tesseracs Chat</a>
            </div>
            <p>If the button doesn't work, you can also <a href="{{ login_url }}" class="link">click here to log in</a> or copy and paste the following URL into your browser: <br><span class="url-display">{{ login_url }}</span></p>
            <p>If you did not request a password reset, please contact support or secure your account immediately.</p>
        </div>
        <div class="footer">
            <p>Thanks,<br>The Tesseracs Chat Team</p>
            <p><small>This is an automated message. Please do not reply directly to this email.</small></p>
        </div>
    </div>
</body>
</html>


=== app/static/email_templates/registration_email.html ===
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Tesseracs Chat</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            line-height: 1.6;
            color: #333333;
            margin: 0;
            padding: 0;
            background-color: #f7fafc; /* Tailwind gray-100 */
        }
        .email-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 25px;
            border: 1px solid #e2e8f0; /* Tailwind gray-300 */
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #edf2f7; /* Tailwind gray-200 */
        }
        .header h2 {
            color: #2c5282; /* Tailwind blue-800 */
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        .content {
            padding-top: 10px;
        }
        .content p {
            margin: 18px 0;
            font-size: 16px;
            color: #4a5568; /* Tailwind gray-700 */
        }
        .content strong {
            color: #2b6cb0; /* Tailwind blue-700 */
            font-weight: 500;
        }
        .password-display-container {
            margin: 25px 0;
            text-align: center;
        }
        .password-label {
            font-size: 16px;
            color: #4a5568; /* Tailwind gray-700 */
            margin-bottom: 8px;
            display: block;
        }
        .password-value {
            background-color: #edf2f7; /* Tailwind gray-200 */
            padding: 15px 20px;
            border-radius: 6px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2em;
            text-align: center;
            color: #1a202c; /* Tailwind gray-900 */
            border: 1px solid #cbd5e0; /* Tailwind gray-400 */
            display: inline-block;
            letter-spacing: 1px;
            word-break: break-all;
        }
        .login-button-container {
            text-align: center;
            margin: 30px 0;
        }
        .login-button {
            display: inline-block;
            background-color: #3182ce; /* Tailwind blue-500 */
            color: #ffffff !important;
            padding: 14px 28px;
            text-decoration: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .login-button:hover {
            background-color: #2b6cb0; /* Tailwind blue-600 */
        }
        .footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #edf2f7; /* Tailwind gray-200 */
            font-size: 0.875em; /* text-sm */
            color: #718096; /* Tailwind gray-600 */
        }
        .link {
            color: #3182ce; /* Tailwind blue-500 */
            text-decoration: none;
        }
        .link:hover {
            text-decoration: underline;
        }
        .url-display { /* Style for displaying the URL as text */
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #718096; /* Tailwind gray-600 */
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="header">
            <h2>Welcome to Tesseracs Chat, {{ recipient_name }}!</h2>
        </div>
        <div class="content">
            <p>Your account has been successfully created.</p>
            <p>Your email: <strong>{{ email }}</strong></p>
            <div class="password-display-container">
                <span class="password-label">Your password is:</span>
                <div class="password-value">{{ password }}</div>
            </div>
            <p>Please use this password to log in. You can log in here:</p>
            <div class="login-button-container">
                <a href="{{ login_url }}" class="login-button">Log In to Tesseracs Chat</a>
            </div>
            <p>If the button doesn't work, you can also <a href="{{ login_url }}" class="link">click here to log in</a> or copy and paste the following URL into your browser: <br><span class="url-display">{{ login_url }}</span></p>
            <p>Please keep this password secure. While you cannot choose your own password, you can regenerate a new secure password at any time from the user settings page after logging in.</p>
            <p>If you did not request this account, please ignore this email.</p>
        </div>
        <div class="footer">
            <p>Thanks,<br>The Tesseracs Chat Team</p>
            <p><small>This is an automated message. Please do not reply directly to this email.</small></p>
        </div>
    </div>
</body>
</html>

=== app/static/js/app-ui.js ===
window.isNavigatingAway = false;


export async function loadSidebarHTML(sidebarHtmlPath = '/static/_sidebar.html', targetElementId = 'sidebar-loader-target') {
    const sidebarTarget = document.getElementById(targetElementId);
    if (!sidebarTarget) {
        console.error(`app-ui.js: Sidebar target element with ID '${targetElementId}' not found.`);
        return false;
    }
    try {
        const response = await fetch(sidebarHtmlPath);
        if (!response.ok) {
            console.error(`app-ui.js: Failed to fetch sidebar HTML from ${sidebarHtmlPath}. Status: ${response.status}`);
            sidebarTarget.innerHTML = `<p class="p-4 text-red-400">Error loading sidebar (status: ${response.status}).</p>`;
            return false;
        }
        const sidebarHTML = await response.text();
        sidebarTarget.innerHTML = sidebarHTML;
        return true;
    } catch (error) {
        console.error('app-ui.js: Could not load sidebar due to an error:', error);
        sidebarTarget.innerHTML = '<p class="p-4 text-red-400">Error loading sidebar content (exception).</p>';
        return false;
    }
}

export async function populateSessionList(apiEndpoint = '/api/sessions', listElementId = 'session-list', chatPageBaseUrl = '/chat/') {
    const sessionListElement = document.getElementById(listElementId);
    const filterInput = document.getElementById('session-filter-input');
    if (!sessionListElement || !filterInput) return;

    sessionListElement.innerHTML = '<li class="px-3 py-1 text-gray-400 italic text-sm">Loading sessions...</li>';

    try {
        const response = await fetch(apiEndpoint);
        if (!response.ok) throw new Error(`Server responded with status ${response.status}`);
        
        const sessions = await response.json();
        sessionListElement.innerHTML = '';

        if (sessions.length === 0) {
            sessionListElement.innerHTML = '<li class="px-3 py-1 text-gray-400 text-sm italic">No sessions in your history.</li>';
        } else {
            const currentUser = window.currentUserInfo;
            const displayedSessions = sessions.slice(0, 10);
            
            window.sessionHistory = sessions;

            displayedSessions.forEach(session => {
                const isHost = currentUser && currentUser.id === session.host_user_id;
                
                const listItem = document.createElement('li');
                listItem.className = 'flex items-center justify-between pr-2 group rounded-md';
                listItem.dataset.sessionName = (session.name || '').toLowerCase();

                const link = document.createElement('a');
                link.className = 'flex items-center pl-3 pr-1 py-2 text-gray-300 rounded-l-md text-sm truncate flex-grow';
                
                if (!session.is_active) {
                    link.classList.add('text-gray-500', 'italic', 'cursor-not-allowed');
                    link.innerHTML = `<span>[Deleted] ${session.name}</span>`;
                } else {
                    const base = chatPageBaseUrl.endsWith('/') ? chatPageBaseUrl : chatPageBaseUrl + '/';
                    link.href = `${base}${session.id}`;
                    const isActive = window.location.pathname.startsWith(link.pathname);
                    link.classList.add('group-hover:text-white', 'hover:text-white');
                    if (isActive) {
                        listItem.classList.add('bg-gray-700');
                        link.classList.add('font-semibold');
                    }
                    link.textContent = session.name;
                    if (isHost) {
                        const hostBadge = document.createElement('span');
                        hostBadge.className = 'ml-2 text-xs font-semibold bg-yellow-500 text-yellow-900 px-1.5 py-0.5 rounded-full';
                        hostBadge.textContent = 'Host';
                        link.appendChild(hostBadge);
                    }
                }
                
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '&#x2715;';
                deleteButton.className = 'ml-2 p-1 text-gray-500 hover:text-red-400 focus:outline-none rounded-full hover:bg-gray-600 opacity-0 group-hover:opacity-100 flex-shrink-0';
                deleteButton.title = isHost ? 'Hide from history' : 'Leave session';
                deleteButton.onclick = (e) => { e.preventDefault(); e.stopPropagation(); handleDeleteSession(session, isHost, listItem); };

                listItem.appendChild(link);
                listItem.appendChild(deleteButton);
                sessionListElement.appendChild(listItem);
            });

            filterInput.addEventListener('input', () => {
                const filterText = filterInput.value.toLowerCase();
                sessionListElement.querySelectorAll('li').forEach(item => {
                    item.style.display = item.dataset.sessionName.includes(filterText) ? 'flex' : 'none';
                });
            });
        }
    } catch (error) {
        sessionListElement.innerHTML = `<li class="px-3 py-1 text-red-400 text-sm">Could not load sessions.</li>`;
    }
}

export async function handleDeleteSession(session, isHost, listItem) {
    const sessionName = session.name || 'Unnamed Session';
    
    // Determine the correct confirmation text based on the session's state
    let actionText = '';
    if (!session.is_active) {
        actionText = `Are you sure you want to remove "[Deleted] ${sessionName}" from your history?`;
    } else if (isHost) {
        actionText = `You are the host. Hiding this session will NOT delete it. You can find it again in your settings. Continue?`;
    } else {
        actionText = `Are you sure you want to leave the session "${sessionName}"? This action cannot be undone.`;
    }

    if (!window.confirm(actionText)) {
        return;
    }

    // This is the primary fix: We now ALWAYS send a request to the backend.
    try {
        const response = await fetch(`/api/sessions/${session.id}`, {
            method: 'DELETE',
            headers: { 'X-CSRF-Token': window.csrfTokenRaw }
        });

        if (response.status === 204) {
            // The action was successful, now update the UI.
            if (window.location.pathname.startsWith(`/chat/${session.id}`)) {
                window.location.href = '/'; 
            } else {
                listItem.remove();
            }
        } else {
            const errorData = await response.json();
            alert(`Error: ${errorData.detail}`);
        }
    } catch (error) {
        alert('An error occurred while processing your request.');
    }
}



=== app/static/js/d3.min.js ===
// https://d3js.org Version 4.13.0. Copyright 2018 Mike Bostock.
(function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.d3=t.d3||{})})(this,function(t){"use strict";function n(t,n){return t<n?-1:t>n?1:t>=n?0:NaN}function e(t){return 1===t.length&&(t=function(t){return function(e,r){return n(t(e),r)}}(t)),{left:function(n,e,r,i){for(null==r&&(r=0),null==i&&(i=n.length);r<i;){var o=r+i>>>1;t(n[o],e)<0?r=o+1:i=o}return r},right:function(n,e,r,i){for(null==r&&(r=0),null==i&&(i=n.length);r<i;){var o=r+i>>>1;t(n[o],e)>0?i=o:r=o+1}return r}}}function r(t,n){return[t,n]}function i(t){return null===t?NaN:+t}function o(t,n){var e,r,o=t.length,u=0,a=-1,c=0,s=0;if(null==n)for(;++a<o;)isNaN(e=i(t[a]))||(s+=(r=e-c)*(e-(c+=r/++u)));else for(;++a<o;)isNaN(e=i(n(t[a],a,t)))||(s+=(r=e-c)*(e-(c+=r/++u)));if(u>1)return s/(u-1)}function u(t,n){var e=o(t,n);return e?Math.sqrt(e):e}function a(t,n){var e,r,i,o=t.length,u=-1;if(null==n){for(;++u<o;)if(null!=(e=t[u])&&e>=e)for(r=i=e;++u<o;)null!=(e=t[u])&&(r>e&&(r=e),i<e&&(i=e))}else for(;++u<o;)if(null!=(e=n(t[u],u,t))&&e>=e)for(r=i=e;++u<o;)null!=(e=n(t[u],u,t))&&(r>e&&(r=e),i<e&&(i=e));return[r,i]}function c(t){return function(){return t}}function s(t){return t}function f(t,n,e){t=+t,n=+n,e=(i=arguments.length)<2?(n=t,t=0,1):i<3?1:+e;for(var r=-1,i=0|Math.max(0,Math.ceil((n-t)/e)),o=new Array(i);++r<i;)o[r]=t+r*e;return o}function l(t,n,e){var r,i,o,u,a=-1;if(n=+n,t=+t,e=+e,t===n&&e>0)return[t];if((r=n<t)&&(i=t,t=n,n=i),0===(u=h(t,n,e))||!isFinite(u))return[];if(u>0)for(t=Math.ceil(t/u),n=Math.floor(n/u),o=new Array(i=Math.ceil(n-t+1));++a<i;)o[a]=(t+a)*u;else for(t=Math.floor(t*u),n=Math.ceil(n*u),o=new Array(i=Math.ceil(t-n+1));++a<i;)o[a]=(t-a)/u;return r&&o.reverse(),o}function h(t,n,e){var r=(n-t)/Math.max(0,e),i=Math.floor(Math.log(r)/Math.LN10),o=r/Math.pow(10,i);return i>=0?(o>=Hs?10:o>=js?5:o>=Xs?2:1)*Math.pow(10,i):-Math.pow(10,-i)/(o>=Hs?10:o>=js?5:o>=Xs?2:1)}function p(t,n,e){var r=Math.abs(n-t)/Math.max(0,e),i=Math.pow(10,Math.floor(Math.log(r)/Math.LN10)),o=r/i;return o>=Hs?i*=10:o>=js?i*=5:o>=Xs&&(i*=2),n<t?-i:i}function d(t){return Math.ceil(Math.log(t.length)/Math.LN2)+1}function v(t,n,e){if(null==e&&(e=i),r=t.length){if((n=+n)<=0||r<2)return+e(t[0],0,t);if(n>=1)return+e(t[r-1],r-1,t);var r,o=(r-1)*n,u=Math.floor(o),a=+e(t[u],u,t);return a+(+e(t[u+1],u+1,t)-a)*(o-u)}}function g(t){for(var n,e,r,i=t.length,o=-1,u=0;++o<i;)u+=t[o].length;for(e=new Array(u);--i>=0;)for(n=(r=t[i]).length;--n>=0;)e[--u]=r[n];return e}function _(t,n){var e,r,i=t.length,o=-1;if(null==n){for(;++o<i;)if(null!=(e=t[o])&&e>=e)for(r=e;++o<i;)null!=(e=t[o])&&r>e&&(r=e)}else for(;++o<i;)if(null!=(e=n(t[o],o,t))&&e>=e)for(r=e;++o<i;)null!=(e=n(t[o],o,t))&&r>e&&(r=e);return r}function y(t){if(!(i=t.length))return[];for(var n=-1,e=_(t,m),r=new Array(e);++n<e;)for(var i,o=-1,u=r[n]=new Array(i);++o<i;)u[o]=t[o][n];return r}function m(t){return t.length}function x(t){return t}function b(t){return"translate("+(t+.5)+",0)"}function w(t){return"translate(0,"+(t+.5)+")"}function M(){return!this.__axis}function T(t,n){function e(e){var h=null==i?n.ticks?n.ticks.apply(n,r):n.domain():i,p=null==o?n.tickFormat?n.tickFormat.apply(n,r):x:o,d=Math.max(u,0)+c,v=n.range(),g=+v[0]+.5,_=+v[v.length-1]+.5,y=(n.bandwidth?function(t){var n=Math.max(0,t.bandwidth()-1)/2;return t.round()&&(n=Math.round(n)),function(e){return+t(e)+n}}:function(t){return function(n){return+t(n)}})(n.copy()),m=e.selection?e.selection():e,b=m.selectAll(".domain").data([null]),w=m.selectAll(".tick").data(h,n).order(),T=w.exit(),N=w.enter().append("g").attr("class","tick"),k=w.select("line"),S=w.select("text");b=b.merge(b.enter().insert("path",".tick").attr("class","domain").attr("stroke","#000")),w=w.merge(N),k=k.merge(N.append("line").attr("stroke","#000").attr(f+"2",s*u)),S=S.merge(N.append("text").attr("fill","#000").attr(f,s*d).attr("dy",t===$s?"0em":t===Zs?"0.71em":"0.32em")),e!==m&&(b=b.transition(e),w=w.transition(e),k=k.transition(e),S=S.transition(e),T=T.transition(e).attr("opacity",Qs).attr("transform",function(t){return isFinite(t=y(t))?l(t):this.getAttribute("transform")}),N.attr("opacity",Qs).attr("transform",function(t){var n=this.parentNode.__axis;return l(n&&isFinite(n=n(t))?n:y(t))})),T.remove(),b.attr("d",t===Gs||t==Ws?"M"+s*a+","+g+"H0.5V"+_+"H"+s*a:"M"+g+","+s*a+"V0.5H"+_+"V"+s*a),w.attr("opacity",1).attr("transform",function(t){return l(y(t))}),k.attr(f+"2",s*u),S.attr(f,s*d).text(p),m.filter(M).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor",t===Ws?"start":t===Gs?"end":"middle"),m.each(function(){this.__axis=y})}var r=[],i=null,o=null,u=6,a=6,c=3,s=t===$s||t===Gs?-1:1,f=t===Gs||t===Ws?"x":"y",l=t===$s||t===Zs?b:w;return e.scale=function(t){return arguments.length?(n=t,e):n},e.ticks=function(){return r=Vs.call(arguments),e},e.tickArguments=function(t){return arguments.length?(r=null==t?[]:Vs.call(t),e):r.slice()},e.tickValues=function(t){return arguments.length?(i=null==t?null:Vs.call(t),e):i&&i.slice()},e.tickFormat=function(t){return arguments.length?(o=t,e):o},e.tickSize=function(t){return arguments.length?(u=a=+t,e):u},e.tickSizeInner=function(t){return arguments.length?(u=+t,e):u},e.tickSizeOuter=function(t){return arguments.length?(a=+t,e):a},e.tickPadding=function(t){return arguments.length?(c=+t,e):c},e}function N(){for(var t,n=0,e=arguments.length,r={};n<e;++n){if(!(t=arguments[n]+"")||t in r)throw new Error("illegal type: "+t);r[t]=[]}return new k(r)}function k(t){this._=t}function S(t,n,e){for(var r=0,i=t.length;r<i;++r)if(t[r].name===n){t[r]=Js,t=t.slice(0,r).concat(t.slice(r+1));break}return null!=e&&t.push({name:n,value:e}),t}function E(t){var n=t+="",e=n.indexOf(":");return e>=0&&"xmlns"!==(n=t.slice(0,e))&&(t=t.slice(e+1)),tf.hasOwnProperty(n)?{space:tf[n],local:t}:t}function A(t){var n=E(t);return(n.local?function(t){return function(){return this.ownerDocument.createElementNS(t.space,t.local)}}:function(t){return function(){var n=this.ownerDocument,e=this.namespaceURI;return e===Ks&&n.documentElement.namespaceURI===Ks?n.createElement(t):n.createElementNS(e,t)}})(n)}function C(){}function z(t){return null==t?C:function(){return this.querySelector(t)}}function P(){return[]}function R(t){return null==t?P:function(){return this.querySelectorAll(t)}}function L(t){return new Array(t.length)}function q(t,n){this.ownerDocument=t.ownerDocument,this.namespaceURI=t.namespaceURI,this._next=null,this._parent=t,this.__data__=n}function D(t,n,e,r,i,o){for(var u,a=0,c=n.length,s=o.length;a<s;++a)(u=n[a])?(u.__data__=o[a],r[a]=u):e[a]=new q(t,o[a]);for(;a<c;++a)(u=n[a])&&(i[a]=u)}function U(t,n,e,r,i,o,u){var a,c,s,f={},l=n.length,h=o.length,p=new Array(l);for(a=0;a<l;++a)(c=n[a])&&(p[a]=s=uf+u.call(c,c.__data__,a,n),s in f?i[a]=c:f[s]=c);for(a=0;a<h;++a)(c=f[s=uf+u.call(t,o[a],a,o)])?(r[a]=c,c.__data__=o[a],f[s]=null):e[a]=new q(t,o[a]);for(a=0;a<l;++a)(c=n[a])&&f[p[a]]===c&&(i[a]=c)}function O(t,n){return t<n?-1:t>n?1:t>=n?0:NaN}function F(t){return t.ownerDocument&&t.ownerDocument.defaultView||t.document&&t||t.defaultView}function I(t,n){return t.style.getPropertyValue(n)||F(t).getComputedStyle(t,null).getPropertyValue(n)}function Y(t){return t.trim().split(/^|\s+/)}function B(t){return t.classList||new H(t)}function H(t){this._node=t,this._names=Y(t.getAttribute("class")||"")}function j(t,n){for(var e=B(t),r=-1,i=n.length;++r<i;)e.add(n[r])}function X(t,n){for(var e=B(t),r=-1,i=n.length;++r<i;)e.remove(n[r])}function V(){this.textContent=""}function $(){this.innerHTML=""}function W(){this.nextSibling&&this.parentNode.appendChild(this)}function Z(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function G(){return null}function Q(){var t=this.parentNode;t&&t.removeChild(this)}function J(){return this.parentNode.insertBefore(this.cloneNode(!1),this.nextSibling)}function K(){return this.parentNode.insertBefore(this.cloneNode(!0),this.nextSibling)}function tt(t,n,e){return t=nt(t,n,e),function(n){var e=n.relatedTarget;e&&(e===this||8&e.compareDocumentPosition(this))||t.call(this,n)}}function nt(n,e,r){return function(i){var o=t.event;t.event=i;try{n.call(this,this.__data__,e,r)}finally{t.event=o}}}function et(t){return function(){var n=this.__on;if(n){for(var e,r=0,i=-1,o=n.length;r<o;++r)e=n[r],t.type&&e.type!==t.type||e.name!==t.name?n[++i]=e:this.removeEventListener(e.type,e.listener,e.capture);++i?n.length=i:delete this.__on}}}function rt(t,n,e){var r=af.hasOwnProperty(t.type)?tt:nt;return function(i,o,u){var a,c=this.__on,s=r(n,o,u);if(c)for(var f=0,l=c.length;f<l;++f)if((a=c[f]).type===t.type&&a.name===t.name)return this.removeEventListener(a.type,a.listener,a.capture),this.addEventListener(a.type,a.listener=s,a.capture=e),void(a.value=n);this.addEventListener(t.type,s,e),a={type:t.type,name:t.name,value:n,listener:s,capture:e},c?c.push(a):this.__on=[a]}}function it(n,e,r,i){var o=t.event;n.sourceEvent=t.event,t.event=n;try{return e.apply(r,i)}finally{t.event=o}}function ot(t,n,e){var r=F(t),i=r.CustomEvent;"function"==typeof i?i=new i(n,e):(i=r.document.createEvent("Event"),e?(i.initEvent(n,e.bubbles,e.cancelable),i.detail=e.detail):i.initEvent(n,!1,!1)),t.dispatchEvent(i)}function ut(t,n){this._groups=t,this._parents=n}function at(){return new ut([[document.documentElement]],cf)}function ct(t){return"string"==typeof t?new ut([[document.querySelector(t)]],[document.documentElement]):new ut([[t]],cf)}function st(){return new ft}function ft(){this._="@"+(++sf).toString(36)}function lt(){for(var n,e=t.event;n=e.sourceEvent;)e=n;return e}function ht(t,n){var e=t.ownerSVGElement||t;if(e.createSVGPoint){var r=e.createSVGPoint();return r.x=n.clientX,r.y=n.clientY,r=r.matrixTransform(t.getScreenCTM().inverse()),[r.x,r.y]}var i=t.getBoundingClientRect();return[n.clientX-i.left-t.clientLeft,n.clientY-i.top-t.clientTop]}function pt(t){var n=lt();return n.changedTouches&&(n=n.changedTouches[0]),ht(t,n)}function dt(t,n,e){arguments.length<3&&(e=n,n=lt().changedTouches);for(var r,i=0,o=n?n.length:0;i<o;++i)if((r=n[i]).identifier===e)return ht(t,r);return null}function vt(){t.event.stopImmediatePropagation()}function gt(){t.event.preventDefault(),t.event.stopImmediatePropagation()}function _t(t){var n=t.document.documentElement,e=ct(t).on("dragstart.drag",gt,!0);"onselectstart"in n?e.on("selectstart.drag",gt,!0):(n.__noselect=n.style.MozUserSelect,n.style.MozUserSelect="none")}function yt(t,n){var e=t.document.documentElement,r=ct(t).on("dragstart.drag",null);n&&(r.on("click.drag",gt,!0),setTimeout(function(){r.on("click.drag",null)},0)),"onselectstart"in e?r.on("selectstart.drag",null):(e.style.MozUserSelect=e.__noselect,delete e.__noselect)}function mt(t){return function(){return t}}function xt(t,n,e,r,i,o,u,a,c,s){this.target=t,this.type=n,this.subject=e,this.identifier=r,this.active=i,this.x=o,this.y=u,this.dx=a,this.dy=c,this._=s}function bt(){return!t.event.button}function wt(){return this.parentNode}function Mt(n){return null==n?{x:t.event.x,y:t.event.y}:n}function Tt(){return"ontouchstart"in this}function Nt(t,n,e){t.prototype=n.prototype=e,e.constructor=t}function kt(t,n){var e=Object.create(t.prototype);for(var r in n)e[r]=n[r];return e}function St(){}function Et(t){var n;return t=(t+"").trim().toLowerCase(),(n=pf.exec(t))?(n=parseInt(n[1],16),new Rt(n>>8&15|n>>4&240,n>>4&15|240&n,(15&n)<<4|15&n,1)):(n=df.exec(t))?At(parseInt(n[1],16)):(n=vf.exec(t))?new Rt(n[1],n[2],n[3],1):(n=gf.exec(t))?new Rt(255*n[1]/100,255*n[2]/100,255*n[3]/100,1):(n=_f.exec(t))?Ct(n[1],n[2],n[3],n[4]):(n=yf.exec(t))?Ct(255*n[1]/100,255*n[2]/100,255*n[3]/100,n[4]):(n=mf.exec(t))?Lt(n[1],n[2]/100,n[3]/100,1):(n=xf.exec(t))?Lt(n[1],n[2]/100,n[3]/100,n[4]):bf.hasOwnProperty(t)?At(bf[t]):"transparent"===t?new Rt(NaN,NaN,NaN,0):null}function At(t){return new Rt(t>>16&255,t>>8&255,255&t,1)}function Ct(t,n,e,r){return r<=0&&(t=n=e=NaN),new Rt(t,n,e,r)}function zt(t){return t instanceof St||(t=Et(t)),t?(t=t.rgb(),new Rt(t.r,t.g,t.b,t.opacity)):new Rt}function Pt(t,n,e,r){return 1===arguments.length?zt(t):new Rt(t,n,e,null==r?1:r)}function Rt(t,n,e,r){this.r=+t,this.g=+n,this.b=+e,this.opacity=+r}function Lt(t,n,e,r){return r<=0?t=n=e=NaN:e<=0||e>=1?t=n=NaN:n<=0&&(t=NaN),new Dt(t,n,e,r)}function qt(t,n,e,r){return 1===arguments.length?function(t){if(t instanceof Dt)return new Dt(t.h,t.s,t.l,t.opacity);if(t instanceof St||(t=Et(t)),!t)return new Dt;if(t instanceof Dt)return t;var n=(t=t.rgb()).r/255,e=t.g/255,r=t.b/255,i=Math.min(n,e,r),o=Math.max(n,e,r),u=NaN,a=o-i,c=(o+i)/2;return a?(u=n===o?(e-r)/a+6*(e<r):e===o?(r-n)/a+2:(n-e)/a+4,a/=c<.5?o+i:2-o-i,u*=60):a=c>0&&c<1?0:u,new Dt(u,a,c,t.opacity)}(t):new Dt(t,n,e,null==r?1:r)}function Dt(t,n,e,r){this.h=+t,this.s=+n,this.l=+e,this.opacity=+r}function Ut(t,n,e){return 255*(t<60?n+(e-n)*t/60:t<180?e:t<240?n+(e-n)*(240-t)/60:n)}function Ot(t){if(t instanceof It)return new It(t.l,t.a,t.b,t.opacity);if(t instanceof Vt){var n=t.h*wf;return new It(t.l,Math.cos(n)*t.c,Math.sin(n)*t.c,t.opacity)}t instanceof Rt||(t=zt(t));var e=jt(t.r),r=jt(t.g),i=jt(t.b),o=Yt((.4124564*e+.3575761*r+.1804375*i)/Tf),u=Yt((.2126729*e+.7151522*r+.072175*i)/Nf);return new It(116*u-16,500*(o-u),200*(u-Yt((.0193339*e+.119192*r+.9503041*i)/kf)),t.opacity)}function Ft(t,n,e,r){return 1===arguments.length?Ot(t):new It(t,n,e,null==r?1:r)}function It(t,n,e,r){this.l=+t,this.a=+n,this.b=+e,this.opacity=+r}function Yt(t){return t>Cf?Math.pow(t,1/3):t/Af+Sf}function Bt(t){return t>Ef?t*t*t:Af*(t-Sf)}function Ht(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function jt(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function Xt(t,n,e,r){return 1===arguments.length?function(t){if(t instanceof Vt)return new Vt(t.h,t.c,t.l,t.opacity);t instanceof It||(t=Ot(t));var n=Math.atan2(t.b,t.a)*Mf;return new Vt(n<0?n+360:n,Math.sqrt(t.a*t.a+t.b*t.b),t.l,t.opacity)}(t):new Vt(t,n,e,null==r?1:r)}function Vt(t,n,e,r){this.h=+t,this.c=+n,this.l=+e,this.opacity=+r}function $t(t,n,e,r){return 1===arguments.length?function(t){if(t instanceof Wt)return new Wt(t.h,t.s,t.l,t.opacity);t instanceof Rt||(t=zt(t));var n=t.r/255,e=t.g/255,r=t.b/255,i=(Df*r+Lf*n-qf*e)/(Df+Lf-qf),o=r-i,u=(Rf*(e-i)-zf*o)/Pf,a=Math.sqrt(u*u+o*o)/(Rf*i*(1-i)),c=a?Math.atan2(u,o)*Mf-120:NaN;return new Wt(c<0?c+360:c,a,i,t.opacity)}(t):new Wt(t,n,e,null==r?1:r)}function Wt(t,n,e,r){this.h=+t,this.s=+n,this.l=+e,this.opacity=+r}function Zt(t,n,e,r,i){var o=t*t,u=o*t;return((1-3*t+3*o-u)*n+(4-6*o+3*u)*e+(1+3*t+3*o-3*u)*r+u*i)/6}function Gt(t){var n=t.length-1;return function(e){var r=e<=0?e=0:e>=1?(e=1,n-1):Math.floor(e*n),i=t[r],o=t[r+1],u=r>0?t[r-1]:2*i-o,a=r<n-1?t[r+2]:2*o-i;return Zt((e-r/n)*n,u,i,o,a)}}function Qt(t){var n=t.length;return function(e){var r=Math.floor(((e%=1)<0?++e:e)*n),i=t[(r+n-1)%n],o=t[r%n],u=t[(r+1)%n],a=t[(r+2)%n];return Zt((e-r/n)*n,i,o,u,a)}}function Jt(t){return function(){return t}}function Kt(t,n){return function(e){return t+e*n}}function tn(t,n){var e=n-t;return e?Kt(t,e>180||e<-180?e-360*Math.round(e/360):e):Jt(isNaN(t)?n:t)}function nn(t){return 1==(t=+t)?en:function(n,e){return e-n?function(t,n,e){return t=Math.pow(t,e),n=Math.pow(n,e)-t,e=1/e,function(r){return Math.pow(t+r*n,e)}}(n,e,t):Jt(isNaN(n)?e:n)}}function en(t,n){var e=n-t;return e?Kt(t,e):Jt(isNaN(t)?n:t)}function rn(t){return function(n){var e,r,i=n.length,o=new Array(i),u=new Array(i),a=new Array(i);for(e=0;e<i;++e)r=Pt(n[e]),o[e]=r.r||0,u[e]=r.g||0,a[e]=r.b||0;return o=t(o),u=t(u),a=t(a),r.opacity=1,function(t){return r.r=o(t),r.g=u(t),r.b=a(t),r+""}}}function on(t,n){var e,r=n?n.length:0,i=t?Math.min(r,t.length):0,o=new Array(i),u=new Array(r);for(e=0;e<i;++e)o[e]=fn(t[e],n[e]);for(;e<r;++e)u[e]=n[e];return function(t){for(e=0;e<i;++e)u[e]=o[e](t);return u}}function un(t,n){var e=new Date;return t=+t,n-=t,function(r){return e.setTime(t+n*r),e}}function an(t,n){return t=+t,n-=t,function(e){return t+n*e}}function cn(t,n){var e,r={},i={};null!==t&&"object"==typeof t||(t={}),null!==n&&"object"==typeof n||(n={});for(e in n)e in t?r[e]=fn(t[e],n[e]):i[e]=n[e];return function(t){for(e in r)i[e]=r[e](t);return i}}function sn(t,n){var e,r,i,o=Vf.lastIndex=$f.lastIndex=0,u=-1,a=[],c=[];for(t+="",n+="";(e=Vf.exec(t))&&(r=$f.exec(n));)(i=r.index)>o&&(i=n.slice(o,i),a[u]?a[u]+=i:a[++u]=i),(e=e[0])===(r=r[0])?a[u]?a[u]+=r:a[++u]=r:(a[++u]=null,c.push({i:u,x:an(e,r)})),o=$f.lastIndex;return o<n.length&&(i=n.slice(o),a[u]?a[u]+=i:a[++u]=i),a.length<2?c[0]?function(t){return function(n){return t(n)+""}}(c[0].x):function(t){return function(){return t}}(n):(n=c.length,function(t){for(var e,r=0;r<n;++r)a[(e=c[r]).i]=e.x(t);return a.join("")})}function fn(t,n){var e,r=typeof n;return null==n||"boolean"===r?Jt(n):("number"===r?an:"string"===r?(e=Et(n))?(n=e,Hf):sn:n instanceof Et?Hf:n instanceof Date?un:Array.isArray(n)?on:"function"!=typeof n.valueOf&&"function"!=typeof n.toString||isNaN(n)?cn:an)(t,n)}function ln(t,n){return t=+t,n-=t,function(e){return Math.round(t+n*e)}}function hn(t,n,e,r,i,o){var u,a,c;return(u=Math.sqrt(t*t+n*n))&&(t/=u,n/=u),(c=t*e+n*r)&&(e-=t*c,r-=n*c),(a=Math.sqrt(e*e+r*r))&&(e/=a,r/=a,c/=a),t*r<n*e&&(t=-t,n=-n,c=-c,u=-u),{translateX:i,translateY:o,rotate:Math.atan2(n,t)*Wf,skewX:Math.atan(c)*Wf,scaleX:u,scaleY:a}}function pn(t,n,e,r){function i(t){return t.length?t.pop()+" ":""}return function(o,u){var a=[],c=[];return o=t(o),u=t(u),function(t,r,i,o,u,a){if(t!==i||r!==o){var c=u.push("translate(",null,n,null,e);a.push({i:c-4,x:an(t,i)},{i:c-2,x:an(r,o)})}else(i||o)&&u.push("translate("+i+n+o+e)}(o.translateX,o.translateY,u.translateX,u.translateY,a,c),function(t,n,e,o){t!==n?(t-n>180?n+=360:n-t>180&&(t+=360),o.push({i:e.push(i(e)+"rotate(",null,r)-2,x:an(t,n)})):n&&e.push(i(e)+"rotate("+n+r)}(o.rotate,u.rotate,a,c),function(t,n,e,o){t!==n?o.push({i:e.push(i(e)+"skewX(",null,r)-2,x:an(t,n)}):n&&e.push(i(e)+"skewX("+n+r)}(o.skewX,u.skewX,a,c),function(t,n,e,r,o,u){if(t!==e||n!==r){var a=o.push(i(o)+"scale(",null,",",null,")");u.push({i:a-4,x:an(t,e)},{i:a-2,x:an(n,r)})}else 1===e&&1===r||o.push(i(o)+"scale("+e+","+r+")")}(o.scaleX,o.scaleY,u.scaleX,u.scaleY,a,c),o=u=null,function(t){for(var n,e=-1,r=c.length;++e<r;)a[(n=c[e]).i]=n.x(t);return a.join("")}}}function dn(t){return((t=Math.exp(t))+1/t)/2}function vn(t,n){var e,r,i=t[0],o=t[1],u=t[2],a=n[0],c=n[1],s=n[2],f=a-i,l=c-o,h=f*f+l*l;if(h<nl)r=Math.log(s/u)/Jf,e=function(t){return[i+t*f,o+t*l,u*Math.exp(Jf*t*r)]};else{var p=Math.sqrt(h),d=(s*s-u*u+tl*h)/(2*u*Kf*p),v=(s*s-u*u-tl*h)/(2*s*Kf*p),g=Math.log(Math.sqrt(d*d+1)-d),_=Math.log(Math.sqrt(v*v+1)-v);r=(_-g)/Jf,e=function(t){var n=t*r,e=dn(g),a=u/(Kf*p)*(e*function(t){return((t=Math.exp(2*t))-1)/(t+1)}(Jf*n+g)-function(t){return((t=Math.exp(t))-1/t)/2}(g));return[i+a*f,o+a*l,u*e/dn(Jf*n+g)]}}return e.duration=1e3*r,e}function gn(t){return function(n,e){var r=t((n=qt(n)).h,(e=qt(e)).h),i=en(n.s,e.s),o=en(n.l,e.l),u=en(n.opacity,e.opacity);return function(t){return n.h=r(t),n.s=i(t),n.l=o(t),n.opacity=u(t),n+""}}}function _n(t){return function(n,e){var r=t((n=Xt(n)).h,(e=Xt(e)).h),i=en(n.c,e.c),o=en(n.l,e.l),u=en(n.opacity,e.opacity);return function(t){return n.h=r(t),n.c=i(t),n.l=o(t),n.opacity=u(t),n+""}}}function yn(t){return function n(e){function r(n,r){var i=t((n=$t(n)).h,(r=$t(r)).h),o=en(n.s,r.s),u=en(n.l,r.l),a=en(n.opacity,r.opacity);return function(t){return n.h=i(t),n.s=o(t),n.l=u(Math.pow(t,e)),n.opacity=a(t),n+""}}return e=+e,r.gamma=n,r}(1)}function mn(){return pl||(gl(xn),pl=vl.now()+dl)}function xn(){pl=0}function bn(){this._call=this._time=this._next=null}function wn(t,n,e){var r=new bn;return r.restart(t,n,e),r}function Mn(){mn(),++cl;for(var t,n=Yf;n;)(t=pl-n._time)>=0&&n._call.call(null,t),n=n._next;--cl}function Tn(){pl=(hl=vl.now())+dl,cl=sl=0;try{Mn()}finally{cl=0,function(){var t,n,e=Yf,r=1/0;for(;e;)e._call?(r>e._time&&(r=e._time),t=e,e=e._next):(n=e._next,e._next=null,e=t?t._next=n:Yf=n);Bf=t,kn(r)}(),pl=0}}function Nn(){var t=vl.now(),n=t-hl;n>ll&&(dl-=n,hl=t)}function kn(t){if(!cl){sl&&(sl=clearTimeout(sl));t-pl>24?(t<1/0&&(sl=setTimeout(Tn,t-vl.now()-dl)),fl&&(fl=clearInterval(fl))):(fl||(hl=vl.now(),fl=setInterval(Nn,ll)),cl=1,gl(Tn))}}function Sn(t,n,e){var r=new bn;return n=null==n?0:+n,r.restart(function(e){r.stop(),t(e+n)},n,e),r}function En(t,n,e,r,i,o){var u=t.__transition;if(u){if(e in u)return}else t.__transition={};(function(t,n,e){function r(c){var s,f,l,h;if(e.state!==xl)return o();for(s in a)if((h=a[s]).name===e.name){if(h.state===wl)return Sn(r);h.state===Ml?(h.state=Nl,h.timer.stop(),h.on.call("interrupt",t,t.__data__,h.index,h.group),delete a[s]):+s<n&&(h.state=Nl,h.timer.stop(),delete a[s])}if(Sn(function(){e.state===wl&&(e.state=Ml,e.timer.restart(i,e.delay,e.time),i(c))}),e.state=bl,e.on.call("start",t,t.__data__,e.index,e.group),e.state===bl){for(e.state=wl,u=new Array(l=e.tween.length),s=0,f=-1;s<l;++s)(h=e.tween[s].value.call(t,t.__data__,e.index,e.group))&&(u[++f]=h);u.length=f+1}}function i(n){for(var r=n<e.duration?e.ease.call(null,n/e.duration):(e.timer.restart(o),e.state=Tl,1),i=-1,a=u.length;++i<a;)u[i].call(null,r);e.state===Tl&&(e.on.call("end",t,t.__data__,e.index,e.group),o())}function o(){e.state=Nl,e.timer.stop(),delete a[n];for(var r in a)return;delete t.__transition}var u,a=t.__transition;a[n]=e,e.timer=wn(function(t){e.state=xl,e.timer.restart(r,e.delay,e.time),e.delay<=t&&r(t-e.delay)},0,e.time)})(t,e,{name:n,index:r,group:i,on:_l,tween:yl,time:o.time,delay:o.delay,duration:o.duration,ease:o.ease,timer:null,state:ml})}function An(t,n){var e=zn(t,n);if(e.state>ml)throw new Error("too late; already scheduled");return e}function Cn(t,n){var e=zn(t,n);if(e.state>bl)throw new Error("too late; already started");return e}function zn(t,n){var e=t.__transition;if(!e||!(e=e[n]))throw new Error("transition not found");return e}function Pn(t,n){var e,r,i,o=t.__transition,u=!0;if(o){n=null==n?null:n+"";for(i in o)(e=o[i]).name===n?(r=e.state>bl&&e.state<Tl,e.state=Nl,e.timer.stop(),r&&e.on.call("interrupt",t,t.__data__,e.index,e.group),delete o[i]):u=!1;u&&delete t.__transition}}function Rn(t,n,e){var r=t._id;return t.each(function(){var t=Cn(this,r);(t.value||(t.value={}))[n]=e.apply(this,arguments)}),function(t){return zn(t,r).value[n]}}function Ln(t,n){var e;return("number"==typeof n?an:n instanceof Et?Hf:(e=Et(n))?(n=e,Hf):sn)(t,n)}function qn(t,n,e,r){this._groups=t,this._parents=n,this._name=e,this._id=r}function Dn(t){return at().transition(t)}function Un(){return++Sl}function On(t){return((t*=2)<=1?t*t:--t*(2-t)+1)/2}function Fn(t){return((t*=2)<=1?t*t*t:(t-=2)*t*t+2)/2}function In(t){return(1-Math.cos(Pl*t))/2}function Yn(t){return((t*=2)<=1?Math.pow(2,10*t-10):2-Math.pow(2,10-10*t))/2}function Bn(t){return((t*=2)<=1?1-Math.sqrt(1-t*t):Math.sqrt(1-(t-=2)*t)+1)/2}function Hn(t){return(t=+t)<Ll?Hl*t*t:t<Dl?Hl*(t-=ql)*t+Ul:t<Fl?Hl*(t-=Ol)*t+Il:Hl*(t-=Yl)*t+Bl}function jn(t,n){for(var e;!(e=t.__transition)||!(e=e[n]);)if(!(t=t.parentNode))return Ql.time=mn(),Ql;return e}function Xn(t){return function(){return t}}function Vn(){t.event.stopImmediatePropagation()}function $n(){t.event.preventDefault(),t.event.stopImmediatePropagation()}function Wn(t){return{type:t}}function Zn(){return!t.event.button}function Gn(){var t=this.ownerSVGElement||this;return[[0,0],[t.width.baseVal.value,t.height.baseVal.value]]}function Qn(t){for(;!t.__brush;)if(!(t=t.parentNode))return;return t.__brush}function Jn(t){return t[0][0]===t[1][0]||t[0][1]===t[1][1]}function Kn(n){function e(t){var e=t.property("__brush",a).selectAll(".overlay").data([Wn("overlay")]);e.enter().append("rect").attr("class","overlay").attr("pointer-events","all").attr("cursor",uh.overlay).merge(e).each(function(){var t=Qn(this).extent;ct(this).attr("x",t[0][0]).attr("y",t[0][1]).attr("width",t[1][0]-t[0][0]).attr("height",t[1][1]-t[0][1])}),t.selectAll(".selection").data([Wn("selection")]).enter().append("rect").attr("class","selection").attr("cursor",uh.selection).attr("fill","#777").attr("fill-opacity",.3).attr("stroke","#fff").attr("shape-rendering","crispEdges");var i=t.selectAll(".handle").data(n.handles,function(t){return t.type});i.exit().remove(),i.enter().append("rect").attr("class",function(t){return"handle handle--"+t.type}).attr("cursor",function(t){return uh[t.type]}),t.each(r).attr("fill","none").attr("pointer-events","all").style("-webkit-tap-highlight-color","rgba(0,0,0,0)").on("mousedown.brush touchstart.brush",u)}function r(){var t=ct(this),n=Qn(this).selection;n?(t.selectAll(".selection").style("display",null).attr("x",n[0][0]).attr("y",n[0][1]).attr("width",n[1][0]-n[0][0]).attr("height",n[1][1]-n[0][1]),t.selectAll(".handle").style("display",null).attr("x",function(t){return"e"===t.type[t.type.length-1]?n[1][0]-h/2:n[0][0]-h/2}).attr("y",function(t){return"s"===t.type[0]?n[1][1]-h/2:n[0][1]-h/2}).attr("width",function(t){return"n"===t.type||"s"===t.type?n[1][0]-n[0][0]+h:h}).attr("height",function(t){return"e"===t.type||"w"===t.type?n[1][1]-n[0][1]+h:h})):t.selectAll(".selection,.handle").style("display","none").attr("x",null).attr("y",null).attr("width",null).attr("height",null)}function i(t,n){return t.__brush.emitter||new o(t,n)}function o(t,n){this.that=t,this.args=n,this.state=t.__brush,this.active=0}function u(){function e(){var t=pt(w);!L||x||b||(Math.abs(t[0]-D[0])>Math.abs(t[1]-D[1])?b=!0:x=!0),D=t,m=!0,$n(),o()}function o(){var t;switch(_=D[0]-q[0],y=D[1]-q[1],T){case th:case Kl:N&&(_=Math.max(C-a,Math.min(P-p,_)),s=a+_,d=p+_),k&&(y=Math.max(z-l,Math.min(R-v,y)),h=l+y,g=v+y);break;case nh:N<0?(_=Math.max(C-a,Math.min(P-a,_)),s=a+_,d=p):N>0&&(_=Math.max(C-p,Math.min(P-p,_)),s=a,d=p+_),k<0?(y=Math.max(z-l,Math.min(R-l,y)),h=l+y,g=v):k>0&&(y=Math.max(z-v,Math.min(R-v,y)),h=l,g=v+y);break;case eh:N&&(s=Math.max(C,Math.min(P,a-_*N)),d=Math.max(C,Math.min(P,p+_*N))),k&&(h=Math.max(z,Math.min(R,l-y*k)),g=Math.max(z,Math.min(R,v+y*k)))}d<s&&(N*=-1,t=a,a=p,p=t,t=s,s=d,d=t,M in ah&&F.attr("cursor",uh[M=ah[M]])),g<h&&(k*=-1,t=l,l=v,v=t,t=h,h=g,g=t,M in ch&&F.attr("cursor",uh[M=ch[M]])),S.selection&&(A=S.selection),x&&(s=A[0][0],d=A[1][0]),b&&(h=A[0][1],g=A[1][1]),A[0][0]===s&&A[0][1]===h&&A[1][0]===d&&A[1][1]===g||(S.selection=[[s,h],[d,g]],r.call(w),U.brush())}function u(){if(Vn(),t.event.touches){if(t.event.touches.length)return;c&&clearTimeout(c),c=setTimeout(function(){c=null},500),O.on("touchmove.brush touchend.brush touchcancel.brush",null)}else yt(t.event.view,m),I.on("keydown.brush keyup.brush mousemove.brush mouseup.brush",null);O.attr("pointer-events","all"),F.attr("cursor",uh.overlay),S.selection&&(A=S.selection),Jn(A)&&(S.selection=null,r.call(w)),U.end()}if(t.event.touches){if(t.event.changedTouches.length<t.event.touches.length)return $n()}else if(c)return;if(f.apply(this,arguments)){var a,s,l,h,p,d,v,g,_,y,m,x,b,w=this,M=t.event.target.__data__.type,T="selection"===(t.event.metaKey?M="overlay":M)?Kl:t.event.altKey?eh:nh,N=n===ih?null:sh[M],k=n===rh?null:fh[M],S=Qn(w),E=S.extent,A=S.selection,C=E[0][0],z=E[0][1],P=E[1][0],R=E[1][1],L=N&&k&&t.event.shiftKey,q=pt(w),D=q,U=i(w,arguments).beforestart();"overlay"===M?S.selection=A=[[a=n===ih?C:q[0],l=n===rh?z:q[1]],[p=n===ih?P:a,v=n===rh?R:l]]:(a=A[0][0],l=A[0][1],p=A[1][0],v=A[1][1]),s=a,h=l,d=p,g=v;var O=ct(w).attr("pointer-events","none"),F=O.selectAll(".overlay").attr("cursor",uh[M]);if(t.event.touches)O.on("touchmove.brush",e,!0).on("touchend.brush touchcancel.brush",u,!0);else{var I=ct(t.event.view).on("keydown.brush",function(){switch(t.event.keyCode){case 16:L=N&&k;break;case 18:T===nh&&(N&&(p=d-_*N,a=s+_*N),k&&(v=g-y*k,l=h+y*k),T=eh,o());break;case 32:T!==nh&&T!==eh||(N<0?p=d-_:N>0&&(a=s-_),k<0?v=g-y:k>0&&(l=h-y),T=th,F.attr("cursor",uh.selection),o());break;default:return}$n()},!0).on("keyup.brush",function(){switch(t.event.keyCode){case 16:L&&(x=b=L=!1,o());break;case 18:T===eh&&(N<0?p=d:N>0&&(a=s),k<0?v=g:k>0&&(l=h),T=nh,o());break;case 32:T===th&&(t.event.altKey?(N&&(p=d-_*N,a=s+_*N),k&&(v=g-y*k,l=h+y*k),T=eh):(N<0?p=d:N>0&&(a=s),k<0?v=g:k>0&&(l=h),T=nh),F.attr("cursor",uh[M]),o());break;default:return}$n()},!0).on("mousemove.brush",e,!0).on("mouseup.brush",u,!0);_t(t.event.view)}Vn(),Pn(w),r.call(w),U.start()}}function a(){var t=this.__brush||{selection:null};return t.extent=s.apply(this,arguments),t.dim=n,t}var c,s=Gn,f=Zn,l=N(e,"start","brush","end"),h=6;return e.move=function(t,e){t.selection?t.on("start.brush",function(){i(this,arguments).beforestart().start()}).on("interrupt.brush end.brush",function(){i(this,arguments).end()}).tween("brush",function(){function t(t){u.selection=1===t&&Jn(s)?null:f(t),r.call(o),a.brush()}var o=this,u=o.__brush,a=i(o,arguments),c=u.selection,s=n.input("function"==typeof e?e.apply(this,arguments):e,u.extent),f=fn(c,s);return c&&s?t:t(1)}):t.each(function(){var t=arguments,o=this.__brush,u=n.input("function"==typeof e?e.apply(this,t):e,o.extent),a=i(this,t).beforestart();Pn(this),o.selection=null==u||Jn(u)?null:u,r.call(this),a.start().brush().end()})},o.prototype={beforestart:function(){return 1==++this.active&&(this.state.emitter=this,this.starting=!0),this},start:function(){return this.starting&&(this.starting=!1,this.emit("start")),this},brush:function(){return this.emit("brush"),this},end:function(){return 0==--this.active&&(delete this.state.emitter,this.emit("end")),this},emit:function(t){it(new function(t,n,e){this.target=t,this.type=n,this.selection=e}(e,t,n.output(this.state.selection)),l.apply,l,[t,this.that,this.args])}},e.extent=function(t){return arguments.length?(s="function"==typeof t?t:Xn([[+t[0][0],+t[0][1]],[+t[1][0],+t[1][1]]]),e):s},e.filter=function(t){return arguments.length?(f="function"==typeof t?t:Xn(!!t),e):f},e.handleSize=function(t){return arguments.length?(h=+t,e):h},e.on=function(){var t=l.on.apply(l,arguments);return t===l?e:t},e}function te(t){return function(){return t}}function ne(){this._x0=this._y0=this._x1=this._y1=null,this._=""}function ee(){return new ne}function re(t){return t.source}function ie(t){return t.target}function oe(t){return t.radius}function ue(t){return t.startAngle}function ae(t){return t.endAngle}function ce(){}function se(t,n){var e=new ce;if(t instanceof ce)t.each(function(t,n){e.set(n,t)});else if(Array.isArray(t)){var r,i=-1,o=t.length;if(null==n)for(;++i<o;)e.set(i,t[i]);else for(;++i<o;)e.set(n(r=t[i],i,t),r)}else if(t)for(var u in t)e.set(u,t[u]);return e}function fe(){return{}}function le(t,n,e){t[n]=e}function he(){return se()}function pe(t,n,e){t.set(n,e)}function de(){}function ve(t,n){var e=new de;if(t instanceof de)t.each(function(t){e.add(t)});else if(t){var r=-1,i=t.length;if(null==n)for(;++r<i;)e.add(t[r]);else for(;++r<i;)e.add(n(t[r],r,t))}return e}function ge(t){return new Function("d","return {"+t.map(function(t,n){return JSON.stringify(t)+": d["+n+"]"}).join(",")+"}")}function _e(t){function n(t,n){function e(){if(s)return Mh;if(f)return f=!1,wh;var n,e,r=a;if(t.charCodeAt(r)===Th){for(;a++<u&&t.charCodeAt(a)!==Th||t.charCodeAt(++a)===Th;);return(n=a)>=u?s=!0:(e=t.charCodeAt(a++))===Nh?f=!0:e===kh&&(f=!0,t.charCodeAt(a)===Nh&&++a),t.slice(r+1,n-1).replace(/""/g,'"')}for(;a<u;){if((e=t.charCodeAt(n=a++))===Nh)f=!0;else if(e===kh)f=!0,t.charCodeAt(a)===Nh&&++a;else if(e!==o)continue;return t.slice(r,n)}return s=!0,t.slice(r,u)}var r,i=[],u=t.length,a=0,c=0,s=u<=0,f=!1;for(t.charCodeAt(u-1)===Nh&&--u,t.charCodeAt(u-1)===kh&&--u;(r=e())!==Mh;){for(var l=[];r!==wh&&r!==Mh;)l.push(r),r=e();n&&null==(l=n(l,c++))||i.push(l)}return i}function e(n){return n.map(r).join(t)}function r(t){return null==t?"":i.test(t+="")?'"'+t.replace(/"/g,'""')+'"':t}var i=new RegExp('["'+t+"\n\r]"),o=t.charCodeAt(0);return{parse:function(t,e){var r,i,o=n(t,function(t,n){if(r)return r(t,n-1);i=t,r=e?function(t,n){var e=ge(t);return function(r,i){return n(e(r),i,t)}}(t,e):ge(t)});return o.columns=i||[],o},parseRows:n,format:function(n,e){return null==e&&(e=function(t){var n=Object.create(null),e=[];return t.forEach(function(t){for(var r in t)r in n||e.push(n[r]=r)}),e}(n)),[e.map(r).join(t)].concat(n.map(function(n){return e.map(function(t){return r(n[t])}).join(t)})).join("\n")},formatRows:function(t){return t.map(e).join("\n")}}}function ye(t){return function(){return t}}function me(){return 1e-6*(Math.random()-.5)}function xe(t,n,e,r){if(isNaN(n)||isNaN(e))return t;var i,o,u,a,c,s,f,l,h,p=t._root,d={data:r},v=t._x0,g=t._y0,_=t._x1,y=t._y1;if(!p)return t._root=d,t;for(;p.length;)if((s=n>=(o=(v+_)/2))?v=o:_=o,(f=e>=(u=(g+y)/2))?g=u:y=u,i=p,!(p=p[l=f<<1|s]))return i[l]=d,t;if(a=+t._x.call(null,p.data),c=+t._y.call(null,p.data),n===a&&e===c)return d.next=p,i?i[l]=d:t._root=d,t;do{i=i?i[l]=new Array(4):t._root=new Array(4),(s=n>=(o=(v+_)/2))?v=o:_=o,(f=e>=(u=(g+y)/2))?g=u:y=u}while((l=f<<1|s)==(h=(c>=u)<<1|a>=o));return i[h]=p,i[l]=d,t}function be(t,n,e,r,i){this.node=t,this.x0=n,this.y0=e,this.x1=r,this.y1=i}function we(t){return t[0]}function Me(t){return t[1]}function Te(t,n,e){var r=new Ne(null==n?we:n,null==e?Me:e,NaN,NaN,NaN,NaN);return null==t?r:r.addAll(t)}function Ne(t,n,e,r,i,o){this._x=t,this._y=n,this._x0=e,this._y0=r,this._x1=i,this._y1=o,this._root=void 0}function ke(t){for(var n={data:t.data},e=n;t=t.next;)e=e.next={data:t.data};return n}function Se(t){return t.x+t.vx}function Ee(t){return t.y+t.vy}function Ae(t){return t.index}function Ce(t,n){var e=t.get(n);if(!e)throw new Error("missing: "+n);return e}function ze(t){return t.x}function Pe(t){return t.y}function Re(t,n){if((e=(t=n?t.toExponential(n-1):t.toExponential()).indexOf("e"))<0)return null;var e,r=t.slice(0,e);return[r.length>1?r[0]+r.slice(2):r,+t.slice(e+1)]}function Le(t){return(t=Re(Math.abs(t)))?t[1]:NaN}function qe(t,n){var e=Re(t,n);if(!e)return t+"";var r=e[0],i=e[1];return i<0?"0."+new Array(-i).join("0")+r:r.length>i+1?r.slice(0,i+1)+"."+r.slice(i+1):r+new Array(i-r.length+2).join("0")}function De(t){return new Ue(t)}function Ue(t){if(!(n=Bh.exec(t)))throw new Error("invalid format: "+t);var n,e=n[1]||" ",r=n[2]||">",i=n[3]||"-",o=n[4]||"",u=!!n[5],a=n[6]&&+n[6],c=!!n[7],s=n[8]&&+n[8].slice(1),f=n[9]||"";"n"===f?(c=!0,f="g"):Yh[f]||(f=""),(u||"0"===e&&"="===r)&&(u=!0,e="0",r="="),this.fill=e,this.align=r,this.sign=i,this.symbol=o,this.zero=u,this.width=a,this.comma=c,this.precision=s,this.type=f}function Oe(t){return t}function Fe(t){function n(t){function n(t){var n,r,u,f=g,x=_;if("c"===v)x=y(t)+x,t="";else{var b=(t=+t)<0;if(t=y(Math.abs(t),d),b&&0==+t&&(b=!1),f=(b?"("===s?s:"-":"-"===s||"("===s?"":s)+f,x=("s"===v?jh[8+Oh/3]:"")+x+(b&&"("===s?")":""),m)for(n=-1,r=t.length;++n<r;)if(48>(u=t.charCodeAt(n))||u>57){x=(46===u?i+t.slice(n+1):t.slice(n))+x,t=t.slice(0,n);break}}p&&!l&&(t=e(t,1/0));var w=f.length+t.length+x.length,M=w<h?new Array(h-w+1).join(a):"";switch(p&&l&&(t=e(M+t,M.length?h-x.length:1/0),M=""),c){case"<":t=f+t+x+M;break;case"=":t=f+M+t+x;break;case"^":t=M.slice(0,w=M.length>>1)+f+t+x+M.slice(w);break;default:t=M+f+t+x}return o(t)}var a=(t=De(t)).fill,c=t.align,s=t.sign,f=t.symbol,l=t.zero,h=t.width,p=t.comma,d=t.precision,v=t.type,g="$"===f?r[0]:"#"===f&&/[boxX]/.test(v)?"0"+v.toLowerCase():"",_="$"===f?r[1]:/[%p]/.test(v)?u:"",y=Yh[v],m=!v||/[defgprs%]/.test(v);return d=null==d?v?6:12:/[gprs]/.test(v)?Math.max(1,Math.min(21,d)):Math.max(0,Math.min(20,d)),n.toString=function(){return t+""},n}var e=t.grouping&&t.thousands?function(t,n){return function(e,r){for(var i=e.length,o=[],u=0,a=t[0],c=0;i>0&&a>0&&(c+a+1>r&&(a=Math.max(1,r-c)),o.push(e.substring(i-=a,i+a)),!((c+=a+1)>r));)a=t[u=(u+1)%t.length];return o.reverse().join(n)}}(t.grouping,t.thousands):Oe,r=t.currency,i=t.decimal,o=t.numerals?function(t){return function(n){return n.replace(/[0-9]/g,function(n){return t[+n]})}}(t.numerals):Oe,u=t.percent||"%";return{format:n,formatPrefix:function(t,e){var r=n((t=De(t),t.type="f",t)),i=3*Math.max(-8,Math.min(8,Math.floor(Le(e)/3))),o=Math.pow(10,-i),u=jh[8+i/3];return function(t){return r(o*t)+u}}}}function Ie(n){return Hh=Fe(n),t.format=Hh.format,t.formatPrefix=Hh.formatPrefix,Hh}function Ye(t){return Math.max(0,-Le(Math.abs(t)))}function Be(t,n){return Math.max(0,3*Math.max(-8,Math.min(8,Math.floor(Le(n)/3)))-Le(Math.abs(t)))}function He(t,n){return t=Math.abs(t),n=Math.abs(n)-t,Math.max(0,Le(n)-Le(t))+1}function je(){return new Xe}function Xe(){this.reset()}function Ve(t,n,e){var r=t.s=n+e,i=r-n,o=r-i;t.t=n-o+(e-i)}function $e(t){return t>1?0:t<-1?Np:Math.acos(t)}function We(t){return t>1?kp:t<-1?-kp:Math.asin(t)}function Ze(t){return(t=Fp(t/2))*t}function Ge(){}function Qe(t,n){t&&jp.hasOwnProperty(t.type)&&jp[t.type](t,n)}function Je(t,n,e){var r,i=-1,o=t.length-e;for(n.lineStart();++i<o;)r=t[i],n.point(r[0],r[1],r[2]);n.lineEnd()}function Ke(t,n){var e=-1,r=t.length;for(n.polygonStart();++e<r;)Je(t[e],n,1);n.polygonEnd()}function tr(t,n){t&&Hp.hasOwnProperty(t.type)?Hp[t.type](t,n):Qe(t,n)}function nr(){$p.point=rr}function er(){ir(Xh,Vh)}function rr(t,n){$p.point=ir,Xh=t,Vh=n,$h=t*=Cp,Wh=Lp(n=(n*=Cp)/2+Sp),Zh=Fp(n)}function ir(t,n){n=(n*=Cp)/2+Sp;var e=(t*=Cp)-$h,r=e>=0?1:-1,i=r*e,o=Lp(n),u=Fp(n),a=Zh*u,c=Wh*o+a*Lp(i),s=a*r*Fp(i);Xp.add(Rp(s,c)),$h=t,Wh=o,Zh=u}function or(t){return[Rp(t[1],t[0]),We(t[2])]}function ur(t){var n=t[0],e=t[1],r=Lp(e);return[r*Lp(n),r*Fp(n),Fp(e)]}function ar(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}function cr(t,n){return[t[1]*n[2]-t[2]*n[1],t[2]*n[0]-t[0]*n[2],t[0]*n[1]-t[1]*n[0]]}function sr(t,n){t[0]+=n[0],t[1]+=n[1],t[2]+=n[2]}function fr(t,n){return[t[0]*n,t[1]*n,t[2]*n]}function lr(t){var n=Yp(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=n,t[1]/=n,t[2]/=n}function hr(t,n){ip.push(op=[Gh=t,Jh=t]),n<Qh&&(Qh=n),n>Kh&&(Kh=n)}function pr(t,n){var e=ur([t*Cp,n*Cp]);if(rp){var r=cr(rp,e),i=cr([r[1],-r[0],0],r);lr(i),i=or(i);var o,u=t-tp,a=u>0?1:-1,c=i[0]*Ap*a,s=zp(u)>180;s^(a*tp<c&&c<a*t)?(o=i[1]*Ap)>Kh&&(Kh=o):(c=(c+360)%360-180,s^(a*tp<c&&c<a*t)?(o=-i[1]*Ap)<Qh&&(Qh=o):(n<Qh&&(Qh=n),n>Kh&&(Kh=n))),s?t<tp?mr(Gh,t)>mr(Gh,Jh)&&(Jh=t):mr(t,Jh)>mr(Gh,Jh)&&(Gh=t):Jh>=Gh?(t<Gh&&(Gh=t),t>Jh&&(Jh=t)):t>tp?mr(Gh,t)>mr(Gh,Jh)&&(Jh=t):mr(t,Jh)>mr(Gh,Jh)&&(Gh=t)}else ip.push(op=[Gh=t,Jh=t]);n<Qh&&(Qh=n),n>Kh&&(Kh=n),rp=e,tp=t}function dr(){Zp.point=pr}function vr(){op[0]=Gh,op[1]=Jh,Zp.point=hr,rp=null}function gr(t,n){if(rp){var e=t-tp;Wp.add(zp(e)>180?e+(e>0?360:-360):e)}else np=t,ep=n;$p.point(t,n),pr(t,n)}function _r(){$p.lineStart()}function yr(){gr(np,ep),$p.lineEnd(),zp(Wp)>Mp&&(Gh=-(Jh=180)),op[0]=Gh,op[1]=Jh,rp=null}function mr(t,n){return(n-=t)<0?n+360:n}function xr(t,n){return t[0]-n[0]}function br(t,n){return t[0]<=t[1]?t[0]<=n&&n<=t[1]:n<t[0]||t[1]<n}function wr(t,n){t*=Cp;var e=Lp(n*=Cp);Mr(e*Lp(t),e*Fp(t),Fp(n))}function Mr(t,n,e){cp+=(t-cp)/++up,sp+=(n-sp)/up,fp+=(e-fp)/up}function Tr(){Gp.point=Nr}function Nr(t,n){t*=Cp;var e=Lp(n*=Cp);mp=e*Lp(t),xp=e*Fp(t),bp=Fp(n),Gp.point=kr,Mr(mp,xp,bp)}function kr(t,n){t*=Cp;var e=Lp(n*=Cp),r=e*Lp(t),i=e*Fp(t),o=Fp(n),u=Rp(Yp((u=xp*o-bp*i)*u+(u=bp*r-mp*o)*u+(u=mp*i-xp*r)*u),mp*r+xp*i+bp*o);ap+=u,lp+=u*(mp+(mp=r)),hp+=u*(xp+(xp=i)),pp+=u*(bp+(bp=o)),Mr(mp,xp,bp)}function Sr(){Gp.point=wr}function Er(){Gp.point=Cr}function Ar(){zr(_p,yp),Gp.point=wr}function Cr(t,n){_p=t,yp=n,t*=Cp,n*=Cp,Gp.point=zr;var e=Lp(n);mp=e*Lp(t),xp=e*Fp(t),bp=Fp(n),Mr(mp,xp,bp)}function zr(t,n){t*=Cp;var e=Lp(n*=Cp),r=e*Lp(t),i=e*Fp(t),o=Fp(n),u=xp*o-bp*i,a=bp*r-mp*o,c=mp*i-xp*r,s=Yp(u*u+a*a+c*c),f=We(s),l=s&&-f/s;dp+=l*u,vp+=l*a,gp+=l*c,ap+=f,lp+=f*(mp+(mp=r)),hp+=f*(xp+(xp=i)),pp+=f*(bp+(bp=o)),Mr(mp,xp,bp)}function Pr(t){return function(){return t}}function Rr(t,n){function e(e,r){return e=t(e,r),n(e[0],e[1])}return t.invert&&n.invert&&(e.invert=function(e,r){return(e=n.invert(e,r))&&t.invert(e[0],e[1])}),e}function Lr(t,n){return[t>Np?t-Ep:t<-Np?t+Ep:t,n]}function qr(t,n,e){return(t%=Ep)?n||e?Rr(Ur(t),Or(n,e)):Ur(t):n||e?Or(n,e):Lr}function Dr(t){return function(n,e){return n+=t,[n>Np?n-Ep:n<-Np?n+Ep:n,e]}}function Ur(t){var n=Dr(t);return n.invert=Dr(-t),n}function Or(t,n){function e(t,n){var e=Lp(n),a=Lp(t)*e,c=Fp(t)*e,s=Fp(n),f=s*r+a*i;return[Rp(c*o-f*u,a*r-s*i),We(f*o+c*u)]}var r=Lp(t),i=Fp(t),o=Lp(n),u=Fp(n);return e.invert=function(t,n){var e=Lp(n),a=Lp(t)*e,c=Fp(t)*e,s=Fp(n),f=s*o-c*u;return[Rp(c*o+s*u,a*r+f*i),We(f*r-a*i)]},e}function Fr(t){function n(n){return n=t(n[0]*Cp,n[1]*Cp),n[0]*=Ap,n[1]*=Ap,n}return t=qr(t[0]*Cp,t[1]*Cp,t.length>2?t[2]*Cp:0),n.invert=function(n){return n=t.invert(n[0]*Cp,n[1]*Cp),n[0]*=Ap,n[1]*=Ap,n},n}function Ir(t,n,e,r,i,o){if(e){var u=Lp(n),a=Fp(n),c=r*e;null==i?(i=n+r*Ep,o=n-c/2):(i=Yr(u,i),o=Yr(u,o),(r>0?i<o:i>o)&&(i+=r*Ep));for(var s,f=i;r>0?f>o:f<o;f-=c)s=or([u,-a*Lp(f),-a*Fp(f)]),t.point(s[0],s[1])}}function Yr(t,n){(n=ur(n))[0]-=t,lr(n);var e=$e(-n[1]);return((-n[2]<0?-e:e)+Ep-Mp)%Ep}function Br(){var t,n=[];return{point:function(n,e){t.push([n,e])},lineStart:function(){n.push(t=[])},lineEnd:Ge,rejoin:function(){n.length>1&&n.push(n.pop().concat(n.shift()))},result:function(){var e=n;return n=[],t=null,e}}}function Hr(t,n){return zp(t[0]-n[0])<Mp&&zp(t[1]-n[1])<Mp}function jr(t,n,e,r){this.x=t,this.z=n,this.o=e,this.e=r,this.v=!1,this.n=this.p=null}function Xr(t,n,e,r,i){var o,u,a=[],c=[];if(t.forEach(function(t){if(!((n=t.length-1)<=0)){var n,e,r=t[0],u=t[n];if(Hr(r,u)){for(i.lineStart(),o=0;o<n;++o)i.point((r=t[o])[0],r[1]);i.lineEnd()}else a.push(e=new jr(r,t,null,!0)),c.push(e.o=new jr(r,null,e,!1)),a.push(e=new jr(u,t,null,!1)),c.push(e.o=new jr(u,null,e,!0))}}),a.length){for(c.sort(n),Vr(a),Vr(c),o=0,u=c.length;o<u;++o)c[o].e=e=!e;for(var s,f,l=a[0];;){for(var h=l,p=!0;h.v;)if((h=h.n)===l)return;s=h.z,i.lineStart();do{if(h.v=h.o.v=!0,h.e){if(p)for(o=0,u=s.length;o<u;++o)i.point((f=s[o])[0],f[1]);else r(h.x,h.n.x,1,i);h=h.n}else{if(p)for(s=h.p.z,o=s.length-1;o>=0;--o)i.point((f=s[o])[0],f[1]);else r(h.x,h.p.x,-1,i);h=h.p}s=(h=h.o).z,p=!p}while(!h.v);i.lineEnd()}}}function Vr(t){if(n=t.length){for(var n,e,r=0,i=t[0];++r<n;)i.n=e=t[r],e.p=i,i=e;i.n=e=t[0],e.p=i}}function $r(t,n){var e=n[0],r=n[1],i=[Fp(e),-Lp(e),0],o=0,u=0;cd.reset();for(var a=0,c=t.length;a<c;++a)if(f=(s=t[a]).length)for(var s,f,l=s[f-1],h=l[0],p=l[1]/2+Sp,d=Fp(p),v=Lp(p),g=0;g<f;++g,h=y,d=x,v=b,l=_){var _=s[g],y=_[0],m=_[1]/2+Sp,x=Fp(m),b=Lp(m),w=y-h,M=w>=0?1:-1,T=M*w,N=T>Np,k=d*x;if(cd.add(Rp(k*M*Fp(T),v*b+k*Lp(T))),o+=N?w+M*Ep:w,N^h>=e^y>=e){var S=cr(ur(l),ur(_));lr(S);var E=cr(i,S);lr(E);var A=(N^w>=0?-1:1)*We(E[2]);(r>A||r===A&&(S[0]||S[1]))&&(u+=N^w>=0?1:-1)}}return(o<-Mp||o<Mp&&cd<-Mp)^1&u}function Wr(t,n,e,r){return function(i){function o(n,e){t(n,e)&&i.point(n,e)}function u(t,n){v.point(t,n)}function a(){x.point=u,v.lineStart()}function c(){x.point=o,v.lineEnd()}function s(t,n){d.push([t,n]),y.point(t,n)}function f(){y.lineStart(),d=[]}function l(){s(d[0][0],d[0][1]),y.lineEnd();var t,n,e,r,o=y.clean(),u=_.result(),a=u.length;if(d.pop(),h.push(d),d=null,a)if(1&o){if(e=u[0],(n=e.length-1)>0){for(m||(i.polygonStart(),m=!0),i.lineStart(),t=0;t<n;++t)i.point((r=e[t])[0],r[1]);i.lineEnd()}}else a>1&&2&o&&u.push(u.pop().concat(u.shift())),p.push(u.filter(Zr))}var h,p,d,v=n(i),_=Br(),y=n(_),m=!1,x={point:o,lineStart:a,lineEnd:c,polygonStart:function(){x.point=s,x.lineStart=f,x.lineEnd=l,p=[],h=[]},polygonEnd:function(){x.point=o,x.lineStart=a,x.lineEnd=c,p=g(p);var t=$r(h,r);p.length?(m||(i.polygonStart(),m=!0),Xr(p,Gr,t,e,i)):t&&(m||(i.polygonStart(),m=!0),i.lineStart(),e(null,null,1,i),i.lineEnd()),m&&(i.polygonEnd(),m=!1),p=h=null},sphere:function(){i.polygonStart(),i.lineStart(),e(null,null,1,i),i.lineEnd(),i.polygonEnd()}};return x}}function Zr(t){return t.length>1}function Gr(t,n){return((t=t.x)[0]<0?t[1]-kp-Mp:kp-t[1])-((n=n.x)[0]<0?n[1]-kp-Mp:kp-n[1])}function Qr(t){function n(t,n){return Lp(t)*Lp(n)>i}function e(t,n,e){var r=[1,0,0],o=cr(ur(t),ur(n)),u=ar(o,o),a=o[0],c=u-a*a;if(!c)return!e&&t;var s=i*u/c,f=-i*a/c,l=cr(r,o),h=fr(r,s);sr(h,fr(o,f));var p=l,d=ar(h,p),v=ar(p,p),g=d*d-v*(ar(h,h)-1);if(!(g<0)){var _=Yp(g),y=fr(p,(-d-_)/v);if(sr(y,h),y=or(y),!e)return y;var m,x=t[0],b=n[0],w=t[1],M=n[1];b<x&&(m=x,x=b,b=m);var T=b-x,N=zp(T-Np)<Mp;if(!N&&M<w&&(m=w,w=M,M=m),N||T<Mp?N?w+M>0^y[1]<(zp(y[0]-x)<Mp?w:M):w<=y[1]&&y[1]<=M:T>Np^(x<=y[0]&&y[0]<=b)){var k=fr(p,(-d+_)/v);return sr(k,h),[y,or(k)]}}}function r(n,e){var r=u?t:Np-t,i=0;return n<-r?i|=1:n>r&&(i|=2),e<-r?i|=4:e>r&&(i|=8),i}var i=Lp(t),o=6*Cp,u=i>0,a=zp(i)>Mp;return Wr(n,function(t){var i,o,c,s,f;return{lineStart:function(){s=c=!1,f=1},point:function(l,h){var p,d=[l,h],v=n(l,h),g=u?v?0:r(l,h):v?r(l+(l<0?Np:-Np),h):0;if(!i&&(s=c=v)&&t.lineStart(),v!==c&&(!(p=e(i,d))||Hr(i,p)||Hr(d,p))&&(d[0]+=Mp,d[1]+=Mp,v=n(d[0],d[1])),v!==c)f=0,v?(t.lineStart(),p=e(d,i),t.point(p[0],p[1])):(p=e(i,d),t.point(p[0],p[1]),t.lineEnd()),i=p;else if(a&&i&&u^v){var _;g&o||!(_=e(d,i,!0))||(f=0,u?(t.lineStart(),t.point(_[0][0],_[0][1]),t.point(_[1][0],_[1][1]),t.lineEnd()):(t.point(_[1][0],_[1][1]),t.lineEnd(),t.lineStart(),t.point(_[0][0],_[0][1])))}!v||i&&Hr(i,d)||t.point(d[0],d[1]),i=d,c=v,o=g},lineEnd:function(){c&&t.lineEnd(),i=null},clean:function(){return f|(s&&c)<<1}}},function(n,e,r,i){Ir(i,t,o,r,n,e)},u?[0,-t]:[-Np,t-Np])}function Jr(t,n,e,r){function i(i,o){return t<=i&&i<=e&&n<=o&&o<=r}function o(i,o,a,s){var f=0,l=0;if(null==i||(f=u(i,a))!==(l=u(o,a))||c(i,o)<0^a>0)do{s.point(0===f||3===f?t:e,f>1?r:n)}while((f=(f+a+4)%4)!==l);else s.point(o[0],o[1])}function u(r,i){return zp(r[0]-t)<Mp?i>0?0:3:zp(r[0]-e)<Mp?i>0?2:1:zp(r[1]-n)<Mp?i>0?1:0:i>0?3:2}function a(t,n){return c(t.x,n.x)}function c(t,n){var e=u(t,1),r=u(n,1);return e!==r?e-r:0===e?n[1]-t[1]:1===e?t[0]-n[0]:2===e?t[1]-n[1]:n[0]-t[0]}return function(u){function c(t,n){i(t,n)&&w.point(t,n)}function s(o,u){var a=i(o,u);if(l&&h.push([o,u]),x)p=o,d=u,v=a,x=!1,a&&(w.lineStart(),w.point(o,u));else if(a&&m)w.point(o,u);else{var c=[_=Math.max(ld,Math.min(fd,_)),y=Math.max(ld,Math.min(fd,y))],s=[o=Math.max(ld,Math.min(fd,o)),u=Math.max(ld,Math.min(fd,u))];!function(t,n,e,r,i,o){var u,a=t[0],c=t[1],s=0,f=1,l=n[0]-a,h=n[1]-c;if(u=e-a,l||!(u>0)){if(u/=l,l<0){if(u<s)return;u<f&&(f=u)}else if(l>0){if(u>f)return;u>s&&(s=u)}if(u=i-a,l||!(u<0)){if(u/=l,l<0){if(u>f)return;u>s&&(s=u)}else if(l>0){if(u<s)return;u<f&&(f=u)}if(u=r-c,h||!(u>0)){if(u/=h,h<0){if(u<s)return;u<f&&(f=u)}else if(h>0){if(u>f)return;u>s&&(s=u)}if(u=o-c,h||!(u<0)){if(u/=h,h<0){if(u>f)return;u>s&&(s=u)}else if(h>0){if(u<s)return;u<f&&(f=u)}return s>0&&(t[0]=a+s*l,t[1]=c+s*h),f<1&&(n[0]=a+f*l,n[1]=c+f*h),!0}}}}}(c,s,t,n,e,r)?a&&(w.lineStart(),w.point(o,u),b=!1):(m||(w.lineStart(),w.point(c[0],c[1])),w.point(s[0],s[1]),a||w.lineEnd(),b=!1)}_=o,y=u,m=a}var f,l,h,p,d,v,_,y,m,x,b,w=u,M=Br(),T={point:c,lineStart:function(){T.point=s,l&&l.push(h=[]),x=!0,m=!1,_=y=NaN},lineEnd:function(){f&&(s(p,d),v&&m&&M.rejoin(),f.push(M.result())),T.point=c,m&&w.lineEnd()},polygonStart:function(){w=M,f=[],l=[],b=!0},polygonEnd:function(){var n=function(){for(var n=0,e=0,i=l.length;e<i;++e)for(var o,u,a=l[e],c=1,s=a.length,f=a[0],h=f[0],p=f[1];c<s;++c)o=h,u=p,h=(f=a[c])[0],p=f[1],u<=r?p>r&&(h-o)*(r-u)>(p-u)*(t-o)&&++n:p<=r&&(h-o)*(r-u)<(p-u)*(t-o)&&--n;return n}(),e=b&&n,i=(f=g(f)).length;(e||i)&&(u.polygonStart(),e&&(u.lineStart(),o(null,null,1,u),u.lineEnd()),i&&Xr(f,a,n,o,u),u.polygonEnd()),w=u,f=l=h=null}};return T}}function Kr(){pd.point=pd.lineEnd=Ge}function ti(t,n){Qp=t*=Cp,Jp=Fp(n*=Cp),Kp=Lp(n),pd.point=ni}function ni(t,n){t*=Cp;var e=Fp(n*=Cp),r=Lp(n),i=zp(t-Qp),o=Lp(i),u=r*Fp(i),a=Kp*e-Jp*r*o,c=Jp*e+Kp*r*o;hd.add(Rp(Yp(u*u+a*a),c)),Qp=t,Jp=e,Kp=r}function ei(t){return hd.reset(),tr(t,pd),+hd}function ri(t,n){return dd[0]=t,dd[1]=n,ei(vd)}function ii(t,n){return!(!t||!_d.hasOwnProperty(t.type))&&_d[t.type](t,n)}function oi(t,n){return 0===ri(t,n)}function ui(t,n){var e=ri(t[0],t[1]);return ri(t[0],n)+ri(n,t[1])<=e+Mp}function ai(t,n){return!!$r(t.map(ci),si(n))}function ci(t){return(t=t.map(si)).pop(),t}function si(t){return[t[0]*Cp,t[1]*Cp]}function fi(t,n,e){var r=f(t,n-Mp,e).concat(n);return function(t){return r.map(function(n){return[t,n]})}}function li(t,n,e){var r=f(t,n-Mp,e).concat(n);return function(t){return r.map(function(n){return[n,t]})}}function hi(){function t(){return{type:"MultiLineString",coordinates:n()}}function n(){return f(qp(o/_)*_,i,_).map(p).concat(f(qp(s/y)*y,c,y).map(d)).concat(f(qp(r/v)*v,e,v).filter(function(t){return zp(t%_)>Mp}).map(l)).concat(f(qp(a/g)*g,u,g).filter(function(t){return zp(t%y)>Mp}).map(h))}var e,r,i,o,u,a,c,s,l,h,p,d,v=10,g=v,_=90,y=360,m=2.5;return t.lines=function(){return n().map(function(t){return{type:"LineString",coordinates:t}})},t.outline=function(){return{type:"Polygon",coordinates:[p(o).concat(d(c).slice(1),p(i).reverse().slice(1),d(s).reverse().slice(1))]}},t.extent=function(n){return arguments.length?t.extentMajor(n).extentMinor(n):t.extentMinor()},t.extentMajor=function(n){return arguments.length?(o=+n[0][0],i=+n[1][0],s=+n[0][1],c=+n[1][1],o>i&&(n=o,o=i,i=n),s>c&&(n=s,s=c,c=n),t.precision(m)):[[o,s],[i,c]]},t.extentMinor=function(n){return arguments.length?(r=+n[0][0],e=+n[1][0],a=+n[0][1],u=+n[1][1],r>e&&(n=r,r=e,e=n),a>u&&(n=a,a=u,u=n),t.precision(m)):[[r,a],[e,u]]},t.step=function(n){return arguments.length?t.stepMajor(n).stepMinor(n):t.stepMinor()},t.stepMajor=function(n){return arguments.length?(_=+n[0],y=+n[1],t):[_,y]},t.stepMinor=function(n){return arguments.length?(v=+n[0],g=+n[1],t):[v,g]},t.precision=function(n){return arguments.length?(m=+n,l=fi(a,u,90),h=li(r,e,m),p=fi(s,c,90),d=li(o,i,m),t):m},t.extentMajor([[-180,-90+Mp],[180,90-Mp]]).extentMinor([[-180,-80-Mp],[180,80+Mp]])}function pi(t){return t}function di(){xd.point=vi}function vi(t,n){xd.point=gi,td=ed=t,nd=rd=n}function gi(t,n){md.add(rd*t-ed*n),ed=t,rd=n}function _i(){gi(td,nd)}function yi(t,n){kd+=t,Sd+=n,++Ed}function mi(){qd.point=xi}function xi(t,n){qd.point=bi,yi(ud=t,ad=n)}function bi(t,n){var e=t-ud,r=n-ad,i=Yp(e*e+r*r);Ad+=i*(ud+t)/2,Cd+=i*(ad+n)/2,zd+=i,yi(ud=t,ad=n)}function wi(){qd.point=yi}function Mi(){qd.point=Ni}function Ti(){ki(id,od)}function Ni(t,n){qd.point=ki,yi(id=ud=t,od=ad=n)}function ki(t,n){var e=t-ud,r=n-ad,i=Yp(e*e+r*r);Ad+=i*(ud+t)/2,Cd+=i*(ad+n)/2,zd+=i,Pd+=(i=ad*t-ud*n)*(ud+t),Rd+=i*(ad+n),Ld+=3*i,yi(ud=t,ad=n)}function Si(t){this._context=t}function Ei(t,n){Bd.point=Ai,Ud=Fd=t,Od=Id=n}function Ai(t,n){Fd-=t,Id-=n,Yd.add(Yp(Fd*Fd+Id*Id)),Fd=t,Id=n}function Ci(){this._string=[]}function zi(t){return"m0,"+t+"a"+t+","+t+" 0 1,1 0,"+-2*t+"a"+t+","+t+" 0 1,1 0,"+2*t+"z"}function Pi(t){return function(n){var e=new Ri;for(var r in t)e[r]=t[r];return e.stream=n,e}}function Ri(){}function Li(t,n,e){var r=t.clipExtent&&t.clipExtent();return t.scale(150).translate([0,0]),null!=r&&t.clipExtent(null),tr(e,t.stream(Nd)),n(Nd.result()),null!=r&&t.clipExtent(r),t}function qi(t,n,e){return Li(t,function(e){var r=n[1][0]-n[0][0],i=n[1][1]-n[0][1],o=Math.min(r/(e[1][0]-e[0][0]),i/(e[1][1]-e[0][1])),u=+n[0][0]+(r-o*(e[1][0]+e[0][0]))/2,a=+n[0][1]+(i-o*(e[1][1]+e[0][1]))/2;t.scale(150*o).translate([u,a])},e)}function Di(t,n,e){return qi(t,[[0,0],n],e)}function Ui(t,n,e){return Li(t,function(e){var r=+n,i=r/(e[1][0]-e[0][0]),o=(r-i*(e[1][0]+e[0][0]))/2,u=-i*e[0][1];t.scale(150*i).translate([o,u])},e)}function Oi(t,n,e){return Li(t,function(e){var r=+n,i=r/(e[1][1]-e[0][1]),o=-i*e[0][0],u=(r-i*(e[1][1]+e[0][1]))/2;t.scale(150*i).translate([o,u])},e)}function Fi(t,n){return+n?function(t,n){function e(r,i,o,u,a,c,s,f,l,h,p,d,v,g){var _=s-r,y=f-i,m=_*_+y*y;if(m>4*n&&v--){var x=u+h,b=a+p,w=c+d,M=Yp(x*x+b*b+w*w),T=We(w/=M),N=zp(zp(w)-1)<Mp||zp(o-l)<Mp?(o+l)/2:Rp(b,x),k=t(N,T),S=k[0],E=k[1],A=S-r,C=E-i,z=y*A-_*C;(z*z/m>n||zp((_*A+y*C)/m-.5)>.3||u*h+a*p+c*d<jd)&&(e(r,i,o,u,a,c,S,E,N,x/=M,b/=M,w,v,g),g.point(S,E),e(S,E,N,x,b,w,s,f,l,h,p,d,v,g))}}return function(n){function r(e,r){e=t(e,r),n.point(e[0],e[1])}function i(){_=NaN,w.point=o,n.lineStart()}function o(r,i){var o=ur([r,i]),u=t(r,i);e(_,y,g,m,x,b,_=u[0],y=u[1],g=r,m=o[0],x=o[1],b=o[2],Hd,n),n.point(_,y)}function u(){w.point=r,n.lineEnd()}function a(){i(),w.point=c,w.lineEnd=s}function c(t,n){o(f=t,n),l=_,h=y,p=m,d=x,v=b,w.point=o}function s(){e(_,y,g,m,x,b,l,h,f,p,d,v,Hd,n),w.lineEnd=u,u()}var f,l,h,p,d,v,g,_,y,m,x,b,w={point:r,lineStart:i,lineEnd:u,polygonStart:function(){n.polygonStart(),w.lineStart=a},polygonEnd:function(){n.polygonEnd(),w.lineStart=i}};return w}}(t,n):function(t){return Pi({point:function(n,e){n=t(n,e),this.stream.point(n[0],n[1])}})}(t)}function Ii(t){return Yi(function(){return t})()}function Yi(t){function n(t){return t=s(t[0]*Cp,t[1]*Cp),[t[0]*v+u,a-t[1]*v]}function e(t,n){return t=o(t,n),[t[0]*v+u,a-t[1]*v]}function r(){s=Rr(c=qr(x,b,w),o);var t=o(y,m);return u=g-t[0]*v,a=_+t[1]*v,i()}function i(){return p=d=null,n}var o,u,a,c,s,f,l,h,p,d,v=150,g=480,_=250,y=0,m=0,x=0,b=0,w=0,M=null,T=sd,N=null,k=pi,S=.5,E=Fi(e,S);return n.stream=function(t){return p&&d===t?p:p=Xd(function(t){return Pi({point:function(n,e){var r=t(n,e);return this.stream.point(r[0],r[1])}})}(c)(T(E(k(d=t)))))},n.preclip=function(t){return arguments.length?(T=t,M=void 0,i()):T},n.postclip=function(t){return arguments.length?(k=t,N=f=l=h=null,i()):k},n.clipAngle=function(t){return arguments.length?(T=+t?Qr(M=t*Cp):(M=null,sd),i()):M*Ap},n.clipExtent=function(t){return arguments.length?(k=null==t?(N=f=l=h=null,pi):Jr(N=+t[0][0],f=+t[0][1],l=+t[1][0],h=+t[1][1]),i()):null==N?null:[[N,f],[l,h]]},n.scale=function(t){return arguments.length?(v=+t,r()):v},n.translate=function(t){return arguments.length?(g=+t[0],_=+t[1],r()):[g,_]},n.center=function(t){return arguments.length?(y=t[0]%360*Cp,m=t[1]%360*Cp,r()):[y*Ap,m*Ap]},n.rotate=function(t){return arguments.length?(x=t[0]%360*Cp,b=t[1]%360*Cp,w=t.length>2?t[2]%360*Cp:0,r()):[x*Ap,b*Ap,w*Ap]},n.precision=function(t){return arguments.length?(E=Fi(e,S=t*t),i()):Yp(S)},n.fitExtent=function(t,e){return qi(n,t,e)},n.fitSize=function(t,e){return Di(n,t,e)},n.fitWidth=function(t,e){return Ui(n,t,e)},n.fitHeight=function(t,e){return Oi(n,t,e)},function(){return o=t.apply(this,arguments),n.invert=o.invert&&function(t){return(t=s.invert((t[0]-u)/v,(a-t[1])/v))&&[t[0]*Ap,t[1]*Ap]},r()}}function Bi(t){var n=0,e=Np/3,r=Yi(t),i=r(n,e);return i.parallels=function(t){return arguments.length?r(n=t[0]*Cp,e=t[1]*Cp):[n*Ap,e*Ap]},i}function Hi(t,n){function e(t,n){var e=Yp(o-2*i*Fp(n))/i;return[e*Fp(t*=i),u-e*Lp(t)]}var r=Fp(t),i=(r+Fp(n))/2;if(zp(i)<Mp)return function(t){function n(t,n){return[t*e,Fp(n)/e]}var e=Lp(t);return n.invert=function(t,n){return[t/e,We(n*e)]},n}(t);var o=1+r*(2*i-r),u=Yp(o)/i;return e.invert=function(t,n){var e=u-n;return[Rp(t,zp(e))/i*Ip(e),We((o-(t*t+e*e)*i*i)/(2*i))]},e}function ji(){return Bi(Hi).scale(155.424).center([0,33.6442])}function Xi(){return ji().parallels([29.5,45.5]).scale(1070).translate([480,250]).rotate([96,0]).center([-.6,38.7])}function Vi(t){return function(n,e){var r=Lp(n),i=Lp(e),o=t(r*i);return[o*i*Fp(n),o*Fp(e)]}}function $i(t){return function(n,e){var r=Yp(n*n+e*e),i=t(r),o=Fp(i),u=Lp(i);return[Rp(n*o,r*u),We(r&&e*o/r)]}}function Wi(t,n){return[t,Up(Bp((kp+n)/2))]}function Zi(t){function n(){var n=Np*a(),u=o(Fr(o.rotate()).invert([0,0]));return s(null==f?[[u[0]-n,u[1]-n],[u[0]+n,u[1]+n]]:t===Wi?[[Math.max(u[0]-n,f),e],[Math.min(u[0]+n,r),i]]:[[f,Math.max(u[1]-n,e)],[r,Math.min(u[1]+n,i)]])}var e,r,i,o=Ii(t),u=o.center,a=o.scale,c=o.translate,s=o.clipExtent,f=null;return o.scale=function(t){return arguments.length?(a(t),n()):a()},o.translate=function(t){return arguments.length?(c(t),n()):c()},o.center=function(t){return arguments.length?(u(t),n()):u()},o.clipExtent=function(t){return arguments.length?(null==t?f=e=r=i=null:(f=+t[0][0],e=+t[0][1],r=+t[1][0],i=+t[1][1]),n()):null==f?null:[[f,e],[r,i]]},n()}function Gi(t){return Bp((kp+t)/2)}function Qi(t,n){function e(t,n){o>0?n<-kp+Mp&&(n=-kp+Mp):n>kp-Mp&&(n=kp-Mp);var e=o/Op(Gi(n),i);return[e*Fp(i*t),o-e*Lp(i*t)]}var r=Lp(t),i=t===n?Fp(t):Up(r/Lp(n))/Up(Gi(n)/Gi(t)),o=r*Op(Gi(t),i)/i;return i?(e.invert=function(t,n){var e=o-n,r=Ip(i)*Yp(t*t+e*e);return[Rp(t,zp(e))/i*Ip(e),2*Pp(Op(o/r,1/i))-kp]},e):Wi}function Ji(t,n){return[t,n]}function Ki(t,n){function e(t,n){var e=o-n,r=i*t;return[e*Fp(r),o-e*Lp(r)]}var r=Lp(t),i=t===n?Fp(t):(r-Lp(n))/(n-t),o=r/i+t;return zp(i)<Mp?Ji:(e.invert=function(t,n){var e=o-n;return[Rp(t,zp(e))/i*Ip(e),o-Ip(i)*Yp(t*t+e*e)]},e)}function to(t,n){var e=Lp(n),r=Lp(t)*e;return[e*Fp(t)/r,Fp(n)/r]}function no(t,n,e,r){return 1===t&&1===n&&0===e&&0===r?pi:Pi({point:function(i,o){this.stream.point(i*t+e,o*n+r)}})}function eo(t,n){var e=n*n,r=e*e;return[t*(.8707-.131979*e+r*(r*(.003971*e-.001529*r)-.013791)),n*(1.007226+e*(.015085+r*(.028874*e-.044475-.005916*r)))]}function ro(t,n){return[Lp(n)*Fp(t),Fp(n)]}function io(t,n){var e=Lp(n),r=1+Lp(t)*e;return[e*Fp(t)/r,Fp(n)/r]}function oo(t,n){return[Up(Bp((kp+n)/2)),-t]}function uo(t,n){return t.parent===n.parent?1:2}function ao(t,n){return t+n.x}function co(t,n){return Math.max(t,n.y)}function so(t){var n=0,e=t.children,r=e&&e.length;if(r)for(;--r>=0;)n+=e[r].value;else n=1;t.value=n}function fo(t,n){var e,r,i,o,u,a=new vo(t),c=+t.value&&(a.value=t.value),s=[a];for(null==n&&(n=lo);e=s.pop();)if(c&&(e.value=+e.data.value),(i=n(e.data))&&(u=i.length))for(e.children=new Array(u),o=u-1;o>=0;--o)s.push(r=e.children[o]=new vo(i[o])),r.parent=e,r.depth=e.depth+1;return a.eachBefore(po)}function lo(t){return t.children}function ho(t){t.data=t.data.data}function po(t){var n=0;do{t.height=n}while((t=t.parent)&&t.height<++n)}function vo(t){this.data=t,this.depth=this.height=0,this.parent=null}function go(t){for(var n,e,r=0,i=(t=function(t){for(var n,e,r=t.length;r;)e=Math.random()*r--|0,n=t[r],t[r]=t[e],t[e]=n;return t}(Wd.call(t))).length,o=[];r<i;)n=t[r],e&&yo(e,n)?++r:(e=function(t){switch(t.length){case 1:return function(t){return{x:t.x,y:t.y,r:t.r}}(t[0]);case 2:return xo(t[0],t[1]);case 3:return bo(t[0],t[1],t[2])}}(o=function(t,n){var e,r;if(mo(n,t))return[n];for(e=0;e<t.length;++e)if(_o(n,t[e])&&mo(xo(t[e],n),t))return[t[e],n];for(e=0;e<t.length-1;++e)for(r=e+1;r<t.length;++r)if(_o(xo(t[e],t[r]),n)&&_o(xo(t[e],n),t[r])&&_o(xo(t[r],n),t[e])&&mo(bo(t[e],t[r],n),t))return[t[e],t[r],n];throw new Error}(o,n)),r=0);return e}function _o(t,n){var e=t.r-n.r,r=n.x-t.x,i=n.y-t.y;return e<0||e*e<r*r+i*i}function yo(t,n){var e=t.r-n.r+1e-6,r=n.x-t.x,i=n.y-t.y;return e>0&&e*e>r*r+i*i}function mo(t,n){for(var e=0;e<n.length;++e)if(!yo(t,n[e]))return!1;return!0}function xo(t,n){var e=t.x,r=t.y,i=t.r,o=n.x,u=n.y,a=n.r,c=o-e,s=u-r,f=a-i,l=Math.sqrt(c*c+s*s);return{x:(e+o+c/l*f)/2,y:(r+u+s/l*f)/2,r:(l+i+a)/2}}function bo(t,n,e){var r=t.x,i=t.y,o=t.r,u=n.x,a=n.y,c=n.r,s=e.x,f=e.y,l=e.r,h=r-u,p=r-s,d=i-a,v=i-f,g=c-o,_=l-o,y=r*r+i*i-o*o,m=y-u*u-a*a+c*c,x=y-s*s-f*f+l*l,b=p*d-h*v,w=(d*x-v*m)/(2*b)-r,M=(v*g-d*_)/b,T=(p*m-h*x)/(2*b)-i,N=(h*_-p*g)/b,k=M*M+N*N-1,S=2*(o+w*M+T*N),E=w*w+T*T-o*o,A=-(k?(S+Math.sqrt(S*S-4*k*E))/(2*k):E/S);return{x:r+w+M*A,y:i+T+N*A,r:A}}function wo(t,n,e){var r=t.x,i=t.y,o=n.r+e.r,u=t.r+e.r,a=n.x-r,c=n.y-i,s=a*a+c*c;if(s){var f=.5+((u*=u)-(o*=o))/(2*s),l=Math.sqrt(Math.max(0,2*o*(u+s)-(u-=s)*u-o*o))/(2*s);e.x=r+f*a+l*c,e.y=i+f*c-l*a}else e.x=r+u,e.y=i}function Mo(t,n){var e=n.x-t.x,r=n.y-t.y,i=t.r+n.r;return i*i-1e-6>e*e+r*r}function To(t){var n=t._,e=t.next._,r=n.r+e.r,i=(n.x*e.r+e.x*n.r)/r,o=(n.y*e.r+e.y*n.r)/r;return i*i+o*o}function No(t){this._=t,this.next=null,this.previous=null}function ko(t){if(!(i=t.length))return 0;var n,e,r,i,o,u,a,c,s,f,l;if(n=t[0],n.x=0,n.y=0,!(i>1))return n.r;if(e=t[1],n.x=-e.r,e.x=n.r,e.y=0,!(i>2))return n.r+e.r;wo(e,n,r=t[2]),n=new No(n),e=new No(e),r=new No(r),n.next=r.previous=e,e.next=n.previous=r,r.next=e.previous=n;t:for(a=3;a<i;++a){wo(n._,e._,r=t[a]),r=new No(r),c=e.next,s=n.previous,f=e._.r,l=n._.r;do{if(f<=l){if(Mo(c._,r._)){e=c,n.next=e,e.previous=n,--a;continue t}f+=c._.r,c=c.next}else{if(Mo(s._,r._)){(n=s).next=e,e.previous=n,--a;continue t}l+=s._.r,s=s.previous}}while(c!==s.next);for(r.previous=n,r.next=e,n.next=e.previous=e=r,o=To(n);(r=r.next)!==e;)(u=To(r))<o&&(n=r,o=u);e=n.next}for(n=[e._],r=e;(r=r.next)!==e;)n.push(r._);for(r=go(n),a=0;a<i;++a)n=t[a],n.x-=r.x,n.y-=r.y;return r.r}function So(t){if("function"!=typeof t)throw new Error;return t}function Eo(){return 0}function Ao(t){return function(){return t}}function Co(t){return Math.sqrt(t.value)}function zo(t){return function(n){n.children||(n.r=Math.max(0,+t(n)||0))}}function Po(t,n){return function(e){if(r=e.children){var r,i,o,u=r.length,a=t(e)*n||0;if(a)for(i=0;i<u;++i)r[i].r+=a;if(o=ko(r),a)for(i=0;i<u;++i)r[i].r-=a;e.r=o+a}}}function Ro(t){return function(n){var e=n.parent;n.r*=t,e&&(n.x=e.x+t*n.x,n.y=e.y+t*n.y)}}function Lo(t){t.x0=Math.round(t.x0),t.y0=Math.round(t.y0),t.x1=Math.round(t.x1),t.y1=Math.round(t.y1)}function qo(t,n,e,r,i){for(var o,u=t.children,a=-1,c=u.length,s=t.value&&(r-n)/t.value;++a<c;)(o=u[a]).y0=e,o.y1=i,o.x0=n,o.x1=n+=o.value*s}function Do(t){return t.id}function Uo(t){return t.parentId}function Oo(t,n){return t.parent===n.parent?1:2}function Fo(t){var n=t.children;return n?n[0]:t.t}function Io(t){var n=t.children;return n?n[n.length-1]:t.t}function Yo(t,n,e){var r=e/(n.i-t.i);n.c-=r,n.s+=e,t.c+=r,n.z+=e,n.m+=e}function Bo(t,n,e){return t.a.parent===n.parent?t.a:e}function Ho(t,n){this._=t,this.parent=null,this.children=null,this.A=null,this.a=this,this.z=0,this.m=0,this.c=0,this.s=0,this.t=null,this.i=n}function jo(t,n,e,r,i){for(var o,u=t.children,a=-1,c=u.length,s=t.value&&(i-e)/t.value;++a<c;)(o=u[a]).x0=n,o.x1=r,o.y0=e,o.y1=e+=o.value*s}function Xo(t,n,e,r,i,o){for(var u,a,c,s,f,l,h,p,d,v,g,_=[],y=n.children,m=0,x=0,b=y.length,w=n.value;m<b;){c=i-e,s=o-r;do{f=y[x++].value}while(!f&&x<b);for(l=h=f,g=f*f*(v=Math.max(s/c,c/s)/(w*t)),d=Math.max(h/g,g/l);x<b;++x){if(f+=a=y[x].value,a<l&&(l=a),a>h&&(h=a),g=f*f*v,(p=Math.max(h/g,g/l))>d){f-=a;break}d=p}_.push(u={value:f,dice:c<s,children:y.slice(m,x)}),u.dice?qo(u,e,r,i,w?r+=s*f/w:o):jo(u,e,r,w?e+=c*f/w:i,o),w-=f,m=x}return _}function Vo(t,n,e){return(n[0]-t[0])*(e[1]-t[1])-(n[1]-t[1])*(e[0]-t[0])}function $o(t,n){return t[0]-n[0]||t[1]-n[1]}function Wo(t){for(var n=t.length,e=[0,1],r=2,i=2;i<n;++i){for(;r>1&&Vo(t[e[r-2]],t[e[r-1]],t[i])<=0;)--r;e[r++]=i}return e.slice(0,r)}function Zo(t){this._size=t,this._call=this._error=null,this._tasks=[],this._data=[],this._waiting=this._active=this._ended=this._start=0}function Go(t){if(!t._start)try{(function(t){for(;t._start=t._waiting&&t._active<t._size;){var n=t._ended+t._active,e=t._tasks[n],r=e.length-1,i=e[r];e[r]=function(t,n){return function(e,r){t._tasks[n]&&(--t._active,++t._ended,t._tasks[n]=null,null==t._error&&(null!=e?Qo(t,e):(t._data[n]=r,t._waiting?Go(t):Jo(t))))}}(t,n),--t._waiting,++t._active,e=i.apply(null,e),t._tasks[n]&&(t._tasks[n]=e||ev)}})(t)}catch(n){if(t._tasks[t._ended+t._active-1])Qo(t,n);else if(!t._data)throw n}}function Qo(t,n){var e,r=t._tasks.length;for(t._error=n,t._data=void 0,t._waiting=NaN;--r>=0;)if((e=t._tasks[r])&&(t._tasks[r]=null,e.abort))try{e.abort()}catch(n){}t._active=NaN,Jo(t)}function Jo(t){if(!t._active&&t._call){var n=t._data;t._data=void 0,t._call(t._error,n)}}function Ko(t){if(null==t)t=1/0;else if(!((t=+t)>=1))throw new Error("invalid concurrency");return new Zo(t)}function tu(){return Math.random()}function nu(t,n){function e(t){var n,e=s.status;if(!e&&function(t){var n=t.responseType;return n&&"text"!==n?t.response:t.responseText}(s)||e>=200&&e<300||304===e){if(o)try{n=o.call(r,s)}catch(t){return void a.call("error",r,t)}else n=s;a.call("load",r,n)}else a.call("error",r,t)}var r,i,o,u,a=N("beforesend","progress","load","error"),c=se(),s=new XMLHttpRequest,f=null,l=null,h=0;if("undefined"==typeof XDomainRequest||"withCredentials"in s||!/^(http(s)?:)?\/\//.test(t)||(s=new XDomainRequest),"onload"in s?s.onload=s.onerror=s.ontimeout=e:s.onreadystatechange=function(t){s.readyState>3&&e(t)},s.onprogress=function(t){a.call("progress",r,t)},r={header:function(t,n){return t=(t+"").toLowerCase(),arguments.length<2?c.get(t):(null==n?c.remove(t):c.set(t,n+""),r)},mimeType:function(t){return arguments.length?(i=null==t?null:t+"",r):i},responseType:function(t){return arguments.length?(u=t,r):u},timeout:function(t){return arguments.length?(h=+t,r):h},user:function(t){return arguments.length<1?f:(f=null==t?null:t+"",r)},password:function(t){return arguments.length<1?l:(l=null==t?null:t+"",r)},response:function(t){return o=t,r},get:function(t,n){return r.send("GET",t,n)},post:function(t,n){return r.send("POST",t,n)},send:function(n,e,o){return s.open(n,t,!0,f,l),null==i||c.has("accept")||c.set("accept",i+",*/*"),s.setRequestHeader&&c.each(function(t,n){s.setRequestHeader(n,t)}),null!=i&&s.overrideMimeType&&s.overrideMimeType(i),null!=u&&(s.responseType=u),h>0&&(s.timeout=h),null==o&&"function"==typeof e&&(o=e,e=null),null!=o&&1===o.length&&(o=function(t){return function(n,e){t(null==n?e:null)}}(o)),null!=o&&r.on("error",o).on("load",function(t){o(null,t)}),a.call("beforesend",r,s),s.send(null==e?null:e),r},abort:function(){return s.abort(),r},on:function(){var t=a.on.apply(a,arguments);return t===a?r:t}},null!=n){if("function"!=typeof n)throw new Error("invalid callback: "+n);return r.get(n)}return r}function eu(t,n){return function(e,r){var i=nu(e).mimeType(t).response(n);if(null!=r){if("function"!=typeof r)throw new Error("invalid callback: "+r);return i.get(r)}return i}}function ru(t,n){return function(e,r,i){arguments.length<3&&(i=r,r=null);var o=nu(e).mimeType(t);return o.row=function(t){return arguments.length?o.response(function(t,n){return function(e){return t(e.responseText,n)}}(n,r=t)):r},o.row(r),i?o.get(i):o}}function iu(t){function n(n){var o=n+"",u=e.get(o);if(!u){if(i!==yv)return i;e.set(o,u=r.push(n))}return t[(u-1)%t.length]}var e=se(),r=[],i=yv;return t=null==t?[]:_v.call(t),n.domain=function(t){if(!arguments.length)return r.slice();r=[],e=se();for(var i,o,u=-1,a=t.length;++u<a;)e.has(o=(i=t[u])+"")||e.set(o,r.push(i));return n},n.range=function(e){return arguments.length?(t=_v.call(e),n):t.slice()},n.unknown=function(t){return arguments.length?(i=t,n):i},n.copy=function(){return iu().domain(r).range(t).unknown(i)},n}function ou(){function t(){var t=i().length,r=u[1]<u[0],h=u[r-0],p=u[1-r];n=(p-h)/Math.max(1,t-c+2*s),a&&(n=Math.floor(n)),h+=(p-h-n*(t-c))*l,e=n*(1-c),a&&(h=Math.round(h),e=Math.round(e));var d=f(t).map(function(t){return h+n*t});return o(r?d.reverse():d)}var n,e,r=iu().unknown(void 0),i=r.domain,o=r.range,u=[0,1],a=!1,c=0,s=0,l=.5;return delete r.unknown,r.domain=function(n){return arguments.length?(i(n),t()):i()},r.range=function(n){return arguments.length?(u=[+n[0],+n[1]],t()):u.slice()},r.rangeRound=function(n){return u=[+n[0],+n[1]],a=!0,t()},r.bandwidth=function(){return e},r.step=function(){return n},r.round=function(n){return arguments.length?(a=!!n,t()):a},r.padding=function(n){return arguments.length?(c=s=Math.max(0,Math.min(1,n)),t()):c},r.paddingInner=function(n){return arguments.length?(c=Math.max(0,Math.min(1,n)),t()):c},r.paddingOuter=function(n){return arguments.length?(s=Math.max(0,Math.min(1,n)),t()):s},r.align=function(n){return arguments.length?(l=Math.max(0,Math.min(1,n)),t()):l},r.copy=function(){return ou().domain(i()).range(u).round(a).paddingInner(c).paddingOuter(s).align(l)},t()}function uu(t){var n=t.copy;return t.padding=t.paddingOuter,delete t.paddingInner,delete t.paddingOuter,t.copy=function(){return uu(n())},t}function au(t){return function(){return t}}function cu(t){return+t}function su(t,n){return(n-=t=+t)?function(e){return(e-t)/n}:au(n)}function fu(t,n,e,r){var i=t[0],o=t[1],u=n[0],a=n[1];return o<i?(i=e(o,i),u=r(a,u)):(i=e(i,o),u=r(u,a)),function(t){return u(i(t))}}function lu(t,n,e,r){var i=Math.min(t.length,n.length)-1,o=new Array(i),u=new Array(i),a=-1;for(t[i]<t[0]&&(t=t.slice().reverse(),n=n.slice().reverse());++a<i;)o[a]=e(t[a],t[a+1]),u[a]=r(n[a],n[a+1]);return function(n){var e=Os(t,n,1,i)-1;return u[e](o[e](n))}}function hu(t,n){return n.domain(t.domain()).range(t.range()).interpolate(t.interpolate()).clamp(t.clamp())}function pu(t,n){function e(){return i=Math.min(a.length,c.length)>2?lu:fu,o=u=null,r}function r(n){return(o||(o=i(a,c,f?function(t){return function(n,e){var r=t(n=+n,e=+e);return function(t){return t<=n?0:t>=e?1:r(t)}}}(t):t,s)))(+n)}var i,o,u,a=mv,c=mv,s=fn,f=!1;return r.invert=function(t){return(u||(u=i(c,a,su,f?function(t){return function(n,e){var r=t(n=+n,e=+e);return function(t){return t<=0?n:t>=1?e:r(t)}}}(n):n)))(+t)},r.domain=function(t){return arguments.length?(a=gv.call(t,cu),e()):a.slice()},r.range=function(t){return arguments.length?(c=_v.call(t),e()):c.slice()},r.rangeRound=function(t){return c=_v.call(t),s=ln,e()},r.clamp=function(t){return arguments.length?(f=!!t,e()):f},r.interpolate=function(t){return arguments.length?(s=t,e()):s},e()}function du(n){var e=n.domain;return n.ticks=function(t){var n=e();return l(n[0],n[n.length-1],null==t?10:t)},n.tickFormat=function(n,r){return function(n,e,r){var i,o=n[0],u=n[n.length-1],a=p(o,u,null==e?10:e);switch((r=De(null==r?",f":r)).type){case"s":var c=Math.max(Math.abs(o),Math.abs(u));return null!=r.precision||isNaN(i=Be(a,c))||(r.precision=i),t.formatPrefix(r,c);case"":case"e":case"g":case"p":case"r":null!=r.precision||isNaN(i=He(a,Math.max(Math.abs(o),Math.abs(u))))||(r.precision=i-("e"===r.type));break;case"f":case"%":null!=r.precision||isNaN(i=Ye(a))||(r.precision=i-2*("%"===r.type))}return t.format(r)}(e(),n,r)},n.nice=function(t){null==t&&(t=10);var r,i=e(),o=0,u=i.length-1,a=i[o],c=i[u];return c<a&&(r=a,a=c,c=r,r=o,o=u,u=r),(r=h(a,c,t))>0?r=h(a=Math.floor(a/r)*r,c=Math.ceil(c/r)*r,t):r<0&&(r=h(a=Math.ceil(a*r)/r,c=Math.floor(c*r)/r,t)),r>0?(i[o]=Math.floor(a/r)*r,i[u]=Math.ceil(c/r)*r,e(i)):r<0&&(i[o]=Math.ceil(a*r)/r,i[u]=Math.floor(c*r)/r,e(i)),n},n}function vu(){var t=pu(su,an);return t.copy=function(){return hu(t,vu())},du(t)}function gu(){function t(t){return+t}var n=[0,1];return t.invert=t,t.domain=t.range=function(e){return arguments.length?(n=gv.call(e,cu),t):n.slice()},t.copy=function(){return gu().domain(n)},du(t)}function _u(t,n){var e,r=0,i=(t=t.slice()).length-1,o=t[r],u=t[i];return u<o&&(e=r,r=i,i=e,e=o,o=u,u=e),t[r]=n.floor(o),t[i]=n.ceil(u),t}function yu(t,n){return(n=Math.log(n/t))?function(e){return Math.log(e/t)/n}:au(n)}function mu(t,n){return t<0?function(e){return-Math.pow(-n,e)*Math.pow(-t,1-e)}:function(e){return Math.pow(n,e)*Math.pow(t,1-e)}}function xu(t){return isFinite(t)?+("1e"+t):t<0?0:t}function bu(t){return 10===t?xu:t===Math.E?Math.exp:function(n){return Math.pow(t,n)}}function wu(t){return t===Math.E?Math.log:10===t&&Math.log10||2===t&&Math.log2||(t=Math.log(t),function(n){return Math.log(n)/t})}function Mu(t){return function(n){return-t(-n)}}function Tu(){function n(){return o=wu(i),u=bu(i),r()[0]<0&&(o=Mu(o),u=Mu(u)),e}var e=pu(yu,mu).domain([1,10]),r=e.domain,i=10,o=wu(10),u=bu(10);return e.base=function(t){return arguments.length?(i=+t,n()):i},e.domain=function(t){return arguments.length?(r(t),n()):r()},e.ticks=function(t){var n,e=r(),a=e[0],c=e[e.length-1];(n=c<a)&&(p=a,a=c,c=p);var s,f,h,p=o(a),d=o(c),v=null==t?10:+t,g=[];if(!(i%1)&&d-p<v){if(p=Math.round(p)-1,d=Math.round(d)+1,a>0){for(;p<d;++p)for(f=1,s=u(p);f<i;++f)if(!((h=s*f)<a)){if(h>c)break;g.push(h)}}else for(;p<d;++p)for(f=i-1,s=u(p);f>=1;--f)if(!((h=s*f)<a)){if(h>c)break;g.push(h)}}else g=l(p,d,Math.min(d-p,v)).map(u);return n?g.reverse():g},e.tickFormat=function(n,r){if(null==r&&(r=10===i?".0e":","),"function"!=typeof r&&(r=t.format(r)),n===1/0)return r;null==n&&(n=10);var a=Math.max(1,i*n/e.ticks().length);return function(t){var n=t/u(Math.round(o(t)));return n*i<i-.5&&(n*=i),n<=a?r(t):""}},e.nice=function(){return r(_u(r(),{floor:function(t){return u(Math.floor(o(t)))},ceil:function(t){return u(Math.ceil(o(t)))}}))},e.copy=function(){return hu(e,Tu().base(i))},e}function Nu(t,n){return t<0?-Math.pow(-t,n):Math.pow(t,n)}function ku(){var t=1,n=pu(function(n,e){return(e=Nu(e,t)-(n=Nu(n,t)))?function(r){return(Nu(r,t)-n)/e}:au(e)},function(n,e){return e=Nu(e,t)-(n=Nu(n,t)),function(r){return Nu(n+e*r,1/t)}}),e=n.domain;return n.exponent=function(n){return arguments.length?(t=+n,e(e())):t},n.copy=function(){return hu(n,ku().exponent(t))},du(n)}function Su(){function t(){var t=0,n=Math.max(1,i.length);for(o=new Array(n-1);++t<n;)o[t-1]=v(r,t/n);return e}function e(t){if(!isNaN(t=+t))return i[Os(o,t)]}var r=[],i=[],o=[];return e.invertExtent=function(t){var n=i.indexOf(t);return n<0?[NaN,NaN]:[n>0?o[n-1]:r[0],n<o.length?o[n]:r[r.length-1]]},e.domain=function(e){if(!arguments.length)return r.slice();r=[];for(var i,o=0,u=e.length;o<u;++o)null==(i=e[o])||isNaN(i=+i)||r.push(i);return r.sort(n),t()},e.range=function(n){return arguments.length?(i=_v.call(n),t()):i.slice()},e.quantiles=function(){return o.slice()},e.copy=function(){return Su().domain(r).range(i)},e}function Eu(){function t(t){if(t<=t)return u[Os(o,t,0,i)]}function n(){var n=-1;for(o=new Array(i);++n<i;)o[n]=((n+1)*r-(n-i)*e)/(i+1);return t}var e=0,r=1,i=1,o=[.5],u=[0,1];return t.domain=function(t){return arguments.length?(e=+t[0],r=+t[1],n()):[e,r]},t.range=function(t){return arguments.length?(i=(u=_v.call(t)).length-1,n()):u.slice()},t.invertExtent=function(t){var n=u.indexOf(t);return n<0?[NaN,NaN]:n<1?[e,o[0]]:n>=i?[o[i-1],r]:[o[n-1],o[n]]},t.copy=function(){return Eu().domain([e,r]).range(u)},du(t)}function Au(){function t(t){if(t<=t)return e[Os(n,t,0,r)]}var n=[.5],e=[0,1],r=1;return t.domain=function(i){return arguments.length?(n=_v.call(i),r=Math.min(n.length,e.length-1),t):n.slice()},t.range=function(i){return arguments.length?(e=_v.call(i),r=Math.min(n.length,e.length-1),t):e.slice()},t.invertExtent=function(t){var r=e.indexOf(t);return[n[r-1],n[r]]},t.copy=function(){return Au().domain(n).range(e)},t}function Cu(t,n,e,r){function i(n){return t(n=new Date(+n)),n}return i.floor=i,i.ceil=function(e){return t(e=new Date(e-1)),n(e,1),t(e),e},i.round=function(t){var n=i(t),e=i.ceil(t);return t-n<e-t?n:e},i.offset=function(t,e){return n(t=new Date(+t),null==e?1:Math.floor(e)),t},i.range=function(e,r,o){var u,a=[];if(e=i.ceil(e),o=null==o?1:Math.floor(o),!(e<r&&o>0))return a;do{a.push(u=new Date(+e)),n(e,o),t(e)}while(u<e&&e<r);return a},i.filter=function(e){return Cu(function(n){if(n>=n)for(;t(n),!e(n);)n.setTime(n-1)},function(t,r){if(t>=t)if(r<0)for(;++r<=0;)for(;n(t,-1),!e(t););else for(;--r>=0;)for(;n(t,1),!e(t););})},e&&(i.count=function(n,r){return xv.setTime(+n),bv.setTime(+r),t(xv),t(bv),Math.floor(e(xv,bv))},i.every=function(t){return t=Math.floor(t),isFinite(t)&&t>0?t>1?i.filter(r?function(n){return r(n)%t==0}:function(n){return i.count(0,n)%t==0}):i:null}),i}function zu(t){return Cu(function(n){n.setDate(n.getDate()-(n.getDay()+7-t)%7),n.setHours(0,0,0,0)},function(t,n){t.setDate(t.getDate()+7*n)},function(t,n){return(n-t-(n.getTimezoneOffset()-t.getTimezoneOffset())*Tv)/Nv})}function Pu(t){return Cu(function(n){n.setUTCDate(n.getUTCDate()-(n.getUTCDay()+7-t)%7),n.setUTCHours(0,0,0,0)},function(t,n){t.setUTCDate(t.getUTCDate()+7*n)},function(t,n){return(n-t)/Nv})}function Ru(t){if(0<=t.y&&t.y<100){var n=new Date(-1,t.m,t.d,t.H,t.M,t.S,t.L);return n.setFullYear(t.y),n}return new Date(t.y,t.m,t.d,t.H,t.M,t.S,t.L)}function Lu(t){if(0<=t.y&&t.y<100){var n=new Date(Date.UTC(-1,t.m,t.d,t.H,t.M,t.S,t.L));return n.setUTCFullYear(t.y),n}return new Date(Date.UTC(t.y,t.m,t.d,t.H,t.M,t.S,t.L))}function qu(t){return{y:t,m:0,d:1,H:0,M:0,S:0,L:0}}function Du(t){function n(t,n){return function(e){var r,i,o,u=[],a=-1,c=0,s=t.length;for(e instanceof Date||(e=new Date(+e));++a<s;)37===t.charCodeAt(a)&&(u.push(t.slice(c,a)),null!=(i=Mg[r=t.charAt(++a)])?r=t.charAt(++a):i="e"===r?" ":"0",(o=n[r])&&(r=o(e,i)),u.push(r),c=a+1);return u.push(t.slice(c,a)),u.join("")}}function e(t,n){return function(e){var i,o,u=qu(1900);if(r(u,t,e+="",0)!=e.length)return null;if("Q"in u)return new Date(u.Q);if("p"in u&&(u.H=u.H%12+12*u.p),"V"in u){if(u.V<1||u.V>53)return null;"w"in u||(u.w=1),"Z"in u?(i=(o=(i=Lu(qu(u.y))).getUTCDay())>4||0===o?og.ceil(i):og(i),i=eg.offset(i,7*(u.V-1)),u.y=i.getUTCFullYear(),u.m=i.getUTCMonth(),u.d=i.getUTCDate()+(u.w+6)%7):(i=(o=(i=n(qu(u.y))).getDay())>4||0===o?qv.ceil(i):qv(i),i=Pv.offset(i,7*(u.V-1)),u.y=i.getFullYear(),u.m=i.getMonth(),u.d=i.getDate()+(u.w+6)%7)}else("W"in u||"U"in u)&&("w"in u||(u.w="u"in u?u.u%7:"W"in u?1:0),o="Z"in u?Lu(qu(u.y)).getUTCDay():n(qu(u.y)).getDay(),u.m=0,u.d="W"in u?(u.w+6)%7+7*u.W-(o+5)%7:u.w+7*u.U-(o+6)%7);return"Z"in u?(u.H+=u.Z/100|0,u.M+=u.Z%100,Lu(u)):n(u)}}function r(t,n,e,r){for(var i,o,u=0,a=n.length,c=e.length;u<a;){if(r>=c)return-1;if(37===(i=n.charCodeAt(u++))){if(i=n.charAt(u++),!(o=T[i in Mg?n.charAt(u++):i])||(r=o(t,e,r))<0)return-1}else if(i!=e.charCodeAt(r++))return-1}return r}var i=t.dateTime,o=t.date,u=t.time,a=t.periods,c=t.days,s=t.shortDays,f=t.months,l=t.shortMonths,h=Fu(a),p=Iu(a),d=Fu(c),v=Iu(c),g=Fu(s),_=Iu(s),y=Fu(f),m=Iu(f),x=Fu(l),b=Iu(l),w={a:function(t){return s[t.getDay()]},A:function(t){return c[t.getDay()]},b:function(t){return l[t.getMonth()]},B:function(t){return f[t.getMonth()]},c:null,d:ua,e:ua,f:la,H:aa,I:ca,j:sa,L:fa,m:ha,M:pa,p:function(t){return a[+(t.getHours()>=12)]},Q:Ya,s:Ba,S:da,u:va,U:ga,V:_a,w:ya,W:ma,x:null,X:null,y:xa,Y:ba,Z:wa,"%":Ia},M={a:function(t){return s[t.getUTCDay()]},A:function(t){return c[t.getUTCDay()]},b:function(t){return l[t.getUTCMonth()]},B:function(t){return f[t.getUTCMonth()]},c:null,d:Ma,e:Ma,f:Ea,H:Ta,I:Na,j:ka,L:Sa,m:Aa,M:Ca,p:function(t){return a[+(t.getUTCHours()>=12)]},Q:Ya,s:Ba,S:za,u:Pa,U:Ra,V:La,w:qa,W:Da,x:null,X:null,y:Ua,Y:Oa,Z:Fa,"%":Ia},T={a:function(t,n,e){var r=g.exec(n.slice(e));return r?(t.w=_[r[0].toLowerCase()],e+r[0].length):-1},A:function(t,n,e){var r=d.exec(n.slice(e));return r?(t.w=v[r[0].toLowerCase()],e+r[0].length):-1},b:function(t,n,e){var r=x.exec(n.slice(e));return r?(t.m=b[r[0].toLowerCase()],e+r[0].length):-1},B:function(t,n,e){var r=y.exec(n.slice(e));return r?(t.m=m[r[0].toLowerCase()],e+r[0].length):-1},c:function(t,n,e){return r(t,i,n,e)},d:Gu,e:Gu,f:ea,H:Ju,I:Ju,j:Qu,L:na,m:Zu,M:Ku,p:function(t,n,e){var r=h.exec(n.slice(e));return r?(t.p=p[r[0].toLowerCase()],e+r[0].length):-1},Q:ia,s:oa,S:ta,u:Bu,U:Hu,V:ju,w:Yu,W:Xu,x:function(t,n,e){return r(t,o,n,e)},X:function(t,n,e){return r(t,u,n,e)},y:$u,Y:Vu,Z:Wu,"%":ra};return w.x=n(o,w),w.X=n(u,w),w.c=n(i,w),M.x=n(o,M),M.X=n(u,M),M.c=n(i,M),{format:function(t){var e=n(t+="",w);return e.toString=function(){return t},e},parse:function(t){var n=e(t+="",Ru);return n.toString=function(){return t},n},utcFormat:function(t){var e=n(t+="",M);return e.toString=function(){return t},e},utcParse:function(t){var n=e(t,Lu);return n.toString=function(){return t},n}}}function Uu(t,n,e){var r=t<0?"-":"",i=(r?-t:t)+"",o=i.length;return r+(o<e?new Array(e-o+1).join(n)+i:i)}function Ou(t){return t.replace(kg,"\\$&")}function Fu(t){return new RegExp("^(?:"+t.map(Ou).join("|")+")","i")}function Iu(t){for(var n={},e=-1,r=t.length;++e<r;)n[t[e].toLowerCase()]=e;return n}function Yu(t,n,e){var r=Tg.exec(n.slice(e,e+1));return r?(t.w=+r[0],e+r[0].length):-1}function Bu(t,n,e){var r=Tg.exec(n.slice(e,e+1));return r?(t.u=+r[0],e+r[0].length):-1}function Hu(t,n,e){var r=Tg.exec(n.slice(e,e+2));return r?(t.U=+r[0],e+r[0].length):-1}function ju(t,n,e){var r=Tg.exec(n.slice(e,e+2));return r?(t.V=+r[0],e+r[0].length):-1}function Xu(t,n,e){var r=Tg.exec(n.slice(e,e+2));return r?(t.W=+r[0],e+r[0].length):-1}function Vu(t,n,e){var r=Tg.exec(n.slice(e,e+4));return r?(t.y=+r[0],e+r[0].length):-1}function $u(t,n,e){var r=Tg.exec(n.slice(e,e+2));return r?(t.y=+r[0]+(+r[0]>68?1900:2e3),e+r[0].length):-1}function Wu(t,n,e){var r=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(n.slice(e,e+6));return r?(t.Z=r[1]?0:-(r[2]+(r[3]||"00")),e+r[0].length):-1}function Zu(t,n,e){var r=Tg.exec(n.slice(e,e+2));return r?(t.m=r[0]-1,e+r[0].length):-1}function Gu(t,n,e){var r=Tg.exec(n.slice(e,e+2));return r?(t.d=+r[0],e+r[0].length):-1}function Qu(t,n,e){var r=Tg.exec(n.slice(e,e+3));return r?(t.m=0,t.d=+r[0],e+r[0].length):-1}function Ju(t,n,e){var r=Tg.exec(n.slice(e,e+2));return r?(t.H=+r[0],e+r[0].length):-1}function Ku(t,n,e){var r=Tg.exec(n.slice(e,e+2));return r?(t.M=+r[0],e+r[0].length):-1}function ta(t,n,e){var r=Tg.exec(n.slice(e,e+2));return r?(t.S=+r[0],e+r[0].length):-1}function na(t,n,e){var r=Tg.exec(n.slice(e,e+3));return r?(t.L=+r[0],e+r[0].length):-1}function ea(t,n,e){var r=Tg.exec(n.slice(e,e+6));return r?(t.L=Math.floor(r[0]/1e3),e+r[0].length):-1}function ra(t,n,e){var r=Ng.exec(n.slice(e,e+1));return r?e+r[0].length:-1}function ia(t,n,e){var r=Tg.exec(n.slice(e));return r?(t.Q=+r[0],e+r[0].length):-1}function oa(t,n,e){var r=Tg.exec(n.slice(e));return r?(t.Q=1e3*+r[0],e+r[0].length):-1}function ua(t,n){return Uu(t.getDate(),n,2)}function aa(t,n){return Uu(t.getHours(),n,2)}function ca(t,n){return Uu(t.getHours()%12||12,n,2)}function sa(t,n){return Uu(1+Pv.count(Gv(t),t),n,3)}function fa(t,n){return Uu(t.getMilliseconds(),n,3)}function la(t,n){return fa(t,n)+"000"}function ha(t,n){return Uu(t.getMonth()+1,n,2)}function pa(t,n){return Uu(t.getMinutes(),n,2)}function da(t,n){return Uu(t.getSeconds(),n,2)}function va(t){var n=t.getDay();return 0===n?7:n}function ga(t,n){return Uu(Lv.count(Gv(t),t),n,2)}function _a(t,n){var e=t.getDay();return t=e>=4||0===e?Ov(t):Ov.ceil(t),Uu(Ov.count(Gv(t),t)+(4===Gv(t).getDay()),n,2)}function ya(t){return t.getDay()}function ma(t,n){return Uu(qv.count(Gv(t),t),n,2)}function xa(t,n){return Uu(t.getFullYear()%100,n,2)}function ba(t,n){return Uu(t.getFullYear()%1e4,n,4)}function wa(t){var n=t.getTimezoneOffset();return(n>0?"-":(n*=-1,"+"))+Uu(n/60|0,"0",2)+Uu(n%60,"0",2)}function Ma(t,n){return Uu(t.getUTCDate(),n,2)}function Ta(t,n){return Uu(t.getUTCHours(),n,2)}function Na(t,n){return Uu(t.getUTCHours()%12||12,n,2)}function ka(t,n){return Uu(1+eg.count(xg(t),t),n,3)}function Sa(t,n){return Uu(t.getUTCMilliseconds(),n,3)}function Ea(t,n){return Sa(t,n)+"000"}function Aa(t,n){return Uu(t.getUTCMonth()+1,n,2)}function Ca(t,n){return Uu(t.getUTCMinutes(),n,2)}function za(t,n){return Uu(t.getUTCSeconds(),n,2)}function Pa(t){var n=t.getUTCDay();return 0===n?7:n}function Ra(t,n){return Uu(ig.count(xg(t),t),n,2)}function La(t,n){var e=t.getUTCDay();return t=e>=4||0===e?cg(t):cg.ceil(t),Uu(cg.count(xg(t),t)+(4===xg(t).getUTCDay()),n,2)}function qa(t){return t.getUTCDay()}function Da(t,n){return Uu(og.count(xg(t),t),n,2)}function Ua(t,n){return Uu(t.getUTCFullYear()%100,n,2)}function Oa(t,n){return Uu(t.getUTCFullYear()%1e4,n,4)}function Fa(){return"+0000"}function Ia(){return"%"}function Ya(t){return+t}function Ba(t){return Math.floor(+t/1e3)}function Ha(n){return bg=Du(n),t.timeFormat=bg.format,t.timeParse=bg.parse,t.utcFormat=bg.utcFormat,t.utcParse=bg.utcParse,bg}function ja(t){return new Date(t)}function Xa(t){return t instanceof Date?+t:+new Date(+t)}function Va(t,n,r,i,o,u,a,c,s){function f(e){return(a(e)<e?g:u(e)<e?_:o(e)<e?y:i(e)<e?m:n(e)<e?r(e)<e?x:b:t(e)<e?w:M)(e)}function l(n,r,i,o){if(null==n&&(n=10),"number"==typeof n){var u=Math.abs(i-r)/n,a=e(function(t){return t[2]}).right(T,u);a===T.length?(o=p(r/Dg,i/Dg,n),n=t):a?(o=(a=T[u/T[a-1][2]<T[a][2]/u?a-1:a])[1],n=a[0]):(o=Math.max(p(r,i,n),1),n=c)}return null==o?n:n.every(o)}var h=pu(su,an),d=h.invert,v=h.domain,g=s(".%L"),_=s(":%S"),y=s("%I:%M"),m=s("%I %p"),x=s("%a %d"),b=s("%b %d"),w=s("%B"),M=s("%Y"),T=[[a,1,Cg],[a,5,5*Cg],[a,15,15*Cg],[a,30,30*Cg],[u,1,zg],[u,5,5*zg],[u,15,15*zg],[u,30,30*zg],[o,1,Pg],[o,3,3*Pg],[o,6,6*Pg],[o,12,12*Pg],[i,1,Rg],[i,2,2*Rg],[r,1,Lg],[n,1,qg],[n,3,3*qg],[t,1,Dg]];return h.invert=function(t){return new Date(d(t))},h.domain=function(t){return arguments.length?v(gv.call(t,Xa)):v().map(ja)},h.ticks=function(t,n){var e,r=v(),i=r[0],o=r[r.length-1],u=o<i;return u&&(e=i,i=o,o=e),e=l(t,i,o,n),e=e?e.range(i,o+1):[],u?e.reverse():e},h.tickFormat=function(t,n){return null==n?f:s(n)},h.nice=function(t,n){var e=v();return(t=l(t,e[0],e[e.length-1],n))?v(_u(e,t)):h},h.copy=function(){return hu(h,Va(t,n,r,i,o,u,a,c,s))},h}function $a(t){return t.match(/.{6}/g).map(function(t){return"#"+t})}function Wa(t){var n=t.length;return function(e){return t[Math.max(0,Math.min(n-1,Math.floor(e*n)))]}}function Za(t){function n(n){var o=(n-e)/(r-e);return t(i?Math.max(0,Math.min(1,o)):o)}var e=0,r=1,i=!1;return n.domain=function(t){return arguments.length?(e=+t[0],r=+t[1],n):[e,r]},n.clamp=function(t){return arguments.length?(i=!!t,n):i},n.interpolator=function(e){return arguments.length?(t=e,n):t},n.copy=function(){return Za(t).domain([e,r]).clamp(i)},du(n)}function Ga(t){return function(){return t}}function Qa(t){return t>=1?i_:t<=-1?-i_:Math.asin(t)}function Ja(t){return t.innerRadius}function Ka(t){return t.outerRadius}function tc(t){return t.startAngle}function nc(t){return t.endAngle}function ec(t){return t&&t.padAngle}function rc(t,n,e,r,i,o,u){var a=t-e,c=n-r,s=(u?o:-o)/n_(a*a+c*c),f=s*c,l=-s*a,h=t+f,p=n+l,d=e+f,v=r+l,g=(h+d)/2,_=(p+v)/2,y=d-h,m=v-p,x=y*y+m*m,b=i-o,w=h*v-d*p,M=(m<0?-1:1)*n_(Jg(0,b*b*x-w*w)),T=(w*m-y*M)/x,N=(-w*y-m*M)/x,k=(w*m+y*M)/x,S=(-w*y+m*M)/x,E=T-g,A=N-_,C=k-g,z=S-_;return E*E+A*A>C*C+z*z&&(T=k,N=S),{cx:T,cy:N,x01:-f,y01:-l,x11:T*(i/b-1),y11:N*(i/b-1)}}function ic(t){this._context=t}function oc(t){return new ic(t)}function uc(t){return t[0]}function ac(t){return t[1]}function cc(){function t(t){var a,c,s,f=t.length,l=!1;for(null==i&&(u=o(s=ee())),a=0;a<=f;++a)!(a<f&&r(c=t[a],a,t))===l&&((l=!l)?u.lineStart():u.lineEnd()),l&&u.point(+n(c,a,t),+e(c,a,t));if(s)return u=null,s+""||null}var n=uc,e=ac,r=Ga(!0),i=null,o=oc,u=null;return t.x=function(e){return arguments.length?(n="function"==typeof e?e:Ga(+e),t):n},t.y=function(n){return arguments.length?(e="function"==typeof n?n:Ga(+n),t):e},t.defined=function(n){return arguments.length?(r="function"==typeof n?n:Ga(!!n),t):r},t.curve=function(n){return arguments.length?(o=n,null!=i&&(u=o(i)),t):o},t.context=function(n){return arguments.length?(null==n?i=u=null:u=o(i=n),t):i},t}function sc(){function t(t){var n,f,l,h,p,d=t.length,v=!1,g=new Array(d),_=new Array(d);for(null==a&&(s=c(p=ee())),n=0;n<=d;++n){if(!(n<d&&u(h=t[n],n,t))===v)if(v=!v)f=n,s.areaStart(),s.lineStart();else{for(s.lineEnd(),s.lineStart(),l=n-1;l>=f;--l)s.point(g[l],_[l]);s.lineEnd(),s.areaEnd()}v&&(g[n]=+e(h,n,t),_[n]=+i(h,n,t),s.point(r?+r(h,n,t):g[n],o?+o(h,n,t):_[n]))}if(p)return s=null,p+""||null}function n(){return cc().defined(u).curve(c).context(a)}var e=uc,r=null,i=Ga(0),o=ac,u=Ga(!0),a=null,c=oc,s=null;return t.x=function(n){return arguments.length?(e="function"==typeof n?n:Ga(+n),r=null,t):e},t.x0=function(n){return arguments.length?(e="function"==typeof n?n:Ga(+n),t):e},t.x1=function(n){return arguments.length?(r=null==n?null:"function"==typeof n?n:Ga(+n),t):r},t.y=function(n){return arguments.length?(i="function"==typeof n?n:Ga(+n),o=null,t):i},t.y0=function(n){return arguments.length?(i="function"==typeof n?n:Ga(+n),t):i},t.y1=function(n){return arguments.length?(o=null==n?null:"function"==typeof n?n:Ga(+n),t):o},t.lineX0=t.lineY0=function(){return n().x(e).y(i)},t.lineY1=function(){return n().x(e).y(o)},t.lineX1=function(){return n().x(r).y(i)},t.defined=function(n){return arguments.length?(u="function"==typeof n?n:Ga(!!n),t):u},t.curve=function(n){return arguments.length?(c=n,null!=a&&(s=c(a)),t):c},t.context=function(n){return arguments.length?(null==n?a=s=null:s=c(a=n),t):a},t}function fc(t,n){return n<t?-1:n>t?1:n>=t?0:NaN}function lc(t){return t}function hc(t){this._curve=t}function pc(t){function n(n){return new hc(t(n))}return n._curve=t,n}function dc(t){var n=t.curve;return t.angle=t.x,delete t.x,t.radius=t.y,delete t.y,t.curve=function(t){return arguments.length?n(pc(t)):n()._curve},t}function vc(){return dc(cc().curve(u_))}function gc(){var t=sc().curve(u_),n=t.curve,e=t.lineX0,r=t.lineX1,i=t.lineY0,o=t.lineY1;return t.angle=t.x,delete t.x,t.startAngle=t.x0,delete t.x0,t.endAngle=t.x1,delete t.x1,t.radius=t.y,delete t.y,t.innerRadius=t.y0,delete t.y0,t.outerRadius=t.y1,delete t.y1,t.lineStartAngle=function(){return dc(e())},delete t.lineX0,t.lineEndAngle=function(){return dc(r())},delete t.lineX1,t.lineInnerRadius=function(){return dc(i())},delete t.lineY0,t.lineOuterRadius=function(){return dc(o())},delete t.lineY1,t.curve=function(t){return arguments.length?n(pc(t)):n()._curve},t}function _c(t,n){return[(n=+n)*Math.cos(t-=Math.PI/2),n*Math.sin(t)]}function yc(t){return t.source}function mc(t){return t.target}function xc(t){function n(){var n,a=a_.call(arguments),c=e.apply(this,a),s=r.apply(this,a);if(u||(u=n=ee()),t(u,+i.apply(this,(a[0]=c,a)),+o.apply(this,a),+i.apply(this,(a[0]=s,a)),+o.apply(this,a)),n)return u=null,n+""||null}var e=yc,r=mc,i=uc,o=ac,u=null;return n.source=function(t){return arguments.length?(e=t,n):e},n.target=function(t){return arguments.length?(r=t,n):r},n.x=function(t){return arguments.length?(i="function"==typeof t?t:Ga(+t),n):i},n.y=function(t){return arguments.length?(o="function"==typeof t?t:Ga(+t),n):o},n.context=function(t){return arguments.length?(u=null==t?null:t,n):u},n}function bc(t,n,e,r,i){t.moveTo(n,e),t.bezierCurveTo(n=(n+r)/2,e,n,i,r,i)}function wc(t,n,e,r,i){t.moveTo(n,e),t.bezierCurveTo(n,e=(e+i)/2,r,e,r,i)}function Mc(t,n,e,r,i){var o=_c(n,e),u=_c(n,e=(e+i)/2),a=_c(r,e),c=_c(r,i);t.moveTo(o[0],o[1]),t.bezierCurveTo(u[0],u[1],a[0],a[1],c[0],c[1])}function Tc(){}function Nc(t,n,e){t._context.bezierCurveTo((2*t._x0+t._x1)/3,(2*t._y0+t._y1)/3,(t._x0+2*t._x1)/3,(t._y0+2*t._y1)/3,(t._x0+4*t._x1+n)/6,(t._y0+4*t._y1+e)/6)}function kc(t){this._context=t}function Sc(t){this._context=t}function Ec(t){this._context=t}function Ac(t,n){this._basis=new kc(t),this._beta=n}function Cc(t,n,e){t._context.bezierCurveTo(t._x1+t._k*(t._x2-t._x0),t._y1+t._k*(t._y2-t._y0),t._x2+t._k*(t._x1-n),t._y2+t._k*(t._y1-e),t._x2,t._y2)}function zc(t,n){this._context=t,this._k=(1-n)/6}function Pc(t,n){this._context=t,this._k=(1-n)/6}function Rc(t,n){this._context=t,this._k=(1-n)/6}function Lc(t,n,e){var r=t._x1,i=t._y1,o=t._x2,u=t._y2;if(t._l01_a>e_){var a=2*t._l01_2a+3*t._l01_a*t._l12_a+t._l12_2a,c=3*t._l01_a*(t._l01_a+t._l12_a);r=(r*a-t._x0*t._l12_2a+t._x2*t._l01_2a)/c,i=(i*a-t._y0*t._l12_2a+t._y2*t._l01_2a)/c}if(t._l23_a>e_){var s=2*t._l23_2a+3*t._l23_a*t._l12_a+t._l12_2a,f=3*t._l23_a*(t._l23_a+t._l12_a);o=(o*s+t._x1*t._l23_2a-n*t._l12_2a)/f,u=(u*s+t._y1*t._l23_2a-e*t._l12_2a)/f}t._context.bezierCurveTo(r,i,o,u,t._x2,t._y2)}function qc(t,n){this._context=t,this._alpha=n}function Dc(t,n){this._context=t,this._alpha=n}function Uc(t,n){this._context=t,this._alpha=n}function Oc(t){this._context=t}function Fc(t){return t<0?-1:1}function Ic(t,n,e){var r=t._x1-t._x0,i=n-t._x1,o=(t._y1-t._y0)/(r||i<0&&-0),u=(e-t._y1)/(i||r<0&&-0),a=(o*i+u*r)/(r+i);return(Fc(o)+Fc(u))*Math.min(Math.abs(o),Math.abs(u),.5*Math.abs(a))||0}function Yc(t,n){var e=t._x1-t._x0;return e?(3*(t._y1-t._y0)/e-n)/2:n}function Bc(t,n,e){var r=t._x0,i=t._y0,o=t._x1,u=t._y1,a=(o-r)/3;t._context.bezierCurveTo(r+a,i+a*n,o-a,u-a*e,o,u)}function Hc(t){this._context=t}function jc(t){this._context=new Xc(t)}function Xc(t){this._context=t}function Vc(t){this._context=t}function $c(t){var n,e,r=t.length-1,i=new Array(r),o=new Array(r),u=new Array(r);for(i[0]=0,o[0]=2,u[0]=t[0]+2*t[1],n=1;n<r-1;++n)i[n]=1,o[n]=4,u[n]=4*t[n]+2*t[n+1];for(i[r-1]=2,o[r-1]=7,u[r-1]=8*t[r-1]+t[r],n=1;n<r;++n)e=i[n]/o[n-1],o[n]-=e,u[n]-=e*u[n-1];for(i[r-1]=u[r-1]/o[r-1],n=r-2;n>=0;--n)i[n]=(u[n]-i[n+1])/o[n];for(o[r-1]=(t[r]+i[r-1])/2,n=0;n<r-1;++n)o[n]=2*t[n+1]-i[n+1];return[i,o]}function Wc(t,n){this._context=t,this._t=n}function Zc(t,n){if((i=t.length)>1)for(var e,r,i,o=1,u=t[n[0]],a=u.length;o<i;++o)for(r=u,u=t[n[o]],e=0;e<a;++e)u[e][1]+=u[e][0]=isNaN(r[e][1])?r[e][0]:r[e][1]}function Gc(t){for(var n=t.length,e=new Array(n);--n>=0;)e[n]=n;return e}function Qc(t,n){return t[n]}function Jc(t){var n=t.map(Kc);return Gc(t).sort(function(t,e){return n[t]-n[e]})}function Kc(t){for(var n,e=0,r=-1,i=t.length;++r<i;)(n=+t[r][1])&&(e+=n);return e}function ts(t){return function(){return t}}function ns(t){return t[0]}function es(t){return t[1]}function rs(){this._=null}function is(t){t.U=t.C=t.L=t.R=t.P=t.N=null}function os(t,n){var e=n,r=n.R,i=e.U;i?i.L===e?i.L=r:i.R=r:t._=r,r.U=i,e.U=r,e.R=r.L,e.R&&(e.R.U=e),r.L=e}function us(t,n){var e=n,r=n.L,i=e.U;i?i.L===e?i.L=r:i.R=r:t._=r,r.U=i,e.U=r,e.L=r.R,e.L&&(e.L.U=e),r.R=e}function as(t){for(;t.L;)t=t.L;return t}function cs(t,n,e,r){var i=[null,null],o=D_.push(i)-1;return i.left=t,i.right=n,e&&fs(i,t,n,e),r&&fs(i,n,t,r),L_[t.index].halfedges.push(o),L_[n.index].halfedges.push(o),i}function ss(t,n,e){var r=[n,e];return r.left=t,r}function fs(t,n,e,r){t[0]||t[1]?t.left===e?t[1]=r:t[0]=r:(t[0]=r,t.left=n,t.right=e)}function ls(t,n,e,r,i){var o,u=t[0],a=t[1],c=u[0],s=u[1],f=0,l=1,h=a[0]-c,p=a[1]-s;if(o=n-c,h||!(o>0)){if(o/=h,h<0){if(o<f)return;o<l&&(l=o)}else if(h>0){if(o>l)return;o>f&&(f=o)}if(o=r-c,h||!(o<0)){if(o/=h,h<0){if(o>l)return;o>f&&(f=o)}else if(h>0){if(o<f)return;o<l&&(l=o)}if(o=e-s,p||!(o>0)){if(o/=p,p<0){if(o<f)return;o<l&&(l=o)}else if(p>0){if(o>l)return;o>f&&(f=o)}if(o=i-s,p||!(o<0)){if(o/=p,p<0){if(o>l)return;o>f&&(f=o)}else if(p>0){if(o<f)return;o<l&&(l=o)}return!(f>0||l<1)||(f>0&&(t[0]=[c+f*h,s+f*p]),l<1&&(t[1]=[c+l*h,s+l*p]),!0)}}}}}function hs(t,n,e,r,i){var o=t[1];if(o)return!0;var u,a,c=t[0],s=t.left,f=t.right,l=s[0],h=s[1],p=f[0],d=f[1],v=(l+p)/2,g=(h+d)/2;if(d===h){if(v<n||v>=r)return;if(l>p){if(c){if(c[1]>=i)return}else c=[v,e];o=[v,i]}else{if(c){if(c[1]<e)return}else c=[v,i];o=[v,e]}}else if(u=(l-p)/(d-h),a=g-u*v,u<-1||u>1)if(l>p){if(c){if(c[1]>=i)return}else c=[(e-a)/u,e];o=[(i-a)/u,i]}else{if(c){if(c[1]<e)return}else c=[(i-a)/u,i];o=[(e-a)/u,e]}else if(h<d){if(c){if(c[0]>=r)return}else c=[n,u*n+a];o=[r,u*r+a]}else{if(c){if(c[0]<n)return}else c=[r,u*r+a];o=[n,u*n+a]}return t[0]=c,t[1]=o,!0}function ps(t,n){var e=t.site,r=n.left,i=n.right;return e===i&&(i=r,r=e),i?Math.atan2(i[1]-r[1],i[0]-r[0]):(e===r?(r=n[1],i=n[0]):(r=n[0],i=n[1]),Math.atan2(r[0]-i[0],i[1]-r[1]))}function ds(t,n){return n[+(n.left!==t.site)]}function vs(t,n){return n[+(n.left===t.site)]}function gs(t){var n=t.P,e=t.N;if(n&&e){var r=n.site,i=t.site,o=e.site;if(r!==o){var u=i[0],a=i[1],c=r[0]-u,s=r[1]-a,f=o[0]-u,l=o[1]-a,h=2*(c*l-s*f);if(!(h>=-I_)){var p=c*c+s*s,d=f*f+l*l,v=(l*p-s*d)/h,g=(c*d-f*p)/h,_=U_.pop()||new function(){is(this),this.x=this.y=this.arc=this.site=this.cy=null};_.arc=t,_.site=i,_.x=v+u,_.y=(_.cy=g+a)+Math.sqrt(v*v+g*g),t.circle=_;for(var y=null,m=q_._;m;)if(_.y<m.y||_.y===m.y&&_.x<=m.x){if(!m.L){y=m.P;break}m=m.L}else{if(!m.R){y=m;break}m=m.R}q_.insert(y,_),y||(P_=_)}}}}function _s(t){var n=t.circle;n&&(n.P||(P_=n.N),q_.remove(n),U_.push(n),is(n),t.circle=null)}function ys(t){var n=O_.pop()||new function(){is(this),this.edge=this.site=this.circle=null};return n.site=t,n}function ms(t){_s(t),R_.remove(t),O_.push(t),is(t)}function xs(t){var n=t.circle,e=n.x,r=n.cy,i=[e,r],o=t.P,u=t.N,a=[t];ms(t);for(var c=o;c.circle&&Math.abs(e-c.circle.x)<F_&&Math.abs(r-c.circle.cy)<F_;)o=c.P,a.unshift(c),ms(c),c=o;a.unshift(c),_s(c);for(var s=u;s.circle&&Math.abs(e-s.circle.x)<F_&&Math.abs(r-s.circle.cy)<F_;)u=s.N,a.push(s),ms(s),s=u;a.push(s),_s(s);var f,l=a.length;for(f=1;f<l;++f)s=a[f],c=a[f-1],fs(s.edge,c.site,s.site,i);c=a[0],(s=a[l-1]).edge=cs(c.site,s.site,null,i),gs(c),gs(s)}function bs(t){for(var n,e,r,i,o=t[0],u=t[1],a=R_._;a;)if((r=ws(a,u)-o)>F_)a=a.L;else{if(!((i=o-function(t,n){var e=t.N;if(e)return ws(e,n);var r=t.site;return r[1]===n?r[0]:1/0}(a,u))>F_)){r>-F_?(n=a.P,e=a):i>-F_?(n=a,e=a.N):n=e=a;break}if(!a.R){n=a;break}a=a.R}(function(t){L_[t.index]={site:t,halfedges:[]}})(t);var c=ys(t);if(R_.insert(n,c),n||e){if(n===e)return _s(n),e=ys(n.site),R_.insert(c,e),c.edge=e.edge=cs(n.site,c.site),gs(n),void gs(e);if(e){_s(n),_s(e);var s=n.site,f=s[0],l=s[1],h=t[0]-f,p=t[1]-l,d=e.site,v=d[0]-f,g=d[1]-l,_=2*(h*g-p*v),y=h*h+p*p,m=v*v+g*g,x=[(g*y-p*m)/_+f,(h*m-v*y)/_+l];fs(e.edge,s,d,x),c.edge=cs(s,t,null,x),e.edge=cs(t,d,null,x),gs(n),gs(e)}else c.edge=cs(n.site,c.site)}}function ws(t,n){var e=t.site,r=e[0],i=e[1],o=i-n;if(!o)return r;var u=t.P;if(!u)return-1/0;var a=(e=u.site)[0],c=e[1],s=c-n;if(!s)return a;var f=a-r,l=1/o-1/s,h=f/s;return l?(-h+Math.sqrt(h*h-2*l*(f*f/(-2*s)-c+s/2+i-o/2)))/l+r:(r+a)/2}function Ms(t,n,e){return(t[0]-e[0])*(n[1]-t[1])-(t[0]-n[0])*(e[1]-t[1])}function Ts(t,n){return n[1]-t[1]||n[0]-t[0]}function Ns(t,n){var e,r,i,o=t.sort(Ts).pop();for(D_=[],L_=new Array(t.length),R_=new rs,q_=new rs;;)if(i=P_,o&&(!i||o[1]<i.y||o[1]===i.y&&o[0]<i.x))o[0]===e&&o[1]===r||(bs(o),e=o[0],r=o[1]),o=t.pop();else{if(!i)break;xs(i.arc)}if(function(){for(var t,n,e,r,i=0,o=L_.length;i<o;++i)if((t=L_[i])&&(r=(n=t.halfedges).length)){var u=new Array(r),a=new Array(r);for(e=0;e<r;++e)u[e]=e,a[e]=ps(t,D_[n[e]]);for(u.sort(function(t,n){return a[n]-a[t]}),e=0;e<r;++e)a[e]=n[u[e]];for(e=0;e<r;++e)n[e]=a[e]}}(),n){var u=+n[0][0],a=+n[0][1],c=+n[1][0],s=+n[1][1];(function(t,n,e,r){for(var i,o=D_.length;o--;)hs(i=D_[o],t,n,e,r)&&ls(i,t,n,e,r)&&(Math.abs(i[0][0]-i[1][0])>F_||Math.abs(i[0][1]-i[1][1])>F_)||delete D_[o]})(u,a,c,s),function(t,n,e,r){var i,o,u,a,c,s,f,l,h,p,d,v,g=L_.length,_=!0;for(i=0;i<g;++i)if(o=L_[i]){for(u=o.site,a=(c=o.halfedges).length;a--;)D_[c[a]]||c.splice(a,1);for(a=0,s=c.length;a<s;)d=(p=vs(o,D_[c[a]]))[0],v=p[1],l=(f=ds(o,D_[c[++a%s]]))[0],h=f[1],(Math.abs(d-l)>F_||Math.abs(v-h)>F_)&&(c.splice(a,0,D_.push(ss(u,p,Math.abs(d-t)<F_&&r-v>F_?[t,Math.abs(l-t)<F_?h:r]:Math.abs(v-r)<F_&&e-d>F_?[Math.abs(h-r)<F_?l:e,r]:Math.abs(d-e)<F_&&v-n>F_?[e,Math.abs(l-e)<F_?h:n]:Math.abs(v-n)<F_&&d-t>F_?[Math.abs(h-n)<F_?l:t,n]:null))-1),++s);s&&(_=!1)}if(_){var y,m,x,b=1/0;for(i=0,_=null;i<g;++i)(o=L_[i])&&(x=(y=(u=o.site)[0]-t)*y+(m=u[1]-n)*m)<b&&(b=x,_=o);if(_){var w=[t,n],M=[t,r],T=[e,r],N=[e,n];_.halfedges.push(D_.push(ss(u=_.site,w,M))-1,D_.push(ss(u,M,T))-1,D_.push(ss(u,T,N))-1,D_.push(ss(u,N,w))-1)}}for(i=0;i<g;++i)(o=L_[i])&&(o.halfedges.length||delete L_[i])}(u,a,c,s)}this.edges=D_,this.cells=L_,R_=q_=D_=L_=null}function ks(t){return function(){return t}}function Ss(t,n,e){this.k=t,this.x=n,this.y=e}function Es(t){return t.__zoom||Y_}function As(){t.event.stopImmediatePropagation()}function Cs(){t.event.preventDefault(),t.event.stopImmediatePropagation()}function zs(){return!t.event.button}function Ps(){var t,n,e=this;return e instanceof SVGElement?(t=(e=e.ownerSVGElement||e).width.baseVal.value,n=e.height.baseVal.value):(t=e.clientWidth,n=e.clientHeight),[[0,0],[t,n]]}function Rs(){return this.__zoom||Y_}function Ls(){return-t.event.deltaY*(t.event.deltaMode?120:1)/500}function qs(){return"ontouchstart"in this}function Ds(t,n,e){var r=t.invertX(n[0][0])-e[0][0],i=t.invertX(n[1][0])-e[1][0],o=t.invertY(n[0][1])-e[0][1],u=t.invertY(n[1][1])-e[1][1];return t.translate(i>r?(r+i)/2:Math.min(0,r)||Math.max(0,i),u>o?(o+u)/2:Math.min(0,o)||Math.max(0,u))}var Us=e(n),Os=Us.right,Fs=Us.left,Is=Array.prototype,Ys=Is.slice,Bs=Is.map,Hs=Math.sqrt(50),js=Math.sqrt(10),Xs=Math.sqrt(2),Vs=Array.prototype.slice,$s=1,Ws=2,Zs=3,Gs=4,Qs=1e-6,Js={value:function(){}};k.prototype=N.prototype={constructor:k,on:function(t,n){var e,r=this._,i=function(t,n){return t.trim().split(/^|\s+/).map(function(t){var e="",r=t.indexOf(".");if(r>=0&&(e=t.slice(r+1),t=t.slice(0,r)),t&&!n.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:e}})}(t+"",r),o=-1,u=i.length;{if(!(arguments.length<2)){if(null!=n&&"function"!=typeof n)throw new Error("invalid callback: "+n);for(;++o<u;)if(e=(t=i[o]).type)r[e]=S(r[e],t.name,n);else if(null==n)for(e in r)r[e]=S(r[e],t.name,null);return this}for(;++o<u;)if((e=(t=i[o]).type)&&(e=function(t,n){for(var e,r=0,i=t.length;r<i;++r)if((e=t[r]).name===n)return e.value}(r[e],t.name)))return e}},copy:function(){var t={},n=this._;for(var e in n)t[e]=n[e].slice();return new k(t)},call:function(t,n){if((e=arguments.length-2)>0)for(var e,r,i=new Array(e),o=0;o<e;++o)i[o]=arguments[o+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(o=0,e=(r=this._[t]).length;o<e;++o)r[o].value.apply(n,i)},apply:function(t,n,e){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var r=this._[t],i=0,o=r.length;i<o;++i)r[i].value.apply(n,e)}};var Ks="http://www.w3.org/1999/xhtml",tf={svg:"http://www.w3.org/2000/svg",xhtml:Ks,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"},nf=function(t){return function(){return this.matches(t)}};if("undefined"!=typeof document){var ef=document.documentElement;if(!ef.matches){var rf=ef.webkitMatchesSelector||ef.msMatchesSelector||ef.mozMatchesSelector||ef.oMatchesSelector;nf=function(t){return function(){return rf.call(this,t)}}}}var of=nf;q.prototype={constructor:q,appendChild:function(t){return this._parent.insertBefore(t,this._next)},insertBefore:function(t,n){return this._parent.insertBefore(t,n)},querySelector:function(t){return this._parent.querySelector(t)},querySelectorAll:function(t){return this._parent.querySelectorAll(t)}};var uf="$";H.prototype={add:function(t){this._names.indexOf(t)<0&&(this._names.push(t),this._node.setAttribute("class",this._names.join(" ")))},remove:function(t){var n=this._names.indexOf(t);n>=0&&(this._names.splice(n,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(t){return this._names.indexOf(t)>=0}};var af={};if(t.event=null,"undefined"!=typeof document){"onmouseenter"in document.documentElement||(af={mouseenter:"mouseover",mouseleave:"mouseout"})}var cf=[null];ut.prototype=at.prototype={constructor:ut,select:function(t){"function"!=typeof t&&(t=z(t));for(var n=this._groups,e=n.length,r=new Array(e),i=0;i<e;++i)for(var o,u,a=n[i],c=a.length,s=r[i]=new Array(c),f=0;f<c;++f)(o=a[f])&&(u=t.call(o,o.__data__,f,a))&&("__data__"in o&&(u.__data__=o.__data__),s[f]=u);return new ut(r,this._parents)},selectAll:function(t){"function"!=typeof t&&(t=R(t));for(var n=this._groups,e=n.length,r=[],i=[],o=0;o<e;++o)for(var u,a=n[o],c=a.length,s=0;s<c;++s)(u=a[s])&&(r.push(t.call(u,u.__data__,s,a)),i.push(u));return new ut(r,i)},filter:function(t){"function"!=typeof t&&(t=of(t));for(var n=this._groups,e=n.length,r=new Array(e),i=0;i<e;++i)for(var o,u=n[i],a=u.length,c=r[i]=[],s=0;s<a;++s)(o=u[s])&&t.call(o,o.__data__,s,u)&&c.push(o);return new ut(r,this._parents)},data:function(t,n){if(!t)return p=new Array(this.size()),s=-1,this.each(function(t){p[++s]=t}),p;var e=n?U:D,r=this._parents,i=this._groups;"function"!=typeof t&&(t=function(t){return function(){return t}}(t));for(var o=i.length,u=new Array(o),a=new Array(o),c=new Array(o),s=0;s<o;++s){var f=r[s],l=i[s],h=l.length,p=t.call(f,f&&f.__data__,s,r),d=p.length,v=a[s]=new Array(d),g=u[s]=new Array(d);e(f,l,v,g,c[s]=new Array(h),p,n);for(var _,y,m=0,x=0;m<d;++m)if(_=v[m]){for(m>=x&&(x=m+1);!(y=g[x])&&++x<d;);_._next=y||null}}return u=new ut(u,r),u._enter=a,u._exit=c,u},enter:function(){return new ut(this._enter||this._groups.map(L),this._parents)},exit:function(){return new ut(this._exit||this._groups.map(L),this._parents)},merge:function(t){for(var n=this._groups,e=t._groups,r=n.length,i=e.length,o=Math.min(r,i),u=new Array(r),a=0;a<o;++a)for(var c,s=n[a],f=e[a],l=s.length,h=u[a]=new Array(l),p=0;p<l;++p)(c=s[p]||f[p])&&(h[p]=c);for(;a<r;++a)u[a]=n[a];return new ut(u,this._parents)},order:function(){for(var t=this._groups,n=-1,e=t.length;++n<e;)for(var r,i=t[n],o=i.length-1,u=i[o];--o>=0;)(r=i[o])&&(u&&u!==r.nextSibling&&u.parentNode.insertBefore(r,u),u=r);return this},sort:function(t){function n(n,e){return n&&e?t(n.__data__,e.__data__):!n-!e}t||(t=O);for(var e=this._groups,r=e.length,i=new Array(r),o=0;o<r;++o){for(var u,a=e[o],c=a.length,s=i[o]=new Array(c),f=0;f<c;++f)(u=a[f])&&(s[f]=u);s.sort(n)}return new ut(i,this._parents).order()},call:function(){var t=arguments[0];return arguments[0]=this,t.apply(null,arguments),this},nodes:function(){var t=new Array(this.size()),n=-1;return this.each(function(){t[++n]=this}),t},node:function(){for(var t=this._groups,n=0,e=t.length;n<e;++n)for(var r=t[n],i=0,o=r.length;i<o;++i){var u=r[i];if(u)return u}return null},size:function(){var t=0;return this.each(function(){++t}),t},empty:function(){return!this.node()},each:function(t){for(var n=this._groups,e=0,r=n.length;e<r;++e)for(var i,o=n[e],u=0,a=o.length;u<a;++u)(i=o[u])&&t.call(i,i.__data__,u,o);return this},attr:function(t,n){var e=E(t);if(arguments.length<2){var r=this.node();return e.local?r.getAttributeNS(e.space,e.local):r.getAttribute(e)}return this.each((null==n?e.local?function(t){return function(){this.removeAttributeNS(t.space,t.local)}}:function(t){return function(){this.removeAttribute(t)}}:"function"==typeof n?e.local?function(t,n){return function(){var e=n.apply(this,arguments);null==e?this.removeAttributeNS(t.space,t.local):this.setAttributeNS(t.space,t.local,e)}}:function(t,n){return function(){var e=n.apply(this,arguments);null==e?this.removeAttribute(t):this.setAttribute(t,e)}}:e.local?function(t,n){return function(){this.setAttributeNS(t.space,t.local,n)}}:function(t,n){return function(){this.setAttribute(t,n)}})(e,n))},style:function(t,n,e){return arguments.length>1?this.each((null==n?function(t){return function(){this.style.removeProperty(t)}}:"function"==typeof n?function(t,n,e){return function(){var r=n.apply(this,arguments);null==r?this.style.removeProperty(t):this.style.setProperty(t,r,e)}}:function(t,n,e){return function(){this.style.setProperty(t,n,e)}})(t,n,null==e?"":e)):I(this.node(),t)},property:function(t,n){return arguments.length>1?this.each((null==n?function(t){return function(){delete this[t]}}:"function"==typeof n?function(t,n){return function(){var e=n.apply(this,arguments);null==e?delete this[t]:this[t]=e}}:function(t,n){return function(){this[t]=n}})(t,n)):this.node()[t]},classed:function(t,n){var e=Y(t+"");if(arguments.length<2){for(var r=B(this.node()),i=-1,o=e.length;++i<o;)if(!r.contains(e[i]))return!1;return!0}return this.each(("function"==typeof n?function(t,n){return function(){(n.apply(this,arguments)?j:X)(this,t)}}:n?function(t){return function(){j(this,t)}}:function(t){return function(){X(this,t)}})(e,n))},text:function(t){return arguments.length?this.each(null==t?V:("function"==typeof t?function(t){return function(){var n=t.apply(this,arguments);this.textContent=null==n?"":n}}:function(t){return function(){this.textContent=t}})(t)):this.node().textContent},html:function(t){return arguments.length?this.each(null==t?$:("function"==typeof t?function(t){return function(){var n=t.apply(this,arguments);this.innerHTML=null==n?"":n}}:function(t){return function(){this.innerHTML=t}})(t)):this.node().innerHTML},raise:function(){return this.each(W)},lower:function(){return this.each(Z)},append:function(t){var n="function"==typeof t?t:A(t);return this.select(function(){return this.appendChild(n.apply(this,arguments))})},insert:function(t,n){var e="function"==typeof t?t:A(t),r=null==n?G:"function"==typeof n?n:z(n);return this.select(function(){return this.insertBefore(e.apply(this,arguments),r.apply(this,arguments)||null)})},remove:function(){return this.each(Q)},clone:function(t){return this.select(t?K:J)},datum:function(t){return arguments.length?this.property("__data__",t):this.node().__data__},on:function(t,n,e){var r,i,o=function(t){return t.trim().split(/^|\s+/).map(function(t){var n="",e=t.indexOf(".");return e>=0&&(n=t.slice(e+1),t=t.slice(0,e)),{type:t,name:n}})}(t+""),u=o.length;if(!(arguments.length<2)){for(a=n?rt:et,null==e&&(e=!1),r=0;r<u;++r)this.each(a(o[r],n,e));return this}var a=this.node().__on;if(a)for(var c,s=0,f=a.length;s<f;++s)for(r=0,c=a[s];r<u;++r)if((i=o[r]).type===c.type&&i.name===c.name)return c.value},dispatch:function(t,n){return this.each(("function"==typeof n?function(t,n){return function(){return ot(this,t,n.apply(this,arguments))}}:function(t,n){return function(){return ot(this,t,n)}})(t,n))}};var sf=0;ft.prototype=st.prototype={constructor:ft,get:function(t){for(var n=this._;!(n in t);)if(!(t=t.parentNode))return;return t[n]},set:function(t,n){return t[this._]=n},remove:function(t){return this._ in t&&delete t[this._]},toString:function(){return this._}},xt.prototype.on=function(){var t=this._.on.apply(this._,arguments);return t===this._?this:t};var ff="\\s*([+-]?\\d+)\\s*",lf="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\s*",hf="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)%\\s*",pf=/^#([0-9a-f]{3})$/,df=/^#([0-9a-f]{6})$/,vf=new RegExp("^rgb\\("+[ff,ff,ff]+"\\)$"),gf=new RegExp("^rgb\\("+[hf,hf,hf]+"\\)$"),_f=new RegExp("^rgba\\("+[ff,ff,ff,lf]+"\\)$"),yf=new RegExp("^rgba\\("+[hf,hf,hf,lf]+"\\)$"),mf=new RegExp("^hsl\\("+[lf,hf,hf]+"\\)$"),xf=new RegExp("^hsla\\("+[lf,hf,hf,lf]+"\\)$"),bf={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Nt(St,Et,{displayable:function(){return this.rgb().displayable()},toString:function(){return this.rgb()+""}}),Nt(Rt,Pt,kt(St,{brighter:function(t){return t=null==t?1/.7:Math.pow(1/.7,t),new Rt(this.r*t,this.g*t,this.b*t,this.opacity)},darker:function(t){return t=null==t?.7:Math.pow(.7,t),new Rt(this.r*t,this.g*t,this.b*t,this.opacity)},rgb:function(){return this},displayable:function(){return 0<=this.r&&this.r<=255&&0<=this.g&&this.g<=255&&0<=this.b&&this.b<=255&&0<=this.opacity&&this.opacity<=1},toString:function(){var t=this.opacity;return(1===(t=isNaN(t)?1:Math.max(0,Math.min(1,t)))?"rgb(":"rgba(")+Math.max(0,Math.min(255,Math.round(this.r)||0))+", "+Math.max(0,Math.min(255,Math.round(this.g)||0))+", "+Math.max(0,Math.min(255,Math.round(this.b)||0))+(1===t?")":", "+t+")")}})),Nt(Dt,qt,kt(St,{brighter:function(t){return t=null==t?1/.7:Math.pow(1/.7,t),new Dt(this.h,this.s,this.l*t,this.opacity)},darker:function(t){return t=null==t?.7:Math.pow(.7,t),new Dt(this.h,this.s,this.l*t,this.opacity)},rgb:function(){var t=this.h%360+360*(this.h<0),n=isNaN(t)||isNaN(this.s)?0:this.s,e=this.l,r=e+(e<.5?e:1-e)*n,i=2*e-r;return new Rt(Ut(t>=240?t-240:t+120,i,r),Ut(t,i,r),Ut(t<120?t+240:t-120,i,r),this.opacity)},displayable:function(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1}}));var wf=Math.PI/180,Mf=180/Math.PI,Tf=.95047,Nf=1,kf=1.08883,Sf=4/29,Ef=6/29,Af=3*Ef*Ef,Cf=Ef*Ef*Ef;Nt(It,Ft,kt(St,{brighter:function(t){return new It(this.l+18*(null==t?1:t),this.a,this.b,this.opacity)},darker:function(t){return new It(this.l-18*(null==t?1:t),this.a,this.b,this.opacity)},rgb:function(){var t=(this.l+16)/116,n=isNaN(this.a)?t:t+this.a/500,e=isNaN(this.b)?t:t-this.b/200;return t=Nf*Bt(t),n=Tf*Bt(n),e=kf*Bt(e),new Rt(Ht(3.2404542*n-1.5371385*t-.4985314*e),Ht(-.969266*n+1.8760108*t+.041556*e),Ht(.0556434*n-.2040259*t+1.0572252*e),this.opacity)}})),Nt(Vt,Xt,kt(St,{brighter:function(t){return new Vt(this.h,this.c,this.l+18*(null==t?1:t),this.opacity)},darker:function(t){return new Vt(this.h,this.c,this.l-18*(null==t?1:t),this.opacity)},rgb:function(){return Ot(this).rgb()}}));var zf=-.29227,Pf=-.90649,Rf=1.97294,Lf=Rf*Pf,qf=1.78277*Rf,Df=1.78277*zf- -.14861*Pf;Nt(Wt,$t,kt(St,{brighter:function(t){return t=null==t?1/.7:Math.pow(1/.7,t),new Wt(this.h,this.s,this.l*t,this.opacity)},darker:function(t){return t=null==t?.7:Math.pow(.7,t),new Wt(this.h,this.s,this.l*t,this.opacity)},rgb:function(){var t=isNaN(this.h)?0:(this.h+120)*wf,n=+this.l,e=isNaN(this.s)?0:this.s*n*(1-n),r=Math.cos(t),i=Math.sin(t);return new Rt(255*(n+e*(-.14861*r+1.78277*i)),255*(n+e*(zf*r+Pf*i)),255*(n+e*(Rf*r)),this.opacity)}}));var Uf,Of,Ff,If,Yf,Bf,Hf=function t(n){function e(t,n){var e=r((t=Pt(t)).r,(n=Pt(n)).r),i=r(t.g,n.g),o=r(t.b,n.b),u=en(t.opacity,n.opacity);return function(n){return t.r=e(n),t.g=i(n),t.b=o(n),t.opacity=u(n),t+""}}var r=nn(n);return e.gamma=t,e}(1),jf=rn(Gt),Xf=rn(Qt),Vf=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,$f=new RegExp(Vf.source,"g"),Wf=180/Math.PI,Zf={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1},Gf=pn(function(t){return"none"===t?Zf:(Uf||(Uf=document.createElement("DIV"),Of=document.documentElement,Ff=document.defaultView),Uf.style.transform=t,t=Ff.getComputedStyle(Of.appendChild(Uf),null).getPropertyValue("transform"),Of.removeChild(Uf),t=t.slice(7,-1).split(","),hn(+t[0],+t[1],+t[2],+t[3],+t[4],+t[5]))},"px, ","px)","deg)"),Qf=pn(function(t){return null==t?Zf:(If||(If=document.createElementNS("http://www.w3.org/2000/svg","g")),If.setAttribute("transform",t),(t=If.transform.baseVal.consolidate())?(t=t.matrix,hn(t.a,t.b,t.c,t.d,t.e,t.f)):Zf)},", ",")",")"),Jf=Math.SQRT2,Kf=2,tl=4,nl=1e-12,el=gn(tn),rl=gn(en),il=_n(tn),ol=_n(en),ul=yn(tn),al=yn(en),cl=0,sl=0,fl=0,ll=1e3,hl=0,pl=0,dl=0,vl="object"==typeof performance&&performance.now?performance:Date,gl="object"==typeof window&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};bn.prototype=wn.prototype={constructor:bn,restart:function(t,n,e){if("function"!=typeof t)throw new TypeError("callback is not a function");e=(null==e?mn():+e)+(null==n?0:+n),this._next||Bf===this||(Bf?Bf._next=this:Yf=this,Bf=this),this._call=t,this._time=e,kn()},stop:function(){this._call&&(this._call=null,this._time=1/0,kn())}};var _l=N("start","end","interrupt"),yl=[],ml=0,xl=1,bl=2,wl=3,Ml=4,Tl=5,Nl=6,kl=at.prototype.constructor,Sl=0,El=at.prototype;qn.prototype=Dn.prototype={constructor:qn,select:function(t){var n=this._name,e=this._id;"function"!=typeof t&&(t=z(t));for(var r=this._groups,i=r.length,o=new Array(i),u=0;u<i;++u)for(var a,c,s=r[u],f=s.length,l=o[u]=new Array(f),h=0;h<f;++h)(a=s[h])&&(c=t.call(a,a.__data__,h,s))&&("__data__"in a&&(c.__data__=a.__data__),l[h]=c,En(l[h],n,e,h,l,zn(a,e)));return new qn(o,this._parents,n,e)},selectAll:function(t){var n=this._name,e=this._id;"function"!=typeof t&&(t=R(t));for(var r=this._groups,i=r.length,o=[],u=[],a=0;a<i;++a)for(var c,s=r[a],f=s.length,l=0;l<f;++l)if(c=s[l]){for(var h,p=t.call(c,c.__data__,l,s),d=zn(c,e),v=0,g=p.length;v<g;++v)(h=p[v])&&En(h,n,e,v,p,d);o.push(p),u.push(c)}return new qn(o,u,n,e)},filter:function(t){"function"!=typeof t&&(t=of(t));for(var n=this._groups,e=n.length,r=new Array(e),i=0;i<e;++i)for(var o,u=n[i],a=u.length,c=r[i]=[],s=0;s<a;++s)(o=u[s])&&t.call(o,o.__data__,s,u)&&c.push(o);return new qn(r,this._parents,this._name,this._id)},merge:function(t){if(t._id!==this._id)throw new Error;for(var n=this._groups,e=t._groups,r=n.length,i=e.length,o=Math.min(r,i),u=new Array(r),a=0;a<o;++a)for(var c,s=n[a],f=e[a],l=s.length,h=u[a]=new Array(l),p=0;p<l;++p)(c=s[p]||f[p])&&(h[p]=c);for(;a<r;++a)u[a]=n[a];return new qn(u,this._parents,this._name,this._id)},selection:function(){return new kl(this._groups,this._parents)},transition:function(){for(var t=this._name,n=this._id,e=Un(),r=this._groups,i=r.length,o=0;o<i;++o)for(var u,a=r[o],c=a.length,s=0;s<c;++s)if(u=a[s]){var f=zn(u,n);En(u,t,e,s,a,{time:f.time+f.delay+f.duration,delay:0,duration:f.duration,ease:f.ease})}return new qn(r,this._parents,t,e)},call:El.call,nodes:El.nodes,node:El.node,size:El.size,empty:El.empty,each:El.each,on:function(t,n){var e=this._id;return arguments.length<2?zn(this.node(),e).on.on(t):this.each(function(t,n,e){var r,i,o=function(t){return(t+"").trim().split(/^|\s+/).every(function(t){var n=t.indexOf(".");return n>=0&&(t=t.slice(0,n)),!t||"start"===t})}(n)?An:Cn;return function(){var u=o(this,t),a=u.on;a!==r&&(i=(r=a).copy()).on(n,e),u.on=i}}(e,t,n))},attr:function(t,n){var e=E(t),r="transform"===e?Qf:Ln;return this.attrTween(t,"function"==typeof n?(e.local?function(t,n,e){var r,i,o;return function(){var u,a=e(this);if(null!=a)return(u=this.getAttributeNS(t.space,t.local))===a?null:u===r&&a===i?o:o=n(r=u,i=a);this.removeAttributeNS(t.space,t.local)}}:function(t,n,e){var r,i,o;return function(){var u,a=e(this);if(null!=a)return(u=this.getAttribute(t))===a?null:u===r&&a===i?o:o=n(r=u,i=a);this.removeAttribute(t)}})(e,r,Rn(this,"attr."+t,n)):null==n?(e.local?function(t){return function(){this.removeAttributeNS(t.space,t.local)}}:function(t){return function(){this.removeAttribute(t)}})(e):(e.local?function(t,n,e){var r,i;return function(){var o=this.getAttributeNS(t.space,t.local);return o===e?null:o===r?i:i=n(r=o,e)}}:function(t,n,e){var r,i;return function(){var o=this.getAttribute(t);return o===e?null:o===r?i:i=n(r=o,e)}})(e,r,n+""))},attrTween:function(t,n){var e="attr."+t;if(arguments.length<2)return(e=this.tween(e))&&e._value;if(null==n)return this.tween(e,null);if("function"!=typeof n)throw new Error;var r=E(t);return this.tween(e,(r.local?function(t,n){function e(){var e=this,r=n.apply(e,arguments);return r&&function(n){e.setAttributeNS(t.space,t.local,r(n))}}return e._value=n,e}:function(t,n){function e(){var e=this,r=n.apply(e,arguments);return r&&function(n){e.setAttribute(t,r(n))}}return e._value=n,e})(r,n))},style:function(t,n,e){var r="transform"==(t+="")?Gf:Ln;return null==n?this.styleTween(t,function(t,n){var e,r,i;return function(){var o=I(this,t),u=(this.style.removeProperty(t),I(this,t));return o===u?null:o===e&&u===r?i:i=n(e=o,r=u)}}(t,r)).on("end.style."+t,function(t){return function(){this.style.removeProperty(t)}}(t)):this.styleTween(t,"function"==typeof n?function(t,n,e){var r,i,o;return function(){var u=I(this,t),a=e(this);return null==a&&(this.style.removeProperty(t),a=I(this,t)),u===a?null:u===r&&a===i?o:o=n(r=u,i=a)}}(t,r,Rn(this,"style."+t,n)):function(t,n,e){var r,i;return function(){var o=I(this,t);return o===e?null:o===r?i:i=n(r=o,e)}}(t,r,n+""),e)},styleTween:function(t,n,e){var r="style."+(t+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(null==n)return this.tween(r,null);if("function"!=typeof n)throw new Error;return this.tween(r,function(t,n,e){function r(){var r=this,i=n.apply(r,arguments);return i&&function(n){r.style.setProperty(t,i(n),e)}}return r._value=n,r}(t,n,null==e?"":e))},text:function(t){return this.tween("text","function"==typeof t?function(t){return function(){var n=t(this);this.textContent=null==n?"":n}}(Rn(this,"text",t)):function(t){return function(){this.textContent=t}}(null==t?"":t+""))},remove:function(){return this.on("end.remove",function(t){return function(){var n=this.parentNode;for(var e in this.__transition)if(+e!==t)return;n&&n.removeChild(this)}}(this._id))},tween:function(t,n){var e=this._id;if(t+="",arguments.length<2){for(var r,i=zn(this.node(),e).tween,o=0,u=i.length;o<u;++o)if((r=i[o]).name===t)return r.value;return null}return this.each((null==n?function(t,n){var e,r;return function(){var i=Cn(this,t),o=i.tween;if(o!==e)for(var u=0,a=(r=e=o).length;u<a;++u)if(r[u].name===n){(r=r.slice()).splice(u,1);break}i.tween=r}}:function(t,n,e){var r,i;if("function"!=typeof e)throw new Error;return function(){var o=Cn(this,t),u=o.tween;if(u!==r){i=(r=u).slice();for(var a={name:n,value:e},c=0,s=i.length;c<s;++c)if(i[c].name===n){i[c]=a;break}c===s&&i.push(a)}o.tween=i}})(e,t,n))},delay:function(t){var n=this._id;return arguments.length?this.each(("function"==typeof t?function(t,n){return function(){An(this,t).delay=+n.apply(this,arguments)}}:function(t,n){return n=+n,function(){An(this,t).delay=n}})(n,t)):zn(this.node(),n).delay},duration:function(t){var n=this._id;return arguments.length?this.each(("function"==typeof t?function(t,n){return function(){Cn(this,t).duration=+n.apply(this,arguments)}}:function(t,n){return n=+n,function(){Cn(this,t).duration=n}})(n,t)):zn(this.node(),n).duration},ease:function(t){var n=this._id;return arguments.length?this.each(function(t,n){if("function"!=typeof n)throw new Error;return function(){Cn(this,t).ease=n}}(n,t)):zn(this.node(),n).ease}};var Al=function t(n){function e(t){return Math.pow(t,n)}return n=+n,e.exponent=t,e}(3),Cl=function t(n){function e(t){return 1-Math.pow(1-t,n)}return n=+n,e.exponent=t,e}(3),zl=function t(n){function e(t){return((t*=2)<=1?Math.pow(t,n):2-Math.pow(2-t,n))/2}return n=+n,e.exponent=t,e}(3),Pl=Math.PI,Rl=Pl/2,Ll=4/11,ql=6/11,Dl=8/11,Ul=.75,Ol=9/11,Fl=10/11,Il=.9375,Yl=21/22,Bl=63/64,Hl=1/Ll/Ll,jl=function t(n){function e(t){return t*t*((n+1)*t-n)}return n=+n,e.overshoot=t,e}(1.70158),Xl=function t(n){function e(t){return--t*t*((n+1)*t+n)+1}return n=+n,e.overshoot=t,e}(1.70158),Vl=function t(n){function e(t){return((t*=2)<1?t*t*((n+1)*t-n):(t-=2)*t*((n+1)*t+n)+2)/2}return n=+n,e.overshoot=t,e}(1.70158),$l=2*Math.PI,Wl=function t(n,e){function r(t){return n*Math.pow(2,10*--t)*Math.sin((i-t)/e)}var i=Math.asin(1/(n=Math.max(1,n)))*(e/=$l);return r.amplitude=function(n){return t(n,e*$l)},r.period=function(e){return t(n,e)},r}(1,.3),Zl=function t(n,e){function r(t){return 1-n*Math.pow(2,-10*(t=+t))*Math.sin((t+i)/e)}var i=Math.asin(1/(n=Math.max(1,n)))*(e/=$l);return r.amplitude=function(n){return t(n,e*$l)},r.period=function(e){return t(n,e)},r}(1,.3),Gl=function t(n,e){function r(t){return((t=2*t-1)<0?n*Math.pow(2,10*t)*Math.sin((i-t)/e):2-n*Math.pow(2,-10*t)*Math.sin((i+t)/e))/2}var i=Math.asin(1/(n=Math.max(1,n)))*(e/=$l);return r.amplitude=function(n){return t(n,e*$l)},r.period=function(e){return t(n,e)},r}(1,.3),Ql={time:null,delay:0,duration:250,ease:Fn};at.prototype.interrupt=function(t){return this.each(function(){Pn(this,t)})},at.prototype.transition=function(t){var n,e;t instanceof qn?(n=t._id,t=t._name):(n=Un(),(e=Ql).time=mn(),t=null==t?null:t+"");for(var r=this._groups,i=r.length,o=0;o<i;++o)for(var u,a=r[o],c=a.length,s=0;s<c;++s)(u=a[s])&&En(u,t,n,s,a,e||jn(u,n));return new qn(r,this._parents,t,n)};var Jl=[null],Kl={name:"drag"},th={name:"space"},nh={name:"handle"},eh={name:"center"},rh={name:"x",handles:["e","w"].map(Wn),input:function(t,n){return t&&[[t[0],n[0][1]],[t[1],n[1][1]]]},output:function(t){return t&&[t[0][0],t[1][0]]}},ih={name:"y",handles:["n","s"].map(Wn),input:function(t,n){return t&&[[n[0][0],t[0]],[n[1][0],t[1]]]},output:function(t){return t&&[t[0][1],t[1][1]]}},oh={name:"xy",handles:["n","e","s","w","nw","ne","se","sw"].map(Wn),input:function(t){return t},output:function(t){return t}},uh={overlay:"crosshair",selection:"move",n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"},ah={e:"w",w:"e",nw:"ne",ne:"nw",se:"sw",sw:"se"},ch={n:"s",s:"n",nw:"sw",ne:"se",se:"ne",sw:"nw"},sh={overlay:1,selection:1,n:null,e:1,s:null,w:-1,nw:-1,ne:1,se:1,sw:-1},fh={overlay:1,selection:1,n:-1,e:null,s:1,w:null,nw:-1,ne:-1,se:1,sw:1},lh=Math.cos,hh=Math.sin,ph=Math.PI,dh=ph/2,vh=2*ph,gh=Math.max,_h=Array.prototype.slice,yh=Math.PI,mh=2*yh,xh=mh-1e-6;ne.prototype=ee.prototype={constructor:ne,moveTo:function(t,n){this._+="M"+(this._x0=this._x1=+t)+","+(this._y0=this._y1=+n)},closePath:function(){null!==this._x1&&(this._x1=this._x0,this._y1=this._y0,this._+="Z")},lineTo:function(t,n){this._+="L"+(this._x1=+t)+","+(this._y1=+n)},quadraticCurveTo:function(t,n,e,r){this._+="Q"+ +t+","+ +n+","+(this._x1=+e)+","+(this._y1=+r)},bezierCurveTo:function(t,n,e,r,i,o){this._+="C"+ +t+","+ +n+","+ +e+","+ +r+","+(this._x1=+i)+","+(this._y1=+o)},arcTo:function(t,n,e,r,i){t=+t,n=+n,e=+e,r=+r,i=+i;var o=this._x1,u=this._y1,a=e-t,c=r-n,s=o-t,f=u-n,l=s*s+f*f;if(i<0)throw new Error("negative radius: "+i);if(null===this._x1)this._+="M"+(this._x1=t)+","+(this._y1=n);else if(l>1e-6)if(Math.abs(f*a-c*s)>1e-6&&i){var h=e-o,p=r-u,d=a*a+c*c,v=h*h+p*p,g=Math.sqrt(d),_=Math.sqrt(l),y=i*Math.tan((yh-Math.acos((d+l-v)/(2*g*_)))/2),m=y/_,x=y/g;Math.abs(m-1)>1e-6&&(this._+="L"+(t+m*s)+","+(n+m*f)),this._+="A"+i+","+i+",0,0,"+ +(f*h>s*p)+","+(this._x1=t+x*a)+","+(this._y1=n+x*c)}else this._+="L"+(this._x1=t)+","+(this._y1=n);else;},arc:function(t,n,e,r,i,o){t=+t,n=+n;var u=(e=+e)*Math.cos(r),a=e*Math.sin(r),c=t+u,s=n+a,f=1^o,l=o?r-i:i-r;if(e<0)throw new Error("negative radius: "+e);null===this._x1?this._+="M"+c+","+s:(Math.abs(this._x1-c)>1e-6||Math.abs(this._y1-s)>1e-6)&&(this._+="L"+c+","+s),e&&(l<0&&(l=l%mh+mh),l>xh?this._+="A"+e+","+e+",0,1,"+f+","+(t-u)+","+(n-a)+"A"+e+","+e+",0,1,"+f+","+(this._x1=c)+","+(this._y1=s):l>1e-6&&(this._+="A"+e+","+e+",0,"+ +(l>=yh)+","+f+","+(this._x1=t+e*Math.cos(i))+","+(this._y1=n+e*Math.sin(i))))},rect:function(t,n,e,r){this._+="M"+(this._x0=this._x1=+t)+","+(this._y0=this._y1=+n)+"h"+ +e+"v"+ +r+"h"+-e+"Z"},toString:function(){return this._}};ce.prototype=se.prototype={constructor:ce,has:function(t){return"$"+t in this},get:function(t){return this["$"+t]},set:function(t,n){return this["$"+t]=n,this},remove:function(t){var n="$"+t;return n in this&&delete this[n]},clear:function(){for(var t in this)"$"===t[0]&&delete this[t]},keys:function(){var t=[];for(var n in this)"$"===n[0]&&t.push(n.slice(1));return t},values:function(){var t=[];for(var n in this)"$"===n[0]&&t.push(this[n]);return t},entries:function(){var t=[];for(var n in this)"$"===n[0]&&t.push({key:n.slice(1),value:this[n]});return t},size:function(){var t=0;for(var n in this)"$"===n[0]&&++t;return t},empty:function(){for(var t in this)if("$"===t[0])return!1;return!0},each:function(t){for(var n in this)"$"===n[0]&&t(this[n],n.slice(1),this)}};var bh=se.prototype;de.prototype=ve.prototype={constructor:de,has:bh.has,add:function(t){return t+="",this["$"+t]=t,this},remove:bh.remove,clear:bh.clear,values:bh.keys,size:bh.size,empty:bh.empty,each:bh.each};var wh={},Mh={},Th=34,Nh=10,kh=13,Sh=_e(","),Eh=Sh.parse,Ah=Sh.parseRows,Ch=Sh.format,zh=Sh.formatRows,Ph=_e("\t"),Rh=Ph.parse,Lh=Ph.parseRows,qh=Ph.format,Dh=Ph.formatRows,Uh=Te.prototype=Ne.prototype;Uh.copy=function(){var t,n,e=new Ne(this._x,this._y,this._x0,this._y0,this._x1,this._y1),r=this._root;if(!r)return e;if(!r.length)return e._root=ke(r),e;for(t=[{source:r,target:e._root=new Array(4)}];r=t.pop();)for(var i=0;i<4;++i)(n=r.source[i])&&(n.length?t.push({source:n,target:r.target[i]=new Array(4)}):r.target[i]=ke(n));return e},Uh.add=function(t){var n=+this._x.call(null,t),e=+this._y.call(null,t);return xe(this.cover(n,e),n,e,t)},Uh.addAll=function(t){var n,e,r,i,o=t.length,u=new Array(o),a=new Array(o),c=1/0,s=1/0,f=-1/0,l=-1/0;for(e=0;e<o;++e)isNaN(r=+this._x.call(null,n=t[e]))||isNaN(i=+this._y.call(null,n))||(u[e]=r,a[e]=i,r<c&&(c=r),r>f&&(f=r),i<s&&(s=i),i>l&&(l=i));for(f<c&&(c=this._x0,f=this._x1),l<s&&(s=this._y0,l=this._y1),this.cover(c,s).cover(f,l),e=0;e<o;++e)xe(this,u[e],a[e],t[e]);return this},Uh.cover=function(t,n){if(isNaN(t=+t)||isNaN(n=+n))return this;var e=this._x0,r=this._y0,i=this._x1,o=this._y1;if(isNaN(e))i=(e=Math.floor(t))+1,o=(r=Math.floor(n))+1;else{if(!(e>t||t>i||r>n||n>o))return this;var u,a,c=i-e,s=this._root;switch(a=(n<(r+o)/2)<<1|t<(e+i)/2){case 0:do{u=new Array(4),u[a]=s,s=u}while(c*=2,i=e+c,o=r+c,t>i||n>o);break;case 1:do{u=new Array(4),u[a]=s,s=u}while(c*=2,e=i-c,o=r+c,e>t||n>o);break;case 2:do{u=new Array(4),u[a]=s,s=u}while(c*=2,i=e+c,r=o-c,t>i||r>n);break;case 3:do{u=new Array(4),u[a]=s,s=u}while(c*=2,e=i-c,r=o-c,e>t||r>n)}this._root&&this._root.length&&(this._root=s)}return this._x0=e,this._y0=r,this._x1=i,this._y1=o,this},Uh.data=function(){var t=[];return this.visit(function(n){if(!n.length)do{t.push(n.data)}while(n=n.next)}),t},Uh.extent=function(t){return arguments.length?this.cover(+t[0][0],+t[0][1]).cover(+t[1][0],+t[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]},Uh.find=function(t,n,e){var r,i,o,u,a,c,s,f=this._x0,l=this._y0,h=this._x1,p=this._y1,d=[],v=this._root;for(v&&d.push(new be(v,f,l,h,p)),null==e?e=1/0:(f=t-e,l=n-e,h=t+e,p=n+e,e*=e);c=d.pop();)if(!(!(v=c.node)||(i=c.x0)>h||(o=c.y0)>p||(u=c.x1)<f||(a=c.y1)<l))if(v.length){var g=(i+u)/2,_=(o+a)/2;d.push(new be(v[3],g,_,u,a),new be(v[2],i,_,g,a),new be(v[1],g,o,u,_),new be(v[0],i,o,g,_)),(s=(n>=_)<<1|t>=g)&&(c=d[d.length-1],d[d.length-1]=d[d.length-1-s],d[d.length-1-s]=c)}else{var y=t-+this._x.call(null,v.data),m=n-+this._y.call(null,v.data),x=y*y+m*m;if(x<e){var b=Math.sqrt(e=x);f=t-b,l=n-b,h=t+b,p=n+b,r=v.data}}return r},Uh.remove=function(t){if(isNaN(o=+this._x.call(null,t))||isNaN(u=+this._y.call(null,t)))return this;var n,e,r,i,o,u,a,c,s,f,l,h,p=this._root,d=this._x0,v=this._y0,g=this._x1,_=this._y1;if(!p)return this;if(p.length)for(;;){if((s=o>=(a=(d+g)/2))?d=a:g=a,(f=u>=(c=(v+_)/2))?v=c:_=c,n=p,!(p=p[l=f<<1|s]))return this;if(!p.length)break;(n[l+1&3]||n[l+2&3]||n[l+3&3])&&(e=n,h=l)}for(;p.data!==t;)if(r=p,!(p=p.next))return this;return(i=p.next)&&delete p.next,r?(i?r.next=i:delete r.next,this):n?(i?n[l]=i:delete n[l],(p=n[0]||n[1]||n[2]||n[3])&&p===(n[3]||n[2]||n[1]||n[0])&&!p.length&&(e?e[h]=p:this._root=p),this):(this._root=i,this)},Uh.removeAll=function(t){for(var n=0,e=t.length;n<e;++n)this.remove(t[n]);return this},Uh.root=function(){return this._root},Uh.size=function(){var t=0;return this.visit(function(n){if(!n.length)do{++t}while(n=n.next)}),t},Uh.visit=function(t){var n,e,r,i,o,u,a=[],c=this._root;for(c&&a.push(new be(c,this._x0,this._y0,this._x1,this._y1));n=a.pop();)if(!t(c=n.node,r=n.x0,i=n.y0,o=n.x1,u=n.y1)&&c.length){var s=(r+o)/2,f=(i+u)/2;(e=c[3])&&a.push(new be(e,s,f,o,u)),(e=c[2])&&a.push(new be(e,r,f,s,u)),(e=c[1])&&a.push(new be(e,s,i,o,f)),(e=c[0])&&a.push(new be(e,r,i,s,f))}return this},Uh.visitAfter=function(t){var n,e=[],r=[];for(this._root&&e.push(new be(this._root,this._x0,this._y0,this._x1,this._y1));n=e.pop();){var i=n.node;if(i.length){var o,u=n.x0,a=n.y0,c=n.x1,s=n.y1,f=(u+c)/2,l=(a+s)/2;(o=i[0])&&e.push(new be(o,u,a,f,l)),(o=i[1])&&e.push(new be(o,f,a,c,l)),(o=i[2])&&e.push(new be(o,u,l,f,s)),(o=i[3])&&e.push(new be(o,f,l,c,s))}r.push(n)}for(;n=r.pop();)t(n.node,n.x0,n.y0,n.x1,n.y1);return this},Uh.x=function(t){return arguments.length?(this._x=t,this):this._x},Uh.y=function(t){return arguments.length?(this._y=t,this):this._y};var Oh,Fh=10,Ih=Math.PI*(3-Math.sqrt(5)),Yh={"":function(t,n){t:for(var e,r=(t=t.toPrecision(n)).length,i=1,o=-1;i<r;++i)switch(t[i]){case".":o=e=i;break;case"0":0===o&&(o=i),e=i;break;case"e":break t;default:o>0&&(o=0)}return o>0?t.slice(0,o)+t.slice(e+1):t},"%":function(t,n){return(100*t).toFixed(n)},b:function(t){return Math.round(t).toString(2)},c:function(t){return t+""},d:function(t){return Math.round(t).toString(10)},e:function(t,n){return t.toExponential(n)},f:function(t,n){return t.toFixed(n)},g:function(t,n){return t.toPrecision(n)},o:function(t){return Math.round(t).toString(8)},p:function(t,n){return qe(100*t,n)},r:qe,s:function(t,n){var e=Re(t,n);if(!e)return t+"";var r=e[0],i=e[1],o=i-(Oh=3*Math.max(-8,Math.min(8,Math.floor(i/3))))+1,u=r.length;return o===u?r:o>u?r+new Array(o-u+1).join("0"):o>0?r.slice(0,o)+"."+r.slice(o):"0."+new Array(1-o).join("0")+Re(t,Math.max(0,n+o-1))[0]},X:function(t){return Math.round(t).toString(16).toUpperCase()},x:function(t){return Math.round(t).toString(16)}},Bh=/^(?:(.)?([<>=^]))?([+\-\( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?([a-z%])?$/i;De.prototype=Ue.prototype,Ue.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(null==this.width?"":Math.max(1,0|this.width))+(this.comma?",":"")+(null==this.precision?"":"."+Math.max(0,0|this.precision))+this.type};var Hh,jh=["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"];Ie({decimal:".",thousands:",",grouping:[3],currency:["$",""]}),Xe.prototype={constructor:Xe,reset:function(){this.s=this.t=0},add:function(t){Ve(wp,t,this.t),Ve(this,wp.s,this.s),this.s?this.t+=wp.t:this.s=wp.t},valueOf:function(){return this.s}};var Xh,Vh,$h,Wh,Zh,Gh,Qh,Jh,Kh,tp,np,ep,rp,ip,op,up,ap,cp,sp,fp,lp,hp,pp,dp,vp,gp,_p,yp,mp,xp,bp,wp=new Xe,Mp=1e-6,Tp=1e-12,Np=Math.PI,kp=Np/2,Sp=Np/4,Ep=2*Np,Ap=180/Np,Cp=Np/180,zp=Math.abs,Pp=Math.atan,Rp=Math.atan2,Lp=Math.cos,qp=Math.ceil,Dp=Math.exp,Up=Math.log,Op=Math.pow,Fp=Math.sin,Ip=Math.sign||function(t){return t>0?1:t<0?-1:0},Yp=Math.sqrt,Bp=Math.tan,Hp={Feature:function(t,n){Qe(t.geometry,n)},FeatureCollection:function(t,n){for(var e=t.features,r=-1,i=e.length;++r<i;)Qe(e[r].geometry,n)}},jp={Sphere:function(t,n){n.sphere()},Point:function(t,n){t=t.coordinates,n.point(t[0],t[1],t[2])},MultiPoint:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)t=e[r],n.point(t[0],t[1],t[2])},LineString:function(t,n){Je(t.coordinates,n,0)},MultiLineString:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)Je(e[r],n,0)},Polygon:function(t,n){Ke(t.coordinates,n)},MultiPolygon:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)Ke(e[r],n)},GeometryCollection:function(t,n){for(var e=t.geometries,r=-1,i=e.length;++r<i;)Qe(e[r],n)}},Xp=je(),Vp=je(),$p={point:Ge,lineStart:Ge,lineEnd:Ge,polygonStart:function(){Xp.reset(),$p.lineStart=nr,$p.lineEnd=er},polygonEnd:function(){var t=+Xp;Vp.add(t<0?Ep+t:t),this.lineStart=this.lineEnd=this.point=Ge},sphere:function(){Vp.add(Ep)}},Wp=je(),Zp={point:hr,lineStart:dr,lineEnd:vr,polygonStart:function(){Zp.point=gr,Zp.lineStart=_r,Zp.lineEnd=yr,Wp.reset(),$p.polygonStart()},polygonEnd:function(){$p.polygonEnd(),Zp.point=hr,Zp.lineStart=dr,Zp.lineEnd=vr,Xp<0?(Gh=-(Jh=180),Qh=-(Kh=90)):Wp>Mp?Kh=90:Wp<-Mp&&(Qh=-90),op[0]=Gh,op[1]=Jh}},Gp={sphere:Ge,point:wr,lineStart:Tr,lineEnd:Sr,polygonStart:function(){Gp.lineStart=Er,Gp.lineEnd=Ar},polygonEnd:function(){Gp.lineStart=Tr,Gp.lineEnd=Sr}};Lr.invert=Lr;var Qp,Jp,Kp,td,nd,ed,rd,id,od,ud,ad,cd=je(),sd=Wr(function(){return!0},function(t){var n,e=NaN,r=NaN,i=NaN;return{lineStart:function(){t.lineStart(),n=1},point:function(o,u){var a=o>0?Np:-Np,c=zp(o-e);zp(c-Np)<Mp?(t.point(e,r=(r+u)/2>0?kp:-kp),t.point(i,r),t.lineEnd(),t.lineStart(),t.point(a,r),t.point(o,r),n=0):i!==a&&c>=Np&&(zp(e-i)<Mp&&(e-=i*Mp),zp(o-a)<Mp&&(o-=a*Mp),r=function(t,n,e,r){var i,o,u=Fp(t-e);return zp(u)>Mp?Pp((Fp(n)*(o=Lp(r))*Fp(e)-Fp(r)*(i=Lp(n))*Fp(t))/(i*o*u)):(n+r)/2}(e,r,o,u),t.point(i,r),t.lineEnd(),t.lineStart(),t.point(a,r),n=0),t.point(e=o,r=u),i=a},lineEnd:function(){t.lineEnd(),e=r=NaN},clean:function(){return 2-n}}},function(t,n,e,r){var i;if(null==t)i=e*kp,r.point(-Np,i),r.point(0,i),r.point(Np,i),r.point(Np,0),r.point(Np,-i),r.point(0,-i),r.point(-Np,-i),r.point(-Np,0),r.point(-Np,i);else if(zp(t[0]-n[0])>Mp){var o=t[0]<n[0]?Np:-Np;i=e*o/2,r.point(-o,i),r.point(0,i),r.point(o,i)}else r.point(n[0],n[1])},[-Np,-kp]),fd=1e9,ld=-fd,hd=je(),pd={sphere:Ge,point:Ge,lineStart:function(){pd.point=ti,pd.lineEnd=Kr},lineEnd:Ge,polygonStart:Ge,polygonEnd:Ge},dd=[null,null],vd={type:"LineString",coordinates:dd},gd={Feature:function(t,n){return ii(t.geometry,n)},FeatureCollection:function(t,n){for(var e=t.features,r=-1,i=e.length;++r<i;)if(ii(e[r].geometry,n))return!0;return!1}},_d={Sphere:function(){return!0},Point:function(t,n){return oi(t.coordinates,n)},MultiPoint:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)if(oi(e[r],n))return!0;return!1},LineString:function(t,n){return ui(t.coordinates,n)},MultiLineString:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)if(ui(e[r],n))return!0;return!1},Polygon:function(t,n){return ai(t.coordinates,n)},MultiPolygon:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)if(ai(e[r],n))return!0;return!1},GeometryCollection:function(t,n){for(var e=t.geometries,r=-1,i=e.length;++r<i;)if(ii(e[r],n))return!0;return!1}},yd=je(),md=je(),xd={point:Ge,lineStart:Ge,lineEnd:Ge,polygonStart:function(){xd.lineStart=di,xd.lineEnd=_i},polygonEnd:function(){xd.lineStart=xd.lineEnd=xd.point=Ge,yd.add(zp(md)),md.reset()},result:function(){var t=yd/2;return yd.reset(),t}},bd=1/0,wd=bd,Md=-bd,Td=Md,Nd={point:function(t,n){t<bd&&(bd=t),t>Md&&(Md=t),n<wd&&(wd=n),n>Td&&(Td=n)},lineStart:Ge,lineEnd:Ge,polygonStart:Ge,polygonEnd:Ge,result:function(){var t=[[bd,wd],[Md,Td]];return Md=Td=-(wd=bd=1/0),t}},kd=0,Sd=0,Ed=0,Ad=0,Cd=0,zd=0,Pd=0,Rd=0,Ld=0,qd={point:yi,lineStart:mi,lineEnd:wi,polygonStart:function(){qd.lineStart=Mi,qd.lineEnd=Ti},polygonEnd:function(){qd.point=yi,qd.lineStart=mi,qd.lineEnd=wi},result:function(){var t=Ld?[Pd/Ld,Rd/Ld]:zd?[Ad/zd,Cd/zd]:Ed?[kd/Ed,Sd/Ed]:[NaN,NaN];return kd=Sd=Ed=Ad=Cd=zd=Pd=Rd=Ld=0,t}};Si.prototype={_radius:4.5,pointRadius:function(t){return this._radius=t,this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){0===this._line&&this._context.closePath(),this._point=NaN},point:function(t,n){switch(this._point){case 0:this._context.moveTo(t,n),this._point=1;break;case 1:this._context.lineTo(t,n);break;default:this._context.moveTo(t+this._radius,n),this._context.arc(t,n,this._radius,0,Ep)}},result:Ge};var Dd,Ud,Od,Fd,Id,Yd=je(),Bd={point:Ge,lineStart:function(){Bd.point=Ei},lineEnd:function(){Dd&&Ai(Ud,Od),Bd.point=Ge},polygonStart:function(){Dd=!0},polygonEnd:function(){Dd=null},result:function(){var t=+Yd;return Yd.reset(),t}};Ci.prototype={_radius:4.5,_circle:zi(4.5),pointRadius:function(t){return(t=+t)!==this._radius&&(this._radius=t,this._circle=null),this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){0===this._line&&this._string.push("Z"),this._point=NaN},point:function(t,n){switch(this._point){case 0:this._string.push("M",t,",",n),this._point=1;break;case 1:this._string.push("L",t,",",n);break;default:null==this._circle&&(this._circle=zi(this._radius)),this._string.push("M",t,",",n,this._circle)}},result:function(){if(this._string.length){var t=this._string.join("");return this._string=[],t}return null}},Ri.prototype={constructor:Ri,point:function(t,n){this.stream.point(t,n)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};var Hd=16,jd=Lp(30*Cp),Xd=Pi({point:function(t,n){this.stream.point(t*Cp,n*Cp)}}),Vd=Vi(function(t){return Yp(2/(1+t))});Vd.invert=$i(function(t){return 2*We(t/2)});var $d=Vi(function(t){return(t=$e(t))&&t/Fp(t)});$d.invert=$i(function(t){return t}),Wi.invert=function(t,n){return[t,2*Pp(Dp(n))-kp]},Ji.invert=Ji,to.invert=$i(Pp),eo.invert=function(t,n){var e,r=n,i=25;do{var o=r*r,u=o*o;r-=e=(r*(1.007226+o*(.015085+u*(.028874*o-.044475-.005916*u)))-n)/(1.007226+o*(.045255+u*(.259866*o-.311325-.005916*11*u)))}while(zp(e)>Mp&&--i>0);return[t/(.8707+(o=r*r)*(o*(o*o*o*(.003971-.001529*o)-.013791)-.131979)),r]},ro.invert=$i(We),io.invert=$i(function(t){return 2*Pp(t)}),oo.invert=function(t,n){return[-n,2*Pp(Dp(t))-kp]},vo.prototype=fo.prototype={constructor:vo,count:function(){return this.eachAfter(so)},each:function(t){var n,e,r,i,o=this,u=[o];do{for(n=u.reverse(),u=[];o=n.pop();)if(t(o),e=o.children)for(r=0,i=e.length;r<i;++r)u.push(e[r])}while(u.length);return this},eachAfter:function(t){for(var n,e,r,i=this,o=[i],u=[];i=o.pop();)if(u.push(i),n=i.children)for(e=0,r=n.length;e<r;++e)o.push(n[e]);for(;i=u.pop();)t(i);return this},eachBefore:function(t){for(var n,e,r=this,i=[r];r=i.pop();)if(t(r),n=r.children)for(e=n.length-1;e>=0;--e)i.push(n[e]);return this},sum:function(t){return this.eachAfter(function(n){for(var e=+t(n.data)||0,r=n.children,i=r&&r.length;--i>=0;)e+=r[i].value;n.value=e})},sort:function(t){return this.eachBefore(function(n){n.children&&n.children.sort(t)})},path:function(t){for(var n=this,e=function(t,n){if(t===n)return t;var e=t.ancestors(),r=n.ancestors(),i=null;for(t=e.pop(),n=r.pop();t===n;)i=t,t=e.pop(),n=r.pop();return i}(n,t),r=[n];n!==e;)n=n.parent,r.push(n);for(var i=r.length;t!==e;)r.splice(i,0,t),t=t.parent;return r},ancestors:function(){for(var t=this,n=[t];t=t.parent;)n.push(t);return n},descendants:function(){var t=[];return this.each(function(n){t.push(n)}),t},leaves:function(){var t=[];return this.eachBefore(function(n){n.children||t.push(n)}),t},links:function(){var t=this,n=[];return t.each(function(e){e!==t&&n.push({source:e.parent,target:e})}),n},copy:function(){return fo(this).eachBefore(ho)}};var Wd=Array.prototype.slice,Zd="$",Gd={depth:-1},Qd={};Ho.prototype=Object.create(vo.prototype);var Jd=(1+Math.sqrt(5))/2,Kd=function t(n){function e(t,e,r,i,o){Xo(n,t,e,r,i,o)}return e.ratio=function(n){return t((n=+n)>1?n:1)},e}(Jd),tv=function t(n){function e(t,e,r,i,o){if((u=t._squarify)&&u.ratio===n)for(var u,a,c,s,f,l=-1,h=u.length,p=t.value;++l<h;){for(c=(a=u[l]).children,s=a.value=0,f=c.length;s<f;++s)a.value+=c[s].value;a.dice?qo(a,e,r,i,r+=(o-r)*a.value/p):jo(a,e,r,e+=(i-e)*a.value/p,o),p-=a.value}else t._squarify=u=Xo(n,t,e,r,i,o),u.ratio=n}return e.ratio=function(n){return t((n=+n)>1?n:1)},e}(Jd),nv=[].slice,ev={};Zo.prototype=Ko.prototype={constructor:Zo,defer:function(t){if("function"!=typeof t)throw new Error("invalid callback");if(this._call)throw new Error("defer after await");if(null!=this._error)return this;var n=nv.call(arguments,1);return n.push(t),++this._waiting,this._tasks.push(n),Go(this),this},abort:function(){return null==this._error&&Qo(this,new Error("abort")),this},await:function(t){if("function"!=typeof t)throw new Error("invalid callback");if(this._call)throw new Error("multiple await");return this._call=function(n,e){t.apply(null,[n].concat(e))},Jo(this),this},awaitAll:function(t){if("function"!=typeof t)throw new Error("invalid callback");if(this._call)throw new Error("multiple await");return this._call=t,Jo(this),this}};var rv=function t(n){function e(t,e){return t=null==t?0:+t,e=null==e?1:+e,1===arguments.length?(e=t,t=0):e-=t,function(){return n()*e+t}}return e.source=t,e}(tu),iv=function t(n){function e(t,e){var r,i;return t=null==t?0:+t,e=null==e?1:+e,function(){var o;if(null!=r)o=r,r=null;else do{r=2*n()-1,o=2*n()-1,i=r*r+o*o}while(!i||i>1);return t+e*o*Math.sqrt(-2*Math.log(i)/i)}}return e.source=t,e}(tu),ov=function t(n){function e(){var t=iv.source(n).apply(this,arguments);return function(){return Math.exp(t())}}return e.source=t,e}(tu),uv=function t(n){function e(t){return function(){for(var e=0,r=0;r<t;++r)e+=n();return e}}return e.source=t,e}(tu),av=function t(n){function e(t){var e=uv.source(n)(t);return function(){return e()/t}}return e.source=t,e}(tu),cv=function t(n){function e(t){return function(){return-Math.log(1-n())/t}}return e.source=t,e}(tu),sv=eu("text/html",function(t){return document.createRange().createContextualFragment(t.responseText)}),fv=eu("application/json",function(t){return JSON.parse(t.responseText)}),lv=eu("text/plain",function(t){return t.responseText}),hv=eu("application/xml",function(t){var n=t.responseXML;if(!n)throw new Error("parse error");return n}),pv=ru("text/csv",Eh),dv=ru("text/tab-separated-values",Rh),vv=Array.prototype,gv=vv.map,_v=vv.slice,yv={name:"implicit"},mv=[0,1],xv=new Date,bv=new Date,wv=Cu(function(){},function(t,n){t.setTime(+t+n)},function(t,n){return n-t});wv.every=function(t){return t=Math.floor(t),isFinite(t)&&t>0?t>1?Cu(function(n){n.setTime(Math.floor(n/t)*t)},function(n,e){n.setTime(+n+e*t)},function(n,e){return(e-n)/t}):wv:null};var Mv=wv.range,Tv=6e4,Nv=6048e5,kv=Cu(function(t){t.setTime(1e3*Math.floor(t/1e3))},function(t,n){t.setTime(+t+1e3*n)},function(t,n){return(n-t)/1e3},function(t){return t.getUTCSeconds()}),Sv=kv.range,Ev=Cu(function(t){t.setTime(Math.floor(t/Tv)*Tv)},function(t,n){t.setTime(+t+n*Tv)},function(t,n){return(n-t)/Tv},function(t){return t.getMinutes()}),Av=Ev.range,Cv=Cu(function(t){var n=t.getTimezoneOffset()*Tv%36e5;n<0&&(n+=36e5),t.setTime(36e5*Math.floor((+t-n)/36e5)+n)},function(t,n){t.setTime(+t+36e5*n)},function(t,n){return(n-t)/36e5},function(t){return t.getHours()}),zv=Cv.range,Pv=Cu(function(t){t.setHours(0,0,0,0)},function(t,n){t.setDate(t.getDate()+n)},function(t,n){return(n-t-(n.getTimezoneOffset()-t.getTimezoneOffset())*Tv)/864e5},function(t){return t.getDate()-1}),Rv=Pv.range,Lv=zu(0),qv=zu(1),Dv=zu(2),Uv=zu(3),Ov=zu(4),Fv=zu(5),Iv=zu(6),Yv=Lv.range,Bv=qv.range,Hv=Dv.range,jv=Uv.range,Xv=Ov.range,Vv=Fv.range,$v=Iv.range,Wv=Cu(function(t){t.setDate(1),t.setHours(0,0,0,0)},function(t,n){t.setMonth(t.getMonth()+n)},function(t,n){return n.getMonth()-t.getMonth()+12*(n.getFullYear()-t.getFullYear())},function(t){return t.getMonth()}),Zv=Wv.range,Gv=Cu(function(t){t.setMonth(0,1),t.setHours(0,0,0,0)},function(t,n){t.setFullYear(t.getFullYear()+n)},function(t,n){return n.getFullYear()-t.getFullYear()},function(t){return t.getFullYear()});Gv.every=function(t){return isFinite(t=Math.floor(t))&&t>0?Cu(function(n){n.setFullYear(Math.floor(n.getFullYear()/t)*t),n.setMonth(0,1),n.setHours(0,0,0,0)},function(n,e){n.setFullYear(n.getFullYear()+e*t)}):null};var Qv=Gv.range,Jv=Cu(function(t){t.setUTCSeconds(0,0)},function(t,n){t.setTime(+t+n*Tv)},function(t,n){return(n-t)/Tv},function(t){return t.getUTCMinutes()}),Kv=Jv.range,tg=Cu(function(t){t.setUTCMinutes(0,0,0)},function(t,n){t.setTime(+t+36e5*n)},function(t,n){return(n-t)/36e5},function(t){return t.getUTCHours()}),ng=tg.range,eg=Cu(function(t){t.setUTCHours(0,0,0,0)},function(t,n){t.setUTCDate(t.getUTCDate()+n)},function(t,n){return(n-t)/864e5},function(t){return t.getUTCDate()-1}),rg=eg.range,ig=Pu(0),og=Pu(1),ug=Pu(2),ag=Pu(3),cg=Pu(4),sg=Pu(5),fg=Pu(6),lg=ig.range,hg=og.range,pg=ug.range,dg=ag.range,vg=cg.range,gg=sg.range,_g=fg.range,yg=Cu(function(t){t.setUTCDate(1),t.setUTCHours(0,0,0,0)},function(t,n){t.setUTCMonth(t.getUTCMonth()+n)},function(t,n){return n.getUTCMonth()-t.getUTCMonth()+12*(n.getUTCFullYear()-t.getUTCFullYear())},function(t){return t.getUTCMonth()}),mg=yg.range,xg=Cu(function(t){t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)},function(t,n){t.setUTCFullYear(t.getUTCFullYear()+n)},function(t,n){return n.getUTCFullYear()-t.getUTCFullYear()},function(t){return t.getUTCFullYear()});xg.every=function(t){return isFinite(t=Math.floor(t))&&t>0?Cu(function(n){n.setUTCFullYear(Math.floor(n.getUTCFullYear()/t)*t),n.setUTCMonth(0,1),n.setUTCHours(0,0,0,0)},function(n,e){n.setUTCFullYear(n.getUTCFullYear()+e*t)}):null};var bg,wg=xg.range,Mg={"-":"",_:" ",0:"0"},Tg=/^\s*\d+/,Ng=/^%/,kg=/[\\^$*+?|[\]().{}]/g;Ha({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});var Sg="%Y-%m-%dT%H:%M:%S.%LZ",Eg=Date.prototype.toISOString?function(t){return t.toISOString()}:t.utcFormat(Sg),Ag=+new Date("2000-01-01T00:00:00.000Z")?function(t){var n=new Date(t);return isNaN(n)?null:n}:t.utcParse(Sg),Cg=1e3,zg=60*Cg,Pg=60*zg,Rg=24*Pg,Lg=7*Rg,qg=30*Rg,Dg=365*Rg,Ug=$a("1f77b4ff7f0e2ca02cd627289467bd8c564be377c27f7f7fbcbd2217becf"),Og=$a("393b795254a36b6ecf9c9ede6379398ca252b5cf6bcedb9c8c6d31bd9e39e7ba52e7cb94843c39ad494ad6616be7969c7b4173a55194ce6dbdde9ed6"),Fg=$a("3182bd6baed69ecae1c6dbefe6550dfd8d3cfdae6bfdd0a231a35474c476a1d99bc7e9c0756bb19e9ac8bcbddcdadaeb636363969696bdbdbdd9d9d9"),Ig=$a("1f77b4aec7e8ff7f0effbb782ca02c98df8ad62728ff98969467bdc5b0d58c564bc49c94e377c2f7b6d27f7f7fc7c7c7bcbd22dbdb8d17becf9edae5"),Yg=al($t(300,.5,0),$t(-240,.5,1)),Bg=al($t(-100,.75,.35),$t(80,1.5,.8)),Hg=al($t(260,.75,.35),$t(80,1.5,.8)),jg=$t(),Xg=Wa($a("44015444025645045745055946075a46085c460a5d460b5e470d60470e6147106347116447136548146748166848176948186a481a6c481b6d481c6e481d6f481f70482071482173482374482475482576482677482878482979472a7a472c7a472d7b472e7c472f7d46307e46327e46337f463480453581453781453882443983443a83443b84433d84433e85423f854240864241864142874144874045884046883f47883f48893e49893e4a893e4c8a3d4d8a3d4e8a3c4f8a3c508b3b518b3b528b3a538b3a548c39558c39568c38588c38598c375a8c375b8d365c8d365d8d355e8d355f8d34608d34618d33628d33638d32648e32658e31668e31678e31688e30698e306a8e2f6b8e2f6c8e2e6d8e2e6e8e2e6f8e2d708e2d718e2c718e2c728e2c738e2b748e2b758e2a768e2a778e2a788e29798e297a8e297b8e287c8e287d8e277e8e277f8e27808e26818e26828e26828e25838e25848e25858e24868e24878e23888e23898e238a8d228b8d228c8d228d8d218e8d218f8d21908d21918c20928c20928c20938c1f948c1f958b1f968b1f978b1f988b1f998a1f9a8a1e9b8a1e9c891e9d891f9e891f9f881fa0881fa1881fa1871fa28720a38620a48621a58521a68522a78522a88423a98324aa8325ab8225ac8226ad8127ad8128ae8029af7f2ab07f2cb17e2db27d2eb37c2fb47c31b57b32b67a34b67935b77937b87838b9773aba763bbb753dbc743fbc7340bd7242be7144bf7046c06f48c16e4ac16d4cc26c4ec36b50c46a52c56954c56856c66758c7655ac8645cc8635ec96260ca6063cb5f65cb5e67cc5c69cd5b6ccd5a6ece5870cf5773d05675d05477d1537ad1517cd2507fd34e81d34d84d44b86d54989d5488bd6468ed64590d74393d74195d84098d83e9bd93c9dd93ba0da39a2da37a5db36a8db34aadc32addc30b0dd2fb2dd2db5de2bb8de29bade28bddf26c0df25c2df23c5e021c8e020cae11fcde11dd0e11cd2e21bd5e21ad8e219dae319dde318dfe318e2e418e5e419e7e419eae51aece51befe51cf1e51df4e61ef6e620f8e621fbe723fde725")),Vg=Wa($a("00000401000501010601010802010902020b02020d03030f03031204041405041606051806051a07061c08071e0907200a08220b09240c09260d0a290e0b2b100b2d110c2f120d31130d34140e36150e38160f3b180f3d19103f1a10421c10441d11471e114920114b21114e22115024125325125527125829115a2a115c2c115f2d11612f116331116533106734106936106b38106c390f6e3b0f703d0f713f0f72400f74420f75440f764510774710784910784a10794c117a4e117b4f127b51127c52137c54137d56147d57157e59157e5a167e5c167f5d177f5f187f601880621980641a80651a80671b80681c816a1c816b1d816d1d816e1e81701f81721f817320817521817621817822817922827b23827c23827e24828025828125818326818426818627818827818928818b29818c29818e2a81902a81912b81932b80942c80962c80982d80992d809b2e7f9c2e7f9e2f7fa02f7fa1307ea3307ea5317ea6317da8327daa337dab337cad347cae347bb0357bb2357bb3367ab5367ab73779b83779ba3878bc3978bd3977bf3a77c03a76c23b75c43c75c53c74c73d73c83e73ca3e72cc3f71cd4071cf4070d0416fd2426fd3436ed5446dd6456cd8456cd9466bdb476adc4869de4968df4a68e04c67e24d66e34e65e44f64e55064e75263e85362e95462ea5661eb5760ec5860ed5a5fee5b5eef5d5ef05f5ef1605df2625df2645cf3655cf4675cf4695cf56b5cf66c5cf66e5cf7705cf7725cf8745cf8765cf9785df9795df97b5dfa7d5efa7f5efa815ffb835ffb8560fb8761fc8961fc8a62fc8c63fc8e64fc9065fd9266fd9467fd9668fd9869fd9a6afd9b6bfe9d6cfe9f6dfea16efea36ffea571fea772fea973feaa74feac76feae77feb078feb27afeb47bfeb67cfeb77efeb97ffebb81febd82febf84fec185fec287fec488fec68afec88cfeca8dfecc8ffecd90fecf92fed194fed395fed597fed799fed89afdda9cfddc9efddea0fde0a1fde2a3fde3a5fde5a7fde7a9fde9aafdebacfcecaefceeb0fcf0b2fcf2b4fcf4b6fcf6b8fcf7b9fcf9bbfcfbbdfcfdbf")),$g=Wa($a("00000401000501010601010802010a02020c02020e03021004031204031405041706041907051b08051d09061f0a07220b07240c08260d08290e092b10092d110a30120a32140b34150b37160b39180c3c190c3e1b0c411c0c431e0c451f0c48210c4a230c4c240c4f260c51280b53290b552b0b572d0b592f0a5b310a5c320a5e340a5f3609613809623909633b09643d09653e0966400a67420a68440a68450a69470b6a490b6a4a0c6b4c0c6b4d0d6c4f0d6c510e6c520e6d540f6d550f6d57106e59106e5a116e5c126e5d126e5f136e61136e62146e64156e65156e67166e69166e6a176e6c186e6d186e6f196e71196e721a6e741a6e751b6e771c6d781c6d7a1d6d7c1d6d7d1e6d7f1e6c801f6c82206c84206b85216b87216b88226a8a226a8c23698d23698f24699025689225689326679526679727669827669a28659b29649d29649f2a63a02a63a22b62a32c61a52c60a62d60a82e5fa92e5eab2f5ead305dae305cb0315bb1325ab3325ab43359b63458b73557b93556ba3655bc3754bd3853bf3952c03a51c13a50c33b4fc43c4ec63d4dc73e4cc83f4bca404acb4149cc4248ce4347cf4446d04545d24644d34743d44842d54a41d74b3fd84c3ed94d3dda4e3cdb503bdd513ade5238df5337e05536e15635e25734e35933e45a31e55c30e65d2fe75e2ee8602de9612bea632aeb6429eb6628ec6726ed6925ee6a24ef6c23ef6e21f06f20f1711ff1731df2741cf3761bf37819f47918f57b17f57d15f67e14f68013f78212f78410f8850ff8870ef8890cf98b0bf98c0af98e09fa9008fa9207fa9407fb9606fb9706fb9906fb9b06fb9d07fc9f07fca108fca309fca50afca60cfca80dfcaa0ffcac11fcae12fcb014fcb216fcb418fbb61afbb81dfbba1ffbbc21fbbe23fac026fac228fac42afac62df9c72ff9c932f9cb35f8cd37f8cf3af7d13df7d340f6d543f6d746f5d949f5db4cf4dd4ff4df53f4e156f3e35af3e55df2e661f2e865f2ea69f1ec6df1ed71f1ef75f1f179f2f27df2f482f3f586f3f68af4f88ef5f992f6fa96f8fb9af9fc9dfafda1fcffa4")),Wg=Wa($a("0d088710078813078916078a19068c1b068d1d068e20068f2206902406912605912805922a05932c05942e05952f059631059733059735049837049938049a3a049a3c049b3e049c3f049c41049d43039e44039e46039f48039f4903a04b03a14c02a14e02a25002a25102a35302a35502a45601a45801a45901a55b01a55c01a65e01a66001a66100a76300a76400a76600a76700a86900a86a00a86c00a86e00a86f00a87100a87201a87401a87501a87701a87801a87a02a87b02a87d03a87e03a88004a88104a78305a78405a78606a68707a68808a68a09a58b0aa58d0ba58e0ca48f0da4910ea3920fa39410a29511a19613a19814a099159f9a169f9c179e9d189d9e199da01a9ca11b9ba21d9aa31e9aa51f99a62098a72197a82296aa2395ab2494ac2694ad2793ae2892b02991b12a90b22b8fb32c8eb42e8db52f8cb6308bb7318ab83289ba3388bb3488bc3587bd3786be3885bf3984c03a83c13b82c23c81c33d80c43e7fc5407ec6417dc7427cc8437bc9447aca457acb4679cc4778cc4977cd4a76ce4b75cf4c74d04d73d14e72d24f71d35171d45270d5536fd5546ed6556dd7566cd8576bd9586ada5a6ada5b69db5c68dc5d67dd5e66de5f65de6164df6263e06363e16462e26561e26660e3685fe4695ee56a5de56b5de66c5ce76e5be76f5ae87059e97158e97257ea7457eb7556eb7655ec7754ed7953ed7a52ee7b51ef7c51ef7e50f07f4ff0804ef1814df1834cf2844bf3854bf3874af48849f48948f58b47f58c46f68d45f68f44f79044f79143f79342f89441f89540f9973ff9983ef99a3efa9b3dfa9c3cfa9e3bfb9f3afba139fba238fca338fca537fca636fca835fca934fdab33fdac33fdae32fdaf31fdb130fdb22ffdb42ffdb52efeb72dfeb82cfeba2cfebb2bfebd2afebe2afec029fdc229fdc328fdc527fdc627fdc827fdca26fdcb26fccd25fcce25fcd025fcd225fbd324fbd524fbd724fad824fada24f9dc24f9dd25f8df25f8e125f7e225f7e425f6e626f6e826f5e926f5eb27f4ed27f3ee27f3f027f2f227f1f426f1f525f0f724f0f921")),Zg=Math.abs,Gg=Math.atan2,Qg=Math.cos,Jg=Math.max,Kg=Math.min,t_=Math.sin,n_=Math.sqrt,e_=1e-12,r_=Math.PI,i_=r_/2,o_=2*r_;ic.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2;default:this._context.lineTo(t,n)}}};var u_=pc(oc);hc.prototype={areaStart:function(){this._curve.areaStart()},areaEnd:function(){this._curve.areaEnd()},lineStart:function(){this._curve.lineStart()},lineEnd:function(){this._curve.lineEnd()},point:function(t,n){this._curve.point(n*Math.sin(t),n*-Math.cos(t))}};var a_=Array.prototype.slice,c_={draw:function(t,n){var e=Math.sqrt(n/r_);t.moveTo(e,0),t.arc(0,0,e,0,o_)}},s_={draw:function(t,n){var e=Math.sqrt(n/5)/2;t.moveTo(-3*e,-e),t.lineTo(-e,-e),t.lineTo(-e,-3*e),t.lineTo(e,-3*e),t.lineTo(e,-e),t.lineTo(3*e,-e),t.lineTo(3*e,e),t.lineTo(e,e),t.lineTo(e,3*e),t.lineTo(-e,3*e),t.lineTo(-e,e),t.lineTo(-3*e,e),t.closePath()}},f_=Math.sqrt(1/3),l_=2*f_,h_={draw:function(t,n){var e=Math.sqrt(n/l_),r=e*f_;t.moveTo(0,-e),t.lineTo(r,0),t.lineTo(0,e),t.lineTo(-r,0),t.closePath()}},p_=Math.sin(r_/10)/Math.sin(7*r_/10),d_=Math.sin(o_/10)*p_,v_=-Math.cos(o_/10)*p_,g_={draw:function(t,n){var e=Math.sqrt(.8908130915292852*n),r=d_*e,i=v_*e;t.moveTo(0,-e),t.lineTo(r,i);for(var o=1;o<5;++o){var u=o_*o/5,a=Math.cos(u),c=Math.sin(u);t.lineTo(c*e,-a*e),t.lineTo(a*r-c*i,c*r+a*i)}t.closePath()}},__={draw:function(t,n){var e=Math.sqrt(n),r=-e/2;t.rect(r,r,e,e)}},y_=Math.sqrt(3),m_={draw:function(t,n){var e=-Math.sqrt(n/(3*y_));t.moveTo(0,2*e),t.lineTo(-y_*e,-e),t.lineTo(y_*e,-e),t.closePath()}},x_=Math.sqrt(3)/2,b_=1/Math.sqrt(12),w_=3*(b_/2+1),M_={draw:function(t,n){var e=Math.sqrt(n/w_),r=e/2,i=e*b_,o=r,u=e*b_+e,a=-o,c=u;t.moveTo(r,i),t.lineTo(o,u),t.lineTo(a,c),t.lineTo(-.5*r-x_*i,x_*r+-.5*i),t.lineTo(-.5*o-x_*u,x_*o+-.5*u),t.lineTo(-.5*a-x_*c,x_*a+-.5*c),t.lineTo(-.5*r+x_*i,-.5*i-x_*r),t.lineTo(-.5*o+x_*u,-.5*u-x_*o),t.lineTo(-.5*a+x_*c,-.5*c-x_*a),t.closePath()}},T_=[c_,s_,h_,__,g_,m_,M_];kc.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){switch(this._point){case 3:Nc(this,this._x1,this._y1);case 2:this._context.lineTo(this._x1,this._y1)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2;break;case 2:this._point=3,this._context.lineTo((5*this._x0+this._x1)/6,(5*this._y0+this._y1)/6);default:Nc(this,t,n)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=n}},Sc.prototype={areaStart:Tc,areaEnd:Tc,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._y0=this._y1=this._y2=this._y3=this._y4=NaN,this._point=0},lineEnd:function(){switch(this._point){case 1:this._context.moveTo(this._x2,this._y2),this._context.closePath();break;case 2:this._context.moveTo((this._x2+2*this._x3)/3,(this._y2+2*this._y3)/3),this._context.lineTo((this._x3+2*this._x2)/3,(this._y3+2*this._y2)/3),this._context.closePath();break;case 3:this.point(this._x2,this._y2),this.point(this._x3,this._y3),this.point(this._x4,this._y4)}},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._x2=t,this._y2=n;break;case 1:this._point=2,this._x3=t,this._y3=n;break;case 2:this._point=3,this._x4=t,this._y4=n,this._context.moveTo((this._x0+4*this._x1+t)/6,(this._y0+4*this._y1+n)/6);break;default:Nc(this,t,n)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=n}},Ec.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){(this._line||0!==this._line&&3===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3;var e=(this._x0+4*this._x1+t)/6,r=(this._y0+4*this._y1+n)/6;this._line?this._context.lineTo(e,r):this._context.moveTo(e,r);break;case 3:this._point=4;default:Nc(this,t,n)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=n}},Ac.prototype={lineStart:function(){this._x=[],this._y=[],this._basis.lineStart()},lineEnd:function(){var t=this._x,n=this._y,e=t.length-1;if(e>0)for(var r,i=t[0],o=n[0],u=t[e]-i,a=n[e]-o,c=-1;++c<=e;)r=c/e,this._basis.point(this._beta*t[c]+(1-this._beta)*(i+r*u),this._beta*n[c]+(1-this._beta)*(o+r*a));this._x=this._y=null,this._basis.lineEnd()},point:function(t,n){this._x.push(+t),this._y.push(+n)}};var N_=function t(n){function e(t){return 1===n?new kc(t):new Ac(t,n)}return e.beta=function(n){return t(+n)},e}(.85);zc.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:Cc(this,this._x1,this._y1)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2,this._x1=t,this._y1=n;break;case 2:this._point=3;default:Cc(this,t,n)}this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var k_=function t(n){function e(t){return new zc(t,n)}return e.tension=function(n){return t(+n)},e}(0);Pc.prototype={areaStart:Tc,areaEnd:Tc,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._x5=this._y0=this._y1=this._y2=this._y3=this._y4=this._y5=NaN,this._point=0},lineEnd:function(){switch(this._point){case 1:this._context.moveTo(this._x3,this._y3),this._context.closePath();break;case 2:this._context.lineTo(this._x3,this._y3),this._context.closePath();break;case 3:this.point(this._x3,this._y3),this.point(this._x4,this._y4),this.point(this._x5,this._y5)}},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._x3=t,this._y3=n;break;case 1:this._point=2,this._context.moveTo(this._x4=t,this._y4=n);break;case 2:this._point=3,this._x5=t,this._y5=n;break;default:Cc(this,t,n)}this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var S_=function t(n){function e(t){return new Pc(t,n)}return e.tension=function(n){return t(+n)},e}(0);Rc.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._point=0},lineEnd:function(){(this._line||0!==this._line&&3===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3,this._line?this._context.lineTo(this._x2,this._y2):this._context.moveTo(this._x2,this._y2);break;case 3:this._point=4;default:Cc(this,t,n)}this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var E_=function t(n){function e(t){return new Rc(t,n)}return e.tension=function(n){return t(+n)},e}(0);qc.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:this.point(this._x2,this._y2)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){if(t=+t,n=+n,this._point){var e=this._x2-t,r=this._y2-n;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(e*e+r*r,this._alpha))}switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2;break;case 2:this._point=3;default:Lc(this,t,n)}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var A_=function t(n){function e(t){return n?new qc(t,n):new zc(t,0)}return e.alpha=function(n){return t(+n)},e}(.5);Dc.prototype={areaStart:Tc,areaEnd:Tc,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._x5=this._y0=this._y1=this._y2=this._y3=this._y4=this._y5=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){switch(this._point){case 1:this._context.moveTo(this._x3,this._y3),this._context.closePath();break;case 2:this._context.lineTo(this._x3,this._y3),this._context.closePath();break;case 3:this.point(this._x3,this._y3),this.point(this._x4,this._y4),this.point(this._x5,this._y5)}},point:function(t,n){if(t=+t,n=+n,this._point){var e=this._x2-t,r=this._y2-n;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(e*e+r*r,this._alpha))}switch(this._point){case 0:this._point=1,this._x3=t,this._y3=n;break;case 1:this._point=2,this._context.moveTo(this._x4=t,this._y4=n);break;case 2:this._point=3,this._x5=t,this._y5=n;break;default:Lc(this,t,n)}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var C_=function t(n){function e(t){return n?new Dc(t,n):new Pc(t,0)}return e.alpha=function(n){return t(+n)},e}(.5);Uc.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){(this._line||0!==this._line&&3===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){if(t=+t,n=+n,this._point){var e=this._x2-t,r=this._y2-n;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(e*e+r*r,this._alpha))}switch(this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3,this._line?this._context.lineTo(this._x2,this._y2):this._context.moveTo(this._x2,this._y2);break;case 3:this._point=4;default:Lc(this,t,n)}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var z_=function t(n){function e(t){return n?new Uc(t,n):new Rc(t,0)}return e.alpha=function(n){return t(+n)},e}(.5);Oc.prototype={areaStart:Tc,areaEnd:Tc,lineStart:function(){this._point=0},lineEnd:function(){this._point&&this._context.closePath()},point:function(t,n){t=+t,n=+n,this._point?this._context.lineTo(t,n):(this._point=1,this._context.moveTo(t,n))}},Hc.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=this._t0=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x1,this._y1);break;case 3:Bc(this,this._t0,Yc(this,this._t0))}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){var e=NaN;if(t=+t,n=+n,t!==this._x1||n!==this._y1){switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2;break;case 2:this._point=3,Bc(this,Yc(this,e=Ic(this,t,n)),e);break;default:Bc(this,this._t0,e=Ic(this,t,n))}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=n,this._t0=e}}},(jc.prototype=Object.create(Hc.prototype)).point=function(t,n){Hc.prototype.point.call(this,n,t)},Xc.prototype={moveTo:function(t,n){this._context.moveTo(n,t)},closePath:function(){this._context.closePath()},lineTo:function(t,n){this._context.lineTo(n,t)},bezierCurveTo:function(t,n,e,r,i,o){this._context.bezierCurveTo(n,t,r,e,o,i)}},Vc.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=[],this._y=[]},lineEnd:function(){var t=this._x,n=this._y,e=t.length;if(e)if(this._line?this._context.lineTo(t[0],n[0]):this._context.moveTo(t[0],n[0]),2===e)this._context.lineTo(t[1],n[1]);else for(var r=$c(t),i=$c(n),o=0,u=1;u<e;++o,++u)this._context.bezierCurveTo(r[0][o],i[0][o],r[1][o],i[1][o],t[u],n[u]);(this._line||0!==this._line&&1===e)&&this._context.closePath(),this._line=1-this._line,this._x=this._y=null},point:function(t,n){this._x.push(+t),this._y.push(+n)}},Wc.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=this._y=NaN,this._point=0},lineEnd:function(){0<this._t&&this._t<1&&2===this._point&&this._context.lineTo(this._x,this._y),(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line>=0&&(this._t=1-this._t,this._line=1-this._line)},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2;default:if(this._t<=0)this._context.lineTo(this._x,n),this._context.lineTo(t,n);else{var e=this._x*(1-this._t)+t*this._t;this._context.lineTo(e,this._y),this._context.lineTo(e,n)}}this._x=t,this._y=n}},rs.prototype={constructor:rs,insert:function(t,n){var e,r,i;if(t){if(n.P=t,n.N=t.N,t.N&&(t.N.P=n),t.N=n,t.R){for(t=t.R;t.L;)t=t.L;t.L=n}else t.R=n;e=t}else this._?(t=as(this._),n.P=null,n.N=t,t.P=t.L=n,e=t):(n.P=n.N=null,this._=n,e=null);for(n.L=n.R=null,n.U=e,n.C=!0,t=n;e&&e.C;)e===(r=e.U).L?(i=r.R)&&i.C?(e.C=i.C=!1,r.C=!0,t=r):(t===e.R&&(os(this,e),e=(t=e).U),e.C=!1,r.C=!0,us(this,r)):(i=r.L)&&i.C?(e.C=i.C=!1,r.C=!0,t=r):(t===e.L&&(us(this,e),e=(t=e).U),e.C=!1,r.C=!0,os(this,r)),e=t.U;this._.C=!1},remove:function(t){t.N&&(t.N.P=t.P),t.P&&(t.P.N=t.N),t.N=t.P=null;var n,e,r,i=t.U,o=t.L,u=t.R;if(e=o?u?as(u):o:u,i?i.L===t?i.L=e:i.R=e:this._=e,o&&u?(r=e.C,e.C=t.C,e.L=o,o.U=e,e!==u?(i=e.U,e.U=t.U,t=e.R,i.L=t,e.R=u,u.U=e):(e.U=i,i=e,t=e.R)):(r=t.C,t=e),t&&(t.U=i),!r)if(t&&t.C)t.C=!1;else{do{if(t===this._)break;if(t===i.L){if((n=i.R).C&&(n.C=!1,i.C=!0,os(this,i),n=i.R),n.L&&n.L.C||n.R&&n.R.C){n.R&&n.R.C||(n.L.C=!1,n.C=!0,us(this,n),n=i.R),n.C=i.C,i.C=n.R.C=!1,os(this,i),t=this._;break}}else if((n=i.L).C&&(n.C=!1,i.C=!0,us(this,i),n=i.L),n.L&&n.L.C||n.R&&n.R.C){n.L&&n.L.C||(n.R.C=!1,n.C=!0,os(this,n),n=i.L),n.C=i.C,i.C=n.L.C=!1,us(this,i),t=this._;break}n.C=!0,t=i,i=i.U}while(!t.C);t&&(t.C=!1)}}};var P_,R_,L_,q_,D_,U_=[],O_=[],F_=1e-6,I_=1e-12;Ns.prototype={constructor:Ns,polygons:function(){var t=this.edges;return this.cells.map(function(n){var e=n.halfedges.map(function(e){return ds(n,t[e])});return e.data=n.site.data,e})},triangles:function(){var t=[],n=this.edges;return this.cells.forEach(function(e,r){if(o=(i=e.halfedges).length)for(var i,o,u,a=e.site,c=-1,s=n[i[o-1]],f=s.left===a?s.right:s.left;++c<o;)u=f,f=(s=n[i[c]]).left===a?s.right:s.left,u&&f&&r<u.index&&r<f.index&&Ms(a,u,f)<0&&t.push([a.data,u.data,f.data])}),t},links:function(){return this.edges.filter(function(t){return t.right}).map(function(t){return{source:t.left.data,target:t.right.data}})},find:function(t,n,e){for(var r,i,o=this,u=o._found||0,a=o.cells.length;!(i=o.cells[u]);)if(++u>=a)return null;var c=t-i.site[0],s=n-i.site[1],f=c*c+s*s;do{i=o.cells[r=u],u=null,i.halfedges.forEach(function(e){var r=o.edges[e],a=r.left;if(a!==i.site&&a||(a=r.right)){var c=t-a[0],s=n-a[1],l=c*c+s*s;l<f&&(f=l,u=a.index)}})}while(null!==u);return o._found=r,null==e||f<=e*e?i.site:null}},Ss.prototype={constructor:Ss,scale:function(t){return 1===t?this:new Ss(this.k*t,this.x,this.y)},translate:function(t,n){return 0===t&0===n?this:new Ss(this.k,this.x+this.k*t,this.y+this.k*n)},apply:function(t){return[t[0]*this.k+this.x,t[1]*this.k+this.y]},applyX:function(t){return t*this.k+this.x},applyY:function(t){return t*this.k+this.y},invert:function(t){return[(t[0]-this.x)/this.k,(t[1]-this.y)/this.k]},invertX:function(t){return(t-this.x)/this.k},invertY:function(t){return(t-this.y)/this.k},rescaleX:function(t){return t.copy().domain(t.range().map(this.invertX,this).map(t.invert,t))},rescaleY:function(t){return t.copy().domain(t.range().map(this.invertY,this).map(t.invert,t))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var Y_=new Ss(1,0,0);Es.prototype=Ss.prototype,t.version="4.13.0",t.bisect=Os,t.bisectRight=Os,t.bisectLeft=Fs,t.ascending=n,t.bisector=e,t.cross=function(t,n,e){var i,o,u,a,c=t.length,s=n.length,f=new Array(c*s);for(null==e&&(e=r),i=u=0;i<c;++i)for(a=t[i],o=0;o<s;++o,++u)f[u]=e(a,n[o]);return f},t.descending=function(t,n){return n<t?-1:n>t?1:n>=t?0:NaN},t.deviation=u,t.extent=a,t.histogram=function(){function t(t){var i,o,u=t.length,a=new Array(u);for(i=0;i<u;++i)a[i]=n(t[i],i,t);var c=e(a),s=c[0],l=c[1],h=r(a,s,l);Array.isArray(h)||(h=p(s,l,h),h=f(Math.ceil(s/h)*h,Math.floor(l/h)*h,h));for(var d=h.length;h[0]<=s;)h.shift(),--d;for(;h[d-1]>l;)h.pop(),--d;var v,g=new Array(d+1);for(i=0;i<=d;++i)(v=g[i]=[]).x0=i>0?h[i-1]:s,v.x1=i<d?h[i]:l;for(i=0;i<u;++i)s<=(o=a[i])&&o<=l&&g[Os(h,o,0,d)].push(t[i]);return g}var n=s,e=a,r=d;return t.value=function(e){return arguments.length?(n="function"==typeof e?e:c(e),t):n},t.domain=function(n){return arguments.length?(e="function"==typeof n?n:c([n[0],n[1]]),t):e},t.thresholds=function(n){return arguments.length?(r="function"==typeof n?n:Array.isArray(n)?c(Ys.call(n)):c(n),t):r},t},t.thresholdFreedmanDiaconis=function(t,e,r){return t=Bs.call(t,i).sort(n),Math.ceil((r-e)/(2*(v(t,.75)-v(t,.25))*Math.pow(t.length,-1/3)))},t.thresholdScott=function(t,n,e){return Math.ceil((e-n)/(3.5*u(t)*Math.pow(t.length,-1/3)))},t.thresholdSturges=d,t.max=function(t,n){var e,r,i=t.length,o=-1;if(null==n){for(;++o<i;)if(null!=(e=t[o])&&e>=e)for(r=e;++o<i;)null!=(e=t[o])&&e>r&&(r=e)}else for(;++o<i;)if(null!=(e=n(t[o],o,t))&&e>=e)for(r=e;++o<i;)null!=(e=n(t[o],o,t))&&e>r&&(r=e);return r},t.mean=function(t,n){var e,r=t.length,o=r,u=-1,a=0;if(null==n)for(;++u<r;)isNaN(e=i(t[u]))?--o:a+=e;else for(;++u<r;)isNaN(e=i(n(t[u],u,t)))?--o:a+=e;if(o)return a/o},t.median=function(t,e){var r,o=t.length,u=-1,a=[];if(null==e)for(;++u<o;)isNaN(r=i(t[u]))||a.push(r);else for(;++u<o;)isNaN(r=i(e(t[u],u,t)))||a.push(r);return v(a.sort(n),.5)},t.merge=g,t.min=_,t.pairs=function(t,n){null==n&&(n=r);for(var e=0,i=t.length-1,o=t[0],u=new Array(i<0?0:i);e<i;)u[e]=n(o,o=t[++e]);return u},t.permute=function(t,n){for(var e=n.length,r=new Array(e);e--;)r[e]=t[n[e]];return r},t.quantile=v,t.range=f,t.scan=function(t,e){if(r=t.length){var r,i,o=0,u=0,a=t[u];for(null==e&&(e=n);++o<r;)(e(i=t[o],a)<0||0!==e(a,a))&&(a=i,u=o);return 0===e(a,a)?u:void 0}},t.shuffle=function(t,n,e){for(var r,i,o=(null==e?t.length:e)-(n=null==n?0:+n);o;)i=Math.random()*o--|0,r=t[o+n],t[o+n]=t[i+n],t[i+n]=r;return t},t.sum=function(t,n){var e,r=t.length,i=-1,o=0;if(null==n)for(;++i<r;)(e=+t[i])&&(o+=e);else for(;++i<r;)(e=+n(t[i],i,t))&&(o+=e);return o},t.ticks=l,t.tickIncrement=h,t.tickStep=p,t.transpose=y,t.variance=o,t.zip=function(){return y(arguments)},t.axisTop=function(t){return T($s,t)},t.axisRight=function(t){return T(Ws,t)},t.axisBottom=function(t){return T(Zs,t)},t.axisLeft=function(t){return T(Gs,t)},t.brush=function(){return Kn(oh)},t.brushX=function(){return Kn(rh)},t.brushY=function(){return Kn(ih)},t.brushSelection=function(t){var n=t.__brush;return n?n.dim.output(n.selection):null},t.chord=function(){function t(t){var o,u,a,c,s,l,h=t.length,p=[],d=f(h),v=[],g=[],_=g.groups=new Array(h),y=new Array(h*h);for(o=0,s=-1;++s<h;){for(u=0,l=-1;++l<h;)u+=t[s][l];p.push(u),v.push(f(h)),o+=u}for(e&&d.sort(function(t,n){return e(p[t],p[n])}),r&&v.forEach(function(n,e){n.sort(function(n,i){return r(t[e][n],t[e][i])})}),c=(o=gh(0,vh-n*h)/o)?n:vh/h,u=0,s=-1;++s<h;){for(a=u,l=-1;++l<h;){var m=d[s],x=v[m][l],b=t[m][x],w=u,M=u+=b*o;y[x*h+m]={index:m,subindex:x,startAngle:w,endAngle:M,value:b}}_[m]={index:m,startAngle:a,endAngle:u,value:p[m]},u+=c}for(s=-1;++s<h;)for(l=s-1;++l<h;){var T=y[l*h+s],N=y[s*h+l];(T.value||N.value)&&g.push(T.value<N.value?{source:N,target:T}:{source:T,target:N})}return i?g.sort(i):g}var n=0,e=null,r=null,i=null;return t.padAngle=function(e){return arguments.length?(n=gh(0,e),t):n},t.sortGroups=function(n){return arguments.length?(e=n,t):e},t.sortSubgroups=function(n){return arguments.length?(r=n,t):r},t.sortChords=function(n){return arguments.length?(null==n?i=null:(i=function(t){return function(n,e){return t(n.source.value+n.target.value,e.source.value+e.target.value)}}(n))._=n,t):i&&i._},t},t.ribbon=function(){function t(){var t,a=_h.call(arguments),c=n.apply(this,a),s=e.apply(this,a),f=+r.apply(this,(a[0]=c,a)),l=i.apply(this,a)-dh,h=o.apply(this,a)-dh,p=f*lh(l),d=f*hh(l),v=+r.apply(this,(a[0]=s,a)),g=i.apply(this,a)-dh,_=o.apply(this,a)-dh;if(u||(u=t=ee()),u.moveTo(p,d),u.arc(0,0,f,l,h),l===g&&h===_||(u.quadraticCurveTo(0,0,v*lh(g),v*hh(g)),u.arc(0,0,v,g,_)),u.quadraticCurveTo(0,0,p,d),u.closePath(),t)return u=null,t+""||null}var n=re,e=ie,r=oe,i=ue,o=ae,u=null;return t.radius=function(n){return arguments.length?(r="function"==typeof n?n:te(+n),t):r},t.startAngle=function(n){return arguments.length?(i="function"==typeof n?n:te(+n),t):i},t.endAngle=function(n){return arguments.length?(o="function"==typeof n?n:te(+n),t):o},t.source=function(e){return arguments.length?(n=e,t):n},t.target=function(n){return arguments.length?(e=n,t):e},t.context=function(n){return arguments.length?(u=null==n?null:n,t):u},t},t.nest=function(){function t(n,i,u,a){if(i>=o.length)return null!=e&&n.sort(e),null!=r?r(n):n;for(var c,s,f,l=-1,h=n.length,p=o[i++],d=se(),v=u();++l<h;)(f=d.get(c=p(s=n[l])+""))?f.push(s):d.set(c,[s]);return d.each(function(n,e){a(v,e,t(n,i,u,a))}),v}function n(t,e){if(++e>o.length)return t;var i,a=u[e-1];return null!=r&&e>=o.length?i=t.entries():(i=[],t.each(function(t,r){i.push({key:r,values:n(t,e)})})),null!=a?i.sort(function(t,n){return a(t.key,n.key)}):i}var e,r,i,o=[],u=[];return i={object:function(n){return t(n,0,fe,le)},map:function(n){return t(n,0,he,pe)},entries:function(e){return n(t(e,0,he,pe),0)},key:function(t){return o.push(t),i},sortKeys:function(t){return u[o.length-1]=t,i},sortValues:function(t){return e=t,i},rollup:function(t){return r=t,i}}},t.set=ve,t.map=se,t.keys=function(t){var n=[];for(var e in t)n.push(e);return n},t.values=function(t){var n=[];for(var e in t)n.push(t[e]);return n},t.entries=function(t){var n=[];for(var e in t)n.push({key:e,value:t[e]});return n},t.color=Et,t.rgb=Pt,t.hsl=qt,t.lab=Ft,t.hcl=Xt,t.cubehelix=$t,t.dispatch=N,t.drag=function(){function n(t){t.on("mousedown.drag",e).filter(g).on("touchstart.drag",o).on("touchmove.drag",u).on("touchend.drag touchcancel.drag",a).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function e(){if(!h&&p.apply(this,arguments)){var n=c("mouse",d.apply(this,arguments),pt,this,arguments);n&&(ct(t.event.view).on("mousemove.drag",r,!0).on("mouseup.drag",i,!0),_t(t.event.view),vt(),l=!1,s=t.event.clientX,f=t.event.clientY,n("start"))}}function r(){if(gt(),!l){var n=t.event.clientX-s,e=t.event.clientY-f;l=n*n+e*e>x}_.mouse("drag")}function i(){ct(t.event.view).on("mousemove.drag mouseup.drag",null),yt(t.event.view,l),gt(),_.mouse("end")}function o(){if(p.apply(this,arguments)){var n,e,r=t.event.changedTouches,i=d.apply(this,arguments),o=r.length;for(n=0;n<o;++n)(e=c(r[n].identifier,i,dt,this,arguments))&&(vt(),e("start"))}}function u(){var n,e,r=t.event.changedTouches,i=r.length;for(n=0;n<i;++n)(e=_[r[n].identifier])&&(gt(),e("drag"))}function a(){var n,e,r=t.event.changedTouches,i=r.length;for(h&&clearTimeout(h),h=setTimeout(function(){h=null},500),n=0;n<i;++n)(e=_[r[n].identifier])&&(vt(),e("end"))}function c(e,r,i,o,u){var a,c,s,f=i(r,e),l=y.copy();if(it(new xt(n,"beforestart",a,e,m,f[0],f[1],0,0,l),function(){return null!=(t.event.subject=a=v.apply(o,u))&&(c=a.x-f[0]||0,s=a.y-f[1]||0,!0)}))return function t(h){var p,d=f;switch(h){case"start":_[e]=t,p=m++;break;case"end":delete _[e],--m;case"drag":f=i(r,e),p=m}it(new xt(n,h,a,e,p,f[0]+c,f[1]+s,f[0]-d[0],f[1]-d[1],l),l.apply,l,[h,o,u])}}var s,f,l,h,p=bt,d=wt,v=Mt,g=Tt,_={},y=N("start","drag","end"),m=0,x=0;return n.filter=function(t){return arguments.length?(p="function"==typeof t?t:mt(!!t),n):p},n.container=function(t){return arguments.length?(d="function"==typeof t?t:mt(t),n):d},n.subject=function(t){return arguments.length?(v="function"==typeof t?t:mt(t),n):v},n.touchable=function(t){return arguments.length?(g="function"==typeof t?t:mt(!!t),n):g},n.on=function(){var t=y.on.apply(y,arguments);return t===y?n:t},n.clickDistance=function(t){return arguments.length?(x=(t=+t)*t,n):Math.sqrt(x)},n},t.dragDisable=_t,t.dragEnable=yt,t.dsvFormat=_e,t.csvParse=Eh,t.csvParseRows=Ah,t.csvFormat=Ch,t.csvFormatRows=zh,t.tsvParse=Rh,t.tsvParseRows=Lh,t.tsvFormat=qh,t.tsvFormatRows=Dh,t.easeLinear=function(t){return+t},t.easeQuad=On,t.easeQuadIn=function(t){return t*t},t.easeQuadOut=function(t){return t*(2-t)},t.easeQuadInOut=On,t.easeCubic=Fn,t.easeCubicIn=function(t){return t*t*t},t.easeCubicOut=function(t){return--t*t*t+1},t.easeCubicInOut=Fn,t.easePoly=zl,t.easePolyIn=Al,t.easePolyOut=Cl,t.easePolyInOut=zl,t.easeSin=In,t.easeSinIn=function(t){return 1-Math.cos(t*Rl)},t.easeSinOut=function(t){return Math.sin(t*Rl)},t.easeSinInOut=In,t.easeExp=Yn,t.easeExpIn=function(t){return Math.pow(2,10*t-10)},t.easeExpOut=function(t){return 1-Math.pow(2,-10*t)},t.easeExpInOut=Yn,t.easeCircle=Bn,t.easeCircleIn=function(t){return 1-Math.sqrt(1-t*t)},t.easeCircleOut=function(t){return Math.sqrt(1- --t*t)},t.easeCircleInOut=Bn,t.easeBounce=Hn,t.easeBounceIn=function(t){return 1-Hn(1-t)},t.easeBounceOut=Hn,t.easeBounceInOut=function(t){return((t*=2)<=1?1-Hn(1-t):Hn(t-1)+1)/2},t.easeBack=Vl,t.easeBackIn=jl,t.easeBackOut=Xl,t.easeBackInOut=Vl,t.easeElastic=Zl,t.easeElasticIn=Wl,t.easeElasticOut=Zl,t.easeElasticInOut=Gl,t.forceCenter=function(t,n){function e(){var e,i,o=r.length,u=0,a=0;for(e=0;e<o;++e)u+=(i=r[e]).x,a+=i.y;for(u=u/o-t,a=a/o-n,e=0;e<o;++e)(i=r[e]).x-=u,i.y-=a}var r;return null==t&&(t=0),null==n&&(n=0),e.initialize=function(t){r=t},e.x=function(n){return arguments.length?(t=+n,e):t},e.y=function(t){return arguments.length?(n=+t,e):n},e},t.forceCollide=function(t){function n(){for(var t,n,r,c,s,f,l,h=i.length,p=0;p<a;++p)for(n=Te(i,Se,Ee).visitAfter(e),t=0;t<h;++t)r=i[t],f=o[r.index],l=f*f,c=r.x+r.vx,s=r.y+r.vy,n.visit(function(t,n,e,i,o){var a=t.data,h=t.r,p=f+h;if(!a)return n>c+p||i<c-p||e>s+p||o<s-p;if(a.index>r.index){var d=c-a.x-a.vx,v=s-a.y-a.vy,g=d*d+v*v;g<p*p&&(0===d&&(d=me(),g+=d*d),0===v&&(v=me(),g+=v*v),g=(p-(g=Math.sqrt(g)))/g*u,r.vx+=(d*=g)*(p=(h*=h)/(l+h)),r.vy+=(v*=g)*p,a.vx-=d*(p=1-p),a.vy-=v*p)}})}function e(t){if(t.data)return t.r=o[t.data.index];for(var n=t.r=0;n<4;++n)t[n]&&t[n].r>t.r&&(t.r=t[n].r)}function r(){if(i){var n,e,r=i.length;for(o=new Array(r),n=0;n<r;++n)e=i[n],o[e.index]=+t(e,n,i)}}var i,o,u=1,a=1;return"function"!=typeof t&&(t=ye(null==t?1:+t)),n.initialize=function(t){i=t,r()},n.iterations=function(t){return arguments.length?(a=+t,n):a},n.strength=function(t){return arguments.length?(u=+t,n):u},n.radius=function(e){return arguments.length?(t="function"==typeof e?e:ye(+e),r(),n):t},n},t.forceLink=function(t){function n(n){for(var e=0,r=t.length;e<p;++e)for(var i,a,c,f,l,h,d,v=0;v<r;++v)a=(i=t[v]).source,f=(c=i.target).x+c.vx-a.x-a.vx||me(),l=c.y+c.vy-a.y-a.vy||me(),f*=h=((h=Math.sqrt(f*f+l*l))-u[v])/h*n*o[v],l*=h,c.vx-=f*(d=s[v]),c.vy-=l*d,a.vx+=f*(d=1-d),a.vy+=l*d}function e(){if(a){var n,e,l=a.length,h=t.length,p=se(a,f);for(n=0,c=new Array(l);n<h;++n)(e=t[n]).index=n,"object"!=typeof e.source&&(e.source=Ce(p,e.source)),"object"!=typeof e.target&&(e.target=Ce(p,e.target)),c[e.source.index]=(c[e.source.index]||0)+1,c[e.target.index]=(c[e.target.index]||0)+1;for(n=0,s=new Array(h);n<h;++n)e=t[n],s[n]=c[e.source.index]/(c[e.source.index]+c[e.target.index]);o=new Array(h),r(),u=new Array(h),i()}}function r(){if(a)for(var n=0,e=t.length;n<e;++n)o[n]=+l(t[n],n,t)}function i(){if(a)for(var n=0,e=t.length;n<e;++n)u[n]=+h(t[n],n,t)}var o,u,a,c,s,f=Ae,l=function(t){return 1/Math.min(c[t.source.index],c[t.target.index])},h=ye(30),p=1;return null==t&&(t=[]),n.initialize=function(t){a=t,e()},n.links=function(r){return arguments.length?(t=r,e(),n):t},n.id=function(t){return arguments.length?(f=t,n):f},n.iterations=function(t){return arguments.length?(p=+t,n):p},n.strength=function(t){return arguments.length?(l="function"==typeof t?t:ye(+t),r(),n):l},n.distance=function(t){return arguments.length?(h="function"==typeof t?t:ye(+t),i(),n):h},n},t.forceManyBody=function(){function t(t){var n,a=i.length,c=Te(i,ze,Pe).visitAfter(e);for(u=t,n=0;n<a;++n)o=i[n],c.visit(r)}function n(){if(i){var t,n,e=i.length;for(a=new Array(e),t=0;t<e;++t)n=i[t],a[n.index]=+c(n,t,i)}}function e(t){var n,e,r,i,o,u=0,c=0;if(t.length){for(r=i=o=0;o<4;++o)(n=t[o])&&(e=Math.abs(n.value))&&(u+=n.value,c+=e,r+=e*n.x,i+=e*n.y);t.x=r/c,t.y=i/c}else{(n=t).x=n.data.x,n.y=n.data.y;do{u+=a[n.data.index]}while(n=n.next)}t.value=u}function r(t,n,e,r){if(!t.value)return!0;var i=t.x-o.x,c=t.y-o.y,h=r-n,p=i*i+c*c;if(h*h/l<p)return p<f&&(0===i&&(i=me(),p+=i*i),0===c&&(c=me(),p+=c*c),p<s&&(p=Math.sqrt(s*p)),o.vx+=i*t.value*u/p,o.vy+=c*t.value*u/p),!0;if(!(t.length||p>=f)){(t.data!==o||t.next)&&(0===i&&(i=me(),p+=i*i),0===c&&(c=me(),p+=c*c),p<s&&(p=Math.sqrt(s*p)));do{t.data!==o&&(h=a[t.data.index]*u/p,o.vx+=i*h,o.vy+=c*h)}while(t=t.next)}}var i,o,u,a,c=ye(-30),s=1,f=1/0,l=.81;return t.initialize=function(t){i=t,n()},t.strength=function(e){return arguments.length?(c="function"==typeof e?e:ye(+e),n(),t):c},t.distanceMin=function(n){return arguments.length?(s=n*n,t):Math.sqrt(s)},t.distanceMax=function(n){return arguments.length?(f=n*n,t):Math.sqrt(f)},t.theta=function(n){return arguments.length?(l=n*n,t):Math.sqrt(l)},t},t.forceRadial=function(t,n,e){function r(t){for(var r=0,i=o.length;r<i;++r){var c=o[r],s=c.x-n||1e-6,f=c.y-e||1e-6,l=Math.sqrt(s*s+f*f),h=(a[r]-l)*u[r]*t/l;c.vx+=s*h,c.vy+=f*h}}function i(){if(o){var n,e=o.length;for(u=new Array(e),a=new Array(e),n=0;n<e;++n)a[n]=+t(o[n],n,o),u[n]=isNaN(a[n])?0:+c(o[n],n,o)}}var o,u,a,c=ye(.1);return"function"!=typeof t&&(t=ye(+t)),null==n&&(n=0),null==e&&(e=0),r.initialize=function(t){o=t,i()},r.strength=function(t){return arguments.length?(c="function"==typeof t?t:ye(+t),i(),r):c},r.radius=function(n){return arguments.length?(t="function"==typeof n?n:ye(+n),i(),r):t},r.x=function(t){return arguments.length?(n=+t,r):n},r.y=function(t){return arguments.length?(e=+t,r):e},r},t.forceSimulation=function(t){function n(){e(),p.call("tick",o),u<a&&(h.stop(),p.call("end",o))}function e(){var n,e,r=t.length;for(u+=(s-u)*c,l.each(function(t){t(u)}),n=0;n<r;++n)null==(e=t[n]).fx?e.x+=e.vx*=f:(e.x=e.fx,e.vx=0),null==e.fy?e.y+=e.vy*=f:(e.y=e.fy,e.vy=0)}function r(){for(var n,e=0,r=t.length;e<r;++e){if(n=t[e],n.index=e,isNaN(n.x)||isNaN(n.y)){var i=Fh*Math.sqrt(e),o=e*Ih;n.x=i*Math.cos(o),n.y=i*Math.sin(o)}(isNaN(n.vx)||isNaN(n.vy))&&(n.vx=n.vy=0)}}function i(n){return n.initialize&&n.initialize(t),n}var o,u=1,a=.001,c=1-Math.pow(a,1/300),s=0,f=.6,l=se(),h=wn(n),p=N("tick","end");return null==t&&(t=[]),r(),o={tick:e,restart:function(){return h.restart(n),o},stop:function(){return h.stop(),o},nodes:function(n){return arguments.length?(t=n,r(),l.each(i),o):t},alpha:function(t){return arguments.length?(u=+t,o):u},alphaMin:function(t){return arguments.length?(a=+t,o):a},alphaDecay:function(t){return arguments.length?(c=+t,o):+c},alphaTarget:function(t){return arguments.length?(s=+t,o):s},velocityDecay:function(t){return arguments.length?(f=1-t,o):1-f},force:function(t,n){return arguments.length>1?(null==n?l.remove(t):l.set(t,i(n)),o):l.get(t)},find:function(n,e,r){var i,o,u,a,c,s=0,f=t.length;for(null==r?r=1/0:r*=r,s=0;s<f;++s)(u=(i=n-(a=t[s]).x)*i+(o=e-a.y)*o)<r&&(c=a,r=u);return c},on:function(t,n){return arguments.length>1?(p.on(t,n),o):p.on(t)}}},t.forceX=function(t){function n(t){for(var n,e=0,u=r.length;e<u;++e)(n=r[e]).vx+=(o[e]-n.x)*i[e]*t}function e(){if(r){var n,e=r.length;for(i=new Array(e),o=new Array(e),n=0;n<e;++n)i[n]=isNaN(o[n]=+t(r[n],n,r))?0:+u(r[n],n,r)}}var r,i,o,u=ye(.1);return"function"!=typeof t&&(t=ye(null==t?0:+t)),n.initialize=function(t){r=t,e()},n.strength=function(t){return arguments.length?(u="function"==typeof t?t:ye(+t),e(),n):u},n.x=function(r){return arguments.length?(t="function"==typeof r?r:ye(+r),e(),n):t},n},t.forceY=function(t){function n(t){for(var n,e=0,u=r.length;e<u;++e)(n=r[e]).vy+=(o[e]-n.y)*i[e]*t}function e(){if(r){var n,e=r.length;for(i=new Array(e),o=new Array(e),n=0;n<e;++n)i[n]=isNaN(o[n]=+t(r[n],n,r))?0:+u(r[n],n,r)}}var r,i,o,u=ye(.1);return"function"!=typeof t&&(t=ye(null==t?0:+t)),n.initialize=function(t){r=t,e()},n.strength=function(t){return arguments.length?(u="function"==typeof t?t:ye(+t),e(),n):u},n.y=function(r){return arguments.length?(t="function"==typeof r?r:ye(+r),e(),n):t},n},t.formatDefaultLocale=Ie,t.formatLocale=Fe,t.formatSpecifier=De,t.precisionFixed=Ye,t.precisionPrefix=Be,t.precisionRound=He,t.geoArea=function(t){return Vp.reset(),tr(t,$p),2*Vp},t.geoBounds=function(t){var n,e,r,i,o,u,a;if(Kh=Jh=-(Gh=Qh=1/0),ip=[],tr(t,Zp),e=ip.length){for(ip.sort(xr),n=1,o=[r=ip[0]];n<e;++n)br(r,(i=ip[n])[0])||br(r,i[1])?(mr(r[0],i[1])>mr(r[0],r[1])&&(r[1]=i[1]),mr(i[0],r[1])>mr(r[0],r[1])&&(r[0]=i[0])):o.push(r=i);for(u=-1/0,n=0,r=o[e=o.length-1];n<=e;r=i,++n)i=o[n],(a=mr(r[1],i[0]))>u&&(u=a,Gh=i[0],Jh=r[1])}return ip=op=null,Gh===1/0||Qh===1/0?[[NaN,NaN],[NaN,NaN]]:[[Gh,Qh],[Jh,Kh]]},t.geoCentroid=function(t){up=ap=cp=sp=fp=lp=hp=pp=dp=vp=gp=0,tr(t,Gp);var n=dp,e=vp,r=gp,i=n*n+e*e+r*r;return i<Tp&&(n=lp,e=hp,r=pp,ap<Mp&&(n=cp,e=sp,r=fp),(i=n*n+e*e+r*r)<Tp)?[NaN,NaN]:[Rp(e,n)*Ap,We(r/Yp(i))*Ap]},t.geoCircle=function(){function t(){var t=r.apply(this,arguments),a=i.apply(this,arguments)*Cp,c=o.apply(this,arguments)*Cp;return n=[],e=qr(-t[0]*Cp,-t[1]*Cp,0).invert,Ir(u,a,c,1),t={type:"Polygon",coordinates:[n]},n=e=null,t}var n,e,r=Pr([0,0]),i=Pr(90),o=Pr(6),u={point:function(t,r){n.push(t=e(t,r)),t[0]*=Ap,t[1]*=Ap}};return t.center=function(n){return arguments.length?(r="function"==typeof n?n:Pr([+n[0],+n[1]]),t):r},t.radius=function(n){return arguments.length?(i="function"==typeof n?n:Pr(+n),t):i},t.precision=function(n){return arguments.length?(o="function"==typeof n?n:Pr(+n),t):o},t},t.geoClipAntimeridian=sd,t.geoClipCircle=Qr,t.geoClipExtent=function(){var t,n,e,r=0,i=0,o=960,u=500;return e={stream:function(e){return t&&n===e?t:t=Jr(r,i,o,u)(n=e)},extent:function(a){return arguments.length?(r=+a[0][0],i=+a[0][1],o=+a[1][0],u=+a[1][1],t=n=null,e):[[r,i],[o,u]]}}},t.geoClipRectangle=Jr,t.geoContains=function(t,n){return(t&&gd.hasOwnProperty(t.type)?gd[t.type]:ii)(t,n)},t.geoDistance=ri,t.geoGraticule=hi,t.geoGraticule10=function(){return hi()()},t.geoInterpolate=function(t,n){var e=t[0]*Cp,r=t[1]*Cp,i=n[0]*Cp,o=n[1]*Cp,u=Lp(r),a=Fp(r),c=Lp(o),s=Fp(o),f=u*Lp(e),l=u*Fp(e),h=c*Lp(i),p=c*Fp(i),d=2*We(Yp(Ze(o-r)+u*c*Ze(i-e))),v=Fp(d),g=d?function(t){var n=Fp(t*=d)/v,e=Fp(d-t)/v,r=e*f+n*h,i=e*l+n*p,o=e*a+n*s;return[Rp(i,r)*Ap,Rp(o,Yp(r*r+i*i))*Ap]}:function(){return[e*Ap,r*Ap]};return g.distance=d,g},t.geoLength=ei,t.geoPath=function(t,n){function e(t){return t&&("function"==typeof o&&i.pointRadius(+o.apply(this,arguments)),tr(t,r(i))),i.result()}var r,i,o=4.5;return e.area=function(t){return tr(t,r(xd)),xd.result()},e.measure=function(t){return tr(t,r(Bd)),Bd.result()},e.bounds=function(t){return tr(t,r(Nd)),Nd.result()},e.centroid=function(t){return tr(t,r(qd)),qd.result()},e.projection=function(n){return arguments.length?(r=null==n?(t=null,pi):(t=n).stream,e):t},e.context=function(t){return arguments.length?(i=null==t?(n=null,new Ci):new Si(n=t),"function"!=typeof o&&i.pointRadius(o),e):n},e.pointRadius=function(t){return arguments.length?(o="function"==typeof t?t:(i.pointRadius(+t),+t),e):o},e.projection(t).context(n)},t.geoAlbers=Xi,t.geoAlbersUsa=function(){function t(t){var n=t[0],e=t[1];return a=null,i.point(n,e),a||(o.point(n,e),a)||(u.point(n,e),a)}function n(){return e=r=null,t}var e,r,i,o,u,a,c=Xi(),s=ji().rotate([154,0]).center([-2,58.5]).parallels([55,65]),f=ji().rotate([157,0]).center([-3,19.9]).parallels([8,18]),l={point:function(t,n){a=[t,n]}};return t.invert=function(t){var n=c.scale(),e=c.translate(),r=(t[0]-e[0])/n,i=(t[1]-e[1])/n;return(i>=.12&&i<.234&&r>=-.425&&r<-.214?s:i>=.166&&i<.234&&r>=-.214&&r<-.115?f:c).invert(t)},t.stream=function(t){return e&&r===t?e:e=function(t){var n=t.length;return{point:function(e,r){for(var i=-1;++i<n;)t[i].point(e,r)},sphere:function(){for(var e=-1;++e<n;)t[e].sphere()},lineStart:function(){for(var e=-1;++e<n;)t[e].lineStart()},lineEnd:function(){for(var e=-1;++e<n;)t[e].lineEnd()},polygonStart:function(){for(var e=-1;++e<n;)t[e].polygonStart()},polygonEnd:function(){for(var e=-1;++e<n;)t[e].polygonEnd()}}}([c.stream(r=t),s.stream(t),f.stream(t)])},t.precision=function(t){return arguments.length?(c.precision(t),s.precision(t),f.precision(t),n()):c.precision()},t.scale=function(n){return arguments.length?(c.scale(n),s.scale(.35*n),f.scale(n),t.translate(c.translate())):c.scale()},t.translate=function(t){if(!arguments.length)return c.translate();var e=c.scale(),r=+t[0],a=+t[1];return i=c.translate(t).clipExtent([[r-.455*e,a-.238*e],[r+.455*e,a+.238*e]]).stream(l),o=s.translate([r-.307*e,a+.201*e]).clipExtent([[r-.425*e+Mp,a+.12*e+Mp],[r-.214*e-Mp,a+.234*e-Mp]]).stream(l),u=f.translate([r-.205*e,a+.212*e]).clipExtent([[r-.214*e+Mp,a+.166*e+Mp],[r-.115*e-Mp,a+.234*e-Mp]]).stream(l),n()},t.fitExtent=function(n,e){return qi(t,n,e)},t.fitSize=function(n,e){return Di(t,n,e)},t.fitWidth=function(n,e){return Ui(t,n,e)},t.fitHeight=function(n,e){return Oi(t,n,e)},t.scale(1070)},t.geoAzimuthalEqualArea=function(){return Ii(Vd).scale(124.75).clipAngle(179.999)},t.geoAzimuthalEqualAreaRaw=Vd,t.geoAzimuthalEquidistant=function(){return Ii($d).scale(79.4188).clipAngle(179.999)},t.geoAzimuthalEquidistantRaw=$d,t.geoConicConformal=function(){return Bi(Qi).scale(109.5).parallels([30,30])},t.geoConicConformalRaw=Qi,t.geoConicEqualArea=ji,t.geoConicEqualAreaRaw=Hi,t.geoConicEquidistant=function(){return Bi(Ki).scale(131.154).center([0,13.9389])},t.geoConicEquidistantRaw=Ki,t.geoEquirectangular=function(){return Ii(Ji).scale(152.63)},t.geoEquirectangularRaw=Ji,t.geoGnomonic=function(){return Ii(to).scale(144.049).clipAngle(60)},t.geoGnomonicRaw=to,t.geoIdentity=function(){function t(){return i=o=null,u}var n,e,r,i,o,u,a=1,c=0,s=0,f=1,l=1,h=pi,p=null,d=pi;return u={stream:function(t){return i&&o===t?i:i=h(d(o=t))},postclip:function(i){return arguments.length?(d=i,p=n=e=r=null,t()):d},clipExtent:function(i){return arguments.length?(d=null==i?(p=n=e=r=null,pi):Jr(p=+i[0][0],n=+i[0][1],e=+i[1][0],r=+i[1][1]),t()):null==p?null:[[p,n],[e,r]]},scale:function(n){return arguments.length?(h=no((a=+n)*f,a*l,c,s),t()):a},translate:function(n){return arguments.length?(h=no(a*f,a*l,c=+n[0],s=+n[1]),t()):[c,s]},reflectX:function(n){return arguments.length?(h=no(a*(f=n?-1:1),a*l,c,s),t()):f<0},reflectY:function(n){return arguments.length?(h=no(a*f,a*(l=n?-1:1),c,s),t()):l<0},fitExtent:function(t,n){return qi(u,t,n)},fitSize:function(t,n){return Di(u,t,n)},fitWidth:function(t,n){return Ui(u,t,n)},fitHeight:function(t,n){return Oi(u,t,n)}}},t.geoProjection=Ii,t.geoProjectionMutator=Yi,t.geoMercator=function(){return Zi(Wi).scale(961/Ep)},t.geoMercatorRaw=Wi,t.geoNaturalEarth1=function(){return Ii(eo).scale(175.295)},t.geoNaturalEarth1Raw=eo,t.geoOrthographic=function(){return Ii(ro).scale(249.5).clipAngle(90+Mp)},t.geoOrthographicRaw=ro,t.geoStereographic=function(){return Ii(io).scale(250).clipAngle(142)},t.geoStereographicRaw=io,t.geoTransverseMercator=function(){var t=Zi(oo),n=t.center,e=t.rotate;return t.center=function(t){return arguments.length?n([-t[1],t[0]]):(t=n(),[t[1],-t[0]])},t.rotate=function(t){return arguments.length?e([t[0],t[1],t.length>2?t[2]+90:90]):(t=e(),[t[0],t[1],t[2]-90])},e([0,0,90]).scale(159.155)},t.geoTransverseMercatorRaw=oo,t.geoRotation=Fr,t.geoStream=tr,t.geoTransform=function(t){return{stream:Pi(t)}},t.cluster=function(){function t(t){var o,u=0;t.eachAfter(function(t){var e=t.children;e?(t.x=function(t){return t.reduce(ao,0)/t.length}(e),t.y=function(t){return 1+t.reduce(co,0)}(e)):(t.x=o?u+=n(t,o):0,t.y=0,o=t)});var a=function(t){for(var n;n=t.children;)t=n[0];return t}(t),c=function(t){for(var n;n=t.children;)t=n[n.length-1];return t}(t),s=a.x-n(a,c)/2,f=c.x+n(c,a)/2;return t.eachAfter(i?function(n){n.x=(n.x-t.x)*e,n.y=(t.y-n.y)*r}:function(n){n.x=(n.x-s)/(f-s)*e,n.y=(1-(t.y?n.y/t.y:1))*r})}var n=uo,e=1,r=1,i=!1;return t.separation=function(e){return arguments.length?(n=e,t):n},t.size=function(n){return arguments.length?(i=!1,e=+n[0],r=+n[1],t):i?null:[e,r]},t.nodeSize=function(n){return arguments.length?(i=!0,e=+n[0],r=+n[1],t):i?[e,r]:null},t},t.hierarchy=fo,t.pack=function(){function t(t){return t.x=e/2,t.y=r/2,n?t.eachBefore(zo(n)).eachAfter(Po(i,.5)).eachBefore(Ro(1)):t.eachBefore(zo(Co)).eachAfter(Po(Eo,1)).eachAfter(Po(i,t.r/Math.min(e,r))).eachBefore(Ro(Math.min(e,r)/(2*t.r))),t}var n=null,e=1,r=1,i=Eo;return t.radius=function(e){return arguments.length?(n=function(t){return null==t?null:So(t)}(e),t):n},t.size=function(n){return arguments.length?(e=+n[0],r=+n[1],t):[e,r]},t.padding=function(n){return arguments.length?(i="function"==typeof n?n:Ao(+n),t):i},t},t.packSiblings=function(t){return ko(t),t},t.packEnclose=go,t.partition=function(){function t(t){var o=t.height+1;return t.x0=t.y0=r,t.x1=n,t.y1=e/o,t.eachBefore(function(t,n){return function(e){e.children&&qo(e,e.x0,t*(e.depth+1)/n,e.x1,t*(e.depth+2)/n);var i=e.x0,o=e.y0,u=e.x1-r,a=e.y1-r;u<i&&(i=u=(i+u)/2),a<o&&(o=a=(o+a)/2),e.x0=i,e.y0=o,e.x1=u,e.y1=a}}(e,o)),i&&t.eachBefore(Lo),t}var n=1,e=1,r=0,i=!1;return t.round=function(n){return arguments.length?(i=!!n,t):i},t.size=function(r){return arguments.length?(n=+r[0],e=+r[1],t):[n,e]},t.padding=function(n){return arguments.length?(r=+n,t):r},t},t.stratify=function(){function t(t){var r,i,o,u,a,c,s,f=t.length,l=new Array(f),h={};for(i=0;i<f;++i)r=t[i],a=l[i]=new vo(r),null!=(c=n(r,i,t))&&(c+="")&&(h[s=Zd+(a.id=c)]=s in h?Qd:a);for(i=0;i<f;++i)if(a=l[i],null!=(c=e(t[i],i,t))&&(c+="")){if(!(u=h[Zd+c]))throw new Error("missing: "+c);if(u===Qd)throw new Error("ambiguous: "+c);u.children?u.children.push(a):u.children=[a],a.parent=u}else{if(o)throw new Error("multiple roots");o=a}if(!o)throw new Error("no root");if(o.parent=Gd,o.eachBefore(function(t){t.depth=t.parent.depth+1,--f}).eachBefore(po),o.parent=null,f>0)throw new Error("cycle");return o}var n=Do,e=Uo;return t.id=function(e){return arguments.length?(n=So(e),t):n},t.parentId=function(n){return arguments.length?(e=So(n),t):e},t},t.tree=function(){function t(t){var c=function(t){for(var n,e,r,i,o,u=new Ho(t,0),a=[u];n=a.pop();)if(r=n._.children)for(n.children=new Array(o=r.length),i=o-1;i>=0;--i)a.push(e=n.children[i]=new Ho(r[i],i)),e.parent=n;return(u.parent=new Ho(null,0)).children=[u],u}(t);if(c.eachAfter(n),c.parent.m=-c.z,c.eachBefore(e),a)t.eachBefore(r);else{var s=t,f=t,l=t;t.eachBefore(function(t){t.x<s.x&&(s=t),t.x>f.x&&(f=t),t.depth>l.depth&&(l=t)});var h=s===f?1:i(s,f)/2,p=h-s.x,d=o/(f.x+h+p),v=u/(l.depth||1);t.eachBefore(function(t){t.x=(t.x+p)*d,t.y=t.depth*v})}return t}function n(t){var n=t.children,e=t.parent.children,r=t.i?e[t.i-1]:null;if(n){(function(t){for(var n,e=0,r=0,i=t.children,o=i.length;--o>=0;)(n=i[o]).z+=e,n.m+=e,e+=n.s+(r+=n.c)})(t);var o=(n[0].z+n[n.length-1].z)/2;r?(t.z=r.z+i(t._,r._),t.m=t.z-o):t.z=o}else r&&(t.z=r.z+i(t._,r._));t.parent.A=function(t,n,e){if(n){for(var r,o=t,u=t,a=n,c=o.parent.children[0],s=o.m,f=u.m,l=a.m,h=c.m;a=Io(a),o=Fo(o),a&&o;)c=Fo(c),(u=Io(u)).a=t,(r=a.z+l-o.z-s+i(a._,o._))>0&&(Yo(Bo(a,t,e),t,r),s+=r,f+=r),l+=a.m,s+=o.m,h+=c.m,f+=u.m;a&&!Io(u)&&(u.t=a,u.m+=l-f),o&&!Fo(c)&&(c.t=o,c.m+=s-h,e=t)}return e}(t,r,t.parent.A||e[0])}function e(t){t._.x=t.z+t.parent.m,t.m+=t.parent.m}function r(t){t.x*=o,t.y=t.depth*u}var i=Oo,o=1,u=1,a=null;return t.separation=function(n){return arguments.length?(i=n,t):i},t.size=function(n){return arguments.length?(a=!1,o=+n[0],u=+n[1],t):a?null:[o,u]},t.nodeSize=function(n){return arguments.length?(a=!0,o=+n[0],u=+n[1],t):a?[o,u]:null},t},t.treemap=function(){function t(t){return t.x0=t.y0=0,t.x1=i,t.y1=o,t.eachBefore(n),u=[0],r&&t.eachBefore(Lo),t}function n(t){var n=u[t.depth],r=t.x0+n,i=t.y0+n,o=t.x1-n,h=t.y1-n;o<r&&(r=o=(r+o)/2),h<i&&(i=h=(i+h)/2),t.x0=r,t.y0=i,t.x1=o,t.y1=h,t.children&&(n=u[t.depth+1]=a(t)/2,r+=l(t)-n,i+=c(t)-n,o-=s(t)-n,h-=f(t)-n,o<r&&(r=o=(r+o)/2),h<i&&(i=h=(i+h)/2),e(t,r,i,o,h))}var e=Kd,r=!1,i=1,o=1,u=[0],a=Eo,c=Eo,s=Eo,f=Eo,l=Eo;return t.round=function(n){return arguments.length?(r=!!n,t):r},t.size=function(n){return arguments.length?(i=+n[0],o=+n[1],t):[i,o]},t.tile=function(n){return arguments.length?(e=So(n),t):e},t.padding=function(n){return arguments.length?t.paddingInner(n).paddingOuter(n):t.paddingInner()},t.paddingInner=function(n){return arguments.length?(a="function"==typeof n?n:Ao(+n),t):a},t.paddingOuter=function(n){return arguments.length?t.paddingTop(n).paddingRight(n).paddingBottom(n).paddingLeft(n):t.paddingTop()},t.paddingTop=function(n){return arguments.length?(c="function"==typeof n?n:Ao(+n),t):c},t.paddingRight=function(n){return arguments.length?(s="function"==typeof n?n:Ao(+n),t):s},t.paddingBottom=function(n){return arguments.length?(f="function"==typeof n?n:Ao(+n),t):f},t.paddingLeft=function(n){return arguments.length?(l="function"==typeof n?n:Ao(+n),t):l},t},t.treemapBinary=function(t,n,e,r,i){function o(t,n,e,r,i,u,a){if(t>=n-1){var s=c[t];return s.x0=r,s.y0=i,s.x1=u,void(s.y1=a)}for(var l=f[t],h=e/2+l,p=t+1,d=n-1;p<d;){var v=p+d>>>1;f[v]<h?p=v+1:d=v}h-f[p-1]<f[p]-h&&t+1<p&&--p;var g=f[p]-l,_=e-g;if(u-r>a-i){var y=(r*_+u*g)/e;o(t,p,g,r,i,y,a),o(p,n,_,y,i,u,a)}else{var m=(i*_+a*g)/e;o(t,p,g,r,i,u,m),o(p,n,_,r,m,u,a)}}var u,a,c=t.children,s=c.length,f=new Array(s+1);for(f[0]=a=u=0;u<s;++u)f[u+1]=a+=c[u].value;o(0,s,t.value,n,e,r,i)},t.treemapDice=qo,t.treemapSlice=jo,t.treemapSliceDice=function(t,n,e,r,i){(1&t.depth?jo:qo)(t,n,e,r,i)},t.treemapSquarify=Kd,t.treemapResquarify=tv,t.interpolate=fn,t.interpolateArray=on,t.interpolateBasis=Gt,t.interpolateBasisClosed=Qt,t.interpolateDate=un,t.interpolateNumber=an,t.interpolateObject=cn,t.interpolateRound=ln,t.interpolateString=sn,t.interpolateTransformCss=Gf,t.interpolateTransformSvg=Qf,t.interpolateZoom=vn,t.interpolateRgb=Hf,t.interpolateRgbBasis=jf,t.interpolateRgbBasisClosed=Xf,t.interpolateHsl=el,t.interpolateHslLong=rl,t.interpolateLab=function(t,n){var e=en((t=Ft(t)).l,(n=Ft(n)).l),r=en(t.a,n.a),i=en(t.b,n.b),o=en(t.opacity,n.opacity);return function(n){return t.l=e(n),t.a=r(n),t.b=i(n),t.opacity=o(n),t+""}},t.interpolateHcl=il,t.interpolateHclLong=ol,t.interpolateCubehelix=ul,t.interpolateCubehelixLong=al,t.quantize=function(t,n){for(var e=new Array(n),r=0;r<n;++r)e[r]=t(r/(n-1));return e},t.path=ee,t.polygonArea=function(t){for(var n,e=-1,r=t.length,i=t[r-1],o=0;++e<r;)n=i,i=t[e],o+=n[1]*i[0]-n[0]*i[1];return o/2},t.polygonCentroid=function(t){for(var n,e,r=-1,i=t.length,o=0,u=0,a=t[i-1],c=0;++r<i;)n=a,a=t[r],c+=e=n[0]*a[1]-a[0]*n[1],o+=(n[0]+a[0])*e,u+=(n[1]+a[1])*e;return c*=3,[o/c,u/c]},t.polygonHull=function(t){if((e=t.length)<3)return null;var n,e,r=new Array(e),i=new Array(e);for(n=0;n<e;++n)r[n]=[+t[n][0],+t[n][1],n];for(r.sort($o),n=0;n<e;++n)i[n]=[r[n][0],-r[n][1]];var o=Wo(r),u=Wo(i),a=u[0]===o[0],c=u[u.length-1]===o[o.length-1],s=[];for(n=o.length-1;n>=0;--n)s.push(t[r[o[n]][2]]);for(n=+a;n<u.length-c;++n)s.push(t[r[u[n]][2]]);return s},t.polygonContains=function(t,n){for(var e,r,i=t.length,o=t[i-1],u=n[0],a=n[1],c=o[0],s=o[1],f=!1,l=0;l<i;++l)e=(o=t[l])[0],(r=o[1])>a!=s>a&&u<(c-e)*(a-r)/(s-r)+e&&(f=!f),c=e,s=r;return f},t.polygonLength=function(t){for(var n,e,r=-1,i=t.length,o=t[i-1],u=o[0],a=o[1],c=0;++r<i;)n=u,e=a,n-=u=(o=t[r])[0],e-=a=o[1],c+=Math.sqrt(n*n+e*e);return c},t.quadtree=Te,t.queue=Ko,t.randomUniform=rv,t.randomNormal=iv,t.randomLogNormal=ov,t.randomBates=av,t.randomIrwinHall=uv,t.randomExponential=cv,t.request=nu,t.html=sv,t.json=fv,t.text=lv,t.xml=hv,t.csv=pv,t.tsv=dv,t.scaleBand=ou,t.scalePoint=function(){return uu(ou().paddingInner(1))},t.scaleIdentity=gu,t.scaleLinear=vu,t.scaleLog=Tu,t.scaleOrdinal=iu,t.scaleImplicit=yv,t.scalePow=ku,t.scaleSqrt=function(){return ku().exponent(.5)},t.scaleQuantile=Su,t.scaleQuantize=Eu,t.scaleThreshold=Au,t.scaleTime=function(){return Va(Gv,Wv,Lv,Pv,Cv,Ev,kv,wv,t.timeFormat).domain([new Date(2e3,0,1),new Date(2e3,0,2)])},t.scaleUtc=function(){return Va(xg,yg,ig,eg,tg,Jv,kv,wv,t.utcFormat).domain([Date.UTC(2e3,0,1),Date.UTC(2e3,0,2)])},t.schemeCategory10=Ug,t.schemeCategory20b=Og,t.schemeCategory20c=Fg,t.schemeCategory20=Ig,t.interpolateCubehelixDefault=Yg,t.interpolateRainbow=function(t){(t<0||t>1)&&(t-=Math.floor(t));var n=Math.abs(t-.5);return jg.h=360*t-100,jg.s=1.5-1.5*n,jg.l=.8-.9*n,jg+""},t.interpolateWarm=Bg,t.interpolateCool=Hg,t.interpolateViridis=Xg,t.interpolateMagma=Vg,t.interpolateInferno=$g,t.interpolatePlasma=Wg,t.scaleSequential=Za,t.create=function(t){return ct(A(t).call(document.documentElement))},t.creator=A,t.local=st,t.matcher=of,t.mouse=pt,t.namespace=E,t.namespaces=tf,t.clientPoint=ht,t.select=ct,t.selectAll=function(t){return"string"==typeof t?new ut([document.querySelectorAll(t)],[document.documentElement]):new ut([null==t?[]:t],cf)},t.selection=at,t.selector=z,t.selectorAll=R,t.style=I,t.touch=dt,t.touches=function(t,n){null==n&&(n=lt().touches);for(var e=0,r=n?n.length:0,i=new Array(r);e<r;++e)i[e]=ht(t,n[e]);return i},t.window=F,t.customEvent=it,t.arc=function(){function t(){var t,s,f=+n.apply(this,arguments),l=+e.apply(this,arguments),h=o.apply(this,arguments)-i_,p=u.apply(this,arguments)-i_,d=Zg(p-h),v=p>h;if(c||(c=t=ee()),l<f&&(s=l,l=f,f=s),l>e_)if(d>o_-e_)c.moveTo(l*Qg(h),l*t_(h)),c.arc(0,0,l,h,p,!v),f>e_&&(c.moveTo(f*Qg(p),f*t_(p)),c.arc(0,0,f,p,h,v));else{var g,_,y=h,m=p,x=h,b=p,w=d,M=d,T=a.apply(this,arguments)/2,N=T>e_&&(i?+i.apply(this,arguments):n_(f*f+l*l)),k=Kg(Zg(l-f)/2,+r.apply(this,arguments)),S=k,E=k;if(N>e_){var A=Qa(N/f*t_(T)),C=Qa(N/l*t_(T));(w-=2*A)>e_?(A*=v?1:-1,x+=A,b-=A):(w=0,x=b=(h+p)/2),(M-=2*C)>e_?(C*=v?1:-1,y+=C,m-=C):(M=0,y=m=(h+p)/2)}var z=l*Qg(y),P=l*t_(y),R=f*Qg(b),L=f*t_(b);if(k>e_){var q=l*Qg(m),D=l*t_(m),U=f*Qg(x),O=f*t_(x);if(d<r_){var F=w>e_?function(t,n,e,r,i,o,u,a){var c=e-t,s=r-n,f=u-i,l=a-o,h=(f*(n-o)-l*(t-i))/(l*c-f*s);return[t+h*c,n+h*s]}(z,P,U,O,q,D,R,L):[R,L],I=z-F[0],Y=P-F[1],B=q-F[0],H=D-F[1],j=1/t_(function(t){return t>1?0:t<-1?r_:Math.acos(t)}((I*B+Y*H)/(n_(I*I+Y*Y)*n_(B*B+H*H)))/2),X=n_(F[0]*F[0]+F[1]*F[1]);S=Kg(k,(f-X)/(j-1)),E=Kg(k,(l-X)/(j+1))}}M>e_?E>e_?(g=rc(U,O,z,P,l,E,v),_=rc(q,D,R,L,l,E,v),c.moveTo(g.cx+g.x01,g.cy+g.y01),E<k?c.arc(g.cx,g.cy,E,Gg(g.y01,g.x01),Gg(_.y01,_.x01),!v):(c.arc(g.cx,g.cy,E,Gg(g.y01,g.x01),Gg(g.y11,g.x11),!v),c.arc(0,0,l,Gg(g.cy+g.y11,g.cx+g.x11),Gg(_.cy+_.y11,_.cx+_.x11),!v),c.arc(_.cx,_.cy,E,Gg(_.y11,_.x11),Gg(_.y01,_.x01),!v))):(c.moveTo(z,P),c.arc(0,0,l,y,m,!v)):c.moveTo(z,P),f>e_&&w>e_?S>e_?(g=rc(R,L,q,D,f,-S,v),_=rc(z,P,U,O,f,-S,v),c.lineTo(g.cx+g.x01,g.cy+g.y01),S<k?c.arc(g.cx,g.cy,S,Gg(g.y01,g.x01),Gg(_.y01,_.x01),!v):(c.arc(g.cx,g.cy,S,Gg(g.y01,g.x01),Gg(g.y11,g.x11),!v),c.arc(0,0,f,Gg(g.cy+g.y11,g.cx+g.x11),Gg(_.cy+_.y11,_.cx+_.x11),v),c.arc(_.cx,_.cy,S,Gg(_.y11,_.x11),Gg(_.y01,_.x01),!v))):c.arc(0,0,f,b,x,v):c.lineTo(R,L)}else c.moveTo(0,0);if(c.closePath(),t)return c=null,t+""||null}var n=Ja,e=Ka,r=Ga(0),i=null,o=tc,u=nc,a=ec,c=null;return t.centroid=function(){var t=(+n.apply(this,arguments)+ +e.apply(this,arguments))/2,r=(+o.apply(this,arguments)+ +u.apply(this,arguments))/2-r_/2;return[Qg(r)*t,t_(r)*t]},t.innerRadius=function(e){return arguments.length?(n="function"==typeof e?e:Ga(+e),t):n},t.outerRadius=function(n){return arguments.length?(e="function"==typeof n?n:Ga(+n),t):e},t.cornerRadius=function(n){return arguments.length?(r="function"==typeof n?n:Ga(+n),t):r},t.padRadius=function(n){return arguments.length?(i=null==n?null:"function"==typeof n?n:Ga(+n),t):i},t.startAngle=function(n){return arguments.length?(o="function"==typeof n?n:Ga(+n),t):o},t.endAngle=function(n){return arguments.length?(u="function"==typeof n?n:Ga(+n),t):u},t.padAngle=function(n){return arguments.length?(a="function"==typeof n?n:Ga(+n),t):a},t.context=function(n){return arguments.length?(c=null==n?null:n,t):c},t},t.area=sc,t.line=cc,t.pie=function(){function t(t){var a,c,s,f,l,h=t.length,p=0,d=new Array(h),v=new Array(h),g=+i.apply(this,arguments),_=Math.min(o_,Math.max(-o_,o.apply(this,arguments)-g)),y=Math.min(Math.abs(_)/h,u.apply(this,arguments)),m=y*(_<0?-1:1);for(a=0;a<h;++a)(l=v[d[a]=a]=+n(t[a],a,t))>0&&(p+=l);for(null!=e?d.sort(function(t,n){return e(v[t],v[n])}):null!=r&&d.sort(function(n,e){return r(t[n],t[e])}),a=0,s=p?(_-h*m)/p:0;a<h;++a,g=f)c=d[a],f=g+((l=v[c])>0?l*s:0)+m,v[c]={data:t[c],index:a,value:l,startAngle:g,endAngle:f,padAngle:y};return v}var n=lc,e=fc,r=null,i=Ga(0),o=Ga(o_),u=Ga(0);return t.value=function(e){return arguments.length?(n="function"==typeof e?e:Ga(+e),t):n},t.sortValues=function(n){return arguments.length?(e=n,r=null,t):e},t.sort=function(n){return arguments.length?(r=n,e=null,t):r},t.startAngle=function(n){return arguments.length?(i="function"==typeof n?n:Ga(+n),t):i},t.endAngle=function(n){return arguments.length?(o="function"==typeof n?n:Ga(+n),t):o},t.padAngle=function(n){return arguments.length?(u="function"==typeof n?n:Ga(+n),t):u},t},t.areaRadial=gc,t.radialArea=gc,t.lineRadial=vc,t.radialLine=vc,t.pointRadial=_c,t.linkHorizontal=function(){return xc(bc)},t.linkVertical=function(){return xc(wc)},t.linkRadial=function(){var t=xc(Mc);return t.angle=t.x,delete t.x,t.radius=t.y,delete t.y,t},t.symbol=function(){function t(){var t;if(r||(r=t=ee()),n.apply(this,arguments).draw(r,+e.apply(this,arguments)),t)return r=null,t+""||null}var n=Ga(c_),e=Ga(64),r=null;return t.type=function(e){return arguments.length?(n="function"==typeof e?e:Ga(e),t):n},t.size=function(n){return arguments.length?(e="function"==typeof n?n:Ga(+n),t):e},t.context=function(n){return arguments.length?(r=null==n?null:n,t):r},t},t.symbols=T_,t.symbolCircle=c_,t.symbolCross=s_,t.symbolDiamond=h_,t.symbolSquare=__,t.symbolStar=g_,t.symbolTriangle=m_,t.symbolWye=M_,t.curveBasisClosed=function(t){return new Sc(t)},t.curveBasisOpen=function(t){return new Ec(t)},t.curveBasis=function(t){return new kc(t)},t.curveBundle=N_,t.curveCardinalClosed=S_,t.curveCardinalOpen=E_,t.curveCardinal=k_,t.curveCatmullRomClosed=C_,t.curveCatmullRomOpen=z_,t.curveCatmullRom=A_,t.curveLinearClosed=function(t){return new Oc(t)},t.curveLinear=oc,t.curveMonotoneX=function(t){return new Hc(t)},t.curveMonotoneY=function(t){return new jc(t)},t.curveNatural=function(t){return new Vc(t)},t.curveStep=function(t){return new Wc(t,.5)},t.curveStepAfter=function(t){return new Wc(t,1)},t.curveStepBefore=function(t){return new Wc(t,0)},t.stack=function(){function t(t){var o,u,a=n.apply(this,arguments),c=t.length,s=a.length,f=new Array(s);for(o=0;o<s;++o){for(var l,h=a[o],p=f[o]=new Array(c),d=0;d<c;++d)p[d]=l=[0,+i(t[d],h,d,t)],l.data=t[d];p.key=h}for(o=0,u=e(f);o<s;++o)f[u[o]].index=o;return r(f,u),f}var n=Ga([]),e=Gc,r=Zc,i=Qc;return t.keys=function(e){return arguments.length?(n="function"==typeof e?e:Ga(a_.call(e)),t):n},t.value=function(n){return arguments.length?(i="function"==typeof n?n:Ga(+n),t):i},t.order=function(n){return arguments.length?(e=null==n?Gc:"function"==typeof n?n:Ga(a_.call(n)),t):e},t.offset=function(n){return arguments.length?(r=null==n?Zc:n,t):r},t},t.stackOffsetExpand=function(t,n){if((r=t.length)>0){for(var e,r,i,o=0,u=t[0].length;o<u;++o){for(i=e=0;e<r;++e)i+=t[e][o][1]||0;if(i)for(e=0;e<r;++e)t[e][o][1]/=i}Zc(t,n)}},t.stackOffsetDiverging=function(t,n){if((a=t.length)>1)for(var e,r,i,o,u,a,c=0,s=t[n[0]].length;c<s;++c)for(o=u=0,e=0;e<a;++e)(i=(r=t[n[e]][c])[1]-r[0])>=0?(r[0]=o,r[1]=o+=i):i<0?(r[1]=u,r[0]=u+=i):r[0]=o},t.stackOffsetNone=Zc,t.stackOffsetSilhouette=function(t,n){if((e=t.length)>0){for(var e,r=0,i=t[n[0]],o=i.length;r<o;++r){for(var u=0,a=0;u<e;++u)a+=t[u][r][1]||0;i[r][1]+=i[r][0]=-a/2}Zc(t,n)}},t.stackOffsetWiggle=function(t,n){if((i=t.length)>0&&(r=(e=t[n[0]]).length)>0){for(var e,r,i,o=0,u=1;u<r;++u){for(var a=0,c=0,s=0;a<i;++a){for(var f=t[n[a]],l=f[u][1]||0,h=(l-(f[u-1][1]||0))/2,p=0;p<a;++p){var d=t[n[p]];h+=(d[u][1]||0)-(d[u-1][1]||0)}c+=l,s+=h*l}e[u-1][1]+=e[u-1][0]=o,c&&(o-=s/c)}e[u-1][1]+=e[u-1][0]=o,Zc(t,n)}},t.stackOrderAscending=Jc,t.stackOrderDescending=function(t){return Jc(t).reverse()},t.stackOrderInsideOut=function(t){var n,e,r=t.length,i=t.map(Kc),o=Gc(t).sort(function(t,n){return i[n]-i[t]}),u=0,a=0,c=[],s=[];for(n=0;n<r;++n)e=o[n],u<a?(u+=i[e],c.push(e)):(a+=i[e],s.push(e));return s.reverse().concat(c)},t.stackOrderNone=Gc,t.stackOrderReverse=function(t){return Gc(t).reverse()},t.timeInterval=Cu,t.timeMillisecond=wv,t.timeMilliseconds=Mv,t.utcMillisecond=wv,t.utcMilliseconds=Mv,t.timeSecond=kv,t.timeSeconds=Sv,t.utcSecond=kv,t.utcSeconds=Sv,t.timeMinute=Ev,t.timeMinutes=Av,t.timeHour=Cv,t.timeHours=zv,t.timeDay=Pv,t.timeDays=Rv,t.timeWeek=Lv,t.timeWeeks=Yv,t.timeSunday=Lv,t.timeSundays=Yv,t.timeMonday=qv,t.timeMondays=Bv,t.timeTuesday=Dv,t.timeTuesdays=Hv,t.timeWednesday=Uv,t.timeWednesdays=jv,t.timeThursday=Ov,t.timeThursdays=Xv,t.timeFriday=Fv,t.timeFridays=Vv,t.timeSaturday=Iv,t.timeSaturdays=$v,t.timeMonth=Wv,t.timeMonths=Zv,t.timeYear=Gv,t.timeYears=Qv,t.utcMinute=Jv,t.utcMinutes=Kv,t.utcHour=tg,t.utcHours=ng,t.utcDay=eg,t.utcDays=rg,t.utcWeek=ig,t.utcWeeks=lg,t.utcSunday=ig,t.utcSundays=lg,t.utcMonday=og,t.utcMondays=hg,t.utcTuesday=ug,t.utcTuesdays=pg,t.utcWednesday=ag,t.utcWednesdays=dg,t.utcThursday=cg,t.utcThursdays=vg,t.utcFriday=sg,t.utcFridays=gg,t.utcSaturday=fg,t.utcSaturdays=_g,t.utcMonth=yg,t.utcMonths=mg,t.utcYear=xg,t.utcYears=wg,t.timeFormatDefaultLocale=Ha,t.timeFormatLocale=Du,t.isoFormat=Eg,t.isoParse=Ag,t.now=mn,t.timer=wn,t.timerFlush=Mn,t.timeout=Sn,t.interval=function(t,n,e){var r=new bn,i=n;return null==n?(r.restart(t,n,e),r):(n=+n,e=null==e?mn():+e,r.restart(function o(u){u+=i,r.restart(o,i+=n,e),t(u)},n,e),r)},t.transition=Dn,t.active=function(t,n){var e,r,i=t.__transition;if(i){n=null==n?null:n+"";for(r in i)if((e=i[r]).state>xl&&e.name===n)return new qn([[t]],Jl,n,+r)}return null},t.interrupt=Pn,t.voronoi=function(){function t(t){return new Ns(t.map(function(r,i){var o=[Math.round(n(r,i,t)/F_)*F_,Math.round(e(r,i,t)/F_)*F_];return o.index=i,o.data=r,o}),r)}var n=ns,e=es,r=null;return t.polygons=function(n){return t(n).polygons()},t.links=function(n){return t(n).links()},t.triangles=function(n){return t(n).triangles()},t.x=function(e){return arguments.length?(n="function"==typeof e?e:ts(+e),t):n},t.y=function(n){return arguments.length?(e="function"==typeof n?n:ts(+n),t):e},t.extent=function(n){return arguments.length?(r=null==n?null:[[+n[0][0],+n[0][1]],[+n[1][0],+n[1][1]]],t):r&&[[r[0][0],r[0][1]],[r[1][0],r[1][1]]]},t.size=function(n){return arguments.length?(r=null==n?null:[[0,0],[+n[0],+n[1]]],t):r&&[r[1][0]-r[0][0],r[1][1]-r[0][1]]},t},t.zoom=function(){function n(t){t.property("__zoom",Rs).on("wheel.zoom",c).on("mousedown.zoom",s).on("dblclick.zoom",f).filter(x).on("touchstart.zoom",l).on("touchmove.zoom",h).on("touchend.zoom touchcancel.zoom",p).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function e(t,n){return(n=Math.max(b[0],Math.min(b[1],n)))===t.k?t:new Ss(n,t.x,t.y)}function r(t,n,e){var r=n[0]-e[0]*t.k,i=n[1]-e[1]*t.k;return r===t.x&&i===t.y?t:new Ss(t.k,r,i)}function i(t){return[(+t[0][0]+ +t[1][0])/2,(+t[0][1]+ +t[1][1])/2]}function o(t,n,e){t.on("start.zoom",function(){u(this,arguments).start()}).on("interrupt.zoom end.zoom",function(){u(this,arguments).end()}).tween("zoom",function(){var t=arguments,r=u(this,t),o=_.apply(this,t),a=e||i(o),c=Math.max(o[1][0]-o[0][0],o[1][1]-o[0][1]),s=this.__zoom,f="function"==typeof n?n.apply(this,t):n,l=T(s.invert(a).concat(c/s.k),f.invert(a).concat(c/f.k));return function(t){if(1===t)t=f;else{var n=l(t),e=c/n[2];t=new Ss(e,a[0]-n[0]*e,a[1]-n[1]*e)}r.zoom(null,t)}})}function u(t,n){for(var e,r=0,i=k.length;r<i;++r)if((e=k[r]).that===t)return e;return new a(t,n)}function a(t,n){this.that=t,this.args=n,this.index=-1,this.active=0,this.extent=_.apply(t,n)}function c(){if(g.apply(this,arguments)){var t=u(this,arguments),n=this.__zoom,i=Math.max(b[0],Math.min(b[1],n.k*Math.pow(2,m.apply(this,arguments)))),o=pt(this);if(t.wheel)t.mouse[0][0]===o[0]&&t.mouse[0][1]===o[1]||(t.mouse[1]=n.invert(t.mouse[0]=o)),clearTimeout(t.wheel);else{if(n.k===i)return;t.mouse=[o,n.invert(o)],Pn(this),t.start()}Cs(),t.wheel=setTimeout(function(){t.wheel=null,t.end()},A),t.zoom("mouse",y(r(e(n,i),t.mouse[0],t.mouse[1]),t.extent,w))}}function s(){if(!v&&g.apply(this,arguments)){var n=u(this,arguments),e=ct(t.event.view).on("mousemove.zoom",function(){if(Cs(),!n.moved){var e=t.event.clientX-o,i=t.event.clientY-a;n.moved=e*e+i*i>C}n.zoom("mouse",y(r(n.that.__zoom,n.mouse[0]=pt(n.that),n.mouse[1]),n.extent,w))},!0).on("mouseup.zoom",function(){e.on("mousemove.zoom mouseup.zoom",null),yt(t.event.view,n.moved),Cs(),n.end()},!0),i=pt(this),o=t.event.clientX,a=t.event.clientY;_t(t.event.view),As(),n.mouse=[i,this.__zoom.invert(i)],Pn(this),n.start()}}function f(){if(g.apply(this,arguments)){var i=this.__zoom,u=pt(this),a=i.invert(u),c=i.k*(t.event.shiftKey?.5:2),s=y(r(e(i,c),u,a),_.apply(this,arguments),w);Cs(),M>0?ct(this).transition().duration(M).call(o,s,u):ct(this).call(n.transform,s)}}function l(){if(g.apply(this,arguments)){var n,e,r,i,o=u(this,arguments),a=t.event.changedTouches,c=a.length;for(As(),e=0;e<c;++e)i=[i=dt(this,a,(r=a[e]).identifier),this.__zoom.invert(i),r.identifier],o.touch0?o.touch1||(o.touch1=i):(o.touch0=i,n=!0);if(d&&(d=clearTimeout(d),!o.touch1))return o.end(),void((i=ct(this).on("dblclick.zoom"))&&i.apply(this,arguments));n&&(d=setTimeout(function(){d=null},E),Pn(this),o.start())}}function h(){var n,i,o,a,c=u(this,arguments),s=t.event.changedTouches,f=s.length;for(Cs(),d&&(d=clearTimeout(d)),n=0;n<f;++n)o=dt(this,s,(i=s[n]).identifier),c.touch0&&c.touch0[2]===i.identifier?c.touch0[0]=o:c.touch1&&c.touch1[2]===i.identifier&&(c.touch1[0]=o);if(i=c.that.__zoom,c.touch1){var l=c.touch0[0],h=c.touch0[1],p=c.touch1[0],v=c.touch1[1],g=(g=p[0]-l[0])*g+(g=p[1]-l[1])*g,_=(_=v[0]-h[0])*_+(_=v[1]-h[1])*_;i=e(i,Math.sqrt(g/_)),o=[(l[0]+p[0])/2,(l[1]+p[1])/2],a=[(h[0]+v[0])/2,(h[1]+v[1])/2]}else{if(!c.touch0)return;o=c.touch0[0],a=c.touch0[1]}c.zoom("touch",y(r(i,o,a),c.extent,w))}function p(){var n,e,r=u(this,arguments),i=t.event.changedTouches,o=i.length;for(As(),v&&clearTimeout(v),v=setTimeout(function(){v=null},E),n=0;n<o;++n)e=i[n],r.touch0&&r.touch0[2]===e.identifier?delete r.touch0:r.touch1&&r.touch1[2]===e.identifier&&delete r.touch1;r.touch1&&!r.touch0&&(r.touch0=r.touch1,delete r.touch1),r.touch0?r.touch0[1]=this.__zoom.invert(r.touch0[0]):r.end()}var d,v,g=zs,_=Ps,y=Ds,m=Ls,x=qs,b=[0,1/0],w=[[-1/0,-1/0],[1/0,1/0]],M=250,T=vn,k=[],S=N("start","zoom","end"),E=500,A=150,C=0;return n.transform=function(t,n){var e=t.selection?t.selection():t;e.property("__zoom",Rs),t!==e?o(t,n):e.interrupt().each(function(){u(this,arguments).start().zoom(null,"function"==typeof n?n.apply(this,arguments):n).end()})},n.scaleBy=function(t,e){n.scaleTo(t,function(){return this.__zoom.k*("function"==typeof e?e.apply(this,arguments):e)})},n.scaleTo=function(t,o){n.transform(t,function(){var t=_.apply(this,arguments),n=this.__zoom,u=i(t),a=n.invert(u),c="function"==typeof o?o.apply(this,arguments):o;return y(r(e(n,c),u,a),t,w)})},n.translateBy=function(t,e,r){n.transform(t,function(){return y(this.__zoom.translate("function"==typeof e?e.apply(this,arguments):e,"function"==typeof r?r.apply(this,arguments):r),_.apply(this,arguments),w)})},n.translateTo=function(t,e,r){n.transform(t,function(){var t=_.apply(this,arguments),n=this.__zoom,o=i(t);return y(Y_.translate(o[0],o[1]).scale(n.k).translate("function"==typeof e?-e.apply(this,arguments):-e,"function"==typeof r?-r.apply(this,arguments):-r),t,w)})},a.prototype={start:function(){return 1==++this.active&&(this.index=k.push(this)-1,this.emit("start")),this},zoom:function(t,n){return this.mouse&&"mouse"!==t&&(this.mouse[1]=n.invert(this.mouse[0])),this.touch0&&"touch"!==t&&(this.touch0[1]=n.invert(this.touch0[0])),this.touch1&&"touch"!==t&&(this.touch1[1]=n.invert(this.touch1[0])),this.that.__zoom=n,this.emit("zoom"),this},end:function(){return 0==--this.active&&(k.splice(this.index,1),this.index=-1,this.emit("end")),this},emit:function(t){it(new function(t,n,e){this.target=t,this.type=n,this.transform=e}(n,t,this.that.__zoom),S.apply,S,[t,this.that,this.args])}},n.wheelDelta=function(t){return arguments.length?(m="function"==typeof t?t:ks(+t),n):m},n.filter=function(t){return arguments.length?(g="function"==typeof t?t:ks(!!t),n):g},n.touchable=function(t){return arguments.length?(x="function"==typeof t?t:ks(!!t),n):x},n.extent=function(t){return arguments.length?(_="function"==typeof t?t:ks([[+t[0][0],+t[0][1]],[+t[1][0],+t[1][1]]]),n):_},n.scaleExtent=function(t){return arguments.length?(b[0]=+t[0],b[1]=+t[1],n):[b[0],b[1]]},n.translateExtent=function(t){return arguments.length?(w[0][0]=+t[0][0],w[1][0]=+t[1][0],w[0][1]=+t[0][1],w[1][1]=+t[1][1],n):[[w[0][0],w[0][1]],[w[1][0],w[1][1]]]},n.constrain=function(t){return arguments.length?(y=t,n):y},n.duration=function(t){return arguments.length?(M=+t,n):M},n.interpolate=function(t){return arguments.length?(T=t,n):T},n.on=function(){var t=S.on.apply(S,arguments);return t===S?n:t},n.clickDistance=function(t){return arguments.length?(C=(t=+t)*t,n):Math.sqrt(C)},n},t.zoomTransform=Es,t.zoomIdentity=Y_,Object.defineProperty(t,"__esModule",{value:!0})});

=== app/static/js/mpld3.min.js ===
function mpld3_cloneObj(t){var e={};for(var i in t)e[i]=t[i];return e}function mpld3_generateId(t,e){t="undefined"!=typeof t?t:10,e="undefined"!=typeof e?e:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(var i=e.charAt(Math.round(Math.random()*(e.length-11))),s=1;t>s;s++)i+=e.charAt(Math.round(Math.random()*(e.length-1)));return i}function mpld3_interpolateDates(t,e){var i=d3.interpolate([t[0].valueOf(),t[1].valueOf()],[e[0].valueOf(),e[1].valueOf()]);return function(t){var e=i(t);return[new Date(e[0]),new Date(e[1])]}}function isUndefined(t){return"undefined"==typeof t}function isUndefinedOrNull(t){return null==t||isUndefined(t)}function getMod(t,e){return t.length>0?t[e%t.length]:null}function mpld3_path(t){function e(t,e){var n=function(t){return"function"==typeof t?t:function(){return t}},p=n(i),a=n(s),l=[],h=[],d=0,c=-1,u=0,m=!1;if(!e){e=["M"];for(var f=1;f<t.length;f++)e.push("L")}for(;++c<e.length;){for(u=d+r[e[c]],l=[];u>d;)o.call(this,t[d],d)?(l.push(p.call(this,t[d],d),a.call(this,t[d],d)),d++):(l=null,d=u);l?m&&l.length>0?(h.push("M",l[0],l[1]),m=!1):(h.push(e[c]),h=h.concat(l)):m=!0}return d!=t.length&&console.warn("Warning: not all vertices used in Path"),h.join(" ")}var i=function(t,e){return t[0]},s=function(t,e){return t[1]},o=function(t,e){return!0},r={M:1,m:1,L:1,l:1,Q:2,q:2,T:1,t:1,S:2,s:2,C:3,c:3,Z:0,z:0};return e.x=function(t){return arguments.length?(i=t,e):i},e.y=function(t){return arguments.length?(s=t,e):s},e.defined=function(t){return arguments.length?(o=t,e):o},e.call=e,e}function mpld3_multiscale(t){function e(t){return i.forEach(function(e){t=e(t)}),t}var i=Array.prototype.slice.call(arguments,0),s=i.length;return e.domain=function(t){return arguments.length?(i[0].domain(t),e):i[0].domain()},e.range=function(t){return arguments.length?(i[s-1].range(t),e):i[s-1].range()},e.step=function(t){return i[t]},e}function mpld3_Grid(t,e){if(mpld3_PlotElement.call(this,t,e),this.cssclass="mpld3-"+this.props.xy+"grid","x"==this.props.xy)this.transform="translate(0,"+this.ax.height+")",this.position="bottom",this.scale=this.ax.xdom,this.tickSize=-this.ax.height;else{if("y"!=this.props.xy)throw"unrecognized grid xy specifier: should be 'x' or 'y'";this.transform="translate(0,0)",this.position="left",this.scale=this.ax.ydom,this.tickSize=-this.ax.width}}function mpld3_Axis(t,e){mpld3_PlotElement.call(this,t,e);var i={bottom:[0,this.ax.height],top:[0,0],left:[0,0],right:[this.ax.width,0]},s={bottom:"x",top:"x",left:"y",right:"y"};this.ax=t,this.transform="translate("+i[this.props.position]+")",this.props.xy=s[this.props.position],this.cssclass="mpld3-"+this.props.xy+"axis",this.scale=this.ax[this.props.xy+"dom"],this.tickNr=null,this.tickFormat=null}function mpld3_Coordinates(t,e){if(this.trans=t,"undefined"==typeof e){if(this.ax=null,this.fig=null,"display"!==this.trans)throw"ax must be defined if transform != 'display'"}else this.ax=e,this.fig=e.fig;if(this.zoomable="data"===this.trans,this.x=this["x_"+this.trans],this.y=this["y_"+this.trans],"undefined"==typeof this.x||"undefined"==typeof this.y)throw"unrecognized coordinate code: "+this.trans}function mpld3_Path(t,e){mpld3_PlotElement.call(this,t,e),this.data=t.fig.get_data(this.props.data),this.pathcodes=this.props.pathcodes,this.pathcoords=new mpld3_Coordinates(this.props.coordinates,this.ax),this.offsetcoords=new mpld3_Coordinates(this.props.offsetcoordinates,this.ax),this.datafunc=mpld3_path()}function mpld3_PathCollection(t,e){mpld3_PlotElement.call(this,t,e),(null==this.props.facecolors||0==this.props.facecolors.length)&&(this.props.facecolors=["none"]),(null==this.props.edgecolors||0==this.props.edgecolors.length)&&(this.props.edgecolors=["none"]);var i=this.ax.fig.get_data(this.props.offsets);(null===i||0===i.length)&&(i=[null]);var s=Math.max(this.props.paths.length,i.length);if(i.length===s)this.offsets=i;else{this.offsets=[];for(var o=0;s>o;o++)this.offsets.push(getMod(i,o))}this.pathcoords=new mpld3_Coordinates(this.props.pathcoordinates,this.ax),this.offsetcoords=new mpld3_Coordinates(this.props.offsetcoordinates,this.ax)}function mpld3_Line(t,e){mpld3_PlotElement.call(this,t,e);var i=this.props;i.facecolor="none",i.edgecolor=i.color,delete i.color,i.edgewidth=i.linewidth,delete i.linewidth;const s=i.drawstyle;switch(delete i.drawstyle,this.defaultProps=mpld3_Path.prototype.defaultProps,mpld3_Path.call(this,t,i),s){case"steps":case"steps-pre":this.datafunc=d3.line().curve(d3.curveStepBefore);break;case"steps-post":this.datafunc=d3.line().curve(d3.curveStepAfter);break;case"steps-mid":this.datafunc=d3.line().curve(d3.curveStep);break;default:this.datafunc=d3.line().curve(d3.curveLinear)}}function mpld3_Markers(t,e){mpld3_PlotElement.call(this,t,e),null!==this.props.markerpath?this.marker=0==this.props.markerpath[0].length?null:mpld3.path().call(this.props.markerpath[0],this.props.markerpath[1]):this.marker=null===this.props.markername?null:d3.symbol(this.props.markername).size(Math.pow(this.props.markersize,2))();var i={paths:[this.props.markerpath],offsets:t.fig.parse_offsets(t.fig.get_data(this.props.data,!0)),xindex:this.props.xindex,yindex:this.props.yindex,offsetcoordinates:this.props.coordinates,edgecolors:[this.props.edgecolor],edgewidths:[this.props.edgewidth],facecolors:[this.props.facecolor],alphas:[this.props.alpha],zorder:this.props.zorder,id:this.props.id};this.requiredProps=mpld3_PathCollection.prototype.requiredProps,this.defaultProps=mpld3_PathCollection.prototype.defaultProps,mpld3_PathCollection.call(this,t,i)}function mpld3_Image(t,e){mpld3_PlotElement.call(this,t,e),this.coords=new mpld3_Coordinates(this.props.coordinates,this.ax)}function mpld3_Text(t,e){mpld3_PlotElement.call(this,t,e),this.text=this.props.text,this.position=this.props.position,this.coords=new mpld3_Coordinates(this.props.coordinates,this.ax)}function mpld3_Axes(t,e){function i(t){return new Date(t[0],t[1],t[2],t[3],t[4],t[5])}function s(t,e){return"date"!==t?e:[i(e[0]),i(e[1])]}function o(t,e,i){var s="date"===t?d3.scaleTime():"log"===t?d3.scaleLog():d3.scaleLinear();return s.domain(e).range(i)}mpld3_PlotElement.call(this,t,e),this.axnum=this.fig.axes.length,this.axid=this.fig.figid+"_ax"+(this.axnum+1),this.clipid=this.axid+"_clip",this.props.xdomain=this.props.xdomain||this.props.xlim,this.props.ydomain=this.props.ydomain||this.props.ylim,this.sharex=[],this.sharey=[],this.elements=[],this.axisList=[];var r=this.props.bbox;this.position=[r[0]*this.fig.width,(1-r[1]-r[3])*this.fig.height],this.width=r[2]*this.fig.width,this.height=r[3]*this.fig.height,this.isZoomEnabled=null,this.zoom=null,this.lastTransform=d3.zoomIdentity,this.isBoxzoomEnabled=null,this.isLinkedBrushEnabled=null,this.isCurrentLinkedBrushTarget=!1,this.brushG=null,this.props.xdomain=s(this.props.xscale,this.props.xdomain),this.props.ydomain=s(this.props.yscale,this.props.ydomain),this.x=this.xdom=o(this.props.xscale,this.props.xdomain,[0,this.width]),this.y=this.ydom=o(this.props.yscale,this.props.ydomain,[this.height,0]),"date"===this.props.xscale&&(this.x=mpld3.multiscale(d3.scaleLinear().domain(this.props.xlim).range(this.props.xdomain.map(Number)),this.xdom)),"date"===this.props.yscale&&(this.y=mpld3.multiscale(d3.scaleLinear().domain(this.props.ylim).range(this.props.ydomain.map(Number)),this.ydom));for(var n=this.props.axes,p=0;p<n.length;p++){var a=new mpld3.Axis(this,n[p]);this.axisList.push(a),this.elements.push(a),(this.props.gridOn||a.props.grid.gridOn)&&this.elements.push(a.getGrid())}for(var l=this.props.paths,p=0;p<l.length;p++)this.elements.push(new mpld3.Path(this,l[p]));for(var h=this.props.lines,p=0;p<h.length;p++)this.elements.push(new mpld3.Line(this,h[p]));for(var d=this.props.markers,p=0;p<d.length;p++)this.elements.push(new mpld3.Markers(this,d[p]));for(var c=this.props.texts,p=0;p<c.length;p++)this.elements.push(new mpld3.Text(this,c[p]));for(var u=this.props.collections,p=0;p<u.length;p++)this.elements.push(new mpld3.PathCollection(this,u[p]));for(var m=this.props.images,p=0;p<m.length;p++)this.elements.push(new mpld3.Image(this,m[p]));this.elements.sort(function(t,e){return t.props.zorder-e.props.zorder})}function mpld3_Toolbar(t,e){mpld3_PlotElement.call(this,t,e),this.buttons=[],this.props.buttons.forEach(this.addButton.bind(this))}function mpld3_Button(t,e){mpld3_PlotElement.call(this,t),this.toolbar=t,this.fig=this.toolbar.fig,this.cssclass="mpld3-"+e+"button",this.active=!1}function mpld3_Plugin(t,e){mpld3_PlotElement.call(this,t,e)}function mpld3_ResetPlugin(t,e){mpld3_Plugin.call(this,t,e);var i=mpld3.ButtonFactory({buttonID:"reset",sticky:!1,onActivate:function(){this.toolbar.fig.reset()},icon:function(){return mpld3.icons.reset}});this.fig.buttons.push(i)}function mpld3_ZoomPlugin(t,e){mpld3_Plugin.call(this,t,e),null===this.props.enabled&&(this.props.enabled=!this.props.button);var i=this.props.enabled;if(this.props.button){var s=mpld3.ButtonFactory({buttonID:"zoom",sticky:!0,actions:["scroll","drag"],onActivate:this.activate.bind(this),onDeactivate:this.deactivate.bind(this),onDraw:function(){this.setState(i)},icon:function(){return mpld3.icons.move}});this.fig.buttons.push(s)}}function mpld3_BoxZoomPlugin(t,e){mpld3_Plugin.call(this,t,e),null===this.props.enabled&&(this.props.enabled=!this.props.button);var i=this.props.enabled;if(this.props.button){var s=mpld3.ButtonFactory({buttonID:"boxzoom",sticky:!0,actions:["drag"],onActivate:this.activate.bind(this),onDeactivate:this.deactivate.bind(this),onDraw:function(){this.setState(i)},icon:function(){return mpld3.icons.zoom}});this.fig.buttons.push(s)}this.extentClass="boxzoombrush"}function mpld3_TooltipPlugin(t,e){mpld3_Plugin.call(this,t,e)}function mpld3_LinkedBrushPlugin(t,e){mpld3.Plugin.call(this,t,e),null===this.props.enabled&&(this.props.enabled=!this.props.button);var i=this.props.enabled;if(this.props.button){var s=mpld3.ButtonFactory({buttonID:"linkedbrush",sticky:!0,actions:["drag"],onActivate:this.activate.bind(this),onDeactivate:this.deactivate.bind(this),onDraw:function(){this.setState(i)},icon:function(){return mpld3.icons.brush}});this.fig.buttons.push(s)}this.pathCollectionsByAxes=[],this.objectsByAxes=[],this.allObjects=[],this.extentClass="linkedbrush",this.dataKey="offsets",this.objectClass=null}function MousePositionPlugin(t,e){mpld3.Plugin.call(this,t,e)}function mpld3_Figure(t,e){mpld3_PlotElement.call(this,null,e),this.figid=t,this.width=this.props.width,this.height=this.props.height,this.data=this.props.data,this.buttons=[],this.root=d3.select("#"+t).append("div").style("position","relative"),this.axes=[];for(var i=0;i<this.props.axes.length;i++)this.axes.push(new mpld3_Axes(this,this.props.axes[i]));this.plugins=[],this.pluginsByType={},this.props.plugins.forEach(function(t){this.addPlugin(t)}.bind(this)),this.toolbar=new mpld3.Toolbar(this,{buttons:this.buttons})}function mpld3_PlotElement(t,e){this.parent=isUndefinedOrNull(t)?null:t,this.props=isUndefinedOrNull(e)?{}:this.processProps(e),this.fig=t instanceof mpld3_Figure?t:t&&"fig"in t?t.fig:null,this.ax=t instanceof mpld3_Axes?t:t&&"ax"in t?t.ax:null}if(!d3)var d3=require("d3");var mpld3={_mpld3IsLoaded:!0,figures:[],plugin_map:{}};mpld3.version="0.5.11",mpld3.register_plugin=function(t,e){mpld3.plugin_map[t]=e},mpld3.remove_figure=function(t){var e=document.getElementById(t);null!==e&&(e.innerHTML="");for(var i=0;i<mpld3.figures.length;i++){var s=mpld3.figures[i];s.figid===t&&mpld3.figures.splice(i,1)}return!0},mpld3.draw_figure=function(t,e,i,s){var o=document.getElementById(t);if(s="undefined"!=typeof s?s:!1,s&&mpld3.remove_figure(t),null===o)throw t+" is not a valid id";var r=new mpld3.Figure(t,e);return i&&i(r,o),mpld3.figures.push(r),r.draw(),r},mpld3.cloneObj=mpld3_cloneObj,mpld3.boundsToTransform=function(t,e){var i=t.width,s=t.height,o=e[1][0]-e[0][0],r=e[1][1]-e[0][1],n=(e[0][0]+e[1][0])/2,p=(e[0][1]+e[1][1])/2,a=Math.max(1,Math.min(8,.9/Math.max(o/i,r/s))),l=[i/2-a*n,s/2-a*p];return{translate:l,scale:a}},mpld3.getTransformation=function(t){var e=document.createElementNS("http://www.w3.org/2000/svg","g");e.setAttributeNS(null,"transform",t);var i,s,o,r=e.transform.baseVal.consolidate().matrix,n=r.a,p=r.b,a=r.c,l=r.d,h=r.e,d=r.f;(i=Math.sqrt(n*n+p*p))&&(n/=i,p/=i),(o=n*a+p*l)&&(a-=n*o,l-=p*o),(s=Math.sqrt(a*a+l*l))&&(a/=s,l/=s,o/=s),p*a>n*l&&(n=-n,p=-p,o=-o,i=-i);var c={translateX:h,translateY:d,rotate:180*Math.atan2(p,n)/Math.PI,skewX:180*Math.atan(o)/Math.PI,scaleX:i,scaleY:s},u="translate("+c.translateX+","+c.translateY+")rotate("+c.rotate+")skewX("+c.skewX+")scale("+c.scaleX+","+c.scaleY+")";return u},mpld3.merge_objects=function(t){for(var e,i={},s=0;s<arguments.length;s++){e=arguments[s];for(var o in e)i[o]=e[o]}return i},mpld3.generate_id=function(t,e){return console.warn("mpld3.generate_id is deprecated. Use mpld3.generateId instead."),mpld3_generateId(t,e)},mpld3.generateId=mpld3_generateId,mpld3.get_element=function(t,e){var i,s,o;i="undefined"==typeof e?mpld3.figures:"undefined"==typeof e.length?[e]:e;for(var r=0;r<i.length;r++){if(e=i[r],e.props.id===t)return e;for(var n=0;n<e.axes.length;n++){if(s=e.axes[n],s.props.id===t)return s;for(var p=0;p<s.elements.length;p++)if(o=s.elements[p],o.props.id===t)return o}}return null},mpld3.insert_css=function(t,e){var i=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style"),o=t+" {";for(var r in e)o+=r+":"+e[r]+"; ";o+="}",s.type="text/css",s.styleSheet?s.styleSheet.cssText=o:s.appendChild(document.createTextNode(o)),i.appendChild(s)},mpld3.process_props=function(t,e,i,s){function o(t){mpld3_PlotElement.call(this,null,t)}console.warn("mpld3.process_props is deprecated. Plot elements should derive from mpld3.PlotElement"),o.prototype=Object.create(mpld3_PlotElement.prototype),o.prototype.constructor=o,o.prototype.requiredProps=s,o.prototype.defaultProps=i;var r=new o(e);return r.props},mpld3.interpolateDates=mpld3_interpolateDates,mpld3.path=function(){return mpld3_path()},mpld3.multiscale=mpld3_multiscale,mpld3.icons={reset:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBI\nWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3gIcACMoD/OzIwAAAJhJREFUOMtjYKAx4KDUgNsMDAx7\nyNV8i4GB4T8U76VEM8mGYNNMtCH4NBM0hBjNMIwSsMzQ0MamcDkDA8NmQi6xggpUoikwQbIkHk2u\nE0rLI7vCBknBSyxeRDZAE6qHgQkq+ZeBgYERSfFPAoHNDNUDN4BswIRmKgxwEasP2dlsDAwMYlA/\n/mVgYHiBpkkGKscIDaPfVMmuAGnOTaGsXF0MAAAAAElFTkSuQmCC\n",move:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBI\nWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3gIcACQMfLHBNQAAANZJREFUOMud07FKA0EQBuAviaKB\nlFr7COJrpAyYRlKn8hECEkFEn8ROCCm0sBMRYgh5EgVFtEhsRjiO27vkBoZd/vn5d3b+XcrjFI9q\nxgXWkc8pUjOB93GMd3zgB9d1unjDSxmhWSHQqOJki+MtOuv/b3ZifUqctIrMxwhHuG1gim4Ma5kR\nWuEkXFgU4B0MW1Ho4TeyjX3s4TDq3zn8ALvZ7q5wX9DqLOHCDA95cFBAnOO1AL/ZdNopgY3fQcqF\nyriMe37hM9w521ZkkvlMo7o/8g7nZYQ/QDctp1nTCf0AAAAASUVORK5CYII=\n",zoom:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBI\nWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3gMPDiIRPL/2oQAAANBJREFUOMvF0b9KgzEcheHHVnCT\nKoI4uXbtLXgB3oJDJxevw1VwkoJ/NjepQ2/BrZRCx0ILFURQKV2kyOeSQpAmn7WDB0Lg955zEhLy\n2scdXlBggits+4WOQqjAJ3qYR7NGLrwXGU9+sGbEtlIF18FwmuBngZ+nCt6CIacC3Rx8LSl4xzgF\nn0tusBn4UyVhuA/7ZYIv5g+pE3ail25hN/qdmzCfpsJVjKKCZesDBwtzrAqGOMQj6vhCDRsY4ALH\nmOVObltR/xeG/jph6OD2r+Fv5lZBWEhMx58AAAAASUVORK5CYII=\n",brush:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBI\nWXMAAEQkAABEJAFAZ8RUAAAAB3RJTUUH3gMCEiQKB9YaAgAAAWtJREFUOMuN0r1qVVEQhuFn700k\nnfEvBq0iNiIiOKXgH4KCaBeIhWARK/EibLwFCwVLjyAWaQzRGG9grC3URkHUBKKgRuWohWvL5pjj\nyTSLxcz7rZlZHyMiItqzFxGTEVF18/UoODNFxDIO4x12dkXqTcBPsCUzD+AK3ndFqhHwEsYz82gn\nN4dbmMRK9R/4KY7jAvbiWmYeHBT5Z4QCP8J1rGAeN3GvU3Mbl/Gq3qCDcxjLzOV+v78fq/iFIxFx\nPyJ2lNJpfBy2g59YzMyzEbEVLzGBJjOriLiBq5gaJrCIU3hcRCbwAtuwjm/Yg/V6I9NgDA1OR8RC\nZq6Vcd7iUwtn5h8fdMBdETGPE+Xe4ExELDRNs4bX2NfCUHe+7UExyfkCP8MhzOA7PuAkvrbwXyNF\nxF3MDqxiqlhXC7SPdaOKiN14g0u4g3H0MvOiTUSNY3iemb0ywmfMdfYyUmAJ2yPiBx6Wr/oy2Oqw\n+A1SupBzAOuE/AAAAABJRU5ErkJggg==\n"},mpld3.Grid=mpld3_Grid,mpld3_Grid.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_Grid.prototype.constructor=mpld3_Grid,mpld3_Grid.prototype.requiredProps=["xy"],mpld3_Grid.prototype.defaultProps={color:"gray",dasharray:"2,2",alpha:"0.5",nticks:10,gridOn:!0,tickvalues:null,zorder:0},mpld3_Grid.prototype.draw=function(){var t={left:"axisLeft",right:"axisRight",top:"axisTop",bottom:"axisBottom"}[this.position];this.grid=d3[t](this.scale).ticks(this.props.nticks).tickValues(this.props.tickvalues).tickSize(this.tickSize,0,0).tickFormat(""),this.elem=this.ax.axes.append("g").attr("class",this.cssclass).attr("transform",this.transform).call(this.grid),mpld3.insert_css("div#"+this.ax.fig.figid+" ."+this.cssclass+" .tick",{stroke:this.props.color,"stroke-dasharray":this.props.dasharray,"stroke-opacity":this.props.alpha}),mpld3.insert_css("div#"+this.ax.fig.figid+" ."+this.cssclass+" path",{"stroke-width":0}),mpld3.insert_css("div#"+this.ax.fig.figid+" ."+this.cssclass+" .domain",{"pointer-events":"none"})},mpld3_Grid.prototype.zoomed=function(t){t?"x"==this.props.xy?this.elem.call(this.grid.scale(t.rescaleX(this.scale))):this.elem.call(this.grid.scale(t.rescaleY(this.scale))):this.elem.call(this.grid)},mpld3.Axis=mpld3_Axis,mpld3_Axis.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_Axis.prototype.constructor=mpld3_Axis,mpld3_Axis.prototype.requiredProps=["position"],mpld3_Axis.prototype.defaultProps={nticks:10,tickvalues:null,tickformat:null,filtered_tickvalues:null,filtered_tickformat:null,tickformat_formatter:null,fontsize:"11px",fontcolor:"black",axiscolor:"black",scale:"linear",grid:{},zorder:0,visible:!0},mpld3_Axis.prototype.getGrid=function(){var t={nticks:this.props.nticks,zorder:this.props.zorder,tickvalues:null,xy:this.props.xy};if(this.props.grid)for(var e in this.props.grid)t[e]=this.props.grid[e];return new mpld3_Grid(this.ax,t)},mpld3_Axis.prototype.wrapTicks=function(){function t(t,e,i){i=i||1.2,t.each(function(){for(var t,s=d3.select(this),o=s.node().getBBox(),r=o.height,n=s.text().split(/\s+/).reverse(),p=[],a=0,l=s.attr("y"),h=r,d=s.text(null).append("tspan").attr("x",0).attr("y",l).attr("dy",h);t=n.pop();)p.push(t),d.text(p.join(" ")),d.node().getComputedTextLength()>e&&(p.pop(),d.text(p.join(" ")),p=[t],d=s.append("tspan").attr("x",0).attr("y",l).attr("dy",++a*(r*i)+h).text(t))})}var e=80;"x"==this.props.xy&&this.elem.selectAll("text").call(t,e)},mpld3_Axis.prototype.draw=function(){var t="x"===this.props.xy?this.parent.props.xscale:this.parent.props.yscale;if("date"===t&&this.props.tickvalues){var e="x"===this.props.xy?this.parent.x.domain():this.parent.y.domain(),i="x"===this.props.xy?this.parent.xdom.domain():this.parent.ydom.domain(),s=d3.scaleLinear().domain(e).range(i);this.props.tickvalues=this.props.tickvalues.map(function(t){return new Date(s(t))})}var o={left:"axisLeft",right:"axisRight",top:"axisTop",bottom:"axisBottom"}[this.props.position];this.axis=d3[o](this.scale);var r=this;this.filter_ticks(this.axis.scale().domain()),"index"==this.props.tickformat_formatter?this.axis=this.axis.tickFormat(function(t,e){return r.props.filtered_tickformat[t]}):"percent"==this.props.tickformat_formatter?this.axis=this.axis.tickFormat(function(t,e){var i=t/r.props.tickformat.xmax*100,s=r.props.tickformat.decimals||0,o=d3.format("."+s+"f")(i);return o+r.props.tickformat.symbol}):"str_method"==this.props.tickformat_formatter?this.axis=this.axis.tickFormat(function(t,e){var i=d3.format(r.props.tickformat.format_string)(t);return r.props.tickformat.prefix+i+r.props.tickformat.suffix}):"fixed"==this.props.tickformat_formatter||"func"==this.props.tickformat_formatter?this.axis=this.axis.tickFormat(function(t,e){return r.props.filtered_tickformat[e]}):this.tickFormat&&(this.axis=this.axis.tickFormat(this.tickFormat)),this.tickNr&&(this.axis=this.axis.ticks(this.tickNr)),this.axis=this.axis.tickValues(this.props.filtered_tickvalues),this.elem=this.ax.baseaxes.append("g").attr("transform",this.transform).attr("class",this.cssclass).call(this.axis),this.wrapTicks(),mpld3.insert_css("div#"+this.ax.fig.figid+" ."+this.cssclass+" line,  ."+this.cssclass+" path",{"shape-rendering":"crispEdges",stroke:this.props.axiscolor,fill:"none"}),mpld3.insert_css("div#"+this.ax.fig.figid+" ."+this.cssclass+" text",{"font-family":"sans-serif","font-size":this.props.fontsize+"px",fill:this.props.fontcolor,stroke:"none"})},mpld3_Axis.prototype.zoomed=function(t){this.filter_ticks(this.axis.scale().domain()),this.axis=this.axis.tickValues(this.props.filtered_tickvalues),t?("x"==this.props.xy?this.elem.call(this.axis.scale(t.rescaleX(this.scale))):this.elem.call(this.axis.scale(t.rescaleY(this.scale))),this.wrapTicks()):this.elem.call(this.axis)},mpld3_Axis.prototype.setTicks=function(t,e){this.tickNr=t,this.tickFormat=e},mpld3_Axis.prototype.filter_ticks=function(t){if(this.props.tickvalues){const e=this,i=this.props.tickvalues.map(function(t,e){return e}).filter(function(i,s){const o=e.props.tickvalues[i];return o>=t[0]&&o<=t[1]});this.props.filtered_tickvalues=this.props.tickvalues.filter(function(t,e){return i.includes(e)}),this.props.tickformat?this.props.filtered_tickformat=this.props.tickformat.filter(function(t,e){return i.includes(e)}):this.props.filtered_tickformat=this.props.tickformat}else this.props.filtered_tickvalues=this.props.tickvalues,this.props.filtered_tickformat=this.props.tickformat},mpld3.Coordinates=mpld3_Coordinates,mpld3_Coordinates.prototype.xy=function(t,e,i){return e="undefined"==typeof e?0:e,i="undefined"==typeof i?1:i,[this.x(t[e]),this.y(t[i])]},mpld3_Coordinates.prototype.x_data=function(t){return this.ax.x(t)},mpld3_Coordinates.prototype.y_data=function(t){return this.ax.y(t)},mpld3_Coordinates.prototype.x_display=function(t){return t},mpld3_Coordinates.prototype.y_display=function(t){return t},mpld3_Coordinates.prototype.x_axes=function(t){return t*this.ax.width},mpld3_Coordinates.prototype.y_axes=function(t){return this.ax.height*(1-t)},mpld3_Coordinates.prototype.x_figure=function(t){return t*this.fig.width-this.ax.position[0]},mpld3_Coordinates.prototype.y_figure=function(t){return(1-t)*this.fig.height-this.ax.position[1]},mpld3.Path=mpld3_Path,mpld3_Path.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_Path.prototype.constructor=mpld3_Path,mpld3_Path.prototype.requiredProps=["data"],mpld3_Path.prototype.defaultProps={xindex:0,yindex:1,coordinates:"data",facecolor:"green",edgecolor:"black",edgewidth:1,dasharray:"none",pathcodes:null,offset:null,offsetcoordinates:"data",alpha:1,drawstyle:"none",zorder:1},mpld3_Path.prototype.finiteFilter=function(t,e){return isFinite(this.pathcoords.x(t[this.props.xindex]))&&isFinite(this.pathcoords.y(t[this.props.yindex]))},mpld3_Path.prototype.draw=function(){if(this.datafunc.defined(this.finiteFilter.bind(this)).x(function(t){return this.pathcoords.x(t[this.props.xindex])}.bind(this)).y(function(t){return this.pathcoords.y(t[this.props.yindex])}.bind(this)),this.pathcoords.zoomable?this.path=this.ax.paths.append("svg:path"):this.path=this.ax.staticPaths.append("svg:path"),this.path=this.path.attr("d",this.datafunc(this.data,this.pathcodes)).attr("class","mpld3-path").style("stroke",this.props.edgecolor).style("stroke-width",this.props.edgewidth).style("stroke-dasharray",this.props.dasharray).style("stroke-opacity",this.props.alpha).style("fill",this.props.facecolor).style("fill-opacity",this.props.alpha).attr("vector-effect","non-scaling-stroke"),null!==this.props.offset){var t=this.offsetcoords.xy(this.props.offset);this.path.attr("transform","translate("+t+")")}},mpld3_Path.prototype.elements=function(t){return this.path},mpld3.PathCollection=mpld3_PathCollection,mpld3_PathCollection.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_PathCollection.prototype.constructor=mpld3_PathCollection,mpld3_PathCollection.prototype.requiredProps=["paths","offsets"],mpld3_PathCollection.prototype.defaultProps={xindex:0,yindex:1,pathtransforms:[],pathcoordinates:"display",offsetcoordinates:"data",offsetorder:"before",edgecolors:["#000000"],drawstyle:"none",edgewidths:[1],facecolors:["#0000FF"],alphas:[1],zorder:2},mpld3_PathCollection.prototype.transformFunc=function(t,e){var i=this.props.pathtransforms,s=0==i.length?"":mpld3.getTransformation("matrix("+getMod(i,e)+")").toString(),o=null===t||"undefined"==typeof t?"translate(0, 0)":"translate("+this.offsetcoords.xy(t,this.props.xindex,this.props.yindex)+")";return"after"===this.props.offsetorder?s+o:o+s},mpld3_PathCollection.prototype.pathFunc=function(t,e){return mpld3_path().x(function(t){return this.pathcoords.x(t[0])}.bind(this)).y(function(t){return this.pathcoords.y(t[1])}.bind(this)).apply(this,getMod(this.props.paths,e))},mpld3_PathCollection.prototype.styleFunc=function(t,e){var i={stroke:getMod(this.props.edgecolors,e),"stroke-width":getMod(this.props.edgewidths,e),"stroke-opacity":getMod(this.props.alphas,e),fill:getMod(this.props.facecolors,e),"fill-opacity":getMod(this.props.alphas,e)},s="";for(var o in i)s+=o+":"+i[o]+";";return s},mpld3_PathCollection.prototype.allFinite=function(t){return t instanceof Array?t.length==t.filter(isFinite).length:!0},mpld3_PathCollection.prototype.draw=function(){this.offsetcoords.zoomable||this.pathcoords.zoomable?this.group=this.ax.paths.append("svg:g"):this.group=this.ax.staticPaths.append("svg:g"),this.pathsobj=this.group.selectAll("paths").data(this.offsets.filter(this.allFinite)).enter().append("svg:path").attr("d",this.pathFunc.bind(this)).attr("class","mpld3-path").attr("transform",this.transformFunc.bind(this)).attr("style",this.styleFunc.bind(this)).attr("vector-effect","non-scaling-stroke")},mpld3_PathCollection.prototype.elements=function(t){return this.group.selectAll("path")},mpld3.Line=mpld3_Line,mpld3_Line.prototype=Object.create(mpld3_Path.prototype),mpld3_Line.prototype.constructor=mpld3_Line,mpld3_Line.prototype.requiredProps=["data"],mpld3_Line.prototype.defaultProps={xindex:0,yindex:1,coordinates:"data",color:"salmon",linewidth:2,dasharray:"none",alpha:1,zorder:2,drawstyle:"none"},mpld3.Markers=mpld3_Markers,mpld3_Markers.prototype=Object.create(mpld3_PathCollection.prototype),mpld3_Markers.prototype.constructor=mpld3_Markers,mpld3_Markers.prototype.requiredProps=["data"],mpld3_Markers.prototype.defaultProps={xindex:0,yindex:1,coordinates:"data",facecolor:"salmon",edgecolor:"black",edgewidth:1,alpha:1,markersize:6,markername:"circle",drawstyle:"none",markerpath:null,zorder:3},mpld3_Markers.prototype.pathFunc=function(t,e){return this.marker},mpld3.Image=mpld3_Image,mpld3_Image.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_Image.prototype.constructor=mpld3_Image,mpld3_Image.prototype.requiredProps=["data","extent"],mpld3_Image.prototype.defaultProps={alpha:1,coordinates:"data",drawstyle:"none",zorder:1},mpld3_Image.prototype.draw=function(){this.image=this.ax.paths.append("svg:image"),this.image=this.image.attr("class","mpld3-image").attr("xlink:href","data:image/png;base64,"+this.props.data).style("opacity",this.props.alpha).attr("preserveAspectRatio","none"),this.updateDimensions()},mpld3_Image.prototype.elements=function(t){return d3.select(this.image)},mpld3_Image.prototype.updateDimensions=function(){var t=this.props.extent;this.image.attr("x",this.coords.x(t[0])).attr("y",this.coords.y(t[3])).attr("width",this.coords.x(t[1])-this.coords.x(t[0])).attr("height",this.coords.y(t[2])-this.coords.y(t[3]))},mpld3.Text=mpld3_Text,mpld3_Text.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_Text.prototype.constructor=mpld3_Text,mpld3_Text.prototype.requiredProps=["text","position"],mpld3_Text.prototype.defaultProps={coordinates:"data",h_anchor:"start",v_baseline:"auto",rotation:0,fontsize:11,drawstyle:"none",color:"black",alpha:1,zorder:3},mpld3_Text.prototype.draw=function(){"data"==this.props.coordinates?this.coords.zoomable?this.obj=this.ax.paths.append("text"):this.obj=this.ax.staticPaths.append("text"):this.obj=this.ax.baseaxes.append("text"),this.obj.attr("class","mpld3-text").text(this.text).style("text-anchor",this.props.h_anchor).style("dominant-baseline",this.props.v_baseline).style("font-size",this.props.fontsize).style("fill",this.props.color).style("opacity",this.props.alpha),this.applyTransform()},mpld3_Text.prototype.elements=function(t){return d3.select(this.obj)},mpld3_Text.prototype.applyTransform=function(){var t=this.coords.xy(this.position);this.obj.attr("x",t[0]).attr("y",t[1]),this.props.rotation&&this.obj.attr("transform","rotate("+this.props.rotation+","+t+")")},mpld3.Axes=mpld3_Axes,mpld3_Axes.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_Axes.prototype.constructor=mpld3_Axes,mpld3_Axes.prototype.requiredProps=["xlim","ylim"],mpld3_Axes.prototype.defaultProps={bbox:[.1,.1,.8,.8],axesbg:"#FFFFFF",axesbgalpha:1,gridOn:!1,xdomain:null,ydomain:null,xscale:"linear",yscale:"linear",zoomable:!0,axes:[{position:"left"},{position:"bottom"}],lines:[],paths:[],markers:[],texts:[],collections:[],sharex:[],sharey:[],images:[]},mpld3_Axes.prototype.draw=function(){for(var t=0;t<this.props.sharex.length;t++)this.sharex.push(mpld3.get_element(this.props.sharex[t]));for(var t=0;t<this.props.sharey.length;t++)this.sharey.push(mpld3.get_element(this.props.sharey[t]));this.baseaxes=this.fig.canvas.append("g").attr("transform","translate("+this.position[0]+","+this.position[1]+")").attr("width",this.width).attr("height",this.height).attr("class","mpld3-baseaxes"),this.axes=this.baseaxes.append("g").attr("class","mpld3-axes").style("pointer-events","visiblefill"),this.clip=this.axes.append("svg:clipPath").attr("id",this.clipid).append("svg:rect").attr("x",0).attr("y",0).attr("width",this.width).attr("height",this.height),this.axesbg=this.axes.append("svg:rect").attr("width",this.width).attr("height",this.height).attr("class","mpld3-axesbg").style("fill",this.props.axesbg).style("fill-opacity",this.props.axesbgalpha),this.pathsContainer=this.axes.append("g").attr("clip-path","url(#"+this.clipid+")").attr("x",0).attr("y",0).attr("width",this.width).attr("height",this.height).attr("class","mpld3-paths-container"),this.paths=this.pathsContainer.append("g").attr("class","mpld3-paths"),this.staticPaths=this.axes.append("g").attr("class","mpld3-staticpaths"),this.brush=d3.brush().extent([[0,0],[this.fig.width,this.fig.height]]).on("start",this.brushStart.bind(this)).on("brush",this.brushMove.bind(this)).on("end",this.brushEnd.bind(this)).on("start.nokey",function(){d3.select(window).on("keydown.brush keyup.brush",null)});for(var t=0;t<this.elements.length;t++)this.elements[t].draw()},mpld3_Axes.prototype.bindZoom=function(){this.zoom||(this.zoom=d3.zoom(),this.zoom.on("zoom",this.zoomed.bind(this)),this.axes.call(this.zoom))},mpld3_Axes.prototype.unbindZoom=function(){this.zoom&&(this.zoom.on("zoom",null),this.axes.on(".zoom",null),this.zoom=null)},mpld3_Axes.prototype.bindBrush=function(){this.brushG||(this.brushG=this.axes.append("g").attr("class","mpld3-brush").call(this.brush))},mpld3_Axes.prototype.unbindBrush=function(){this.brushG&&(this.brushG.remove(),this.brushG.on(".brush",null),this.brushG=null)},mpld3_Axes.prototype.reset=function(){this.zoom?this.doZoom(!1,d3.zoomIdentity,750):(this.bindZoom(),this.doZoom(!1,d3.zoomIdentity,750,function(){this.isSomeTypeOfZoomEnabled||this.unbindZoom()}.bind(this)))},mpld3_Axes.prototype.enableOrDisableBrushing=function(){this.isBoxzoomEnabled||this.isLinkedBrushEnabled?this.bindBrush():this.unbindBrush()},mpld3_Axes.prototype.isSomeTypeOfZoomEnabled=function(){return this.isZoomEnabled||this.isBoxzoomEnabled},mpld3_Axes.prototype.enableOrDisableZooming=function(){this.isSomeTypeOfZoomEnabled()?this.bindZoom():this.unbindZoom()},mpld3_Axes.prototype.enableLinkedBrush=function(){this.isLinkedBrushEnabled=!0,this.enableOrDisableBrushing()},mpld3_Axes.prototype.disableLinkedBrush=function(){this.isLinkedBrushEnabled=!1,this.enableOrDisableBrushing()},mpld3_Axes.prototype.enableBoxzoom=function(){
this.isBoxzoomEnabled=!0,this.enableOrDisableBrushing(),this.enableOrDisableZooming()},mpld3_Axes.prototype.disableBoxzoom=function(){this.isBoxzoomEnabled=!1,this.enableOrDisableBrushing(),this.enableOrDisableZooming()},mpld3_Axes.prototype.enableZoom=function(){this.isZoomEnabled=!0,this.enableOrDisableZooming(),this.axes.style("cursor","move")},mpld3_Axes.prototype.disableZoom=function(){this.isZoomEnabled=!1,this.enableOrDisableZooming(),this.axes.style("cursor",null)},mpld3_Axes.prototype.doZoom=function(t,e,i,s){if(this.props.zoomable&&this.zoom){if(i){var o=this.axes.transition().duration(i).call(this.zoom.transform,e);s&&o.on("end",s)}else this.axes.call(this.zoom.transform,e);t?(this.lastTransform=e,this.sharex.forEach(function(t){t.doZoom(!1,e,i)}),this.sharey.forEach(function(t){t.doZoom(!1,e,i)})):this.lastTransform=e}},mpld3_Axes.prototype.zoomed=function(){var t=d3.event.sourceEvent&&"zoom"!=d3.event.sourceEvent.type;if(t)this.doZoom(!0,d3.event.transform,!1);else{var e=d3.event.transform;this.paths.attr("transform",e),this.elements.forEach(function(t){t.zoomed&&t.zoomed(e)}.bind(this))}},mpld3_Axes.prototype.resetBrush=function(){this.brushG.call(this.brush.move,null)},mpld3_Axes.prototype.doBoxzoom=function(t){if(t&&this.brushG){var e=t.map(this.lastTransform.invert,this.lastTransform),i=e[1][0]-e[0][0],s=e[1][1]-e[0][1],o=(e[0][0]+e[1][0])/2,r=(e[0][1]+e[1][1])/2,n=i>s?this.width/i:this.height/s,p=this.width/2-n*o,a=this.height/2-n*r,l=d3.zoomIdentity.translate(p,a).scale(n);this.doZoom(!0,l,750),this.resetBrush()}},mpld3_Axes.prototype.brushStart=function(){this.isLinkedBrushEnabled&&(this.isCurrentLinkedBrushTarget="MouseEvent"==d3.event.sourceEvent.constructor.name,this.isCurrentLinkedBrushTarget&&this.fig.resetBrushForOtherAxes(this.axid))},mpld3_Axes.prototype.brushMove=function(){var t=d3.event.selection;this.isLinkedBrushEnabled&&this.fig.updateLinkedBrush(t)},mpld3_Axes.prototype.brushEnd=function(){var t=d3.event.selection;this.isBoxzoomEnabled&&this.doBoxzoom(t),this.isLinkedBrushEnabled&&(t||this.fig.endLinkedBrush(),this.isCurrentLinkedBrushTarget=!1)},mpld3_Axes.prototype.setTicks=function(t,e,i){this.axisList.forEach(function(s){s.props.xy==t&&s.setTicks(e,i)})},mpld3.Toolbar=mpld3_Toolbar,mpld3_Toolbar.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_Toolbar.prototype.constructor=mpld3_Toolbar,mpld3_Toolbar.prototype.defaultProps={buttons:["reset","move"]},mpld3_Toolbar.prototype.addButton=function(t){this.buttons.push(new t(this))},mpld3_Toolbar.prototype.draw=function(){function t(){this.buttonsobj.transition(750).attr("y",0)}function e(){this.buttonsobj.transition(750).delay(250).attr("y",16)}mpld3.insert_css("div#"+this.fig.figid+" .mpld3-toolbar image",{cursor:"pointer",opacity:.2,display:"inline-block",margin:"0px"}),mpld3.insert_css("div#"+this.fig.figid+" .mpld3-toolbar image.active",{opacity:.4}),mpld3.insert_css("div#"+this.fig.figid+" .mpld3-toolbar image.pressed",{opacity:.6}),this.fig.canvas.on("mouseenter",t.bind(this)).on("mouseleave",e.bind(this)).on("touchenter",t.bind(this)).on("touchstart",t.bind(this)),this.toolbar=this.fig.canvas.append("svg:svg").attr("width",16*this.buttons.length).attr("height",16).attr("x",2).attr("y",this.fig.height-16-2).attr("class","mpld3-toolbar"),this.buttonsobj=this.toolbar.append("svg:g").selectAll("buttons").data(this.buttons).enter().append("svg:image").attr("class",function(t){return t.cssclass}).attr("xlink:href",function(t){return t.icon()}).attr("width",16).attr("height",16).attr("x",function(t,e){return 16*e}).attr("y",16).on("click",function(t){t.click()}).on("mouseenter",function(){d3.select(this).classed("active",!0)}).on("mouseleave",function(){d3.select(this).classed("active",!1)});for(var i=0;i<this.buttons.length;i++)this.buttons[i].onDraw()},mpld3_Toolbar.prototype.deactivate_all=function(){this.buttons.forEach(function(t){t.deactivate()})},mpld3_Toolbar.prototype.deactivate_by_action=function(t){function e(e){return-1!==t.indexOf(e)}t.length>0&&this.buttons.forEach(function(t){t.actions.filter(e).length>0&&t.deactivate()})},mpld3.Button=mpld3_Button,mpld3_Button.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_Button.prototype.constructor=mpld3_Button,mpld3_Button.prototype.setState=function(t){t?this.activate():this.deactivate()},mpld3_Button.prototype.click=function(){this.active?this.deactivate():this.activate()},mpld3_Button.prototype.activate=function(){this.toolbar.deactivate_by_action(this.actions),this.onActivate(),this.active=!0,this.toolbar.toolbar.select("."+this.cssclass).classed("pressed",!0),this.sticky||this.deactivate()},mpld3_Button.prototype.deactivate=function(){this.onDeactivate(),this.active=!1,this.toolbar.toolbar.select("."+this.cssclass).classed("pressed",!1)},mpld3_Button.prototype.sticky=!1,mpld3_Button.prototype.actions=[],mpld3_Button.prototype.icon=function(){return""},mpld3_Button.prototype.onActivate=function(){},mpld3_Button.prototype.onDeactivate=function(){},mpld3_Button.prototype.onDraw=function(){},mpld3.ButtonFactory=function(t){function e(t){mpld3_Button.call(this,t,this.buttonID)}if("string"!=typeof t.buttonID)throw"ButtonFactory: buttonID must be present and be a string";e.prototype=Object.create(mpld3_Button.prototype),e.prototype.constructor=e;for(var i in t)e.prototype[i]=t[i];return e},mpld3.Plugin=mpld3_Plugin,mpld3_Plugin.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_Plugin.prototype.constructor=mpld3_Plugin,mpld3_Plugin.prototype.requiredProps=[],mpld3_Plugin.prototype.defaultProps={},mpld3_Plugin.prototype.draw=function(){},mpld3.ResetPlugin=mpld3_ResetPlugin,mpld3.register_plugin("reset",mpld3_ResetPlugin),mpld3_ResetPlugin.prototype=Object.create(mpld3_Plugin.prototype),mpld3_ResetPlugin.prototype.constructor=mpld3_ResetPlugin,mpld3_ResetPlugin.prototype.requiredProps=[],mpld3_ResetPlugin.prototype.defaultProps={},mpld3.ZoomPlugin=mpld3_ZoomPlugin,mpld3.register_plugin("zoom",mpld3_ZoomPlugin),mpld3_ZoomPlugin.prototype=Object.create(mpld3_Plugin.prototype),mpld3_ZoomPlugin.prototype.constructor=mpld3_ZoomPlugin,mpld3_ZoomPlugin.prototype.requiredProps=[],mpld3_ZoomPlugin.prototype.defaultProps={button:!0,enabled:null},mpld3_ZoomPlugin.prototype.activate=function(){this.fig.enableZoom()},mpld3_ZoomPlugin.prototype.deactivate=function(){this.fig.disableZoom()},mpld3_ZoomPlugin.prototype.draw=function(){this.props.enabled?this.activate():this.deactivate()},mpld3.BoxZoomPlugin=mpld3_BoxZoomPlugin,mpld3.register_plugin("boxzoom",mpld3_BoxZoomPlugin),mpld3_BoxZoomPlugin.prototype=Object.create(mpld3_Plugin.prototype),mpld3_BoxZoomPlugin.prototype.constructor=mpld3_BoxZoomPlugin,mpld3_BoxZoomPlugin.prototype.requiredProps=[],mpld3_BoxZoomPlugin.prototype.defaultProps={button:!0,enabled:null},mpld3_BoxZoomPlugin.prototype.activate=function(){this.fig.enableBoxzoom()},mpld3_BoxZoomPlugin.prototype.deactivate=function(){this.fig.disableBoxzoom()},mpld3_BoxZoomPlugin.prototype.draw=function(){this.props.enabled?this.activate():this.deactivate()},mpld3.TooltipPlugin=mpld3_TooltipPlugin,mpld3.register_plugin("tooltip",mpld3_TooltipPlugin),mpld3_TooltipPlugin.prototype=Object.create(mpld3_Plugin.prototype),mpld3_TooltipPlugin.prototype.constructor=mpld3_TooltipPlugin,mpld3_TooltipPlugin.prototype.requiredProps=["id"],mpld3_TooltipPlugin.prototype.defaultProps={labels:null,hoffset:0,voffset:10,location:"mouse"},mpld3_TooltipPlugin.prototype.draw=function(){function t(t,e){this.tooltip.style("visibility","visible").text(null===o?"("+t+")":getMod(o,e))}function e(t,e){if("mouse"===r){var i=d3.mouse(this.fig.canvas.node());this.x=i[0]+this.props.hoffset,this.y=i[1]-this.props.voffset}this.tooltip.attr("x",this.x).attr("y",this.y)}function i(t,e){this.tooltip.style("visibility","hidden")}var s=mpld3.get_element(this.props.id,this.fig),o=this.props.labels,r=this.props.location;this.tooltip=this.fig.canvas.append("text").attr("class","mpld3-tooltip-text").attr("x",0).attr("y",0).text("").style("visibility","hidden"),"bottom left"==r||"top left"==r?(this.x=s.ax.position[0]+5+this.props.hoffset,this.tooltip.style("text-anchor","beginning")):"bottom right"==r||"top right"==r?(this.x=s.ax.position[0]+s.ax.width-5+this.props.hoffset,this.tooltip.style("text-anchor","end")):this.tooltip.style("text-anchor","middle"),"bottom left"==r||"bottom right"==r?this.y=s.ax.position[1]+s.ax.height-5+this.props.voffset:("top left"==r||"top right"==r)&&(this.y=s.ax.position[1]+5+this.props.voffset),s.elements().on("mouseover",t.bind(this)).on("mousemove",e.bind(this)).on("mouseout",i.bind(this))},mpld3.LinkedBrushPlugin=mpld3_LinkedBrushPlugin,mpld3.register_plugin("linkedbrush",mpld3_LinkedBrushPlugin),mpld3_LinkedBrushPlugin.prototype=Object.create(mpld3.Plugin.prototype),mpld3_LinkedBrushPlugin.prototype.constructor=mpld3_LinkedBrushPlugin,mpld3_LinkedBrushPlugin.prototype.requiredProps=["id"],mpld3_LinkedBrushPlugin.prototype.defaultProps={button:!0,enabled:null},mpld3_LinkedBrushPlugin.prototype.activate=function(){this.fig.enableLinkedBrush()},mpld3_LinkedBrushPlugin.prototype.deactivate=function(){this.fig.disableLinkedBrush()},mpld3_LinkedBrushPlugin.prototype.isPathInSelection=function(t,e,i,s){var o=s[0][0]<t[e]&&s[1][0]>t[e]&&s[0][1]<t[i]&&s[1][1]>t[i];return o},mpld3_LinkedBrushPlugin.prototype.invertSelection=function(t,e){var i=[e.x.invert(t[0][0]),e.x.invert(t[1][0])],s=[e.y.invert(t[1][1]),e.y.invert(t[0][1])];return[[Math.min.apply(Math,i),Math.min.apply(Math,s)],[Math.max.apply(Math,i),Math.max.apply(Math,s)]]},mpld3_LinkedBrushPlugin.prototype.update=function(t){t&&this.pathCollectionsByAxes.forEach(function(e,i){var s=e[0],o=this.objectsByAxes[i],r=this.invertSelection(t,this.fig.axes[i]),n=s.props.xindex,p=s.props.yindex;o.selectAll("path").classed("mpld3-hidden",function(t,e){return!this.isPathInSelection(t,n,p,r)}.bind(this))}.bind(this))},mpld3_LinkedBrushPlugin.prototype.end=function(){this.allObjects.selectAll("path").classed("mpld3-hidden",!1)},mpld3_LinkedBrushPlugin.prototype.draw=function(){mpld3.insert_css("#"+this.fig.figid+" path.mpld3-hidden",{stroke:"#ccc !important",fill:"#ccc !important"});var t=mpld3.get_element(this.props.id);if(!t)throw new Error("[LinkedBrush] Could not find path collection");if(!("offsets"in t.props))throw new Error("[LinkedBrush] Figure is not a scatter plot.");this.objectClass="mpld3-brushtarget-"+t.props[this.dataKey],this.pathCollectionsByAxes=this.fig.axes.map(function(e){return e.elements.map(function(e){return e.props[this.dataKey]==t.props[this.dataKey]?(e.group.classed(this.objectClass,!0),e):void 0}.bind(this)).filter(function(t){return t})}.bind(this)),this.objectsByAxes=this.fig.axes.map(function(t){return t.axes.selectAll("."+this.objectClass)}.bind(this)),this.allObjects=this.fig.canvas.selectAll("."+this.objectClass)},mpld3.register_plugin("mouseposition",MousePositionPlugin),MousePositionPlugin.prototype=Object.create(mpld3.Plugin.prototype),MousePositionPlugin.prototype.constructor=MousePositionPlugin,MousePositionPlugin.prototype.requiredProps=[],MousePositionPlugin.prototype.defaultProps={fontsize:12,fmt:".3g"},MousePositionPlugin.prototype.draw=function(){for(var t=this.fig,e=d3.format(this.props.fmt),i=t.canvas.append("text").attr("class","mpld3-coordinates").style("text-anchor","end").style("font-size",this.props.fontsize).attr("x",this.fig.width-5).attr("y",this.fig.height-5),s=0;s<this.fig.axes.length;s++){var o=function(){var o=t.axes[s];return function(){var t=d3.mouse(this),s=o.x.invert(t[0]),r=o.y.invert(t[1]);i.text("("+e(s)+", "+e(r)+")")}}();t.axes[s].baseaxes.on("mousemove",o).on("mouseout",function(){i.text("")})}},mpld3.Figure=mpld3_Figure,mpld3_Figure.prototype=Object.create(mpld3_PlotElement.prototype),mpld3_Figure.prototype.constructor=mpld3_Figure,mpld3_Figure.prototype.requiredProps=["width","height"],mpld3_Figure.prototype.defaultProps={data:{},axes:[],plugins:[{type:"reset"},{type:"zoom"},{type:"boxzoom"}]},mpld3_Figure.prototype.addPlugin=function(t){if(!t.type)return console.warn("unspecified plugin type. Skipping this");var e;if(!(t.type in mpld3.plugin_map))return console.warn("Skipping unrecognized plugin: "+e);e=mpld3.plugin_map[t.type],(t.clear_toolbar||t.buttons)&&console.warn("DEPRECATION WARNING: You are using pluginInfo.clear_toolbar or pluginInfo, which have been deprecated. Please see the build-in plugins for the new method to add buttons, otherwise contact the mpld3 maintainers.");var i=mpld3_cloneObj(t);delete i.type;var s=new e(this,i);this.plugins.push(s),this.pluginsByType[t.type]=s},mpld3_Figure.prototype.draw=function(){mpld3.insert_css("div#"+this.figid,{"font-family":"Helvetica, sans-serif"}),this.canvas=this.root.append("svg:svg").attr("class","mpld3-figure").attr("width",this.width).attr("height",this.height);for(var t=0;t<this.axes.length;t++)this.axes[t].draw();this.disableZoom();for(var t=0;t<this.plugins.length;t++)this.plugins[t].draw();this.toolbar.draw()},mpld3_Figure.prototype.resetBrushForOtherAxes=function(t){this.axes.forEach(function(e){e.axid!=t&&e.resetBrush()})},mpld3_Figure.prototype.updateLinkedBrush=function(t){this.pluginsByType.linkedbrush&&this.pluginsByType.linkedbrush.update(t)},mpld3_Figure.prototype.endLinkedBrush=function(){this.pluginsByType.linkedbrush&&this.pluginsByType.linkedbrush.end()},mpld3_Figure.prototype.reset=function(t){this.axes.forEach(function(t){t.reset()})},mpld3_Figure.prototype.enableLinkedBrush=function(){this.axes.forEach(function(t){t.enableLinkedBrush()})},mpld3_Figure.prototype.disableLinkedBrush=function(){this.axes.forEach(function(t){t.disableLinkedBrush()})},mpld3_Figure.prototype.enableBoxzoom=function(){this.axes.forEach(function(t){t.enableBoxzoom()})},mpld3_Figure.prototype.disableBoxzoom=function(){this.axes.forEach(function(t){t.disableBoxzoom()})},mpld3_Figure.prototype.enableZoom=function(){this.axes.forEach(function(t){t.enableZoom()})},mpld3_Figure.prototype.disableZoom=function(){this.axes.forEach(function(t){t.disableZoom()})},mpld3_Figure.prototype.toggleZoom=function(){this.isZoomEnabled?this.disableZoom():this.enableZoom()},mpld3_Figure.prototype.setTicks=function(t,e,i){this.axes.forEach(function(s){s.setTicks(t,e,i)})},mpld3_Figure.prototype.setXTicks=function(t,e){this.setTicks("x",t,e)},mpld3_Figure.prototype.setYTicks=function(t,e){this.setTicks("y",t,e)},mpld3_Figure.prototype.removeNaN=function(t){output=output.map(function(t){return t.map(function(t){return"number"==typeof t&&isNaN(t)?0:t})})},mpld3_Figure.prototype.parse_offsets=function(t){return t.map(function(t){return t.map(function(t){return"number"==typeof t&&isNaN(t)?0:t})})},mpld3_Figure.prototype.get_data=function(t){var e=t;return null===t||"undefined"==typeof t?e=null:"string"==typeof t&&(e=this.data[t]),e},mpld3.PlotElement=mpld3_PlotElement,mpld3_PlotElement.prototype.requiredProps=[],mpld3_PlotElement.prototype.defaultProps={},mpld3_PlotElement.prototype.processProps=function(t){t=mpld3_cloneObj(t);var e={},i=this.name();this.requiredProps.forEach(function(s){if(!(s in t))throw"property '"+s+"' must be specified for "+i;e[s]=t[s],delete t[s]});for(var s in this.defaultProps)s in t?(e[s]=t[s],delete t[s]):e[s]=this.defaultProps[s];"id"in t?(e.id=t.id,delete t.id):"id"in e||(e.id=mpld3.generateId());for(var s in t)console.warn("Unrecognized property '"+s+"' for object "+this.name()+" (value = "+t[s]+").");return e},mpld3_PlotElement.prototype.name=function(){var t=/function (.{1,})\(/,e=t.exec(this.constructor.toString());return e&&e.length>1?e[1]:""},"object"==typeof module&&module.exports?module.exports=mpld3:this.mpld3=mpld3,console.log("Loaded mpld3 version "+mpld3.version);


=== app/static/js/session-manager.js ===
// --- Start: session-manager.js ---

// Helper functions for storing and retrieving passcodes
function savePasscode(sessionId, passcode) {
    try {
        const passcodes = JSON.parse(localStorage.getItem('mpld3_passcodes')) || {};
        passcodes[sessionId] = passcode;
        localStorage.setItem('mpld3_passcodes', JSON.stringify(passcodes));
    } catch (e) {
        console.error("Could not save passcode to localStorage:", e);
    }
}

function getPasscode(sessionId) {
    try {
        const passcodes = JSON.parse(localStorage.getItem('mpld3_passcodes')) || {};
        return passcodes[sessionId] || null;
    } catch (e) {
        console.error("Could not retrieve passcode from localStorage:", e);
        return null;
    }
}

// Helper function to create a list item for the "Joinable" list
function createJoinableSessionListItem(session) {
    const listItem = document.createElement('li');
    listItem.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-md';
    listItem.dataset.sessionId = session.id;

    const nameSpan = document.createElement('span');
    nameSpan.className = 'text-sm text-gray-800 truncate';
    nameSpan.textContent = session.name || `Session ${session.id.substring(0, 8)}`;
    nameSpan.title = session.name;

    const actionButton = document.createElement('button');
    actionButton.className = 'px-3 py-1 text-white text-xs font-semibold rounded-md transition-colors';

    if (session.is_member) {
        actionButton.textContent = 'Open';
        actionButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
        actionButton.onclick = () => { window.location.href = `/chat/${session.id}`; };
    } else {
        actionButton.textContent = 'Join';
        if (session.access_level === 'protected') {
            actionButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
        } else {
            actionButton.classList.add('bg-green-500', 'hover:bg-green-600');
        }
        actionButton.onclick = async () => {
            let passcode = getPasscode(session.id);
            if (session.access_level === 'protected' && !passcode) {
                passcode = prompt(`Session "${session.name}" is protected. Please enter the passcode:`);
                if (passcode === null) return;
            }
            const attemptJoin = async (passcodeToTry) => {
                actionButton.textContent = 'Joining...';
                actionButton.disabled = true;
                try {
                    const joinResponse = await fetch(`/api/sessions/${session.id}/join`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': window.csrfTokenRaw },
                        body: JSON.stringify({ passcode: passcodeToTry })
                    });
                    const result = await joinResponse.json();
                    if (joinResponse.ok && result.redirect_url) {
                        if (session.access_level === 'protected' && passcodeToTry) {
                            savePasscode(session.id, passcodeToTry);
                        }
                        window.location.href = result.redirect_url;
                    } else {
                        if (joinResponse.status === 403) {
                            const newPasscode = prompt(`Incorrect passcode for "${session.name}". Please try again:`);
                            if (newPasscode !== null) await attemptJoin(newPasscode);
                            else {
                                actionButton.textContent = 'Join';
                                actionButton.disabled = false;
                            }
                        } else {
                            alert('Failed to join: ' + (result.detail || 'Unknown error'));
                            actionButton.textContent = 'Join';
                            actionButton.disabled = false;
                        }
                    }
                } catch (error) {
                    alert('An error occurred.');
                    actionButton.textContent = 'Join';
                    actionButton.disabled = false;
                }
            };
            await attemptJoin(passcode);
        };
    }
    listItem.appendChild(nameSpan);
    listItem.appendChild(actionButton);
    return listItem;
}

export function initializeDashboard() {
    const hostTabButton = document.getElementById('host-tab-button');
    const joinTabButton = document.getElementById('join-tab-button');
    const hostSessionView = document.getElementById('host-session-view');
    const joinSessionView = document.getElementById('join-session-view');

    if (!hostTabButton || !joinTabButton || !hostSessionView || !joinSessionView) return;

    const setActiveTab = (tabName) => {
        if (tabName === 'host') {
            hostTabButton.classList.add('text-blue-600', 'border-blue-500');
            hostTabButton.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            joinTabButton.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            joinTabButton.classList.remove('text-blue-600', 'border-blue-500');
            hostSessionView.classList.remove('hidden');
            joinSessionView.classList.add('hidden');
        } else {
            joinTabButton.classList.add('text-blue-600', 'border-blue-500');
            joinTabButton.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            hostTabButton.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            hostTabButton.classList.remove('text-blue-600', 'border-blue-500');
            joinSessionView.classList.remove('hidden');
            hostSessionView.classList.add('hidden');
        }
    };

    hostTabButton.addEventListener('click', () => setActiveTab('host'));
    joinTabButton.addEventListener('click', () => setActiveTab('join'));

    handleHostSessionForm();
}

export function handleHostSessionForm() {
    const form = document.getElementById('host-session-form');
    const accessSelect = document.getElementById('session-access');
    const passcodeGroup = document.getElementById('passcode-group');
    const passcode_input = document.getElementById('session-passcode');
    const button = document.getElementById('host-session-button');

    if (!form || !accessSelect || !passcodeGroup || !button) return;

    accessSelect.addEventListener('change', () => {
        if (accessSelect.value === 'protected') {
            passcodeGroup.classList.remove('hidden');
            passcode_input.required = true;
        } else {
            passcodeGroup.classList.add('hidden');
            passcode_input.required = false;
        }
    });

    button.addEventListener('click', async (event) => {
        event.preventDefault();
        
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        button.disabled = true;
        button.textContent = 'Hosting...';

        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/sessions/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': window.csrfTokenRaw },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (response.ok) {
                window.location.href = `/chat/${result.id}`;
            } else {
                alert(`Error: ${result.detail || 'Could not host session.'}`);
                button.disabled = false;
                button.textContent = 'Host New Session';
            }
        } catch (error) {
            alert('A network error occurred. Please try again.');
            button.disabled = false;
            button.textContent = 'Host New Session';
        }
    });
}

export function handleSessionSettings() {
    const settingsButton = document.getElementById('session-settings-button');
    const chatView = document.getElementById('chat-view');
    const settingsView = document.getElementById('session-settings-view');
    const backToChatButton = document.getElementById('back-to-chat-button');
    const sessionNameForDelete = document.getElementById('session-name-for-delete');
    const deleteConfirmationInput = document.getElementById('delete-confirmation');
    const deleteSessionButton = document.getElementById('delete-session-button');
    
    if (!settingsButton || !chatView || !settingsView || !backToChatButton || !sessionNameForDelete || !deleteConfirmationInput || !deleteSessionButton) return;

    const sessionId = window.location.pathname.split('/')[2];
    const currentUser = window.currentUserInfo;
    const sessionData = window.currentSessionData;
    
    if (currentUser && sessionData && currentUser.id === sessionData.host_user_id) {
        settingsButton.classList.remove('hidden');
    }

    settingsButton.addEventListener('click', () => {
        chatView.classList.add('hidden');
        settingsView.classList.remove('hidden');
        sessionNameForDelete.textContent = sessionData.name;
        deleteConfirmationInput.value = '';
        deleteSessionButton.disabled = true;
    });

    backToChatButton.addEventListener('click', () => {
        settingsView.classList.add('hidden');
        chatView.classList.remove('hidden');
    });

    deleteConfirmationInput.addEventListener('input', () => {
        deleteSessionButton.disabled = deleteConfirmationInput.value !== sessionData.name;
    });

    deleteSessionButton.addEventListener('click', async () => {
        try {
            const response = await fetch(`/api/sessions/${sessionId}/delete-by-host`, {
                method: 'DELETE',
                headers: { 'X-CSRF-Token': window.csrfTokenRaw }
            });
            if (response.ok) {
                alert("Session deleted successfully.");
                window.location.href = '/';
            } else {
                const error = await response.json();
                alert(`Error: ${error.detail}`);
            }
        } catch (err) {
            alert("An error occurred during deletion.");
        }
    });
}

export async function populateJoinableSessionList(apiEndpoint = '/api/sessions?scope=joinable', listElementId = 'joinable-session-list') {
    const sessionListElement = document.getElementById(listElementId);
    if (!sessionListElement) return;
    sessionListElement.innerHTML = '<li class="px-3 py-1 text-gray-500 italic text-sm">Loading...</li>';

    try {
        const response = await fetch(apiEndpoint);
        if (!response.ok) throw new Error('Failed to fetch sessions');
        
        const sessions = await response.json();
        if (sessions.length === 0) {
            sessionListElement.innerHTML = '<li class="px-3 py-1 text-gray-500 text-sm italic">No public sessions available.</li>';
        } else {
            sessionListElement.innerHTML = '';
            sessions.forEach(session => {
                sessionListElement.appendChild(createJoinableSessionListItem(session));
            });
        }
    } catch (error) {
        sessionListElement.innerHTML = `<li class="px-3 py-1 text-red-500 text-sm">Could not load sessions.</li>`;
    }
}

export async function updateAndDisplayParticipants(participants) {
    const participantList = document.getElementById('participant-list');
    if (!participantList) return;

    // Set a global flag to be used by the chat input
    window.isAiConfigured = false;

    if (!participants) {
        const sessionId = window.location.pathname.split('/')[2];
        if (!sessionId) return;
        try {
            const response = await fetch(`/api/sessions/${sessionId}/participants`);
            if (!response.ok) {
                participantList.innerHTML = '<li class="text-red-500 text-sm">Error loading participants.</li>';
                return;
            }
            participants = await response.json();
        } catch (error) {
            participantList.innerHTML = '<li class="text-red-500 text-sm">Could not load participants.</li>';
            return;
        }
    }

    window.participantInfo = {};
    participants.forEach(p => {
        window.participantInfo[p.id] = { initials: p.initials, color: p.color, name: p.name };
        if (window.currentUserInfo && window.currentUserInfo.id === p.id) {
            window.currentUserInfo.color = p.color;
        }
    });

    const sessionData = window.currentSessionData;
    const hostId = sessionData ? sessionData.host_user_id : null;

    participantList.innerHTML = '';
    participants.forEach(user => {
        const li = document.createElement('li');
        li.className = 'flex items-center space-x-2';
        const avatar = document.createElement('div');
        avatar.className = 'w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-gray-700';
        avatar.style.backgroundColor = user.color;
        avatar.textContent = user.initials;
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'text-sm text-gray-600';
        nameSpan.textContent = user.name;
        
        if (user.id === hostId) {
            const hostLabel = document.createElement('span');
            hostLabel.className = 'text-xs text-gray-500 font-semibold ml-1';
            hostLabel.textContent = '(Host)';
            nameSpan.appendChild(hostLabel);
        }
        
        li.appendChild(avatar);
        li.appendChild(nameSpan);
        participantList.appendChild(li);
    });

    try {
        const settingsResponse = await fetch('/api/me/llm-settings');
        if (settingsResponse.ok) {
            const settings = await settingsResponse.json();
            if (settings.is_llm_ready) {
                window.isAiConfigured = true; // Set the flag
                window.participantInfo['AI'] = { initials: 'AI', color: '#E0F2FE', name: 'AI Assistant' };
                const aiLi = document.createElement('li');
                aiLi.className = 'flex items-center space-x-2';
                const aiAvatar = document.createElement('div');
                aiAvatar.className = 'w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-gray-700 italic';
                aiAvatar.style.backgroundColor = window.participantInfo['AI'].color;
                aiAvatar.textContent = 'AI';
                const aiNameSpan = document.createElement('span');
                aiNameSpan.className = 'text-sm text-gray-600 italic';
                aiNameSpan.textContent = 'AI Assistant';
                aiLi.appendChild(aiAvatar);
                aiLi.appendChild(aiNameSpan);
                participantList.appendChild(aiLi);
            }
        }
    } catch (error) {
        console.error("Could not check LLM configuration:", error);
    }
}

export function connectToLobbySocket() {
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/lobby`;
    const lobbyWs = new WebSocket(wsUrl);

    lobbyWs.onmessage = (event) => {
        try {
            const message = JSON.parse(event.data);
            const sessionListElement = document.getElementById('joinable-session-list');
            if (!sessionListElement) return;

            if (message.type === 'new_public_session') {
                const session = message.payload;
                const placeholder = sessionListElement.querySelector('li.italic');
                if (placeholder) placeholder.remove();
                
                if (!sessionListElement.querySelector(`[data-session-id="${session.id}"]`)) {
                    const newItem = createJoinableSessionListItem(session);
                    sessionListElement.prepend(newItem);
                }
            } else if (message.type === 'session_deleted') {
                const itemToRemove = sessionListElement.querySelector(`[data-session-id="${message.payload.session_id}"]`);
                if (itemToRemove) itemToRemove.remove();
            }
        } catch (e) { console.error("Error processing lobby message:", e); }
    };

    lobbyWs.onclose = () => {
        console.log("Lobby WebSocket closed. Reconnecting in 5 seconds...");
        setTimeout(connectToLobbySocket, 5000);
    };
    lobbyWs.onerror = (err) => {
        console.error("Lobby WebSocket error:", err);
    };
}
// --- End: session-manager.js ---

=== app/static/js/settings.js ===
// app/static/js/settings.js
import { loadSidebarHTML, populateSessionList } from '/static/js/app-ui.js';

/**
 * Retrieves a cookie value by its name.
 * @param {string} name The name of the cookie to retrieve.
 * @returns {string|null} The cookie value, or null if not found.
 */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', async () => {
    console.log("Settings Page: DOMContentLoaded.");

    // Ensure sidebar is scrollable using the class defined in input.css
    const sidebarLoaderTarget = document.getElementById('sidebar-loader-target');
    if (sidebarLoaderTarget) {
        sidebarLoaderTarget.classList.add('sidebar-scrollable');
    }

    const sidebarLoaded = await loadSidebarHTML('/static/_sidebar.html', 'sidebar-loader-target');
    if (sidebarLoaded) {
        await populateSessionList('/api/sessions', 'session-list', '/chat/');
    } else {
        console.error("Settings Page: Sidebar loading failed.");
    }

    const settingsMessageArea = document.getElementById('settings-message-area');

    /**
     * Displays a message in the settings message area and focuses it.
     * @param {string} message The message to display.
     * @param {string} type The type of message ('info', 'success', 'error').
     * @param {number} duration Time in ms to display the message (0 for indefinite).
     * @param {HTMLElement|null} elementToFocusAfter An optional element to return focus to after message timeout.
     */
    function showSettingsMessage(message, type = 'info', duration = 0, elementToFocusAfter = null) {
        settingsMessageArea.textContent = message;
        settingsMessageArea.className = 'py-3 px-4 rounded-md text-center mb-4 text-sm'; // Reset classes
        if (type === 'success') {
            settingsMessageArea.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
        } else if (type === 'error') {
            settingsMessageArea.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
        } else { // 'info' or default
            settingsMessageArea.classList.add('bg-blue-100', 'text-blue-700', 'border', 'border-blue-300');
        }
        settingsMessageArea.style.display = 'block';

        settingsMessageArea.setAttribute('tabindex', '-1');
        settingsMessageArea.focus();

        if (duration > 0) {
            setTimeout(() => {
                settingsMessageArea.style.display = 'none';
                settingsMessageArea.removeAttribute('tabindex');
                if (elementToFocusAfter && typeof elementToFocusAfter.focus === 'function') {
                    elementToFocusAfter.focus();
                }
            }, duration);
        }
    }

    const currentNameInput = document.getElementById('current-name');
    const currentEmailInput = document.getElementById('current-email');

    async function fetchCurrentUser() {
        try {
            const response = await fetch('/api/me', { cache: 'no-store' });
            if (response.ok) {
                const userData = await response.json();
                if (currentNameInput) currentNameInput.value = userData.name;
                if (currentEmailInput) currentEmailInput.value = userData.email;
                window.currentUserDetails = userData;
            } else {
                showSettingsMessage('Could not load your current user details.', 'error', 0, document.body);
                if (currentNameInput) currentNameInput.value = 'Error loading';
                if (currentEmailInput) currentEmailInput.value = 'Error loading';
            }
        } catch (error) {
            console.error("Error fetching current user:", error);
            showSettingsMessage('An error occurred while loading your details.', 'error', 0, document.body);
        }
    }
    await fetchCurrentUser();

    // --- Account Settings Forms (Keep existing logic for these) ---
    const updateNameForm = document.getElementById('update-name-form');
    if (updateNameForm) {
        const newNameInput = document.getElementById('new-name');
        updateNameForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            settingsMessageArea.style.display = 'none';
            const updateNameButton = document.getElementById('update-name-button');
            updateNameButton.disabled = true;
            updateNameButton.textContent = 'Updating...';
            const newName = newNameInput.value;
            const currentPasswordForName = document.getElementById('current-password-for-name');
            const currentPassword = currentPasswordForName.value;
            // Use window.csrfTokenRaw which should be populated by the server
            const csrfToken = window.csrfTokenRaw; 
            let focusTargetAfterMessage = newNameInput;

            if (!csrfToken || csrfToken === "%%CSRF_TOKEN_RAW%%") {
                showSettingsMessage('CSRF token missing. Cannot update name. Please refresh.', 'error', 0, updateNameButton);
                updateNameButton.disabled = false;
                updateNameButton.textContent = 'Update Name';
                return;
            }

            try {
                const response = await fetch('/api/me/update-name', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ new_name: newName, current_password: currentPassword })
                });
                const result = await response.json();
                if (response.ok) {
                    showSettingsMessage(result.message || 'Name updated successfully!', 'success', 3000, newNameInput);
                    if (currentNameInput) currentNameInput.value = result.new_name;
                    currentPasswordForName.value = '';
                    newNameInput.value = '';
                } else {
                    focusTargetAfterMessage = result.field === 'current_password' ? currentPasswordForName : newNameInput;
                    showSettingsMessage(result.detail || 'Failed to update name.', 'error', 0, focusTargetAfterMessage);
                }
            } catch (error) {
                console.error("Error updating name:", error);
                showSettingsMessage('An error occurred. Please try again.', 'error', 0, newNameInput);
            } finally {
                updateNameButton.disabled = false;
                updateNameButton.textContent = 'Update Name';
            }
        });
    }

    const updateEmailForm = document.getElementById('update-email-form');
    if (updateEmailForm) {
        const newEmailInput = document.getElementById('new-email');
        updateEmailForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            settingsMessageArea.style.display = 'none';
            const updateEmailButton = document.getElementById('update-email-button');
            updateEmailButton.disabled = true;
            updateEmailButton.textContent = 'Updating Email...';
            const newEmail = newEmailInput.value;
            const currentPasswordForEmail = document.getElementById('current-password-for-email');
            const currentPassword = currentPasswordForEmail.value;
            const csrfToken = window.csrfTokenRaw; // Use window.csrfTokenRaw
            let focusTargetAfterMessage = newEmailInput;

            if (!csrfToken || csrfToken === "%%CSRF_TOKEN_RAW%%") {
                showSettingsMessage('CSRF token missing. Cannot update email. Please refresh.', 'error', 0, updateEmailButton);
                updateEmailButton.disabled = false;
                updateEmailButton.textContent = 'Update Email Address';
                return;
            }

            try {
                const response = await fetch('/api/me/update-email', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ new_email: newEmail, current_password: currentPassword })
                });
                const result = await response.json();
                if (response.ok) {
                    showSettingsMessage(result.message || 'Email updated. Logging out...', 'success', 0);
                    setTimeout(() => { window.location.href = '/logout'; }, 4000);
                } else {
                    focusTargetAfterMessage = result.field === 'current_password' ? currentPasswordForEmail : newEmailInput;
                    showSettingsMessage(result.detail || 'Failed to update email.', 'error', 0, focusTargetAfterMessage);
                    updateEmailButton.disabled = false;
                    updateEmailButton.textContent = 'Update Email Address';
                }
            } catch (error) {
                console.error("Error updating email:", error);
                showSettingsMessage('An error occurred. Please try again.', 'error', 0, newEmailInput);
                updateEmailButton.disabled = false;
                updateEmailButton.textContent = 'Update Email Address';
            }
        });
    }

    const regeneratePasswordForm = document.getElementById('regenerate-password-form');
    if (regeneratePasswordForm) {
        const currentPasswordForRegen = document.getElementById('current-password-for-regen');
        regeneratePasswordForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            settingsMessageArea.style.display = 'none';
            const regeneratePasswordButton = document.getElementById('regenerate-password-button');
            regeneratePasswordButton.disabled = true;
            regeneratePasswordButton.textContent = 'Regenerating...';
            const currentPassword = currentPasswordForRegen.value;
            const csrfToken = window.csrfTokenRaw; // Use window.csrfTokenRaw

            if (!csrfToken || csrfToken === "%%CSRF_TOKEN_RAW%%") {
                showSettingsMessage('CSRF token missing. Cannot regenerate password. Please refresh.', 'error', 0, regeneratePasswordButton);
                regeneratePasswordButton.disabled = false;
                regeneratePasswordButton.textContent = 'Regenerate Password & Send Email';
                return;
            }

            try {
                const response = await fetch('/api/me/regenerate-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ current_password: currentPassword })
                });
                const result = await response.json();
                if (response.ok) {
                    showSettingsMessage(result.message || 'Password regenerated. Check email. Logging out...', 'success', 0);
                    setTimeout(() => { window.location.href = '/logout'; }, 4000);
                } else {
                    showSettingsMessage(result.detail || 'Failed to regenerate password.', 'error', 0, currentPasswordForRegen);
                    regeneratePasswordButton.disabled = false;
                    regeneratePasswordButton.textContent = 'Regenerate Password & Send Email';
                }
            } catch (error) {
                console.error("Error regenerating password:", error);
                showSettingsMessage('An error occurred. Please try again.', 'error', 0, currentPasswordForRegen);
                regeneratePasswordButton.disabled = false;
                regeneratePasswordButton.textContent = 'Regenerate Password & Send Email';
            }
        });
    }

    // --- LLM Settings Functionality ---
    const llmProviderSelect = document.getElementById('llm-provider');
    const llmModelSelect = document.getElementById('llm-model');
    const llmApiKeyGroup = document.getElementById('llm-api-key-group');
    const llmApiKeyInput = document.getElementById('llm-api-key');
    const llmApiKeyStatus = document.getElementById('llm-api-key-status');
    const llmBaseUrlGroup = document.getElementById('llm-base-url-group');
    const llmBaseUrlInput = document.getElementById('llm-base-url');
    const llmProviderStatus = document.getElementById('llm-provider-status');
    const saveLLMSettingsButton = document.getElementById('save-llm-settings-button');
    const llmSettingsForm = document.getElementById('llm-settings-form');

    let availableProvidersData = []; // To store fetched provider details, including their models

    /**
     * Loads initial LLM configuration data: available providers and current user's LLM settings.
     * Populates the provider dropdown and sets initial values for other fields.
     */
    async function loadLLMConfigData() {
        if (!llmProviderSelect || !llmModelSelect) {
            console.error("LLM configuration select elements not found in the DOM.");
            return;
        }
        try {
            // Fetch all available providers and their details (including models)
            const providersResponse = await fetch('/api/llm/providers');
            if (!providersResponse.ok) {
                showSettingsMessage('Failed to load LLM providers configuration.', 'error', 0, llmProviderSelect);
                llmProviderSelect.innerHTML = '<option value="">Error loading providers</option>';
                llmModelSelect.innerHTML = '<option value="">-- Select Provider First --</option>';
                llmModelSelect.disabled = true;
                return;
            }
            availableProvidersData = await providersResponse.json(); // Store for later use

            // Fetch the current user's saved LLM settings
            const userSettingsResponse = await fetch('/api/me/llm-settings', { cache: 'no-store' });
            const currentUserLLMSettings = userSettingsResponse.ok ? await userSettingsResponse.json() : {};
            
            if (!userSettingsResponse.ok && availableProvidersData.length > 0) {
                showSettingsMessage('Could not load your saved LLM settings. Defaults may be shown.', 'error', 4000, llmProviderSelect);
            }

            // Populate the providers dropdown
            populateLLMProviders(currentUserLLMSettings.selected_llm_provider_id);

            // Set the initially selected provider (if any)
            const effectiveProviderId = currentUserLLMSettings.selected_llm_provider_id || "";
            if (llmProviderSelect.querySelector(`option[value="${effectiveProviderId}"]`)) {
                 llmProviderSelect.value = effectiveProviderId;
            } else {
                llmProviderSelect.value = ""; // Default to "Select Provider"
            }
           

            // Update model dropdown and other fields based on the (potentially) selected provider
            updateModelDropdown(llmProviderSelect.value, currentUserLLMSettings.selected_llm_model_id, currentUserLLMSettings);
            updateProviderSpecificFields(llmProviderSelect.value, currentUserLLMSettings);

        } catch (error) {
            console.error("Error loading LLM configuration:", error);
            showSettingsMessage('A critical error occurred while loading LLM configuration.', 'error', 0, llmProviderSelect);
            llmProviderSelect.innerHTML = '<option value="">Error</option>';
            llmModelSelect.innerHTML = '<option value="">Error</option>';
            llmModelSelect.disabled = true;
        }
    }

    /**
     * Populates the LLM Provider dropdown.
     * @param {string|null} currentProviderId The ID of the currently selected provider (to pre-select it).
     */
    function populateLLMProviders(currentProviderId) {
        llmProviderSelect.innerHTML = '<option value="">-- Select Provider --</option>'; // Default empty option
        availableProvidersData.forEach(provider => {
            // You might have filtering logic here if needed, e.g., based on provider.is_system_configured
            const option = document.createElement('option');
            option.value = provider.id;
            option.textContent = provider.display_name;
            if (provider.id === currentProviderId) {
                option.selected = true;
            }
            llmProviderSelect.appendChild(option);
        });
    }

    /**
     * Updates the LLM Model dropdown based on the selected provider.
     * Enables or disables the model dropdown accordingly.
     * @param {string} providerId The ID of the selected provider.
     * @param {string|null} currentModelId The ID of the currently selected model (to pre-select it).
     * @param {object} userSettings The current user's LLM settings (for context).
     */
    function updateModelDropdown(providerId, currentModelId, userSettings = {}) {
        llmModelSelect.innerHTML = '<option value="">-- Select Model --</option>'; // Default empty option
        const selectedProvider = availableProvidersData.find(p => p.id === providerId);

        if (selectedProvider && selectedProvider.available_models && selectedProvider.available_models.length > 0) {
            llmModelSelect.disabled = false; // *** ENABLE the dropdown ***
            selectedProvider.available_models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.model_id;
                // Display both name and ID for clarity, especially if names are not unique across providers
                option.textContent = model.display_name ? `${model.display_name} (${model.model_id})` : model.model_id;
                
                // Pre-select if this model was the user's saved choice for this provider
                if (providerId === userSettings.selected_llm_provider_id && model.model_id === currentModelId) {
                    option.selected = true;
                }
                llmModelSelect.appendChild(option);
            });
        } else if (providerId) { // Provider selected, but no models
            llmModelSelect.innerHTML = '<option value="">No models available for this provider</option>';
            llmModelSelect.disabled = true; // *** DISABLE if no models ***
        } else { // No provider selected
            llmModelSelect.innerHTML = '<option value="">-- Select Provider First --</option>';
            llmModelSelect.disabled = true; // *** DISABLE if no provider selected ***
        }
    }

    /**
     * Updates provider-specific fields (API key, base URL) based on the selected provider.
     * @param {string} providerId The ID of the selected provider.
     * @param {object} userSettings The current user's LLM settings.
     */
    function updateProviderSpecificFields(providerId, userSettings = {}) {
        const selectedProvider = availableProvidersData.find(p => p.id === providerId);

        // Hide all optional groups by default
        llmApiKeyGroup.style.display = 'none';
        llmApiKeyGroup.setAttribute('aria-hidden', 'true');
        llmBaseUrlGroup.style.display = 'none';
        llmBaseUrlGroup.setAttribute('aria-hidden', 'true');

        // Reset fields and status messages
        llmProviderStatus.textContent = providerId ? "Loading provider details..." : "Select a provider to see more options.";
        llmApiKeyInput.value = '';
        llmApiKeyInput.placeholder = '';
        llmApiKeyStatus.textContent = '';
        llmBaseUrlInput.value = '';
        llmBaseUrlInput.placeholder = '';

        if (selectedProvider) {
            // API Key field visibility and status
            if (selectedProvider.can_accept_user_api_key) { // Check if provider *can* accept a user key
                llmApiKeyGroup.style.display = 'block';
                llmApiKeyGroup.setAttribute('aria-hidden', 'false');
                if (userSettings.has_user_api_key && selectedProvider.id === userSettings.selected_llm_provider_id) {
                    llmApiKeyInput.placeholder = "•••••••• (A key is currently saved)";
                    llmApiKeyStatus.textContent = "A key is saved. Edit to change, or clear field and save to remove your key.";
                } else if (selectedProvider.is_system_configured && selectedProvider.needs_api_key_from_user === false) {
                    // System has a key, and user doesn't strictly need to provide one, but can.
                    llmApiKeyInput.placeholder = "API Key (Optional - System key available)";
                    llmApiKeyStatus.textContent = "A system key is configured. You can provide your own to override it for your account.";
                } else if (selectedProvider.needs_api_key_from_user === true) {
                    llmApiKeyInput.placeholder = "API Key (Required)";
                    llmApiKeyStatus.textContent = "Please enter your API key for this provider.";
                } else { // Can accept, but not strictly required and no system key (e.g. some local models)
                    llmApiKeyInput.placeholder = "API Key (Optional)";
                    llmApiKeyStatus.textContent = "You can optionally provide an API key.";
                }
            }

            // Base URL field visibility and status
            if (selectedProvider.can_accept_user_base_url) { // Check if provider *can* accept a user base URL
                llmBaseUrlGroup.style.display = 'block';
                llmBaseUrlGroup.setAttribute('aria-hidden', 'false');
                if (selectedProvider.id === userSettings.selected_llm_provider_id && userSettings.selected_llm_base_url) {
                    llmBaseUrlInput.value = userSettings.selected_llm_base_url;
                }
                // Provide more specific placeholders based on provider type if available
                if (selectedProvider.type === 'ollama') {
                    llmBaseUrlInput.placeholder = "e.g., http://localhost:11434 (uses system default if empty)";
                } else if (selectedProvider.type === 'openai_compatible_server') {
                    llmBaseUrlInput.placeholder = "e.g., https://api.example.com/v1 (Required if no system default)";
                } else {
                    llmBaseUrlInput.placeholder = "Custom Base URL (Optional)";
                }
            }

            // General provider status message
            if (!selectedProvider.is_system_configured && selectedProvider.needs_api_key_from_user === true) {
                llmProviderStatus.textContent = "This provider requires configuration (e.g., an API key).";
            } else if (selectedProvider.is_system_configured && selectedProvider.needs_api_key_from_user === false) {
                llmProviderStatus.textContent = "This provider is system-configured and ready to use.";
            } else if (selectedProvider.can_accept_user_api_key || selectedProvider.can_accept_user_base_url) {
                llmProviderStatus.textContent = "This provider can be customized with your own API key or base URL.";
            } else {
                llmProviderStatus.textContent = "This provider does not require additional configuration.";
            }

        } else if (providerId === "") { // "-- Select Provider --" is chosen
             llmProviderStatus.textContent = "Select a provider to see configuration options.";
        }
    }

    // Event listener for when the LLM provider selection changes
    llmProviderSelect.addEventListener('change', async (event) => {
        const selectedProviderId = event.target.value;
        
        // Fetch the latest user settings as they might have changed or to get defaults for the new provider
        const userSettingsResponse = await fetch('/api/me/llm-settings', {cache: 'no-store'});
        const currentUserLLMSettings = userSettingsResponse.ok ? await userSettingsResponse.json() : {};

        // Determine which model should be pre-selected.
        // If the newly selected provider is the same as the user's saved provider, use their saved model.
        // Otherwise, no specific model is pre-selected (will default to "-- Select Model --").
        const modelToSelect = (selectedProviderId === currentUserLLMSettings.selected_llm_provider_id)
                                ? currentUserLLMSettings.selected_llm_model_id
                                : null; // Let updateModelDropdown handle the default "-- Select Model --"

        updateModelDropdown(selectedProviderId, modelToSelect, currentUserLLMSettings);
        updateProviderSpecificFields(selectedProviderId, currentUserLLMSettings);
    });

    // Event listener for saving LLM settings
    llmSettingsForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        settingsMessageArea.style.display = 'none';
        saveLLMSettingsButton.disabled = true;
        saveLLMSettingsButton.textContent = 'Saving...';
        const csrfToken = window.csrfTokenRaw; // Use the globally available raw CSRF token

        if (!csrfToken || csrfToken === "%%CSRF_TOKEN_RAW%%") {
            showSettingsMessage('CSRF token missing. Cannot save settings. Please refresh.', 'error', 0, saveLLMSettingsButton);
            saveLLMSettingsButton.disabled = false;
            saveLLMSettingsButton.textContent = 'Save LLM Settings';
            return;
        }

        const providerId = llmProviderSelect.value;
        const modelId = llmModelSelect.value;
        // Only include API key if the input group is visible (meaning provider accepts it)
        const apiKey = (llmApiKeyGroup.style.display !== 'none') ? llmApiKeyInput.value : undefined;
        // Only include base URL if the input group is visible
        const baseUrl = (llmBaseUrlGroup.style.display !== 'none') ? llmBaseUrlInput.value : undefined;

        const payload = {
            selected_llm_provider_id: providerId || null, // Send null if empty string
            selected_llm_model_id: modelId || null,     // Send null if empty string
        };

        // Conditionally add api_key and base_url to the payload
        // The backend expects `user_llm_api_key` and `selected_llm_base_url`
        if (apiKey !== undefined) { // Check for undefined, empty string means "clear the key"
            payload.user_llm_api_key = apiKey;
        }
        if (baseUrl !== undefined) { // Check for undefined, empty string means "clear the base URL"
            payload.selected_llm_base_url = baseUrl || null; // Send null if empty string
        }

        try {
            const response = await fetch('/api/me/llm-settings', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (response.ok) {
                showSettingsMessage('LLM settings saved successfully!', 'success', 3000, saveLLMSettingsButton);
                // Reload the config data to reflect saved settings (e.g., has_user_api_key status)
                await loadLLMConfigData(); 
            } else {
                let fieldToFocus = llmProviderSelect;
                if (result.detail && typeof result.detail === 'string') {
                    if (result.detail.toLowerCase().includes('model')) fieldToFocus = llmModelSelect;
                    else if (result.detail.toLowerCase().includes('api key')) fieldToFocus = llmApiKeyInput;
                    else if (result.detail.toLowerCase().includes('base url')) fieldToFocus = llmBaseUrlInput;
                }
                showSettingsMessage(result.detail || 'Failed to save LLM settings.', 'error', 0, fieldToFocus);
            }
        } catch (error) {
            console.error("Error saving LLM settings:", error);
            showSettingsMessage('An error occurred while saving LLM settings.', 'error', 0, saveLLMSettingsButton);
        } finally {
            saveLLMSettingsButton.disabled = false;
            saveLLMSettingsButton.textContent = 'Save LLM Settings';
        }
    });

    // Initial load of LLM configuration when the page is ready
    await loadLLMConfigData(); 
});


=== app/static/js/sidebar-toggle.js ===
export function initializeSidebarToggle() {
    const sidebar = document.getElementById('sidebar-loader-target');
    const toggleButton = document.getElementById('sidebar-toggle');
    const toggleIcon = document.getElementById('sidebar-toggle-icon');

    if (!sidebar || !toggleButton || !toggleIcon) {
        console.error("Sidebar toggle elements not found.");
        return;
    }

    toggleButton.addEventListener('click', () => {
        sidebar.classList.toggle('sidebar-collapsed');
        toggleButton.classList.toggle('collapsed');
        toggleIcon.classList.toggle('collapsed');
    });
}


=== app/static/js/temp.js ===
// Add these new state variables at the top with other state variables
let activeStreamingCodeBlocks = new Map(); // blockId -> { element, language, content }
let streamingCodeBlockCounter = 0;

// Replace the renderLiveMessage function
function renderLiveMessage(fullContent) {
    if (!currentAiTurnContainer) return;

    if (!firstAnswerTokenReceived && fullContent.trim().length > 0) {
        if (currentAnswerElement && currentAnswerElement.style.display === 'none') {
            currentAnswerElement.style.display = '';
        }
        const loadingDots = currentAnswerElement ? currentAnswerElement.querySelector('.loading-dots') : null;
        if (loadingDots) loadingDots.remove();
        firstAnswerTokenReceived = true;
    }

    const contentArea = currentAnswerElement.querySelector('.live-ai-content-area');
    const codeArea = currentCodeBlocksArea;

    if (!contentArea || !codeArea) return;
    
    parseAndRenderStreamingContent(fullContent, contentArea, codeArea, currentTurnId);
    scrollToBottom('auto');
}

// New function to handle streaming content with live code block creation
function parseAndRenderStreamingContent(contentString, answerBubbleContentElement, codeBlocksDivElement, turnIdSuffix) {
    if (!contentString || !answerBubbleContentElement || !codeBlocksDivElement) return;

    let processedContent = contentString;
    const codeBlockRegex = /```(\w*)\n?([\s\S]*?)(?:\n```|$)/g;
    let match;
    let lastIndex = 0;
    let contentWithPlaceholders = '';

    // Process each code block
    while ((match = codeBlockRegex.exec(contentString)) !== null) {
        const [fullMatch, language, code] = match;
        const isComplete = fullMatch.endsWith('\n```') || fullMatch.endsWith('```');
        
        // Add content before this code block
        contentWithPlaceholders += contentString.substring(lastIndex, match.index);
        
        const blockId = `streaming-code-block-turn${turnIdSuffix}-${++streamingCodeBlockCounter}`;
        
        if (!activeStreamingCodeBlocks.has(blockId)) {
            // Create new streaming code block
            createStreamingCodeBlock(language || 'plaintext', blockId, codeBlocksDivElement, turnIdSuffix, streamingCodeBlockCounter);
            activeStreamingCodeBlocks.set(blockId, {
                language: language || 'plaintext',
                content: code,
                isComplete: isComplete
            });
        } else {
            // Update existing streaming code block
            const blockData = activeStreamingCodeBlocks.get(blockId);
            blockData.content = code;
            blockData.isComplete = isComplete;
            updateStreamingCodeBlockContent(blockId, code, isComplete);
        }
        
        // Add placeholder reference
        contentWithPlaceholders += ` [Code Block ${streamingCodeBlockCounter}] `;
        lastIndex = codeBlockRegex.lastIndex;
    }
    
    // Add remaining content after last code block
    contentWithPlaceholders += contentString.substring(lastIndex);
    
    // Handle KaTeX and render markdown for non-code content
    const KATEX_PLACEHOLDER_PREFIX_STREAMING = `%%STREAMING_KATEX_PLACEHOLDER_${turnIdSuffix}_`;
    const storedKatex = {};
    let katexPlaceholderIndex = 0;
    
    const katexRegexGlobal = /(?<!\\)\$\$([\s\S]+?)(?<!\\)\$\$|(?<!\\)\$((?:\\\$|[^$])+?)(?<!\\)\$/g;
    let textForMarkdownParsing = contentWithPlaceholders.replace(katexRegexGlobal, (match, displayContent, inlineContent) => {
        const isDisplayMode = !!displayContent;
        const katexString = displayContent || inlineContent;
        const cleanedKatexString = katexString.replace(/\\([$])/g, '$1');
        let katexHtml = '';
        try {
            katexHtml = katex.renderToString(cleanedKatexString, {
                displayMode: isDisplayMode, throwOnError: false, output: "html", strict: false
            });
        } catch (e) {
            katexHtml = `<span class="katex-error" title="${escapeHTML(e.toString())}">${escapeHTML(match)}</span>`;
        }
        const placeholderId = `${KATEX_PLACEHOLDER_PREFIX_STREAMING}${katexPlaceholderIndex++}`;
        storedKatex[placeholderId] = katexHtml;
        return placeholderId;
    });

    answerBubbleContentElement.innerHTML = marked.parse(textForMarkdownParsing);

    // Restore KaTeX content
    if (Object.keys(storedKatex).length > 0) {
        const walker = document.createTreeWalker(answerBubbleContentElement, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const textNodesToModify = [];
        while (node = walker.nextNode()) {
            if (node.nodeValue && node.nodeValue.includes(KATEX_PLACEHOLDER_PREFIX_STREAMING)) {
                textNodesToModify.push(node);
            }
        }
        textNodesToModify.forEach(textNode => {
            let currentTextValue = textNode.nodeValue;
            const parent = textNode.parentNode;
            if (!parent) return;
            const fragment = document.createDocumentFragment();
            let lastSplitEnd = 0;
            const placeholderScanRegex = new RegExp(`(${KATEX_PLACEHOLDER_PREFIX_STREAMING}\\d+)`, 'g');
            let placeholderMatch;
            while((placeholderMatch = placeholderScanRegex.exec(currentTextValue)) !== null) {
                const placeholderId = placeholderMatch[1];
                const matchStartIndex = placeholderMatch.index;
                if (matchStartIndex > lastSplitEnd) {
                    fragment.appendChild(document.createTextNode(currentTextValue.substring(lastSplitEnd, matchStartIndex)));
                }
                if (storedKatex[placeholderId]) {
                    const katexWrapperSpan = document.createElement('span');
                    katexWrapperSpan.innerHTML = storedKatex[placeholderId];
                    fragment.appendChild(katexWrapperSpan.firstChild || katexWrapperSpan);
                } else {
                    fragment.appendChild(document.createTextNode(placeholderId));
                }
                lastSplitEnd = placeholderScanRegex.lastIndex;
            }
            if (lastSplitEnd < currentTextValue.length) {
                fragment.appendChild(document.createTextNode(currentTextValue.substring(lastSplitEnd)));
            }
            parent.replaceChild(fragment, textNode);
        });
    }
}

// New function to create streaming code blocks immediately
function createStreamingCodeBlock(language, blockId, codeBlocksAreaElement, turnIdSuffix, codeBlockIndex) {
    if (!codeBlocksAreaElement) {
        console.error("createStreamingCodeBlock: Code blocks area element is null!");
        return;
    }

    const safeLanguage = (language || '').trim().toLowerCase() || 'plaintext';
    const langAlias = {
        'python': 'python', 'py': 'python', 'javascript': 'javascript', 'js': 'javascript',
        'html': 'markup', 'xml': 'markup', 'svg': 'markup', 'css': 'css', 'bash': 'bash',
        'sh': 'bash', 'shell': 'bash', 'json': 'json', 'yaml': 'yaml', 'yml': 'yaml',
        'markdown': 'markdown', 'md': 'markdown', 'sql': 'sql', 'java': 'java', 'c': 'c',
        'cpp': 'cpp', 'c++': 'cpp', 'csharp': 'csharp', 'cs': 'csharp', 'go': 'go',
        'rust': 'rust', 'php': 'php', 'ruby': 'ruby', 'rb': 'ruby',
        'dockerfile': 'docker', 'docker': 'docker', 'typescript': 'typescript', 'ts': 'typescript',
        'plaintext': 'plain', 'text': 'plain',
    };
    const prismLang = langAlias[safeLanguage] || safeLanguage;
    const displayLang = safeLanguage;

    const isLanguageSupported = supportedLanguagesConfig[displayLang]?.executable;
    const playIconSvg = `<svg viewBox="0 0 100 100" fill="currentColor" width="1em" height="1em" style="display: block;"><polygon points="0,0 100,50 0,100"/></svg>`;

    const container = document.createElement('div');
    container.classList.add('block-container');
    container.id = blockId;
    container.dataset.language = displayLang;

    const codeHeader = document.createElement('div');
    codeHeader.classList.add('block-header');

    const codeButtonsDiv = document.createElement('div');
    codeButtonsDiv.classList.add('block-buttons');

    const runStopBtn = document.createElement('button');
    runStopBtn.classList.add('run-code-btn', 'block-action-btn');
    runStopBtn.dataset.status = 'idle';
    runStopBtn.innerHTML = playIconSvg;
    runStopBtn.title = 'Run Code';
    runStopBtn.addEventListener('click', handleRunStopCodeClick);

    const toggleCodeBtn = document.createElement('button');
    toggleCodeBtn.classList.add('toggle-code-btn', 'block-action-btn');
    toggleCodeBtn.textContent = 'Hide';
    toggleCodeBtn.title = 'Show/Hide Code';

    const copyCodeBtn = document.createElement('button');
    copyCodeBtn.classList.add('copy-code-btn', 'block-action-btn');
    copyCodeBtn.textContent = 'Copy';
    copyCodeBtn.title = 'Copy Code';

    if (!isLanguageSupported) {
        runStopBtn.style.display = 'none';
        runStopBtn.title = `Run Code (language '${displayLang}' not supported for execution)`;
    }

    codeButtonsDiv.appendChild(runStopBtn);
    codeButtonsDiv.appendChild(toggleCodeBtn);
    codeButtonsDiv.appendChild(copyCodeBtn);

    const codeTitle = document.createElement('span');
    codeTitle.classList.add('block-title');
    const titleTextSpan = document.createElement('span');
    titleTextSpan.classList.add('title-text');
    titleTextSpan.textContent = `Code Block ${codeBlockIndex} (${displayLang})`;
    const dotsSpan = document.createElement('span');
    dotsSpan.classList.add('streaming-dots');
    dotsSpan.textContent = '...';
    codeTitle.appendChild(titleTextSpan);
    codeTitle.appendChild(dotsSpan);
    codeTitle.style.flexGrow = '1';
    codeTitle.style.textAlign = 'left';

    codeHeader.appendChild(codeButtonsDiv);
    codeHeader.appendChild(codeTitle);

    const preElement = document.createElement('pre');
    preElement.classList.add('manual');
    const codeElement = document.createElement('code');
    codeElement.className = `language-${prismLang}`;
    codeElement.setAttribute('contenteditable', 'true');
    codeElement.setAttribute('spellcheck', 'false');
    codeElement.textContent = '';

    // Create output area structure (same as before)
    const outputHeader = document.createElement('div');
    outputHeader.classList.add('block-header');
    outputHeader.style.display = 'none';
    
    const outputButtonsDiv = document.createElement('div');
    outputButtonsDiv.classList.add('block-buttons');
    const placeholderSpan = document.createElement('span');
    placeholderSpan.classList.add('output-header-button-placeholder');
    outputButtonsDiv.appendChild(placeholderSpan);
    
    const toggleOutputBtn = document.createElement('button');
    toggleOutputBtn.classList.add('toggle-output-btn', 'block-action-btn');
    toggleOutputBtn.textContent = 'Hide';
    toggleOutputBtn.title = 'Show/Hide Output';
    
    const copyOutputBtn = document.createElement('button');
    copyOutputBtn.classList.add('copy-output-btn', 'block-action-btn');
    copyOutputBtn.textContent = 'Copy';
    copyOutputBtn.title = 'Copy Output';
    
    outputButtonsDiv.appendChild(toggleOutputBtn);
    outputButtonsDiv.appendChild(copyOutputBtn);
    
    const outputTitle = document.createElement('span');
    outputTitle.classList.add('block-title');
    outputTitle.textContent = `Output Code Block ${codeBlockIndex}`;
    
    const codeStatusSpan = document.createElement('span');
    codeStatusSpan.classList.add('block-status');
    codeStatusSpan.textContent = 'Idle';
    
    outputHeader.appendChild(outputButtonsDiv);
    outputHeader.appendChild(outputTitle);
    outputHeader.appendChild(codeStatusSpan);

    const outputConsoleDiv = document.createElement('div');
    outputConsoleDiv.classList.add('block-output-console');
    outputConsoleDiv.style.display = 'none';
    const outputPre = document.createElement('pre');
    outputConsoleDiv.appendChild(outputPre);

    preElement.appendChild(codeElement);
    container.appendChild(codeHeader);
    container.appendChild(preElement);
    container.appendChild(outputHeader);
    container.appendChild(outputConsoleDiv);

    // Add all the same event listeners as the original function
    toggleCodeBtn.addEventListener('click', () => {
        const isHidden = preElement.classList.toggle('hidden');
        toggleCodeBtn.textContent = isHidden ? 'Show' : 'Hide';
    });

    copyCodeBtn.addEventListener('click', async () => {
        try {
            await navigator.clipboard.writeText(codeElement.textContent || '');
            copyCodeBtn.textContent = 'Copied!';
            copyCodeBtn.classList.add('copied');
            setTimeout(() => { 
                copyCodeBtn.textContent = 'Copy'; 
                copyCodeBtn.classList.remove('copied'); 
            }, 1500);
        } catch (err) {
            console.error('Failed to copy code: ', err);
            copyCodeBtn.textContent = 'Error';
            setTimeout(() => { copyCodeBtn.textContent = 'Copy'; }, 1500);
        }
    });

    const debouncedHighlight = debounce(() => {
        const savedPosition = getCursorPosition(codeElement);
        try {
            const currentText = codeElement.textContent;
            codeElement.innerHTML = ''; 
            codeElement.textContent = currentText; 
            if (typeof Prism !== 'undefined' && typeof Prism.highlightElement === 'function') {
                Prism.highlightElement(codeElement);
            }
            if (savedPosition !== -1) { 
                setCursorPosition(codeElement, savedPosition); 
            }
        } catch (e) {
            console.error("Error during debounced highlighting:", e);
            if (savedPosition !== -1) { 
                setCursorPosition(codeElement, savedPosition); 
            }
        }
    }, 500);

    codeElement.addEventListener('input', debouncedHighlight);
    codeElement.addEventListener('paste', (e) => { 
        setTimeout(debouncedHighlight, 100); 
    });

    toggleOutputBtn.addEventListener('click', () => {
        const isHidden = outputConsoleDiv.classList.toggle('hidden');
        toggleOutputBtn.textContent = isHidden ? 'Show' : 'Hide';
    });

    copyOutputBtn.addEventListener('click', async () => {
        if (!outputPre) return;
        try {
            await navigator.clipboard.writeText(outputPre.textContent || '');
            copyOutputBtn.textContent = 'Copied!';
            copyOutputBtn.classList.add('copied');
            setTimeout(() => { 
                copyOutputBtn.textContent = 'Copy'; 
                copyOutputBtn.classList.remove('copied'); 
            }, 1500);
        } catch (err) {
            console.error('Failed to copy output: ', err);
            copyOutputBtn.textContent = 'Error';
            setTimeout(() => { copyOutputBtn.textContent = 'Copy'; }, 1500);
        }
    });

    codeBlocksAreaElement.appendChild(container);
}

// New function to update streaming code block content
function updateStreamingCodeBlockContent(blockId, content, isComplete) {
    const container = document.getElementById(blockId);
    if (!container) return;

    const codeElement = container.querySelector('code');
    const dotsSpan = container.querySelector('.streaming-dots');
    
    if (codeElement) {
        codeElement.textContent = content;
        
        // Apply syntax highlighting
        if (typeof Prism !== 'undefined' && typeof Prism.highlightElement === 'function') {
            try {
                Prism.highlightElement(codeElement);
            } catch (e) {
                console.error(`Prism highlight error:`, e);
            }
        }
    }
    
    // Remove dots animation when complete
    if (isComplete && dotsSpan) {
        dotsSpan.remove();
    }
}

=== tests/test_coding.py ===
import pytest
import asyncio
import time
import sys
import os

# Add the app directory to Python path
sys.path.append(os.path.dirname(os.path.dirname(__file__)))

from app import docker_utils
from app import state


def test_docker_client_connection():
    """Test that Docker client can be obtained"""
    client = docker_utils.get_docker_client()
    assert client is not None, "Docker client should be available"
    
    # Test ping
    try:
        result = client.ping()
        assert result is True, "Docker daemon should respond to ping"
    except Exception as e:
        pytest.fail(f"Docker ping failed: {e}")


def test_input_prompt_detection_patterns():
    """Test the input prompt detection logic"""
    
    # Test cases: (input_line, should_detect_as_prompt)
    test_cases = [
        ("Enter your name: ", True),
        ("What is your age? ", True), 
        ("Type something> ", True),
        ("Please enter input: ", True),
        ("Password: ", True),
        ("Normal output with newline\n", False),
        ("Processing...\n", False),
        ("Error occurred\n", False),
        ("", False),
    ]
    
    for line_str, expected in test_cases:
        # This is the same logic from sync_log_streamer
        stripped_line = line_str.rstrip('\n\r')
        is_input_prompt = (
            line_str == stripped_line and  # No newline at end
            len(stripped_line) > 0 and
            (stripped_line.endswith(': ') or 
             stripped_line.endswith('? ') or
             stripped_line.endswith('> ') or
             'enter' in stripped_line.lower() or
             'input' in stripped_line.lower())
        )
        
        assert is_input_prompt == expected, f"Failed for line: '{line_str}'"


@pytest.mark.asyncio
async def test_run_simple_python_code():
    """Test running simple Python code without input"""
    
    from fastapi.websockets import WebSocketState
    
    class TestWebSocket:
        def __init__(self):
            self.messages = []
            self.client_state = WebSocketState.CONNECTED
        
        async def send_text(self, text):
            self.messages.append(text)
        
        async def send_json(self, data):
            self.messages.append(data)
    
    ws = TestWebSocket()
    # Use code that takes a bit longer to execute
    code = '''
import time
print("Hello from Docker")
time.sleep(0.5)
print("Docker execution complete")
'''
    code_block_id = f"test_simple_{int(time.time())}"
    
    await docker_utils.run_code_in_docker_stream(
        ws, "test_client", code_block_id, "python", code
    )
    
    # Should have some output
    assert len(ws.messages) > 0
    
    print(f"Received {len(ws.messages)} messages")
    
    # Check if we got code_output messages (the actual stdout)
    output_messages = [msg for msg in ws.messages if isinstance(msg, dict) and msg.get('type') == 'code_output']
    finished_messages = [msg for msg in ws.messages if isinstance(msg, dict) and msg.get('type') == 'code_finished']
    
    # Should have at least the finished message
    assert len(finished_messages) > 0
    assert finished_messages[0]['payload']['exit_code'] == 0
    
    # If we got output messages, check for our text
    if output_messages:
        # Concatenate all the character data without spaces
        output_text = "".join(msg['payload']['data'] for msg in output_messages)
        print(f"Combined output: '{output_text}'")
        assert "Hello from Docker" in output_text
        assert "Docker execution complete" in output_text
    else:
        print("No code_output messages received, but container executed successfully")
    
    print("✅ Test passed - Docker execution with interactive flags works!")

@pytest.mark.asyncio  
async def test_run_python_with_input_prompt():
    """Test running Python code that has input() call"""
    
    from fastapi.websockets import WebSocketState
    
    class TestWebSocket:
        def __init__(self):
            self.messages = []
            self.structured_messages = []
            # Use the correct WebSocketState enum
            self.client_state = WebSocketState.CONNECTED
        
        async def send_text(self, text):
            self.messages.append(text)
        
        async def send_json(self, data):
            self.messages.append(data)
            self.structured_messages.append(data)
    
    ws = TestWebSocket()
    code = '''
print("Starting program")
name = input("Enter your name: ")
print(f"Hello {name}")
'''
    code_block_id = f"test_input_{int(time.time())}"
    
    # Start the execution task
    task = asyncio.create_task(
        docker_utils.run_code_in_docker_stream(
            ws, "test_client", code_block_id, "python", code
        )
    )
    
    # Wait a bit for it to reach the input prompt
    await asyncio.sleep(3)
    
    # Stop the container to avoid hanging
    await docker_utils.stop_docker_container(code_block_id)
    
    # Check that we got some output
    assert len(ws.messages) > 0
    
    print(f"Received {len(ws.messages)} messages")
    
    # Should see the program starting
    output_messages = [msg for msg in ws.messages if isinstance(msg, dict) and msg.get('type') == 'code_output']
    if output_messages:
        output_text = "".join(msg['payload']['data'] for msg in output_messages)
        print(f"Combined output: '{output_text}'")
        assert "Starting program" in output_text
    
    print("✅ Input prompt test completed")


@pytest.mark.asyncio
async def test_send_input_to_nonexistent_container():
    """Test sending input to a container that doesn't exist"""
    
    # This should not raise an exception, just log and return
    await docker_utils.send_input_to_container("nonexistent_block", "test input\n")
    
    # If we get here without exception, the test passes


@pytest.mark.asyncio
async def test_stop_nonexistent_container():
    """Test stopping a container that doesn't exist"""
    
    # This should not raise an exception
    await docker_utils.stop_docker_container("nonexistent_block")
    

@pytest.mark.asyncio
async def test_container_lifecycle():
    """Test creating, running, and stopping a container"""
    
    from fastapi.websockets import WebSocketState
    
    class TestWebSocket:
        def __init__(self):
            self.messages = []
            # Use the correct WebSocketState enum
            self.client_state = WebSocketState.CONNECTED
        
        async def send_text(self, text):
            self.messages.append(text)
        
        async def send_json(self, data):
            self.messages.append(data)
    
    ws = TestWebSocket()
    code = '''
import time
print("Container started")
time.sleep(2)
print("Container finishing")
'''
    code_block_id = f"test_lifecycle_{int(time.time())}"
    
    # Start execution
    task = asyncio.create_task(
        docker_utils.run_code_in_docker_stream(
            ws, "test_client", code_block_id, "python", code
        )
    )
    
    # Wait a moment
    await asyncio.sleep(1)
    
    # Check that container is tracked
    async with state.running_containers_lock:
        assert code_block_id in state.running_containers
    
    # Stop the container
    await docker_utils.stop_docker_container(code_block_id)
    
    # Wait a moment for cleanup
    await asyncio.sleep(1)
    
    # Check that container is no longer tracked
    async with state.running_containers_lock:
        assert code_block_id not in state.running_containers
    
    # Should have received some output
    assert len(ws.messages) > 0
    
    print(f"Lifecycle test completed with {len(ws.messages)} messages")
    print("✅ Container lifecycle test passed")

@pytest.mark.asyncio
async def test_interactive_container_creation():
    """Test that containers are created with interactive flags"""
    
    from fastapi.websockets import WebSocketState
    
    class TestWebSocket:
        def __init__(self):
            self.messages = []
            # Use the correct WebSocketState enum
            self.client_state = WebSocketState.CONNECTED
        
        async def send_text(self, text):
            self.messages.append(text)
        
        async def send_json(self, data):
            self.messages.append(data)
    
    ws = TestWebSocket()
    code = "print('Testing interactive flags')"
    code_block_id = f"test_interactive_{int(time.time())}"
    
    # This should work without errors if interactive flags are set correctly
    await docker_utils.run_code_in_docker_stream(
        ws, "test_client", code_block_id, "python", code
    )
    
    # Should complete successfully
    assert len(ws.messages) > 0
    
    # Get the actual output text from code_output messages
    output_messages = [msg for msg in ws.messages if isinstance(msg, dict) and msg.get('type') == 'code_output']
    if output_messages:
        # Concatenate character-by-character output
        output_text = "".join(msg['payload']['data'] for msg in output_messages)
        print(f"Interactive test output: '{output_text}'")
        assert "Testing interactive flags" in output_text
    else:
        # If no code_output messages, check if container finished successfully
        finished_messages = [msg for msg in ws.messages if isinstance(msg, dict) and msg.get('type') == 'code_finished']
        assert len(finished_messages) > 0
        assert finished_messages[0]['payload']['exit_code'] == 0
        print("✅ Interactive container executed successfully (no output captured)")
    
    print("✅ Interactive container creation test passed")


def test_state_initialization():
    """Test that required state objects exist"""
    
    # Check that running_containers exists
    assert hasattr(state, 'running_containers')
    assert hasattr(state, 'running_containers_lock')
    
    # Should be able to access the lock
    assert state.running_containers_lock is not None


=== LLM Instructions ===
Now please just read the project and the rules for writing code and just wait for instructions.

Here are the rules:
1. DONT write comments, placeholders or docstrings if not explicitely told.
2. Write functions with the correct initial indentation so that if the function is indented so is your code that you write.
3. DO NOT USE NON-TERMINATED SPACES. MAKE SURE TO FOLLOW THIS! ITS SUPER IMPORTANT AND YOU SEEM TO BREAK IT, PLEASE!!!
4. For changes that require multiple replacements please tell me what to replace with what instead of rewriting large portions of text. You can use vscode valid regexp for instance.
5. For small functions less than 100 lines of code please rewrite the full function. For larger functions please only write complete control statements if/while/case.
6. Never omit/change working logic if not explicitely statet that it should be removed/change
7. DONT use the CANVAS TOOL where code is written in artifacts.
8. Write only functions that are new seperately from functions that needs updates.
9. Make sure to write what has been change where to place/what to replace for each code snippet.
