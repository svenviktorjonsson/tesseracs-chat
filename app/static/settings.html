<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Settings - Tesseracs Chat</title>
    <link rel="stylesheet" href="/dist/input.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script id="csrf-token-script-page-settings">
      // This placeholder will be replaced by the server with the actual raw CSRF token.
      window.csrfTokenRaw = "%%CSRF_TOKEN_RAW%%";
    </script>
    <script>
      // Optional immediate diagnostic client-side to verify token injection
      if (typeof window.csrfTokenRaw !== 'undefined' && window.csrfTokenRaw !== "%%CSRF_TOKEN_RAW%%") {
        console.log('SETTINGS PAGE JS (after csrf-token-script): window.csrfTokenRaw is available.');
      } else {
        console.warn('SETTINGS PAGE JS (after csrf-token-script): window.csrfTokenRaw IS STILL THE PLACEHOLDER "%%CSRF_TOKEN_RAW%%" OR UNDEFINED. Value:', window.csrfTokenRaw);
      }
    </script>    
    <style>
        .sidebar-scrollable { overflow-y: auto; scrollbar-width: thin; scrollbar-color: #a0aec0 #edf2f7; }
        .sidebar-scrollable::-webkit-scrollbar { width: 6px; }
        .sidebar-scrollable::-webkit-scrollbar-track { background: #edf2f7; border-radius: 3px; }
        .sidebar-scrollable::-webkit-scrollbar-thumb { background-color: #a0aec0; border-radius: 3px; border: 1px solid #edf2f7; }
        /* Additional styles for focused state or loading states if needed */
        input:read-only, select:disabled {
            background-color: #f3f4f6; /* Tailwind gray-100 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        label {
            user-select: none;
        }
    </style>
</head>
<body class="font-inter bg-gray-100 text-gray-800">

    <div class="flex h-screen overflow-hidden">
        <aside id="sidebar-loader-target" class="w-64 bg-gray-800 text-gray-200 flex flex-col overflow-hidden">
            </aside>

        <main class="flex-1 flex flex-col overflow-y-auto p-6 items-center">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-2xl lg:max-w-3xl"> <h1 class="text-2xl lg:text-3xl font-semibold text-gray-900 mb-6 border-b border-gray-200 pb-4">User Settings</h1>

                <div id="settings-message-area" class="p-3 rounded-md text-sm text-center mb-4" style="display: none;" role="alert" aria-live="polite"></div>

                <section id="account-settings" aria-labelledby="account-settings-heading" class="mb-8">
                    <h2 id="account-settings-heading" class="text-xl font-semibold text-gray-700 mb-5">Account Information</h2>
                    
                    <form id="update-name-form" class="space-y-4 mb-6">
                        <div class="mb-4">
                            <label for="current-name" class="block text-sm font-medium text-gray-700 mb-1">Current Name</label>
                            <input type="text" id="current-name" name="current-name" readonly
                                   class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm"
                                   placeholder="Loading...">
                        </div>
                        <div class="mb-4">
                            <label for="new-name" class="block text-sm font-medium text-gray-700 mb-1">New Name</label>
                            <input type="text" id="new-name" name="new_name" required autocomplete="name"
                                   class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150"
                                   minlength="1" maxlength="100">
                        </div>
                        <div class="mb-4">
                            <label for="current-password-for-name" class="block text-sm font-medium text-gray-700 mb-1">Current Password <span class="text-gray-500">(to confirm name change)</span></label>
                            <input type="password" id="current-password-for-name" name="current_password" required autocomplete="current-password"
                                   class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150">
                        </div>
                        <div>
                            <button type="submit" id="update-name-button"
                                    class="py-2.5 px-5 bg-blue-600 text-white rounded-md font-medium text-sm transition-colors duration-150 hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                Update Name
                            </button>
                        </div>
                    </form>

                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">Change Email</h3>
                        <p class="text-sm text-gray-500 mb-3" id="change-email-description">You will be logged out after successfully changing your email address.</p>
                        <form id="update-email-form" class="space-y-4 mb-6" aria-describedby="change-email-description">
                            <div class="mb-4">
                                <label for="current-email" class="block text-sm font-medium text-gray-700 mb-1">Current Email</label>
                                <input type="email" id="current-email" name="current-email" readonly
                                       class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm"
                                       placeholder="Loading...">
                            </div>
                            <div class="mb-4">
                                <label for="new-email" class="block text-sm font-medium text-gray-700 mb-1">New Email Address</label>
                                <input type="email" id="new-email" name="new_email" required autocomplete="email"
                                       class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150">
                            </div>
                            <div class="mb-4">
                                <label for="current-password-for-email" class="block text-sm font-medium text-gray-700 mb-1">Current Password <span class="text-gray-500">(to confirm email change)</span></label>
                                <input type="password" id="current-password-for-email" name="current_password" required autocomplete="current-password"
                                       class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150">
                            </div>
                            <div>
                                <button type="submit" id="update-email-button"
                                        class="py-2.5 px-5 bg-blue-600 text-white rounded-md font-medium text-sm transition-colors duration-150 hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Update Email Address
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-medium text-gray-700 mb-3">Regenerate Password</h3>
                        <p class="text-sm text-gray-500 mb-3" id="regenerate-password-description">A new password will be generated and emailed to your current email address. You will be logged out after this action.</p>
                        <form id="regenerate-password-form" class="space-y-4" aria-describedby="regenerate-password-description">
                            <div class="mb-4">
                                <label for="current-password-for-regen" class="block text-sm font-medium text-gray-700 mb-1">Current Password <span class="text-gray-500">(to confirm password regeneration)</span></label>
                                <input type="password" id="current-password-for-regen" name="current_password" required autocomplete="current-password"
                                       class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150">
                            </div>
                            <div>
                                <button type="submit" id="regenerate-password-button"
                                        class="py-2.5 px-5 bg-orange-600 text-white rounded-md font-medium text-sm transition-colors duration-150 hover:bg-orange-700 focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Regenerate Password & Send Email
                                </button>
                            </div>
                        </form>
                    </div>
                </section>

                <section id="llm-settings" class="mt-8 pt-6 border-t border-gray-200" aria-labelledby="llm-settings-heading">
                    <h2 id="llm-settings-heading" class="text-xl font-semibold text-gray-700 mb-5">LLM Configuration</h2>
                    <form id="llm-settings-form" class="space-y-4">
                        <div class="mb-4">
                            <label for="llm-provider" class="block text-sm font-medium text-gray-700 mb-1">Chat Provider</label>
                            <select id="llm-provider" name="selected_llm_provider_id"
                                    class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150"
                                    aria-describedby="llm-provider-status">
                                <option value="">Loading providers...</option>
                            </select>
                            <p id="llm-provider-status" class="text-xs text-gray-500 mt-1"></p>
                        </div>

                        <div class="mb-4">
                            <label for="llm-model" class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                            <select id="llm-model" name="selected_llm_model_id"
                                    class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm bg-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150"
                                    disabled> <option value="">Select a provider first</option>
                            </select>
                        </div>

                        <div id="llm-api-key-group" class="mb-4" style="display: none;" aria-hidden="true">
                            <label for="llm-api-key" class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                            <input type="password" id="llm-api-key" name="user_llm_api_key" autocomplete="off"
                                   class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150"
                                   placeholder="Leave blank to use system key or if not required"
                                   aria-describedby="llm-api-key-status">
                            <p id="llm-api-key-status" class="text-xs text-gray-500 mt-1"></p>
                        </div>

                        <div id="llm-base-url-group" class="mb-4" style="display: none;" aria-hidden="true">
                            <label for="llm-base-url" class="block text-sm font-medium text-gray-700 mb-1">Custom Base URL <span class="text-gray-500">(Optional)</span></label>
                            <input type="url" id="llm-base-url" name="selected_llm_base_url" autocomplete="off"
                                   class="w-full py-2.5 px-4 border border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-colors duration-150"
                                   placeholder="e.g., http://localhost:11434/v1"
                                   aria-describedby="llm-base-url-description">
                               <p id="llm-base-url-description" class="text-xs text-gray-500 mt-1">Typically for OpenAI-compatible servers or custom Ollama instances.</p>
                        </div>
                        <div>
                            <button type="submit" id="save-llm-settings-button"
                                    class="py-2.5 px-5 bg-blue-600 text-white rounded-md font-medium text-sm transition-colors duration-150 hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                Save LLM Settings
                            </button>
                        </div>
                    </form>
                </section>
            </div>
        </main>
    </div>

    <script type="module" src="/static/js/settings.js"></script>
    </body>
</html>